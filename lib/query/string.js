'use strict';

var SqlString = exports;
var helpers = require('../helpers');

SqlString.escape = function (val, timeZone) {
  // Cant do require on top of file beacuse Raw is not yet initialized when this file is
  // executed for the first time
  var Raw = require('../raw');

  if (val === null || val === undefined) {
    return 'NULL';
  }

  switch (typeof val) {
    case 'boolean':
      return val ? 'true' : 'false';
    case 'number':
      return val + '';
  }

  if (val instanceof Date) {
    val = SqlString.dateToString(val, timeZone || 'local');
  }

  if (Buffer.isBuffer(val)) {
    return SqlString.bufferToString(val);
  }

  if (Array.isArray(val)) {
    return SqlString.arrayToList(val, timeZone);
  }

  if (val instanceof Raw) {
    return val;
  }

  if (typeof val === 'object') {
    try {
      val = JSON.stringify(val);
    } catch (e) {
      helpers.warn(e);
      val = val + '';
    }
  }

  val = val.replace(/(\\\?)|[\0\n\r\b\t\\\'\"\x1a]/g, function (s) {
    switch (s) {
      case "\0":
        return "\\0";
      case "\n":
        return "\\n";
      case "\r":
        return "\\r";
      case "\b":
        return "\\b";
      case "\t":
        return "\\t";
      case "\x1a":
        return "\\Z";
      case "\\?":
        return "?";
      default:
        return "\\" + s;
    }
  });
  return "'" + val + "'";
};

SqlString.arrayToList = function (array, timeZone) {
  var self = this;
  return array.map(function (v) {
    if (Array.isArray(v)) return '(' + SqlString.arrayToList(v, timeZone) + ')';
    return self.escape(v, timeZone);
  }).join(', ');
};

SqlString.format = function (sql, values, timeZone) {
  var self = this;
  values = values == null ? [] : [].concat(values);
  var index = 0;
  return sql.replace(/\\?\?/g, function (match) {
    if (match === '\\?') return match;
    if (index === values.length) {
      return match;
    }
    var value = values[index++];
    return self.escape(value, timeZone);
  }).replace('\\?', '?');
};

SqlString.dateToString = function (date, timeZone) {
  var dt = new Date(date);

  if (timeZone !== 'local') {
    var tz = convertTimezone(timeZone);

    dt.setTime(dt.getTime() + dt.getTimezoneOffset() * 60000);
    if (tz !== false) {
      dt.setTime(dt.getTime() + tz * 60000);
    }
  }

  var year = dt.getFullYear();
  var month = zeroPad(dt.getMonth() + 1, 2);
  var day = zeroPad(dt.getDate(), 2);
  var hour = zeroPad(dt.getHours(), 2);
  var minute = zeroPad(dt.getMinutes(), 2);
  var second = zeroPad(dt.getSeconds(), 2);
  var millisecond = zeroPad(dt.getMilliseconds(), 3);

  return year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second + '.' + millisecond;
};

SqlString.bufferToString = function bufferToString(buffer) {
  return "X'" + buffer.toString('hex') + "'";
};

function zeroPad(number, length) {
  number = number.toString();
  while (number.length < length) {
    number = '0' + number;
  }

  return number;
}

function convertTimezone(tz) {
  if (tz === "Z") return 0;

  var m = tz.match(/([\+\-\s])(\d\d):?(\d\d)?/);
  if (m) {
    return (m[1] === '-' ? -1 : 1) * (parseInt(m[2], 10) + (m[3] ? parseInt(m[3], 10) : 0) / 60) * 60;
  }
  return false;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9xdWVyeS9zdHJpbmcuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFBOztBQUVaLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQztBQUN4QixJQUFJLE9BQU8sR0FBSyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUE7O0FBRXJDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsVUFBUyxHQUFHLEVBQUUsUUFBUSxFQUFFOzs7QUFHekMsTUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBOztBQUUzQixNQUFJLEdBQUcsS0FBSyxJQUFJLElBQUksR0FBRyxLQUFLLFNBQVMsRUFBRTtBQUNyQyxXQUFPLE1BQU0sQ0FBQztHQUNmOztBQUVELFVBQVEsT0FBTyxHQUFHO0FBQ2hCLFNBQUssU0FBUztBQUFFLGFBQU8sQUFBQyxHQUFHLEdBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQztBQUFBLEFBQ2hELFNBQUssUUFBUTtBQUFFLGFBQU8sR0FBRyxHQUFDLEVBQUUsQ0FBQztBQUFBLEdBQzlCOztBQUVELE1BQUksR0FBRyxZQUFZLElBQUksRUFBRTtBQUN2QixPQUFHLEdBQUcsU0FBUyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsUUFBUSxJQUFJLE9BQU8sQ0FBQyxDQUFDO0dBQ3hEOztBQUVELE1BQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUN4QixXQUFPLFNBQVMsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7R0FDdEM7O0FBRUQsTUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ3RCLFdBQU8sU0FBUyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7R0FDN0M7O0FBRUQsTUFBSSxHQUFHLFlBQVksR0FBRyxFQUFFO0FBQ3RCLFdBQU8sR0FBRyxDQUFDO0dBQ1o7O0FBRUQsTUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLEVBQUU7QUFD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QUE7O0FBRUQsU0FBUyxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRTtBQUMvQixRQUFNLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQzNCLFNBQU8sTUFBTSxDQUFDLE1BQU0sR0FBRyxNQUFNLEVBQUU7QUFDN0IsVUFBTSxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUM7R0FDdkI7O0FBRUQsU0FBTyxNQUFNLENBQUM7Q0FDZjs7QUFFRCxTQUFTLGVBQWUsQ0FBQyxFQUFFLEVBQUU7QUFDM0IsTUFBSSxFQUFFLEtBQUssR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDOztBQUV6QixNQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7QUFDOUMsTUFBSSxDQUFDLEVBQUU7QUFDTCxXQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUEsSUFBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFBLEdBQUksRUFBRSxDQUFDLEFBQUMsR0FBRyxFQUFFLENBQUM7R0FDckc7QUFDRCxTQUFPLEtBQUssQ0FBQztDQUNkIiwiZmlsZSI6InN0cmluZy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG52YXIgU3FsU3RyaW5nID0gZXhwb3J0cztcbnZhciBoZWxwZXJzICAgPSByZXF1aXJlKCcuLi9oZWxwZXJzJylcblxuU3FsU3RyaW5nLmVzY2FwZSA9IGZ1bmN0aW9uKHZhbCwgdGltZVpvbmUpIHtcbiAgLy8gQ2FudCBkbyByZXF1aXJlIG9uIHRvcCBvZiBmaWxlIGJlYWN1c2UgUmF3IGlzIG5vdCB5ZXQgaW5pdGlhbGl6ZWQgd2hlbiB0aGlzIGZpbGUgaXNcbiAgLy8gZXhlY3V0ZWQgZm9yIHRoZSBmaXJzdCB0aW1lXG4gIHZhciBSYXcgPSByZXF1aXJlKCcuLi9yYXcnKVxuXG4gIGlmICh2YWwgPT09IG51bGwgfHwgdmFsID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gJ05VTEwnO1xuICB9XG5cbiAgc3dpdGNoICh0eXBlb2YgdmFsKSB7XG4gICAgY2FzZSAnYm9vbGVhbic6IHJldHVybiAodmFsKSA/ICd0cnVlJyA6ICdmYWxzZSc7XG4gICAgY2FzZSAnbnVtYmVyJzogcmV0dXJuIHZhbCsnJztcbiAgfVxuXG4gIGlmICh2YWwgaW5zdGFuY2VvZiBEYXRlKSB7XG4gICAgdmFsID0gU3FsU3RyaW5nLmRhdGVUb1N0cmluZyh2YWwsIHRpbWVab25lIHx8ICdsb2NhbCcpO1xuICB9XG5cbiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcih2YWwpKSB7XG4gICAgcmV0dXJuIFNxbFN0cmluZy5idWZmZXJUb1N0cmluZyh2YWwpO1xuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkge1xuICAgIHJldHVybiBTcWxTdHJpbmcuYXJyYXlUb0xpc3QodmFsLCB0aW1lWm9uZSk7XG4gIH1cblxuICBpZiAodmFsIGluc3RhbmNlb2YgUmF3KSB7XG4gICAgcmV0dXJuIHZhbDtcbiAgfVxuXG4gIGlmICh0eXBlb2YgdmFsID09PSAnb2JqZWN0Jykge1xuICAgIHRyeSB7XG4gICAgICB2YWwgPSBKU09OLnN0cmluZ2lmeSh2YWwpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaGVscGVycy53YXJuKGUpXG4gICAgICB2YWwgPSB2YWwgKyAnJ1xuICAgIH1cbiAgfVxuXG4gIHZhbCA9IHZhbC5yZXBsYWNlKC8oXFxcXFxcPyl8W1xcMFxcblxcclxcYlxcdFxcXFxcXCdcXFwiXFx4MWFdL2csIGZ1bmN0aW9uKHMpIHtcbiAgICBzd2l0Y2gocykge1xuICAgICAgY2FzZSBcIlxcMFwiOiByZXR1cm4gXCJcXFxcMFwiO1xuICAgICAgY2FzZSBcIlxcblwiOiByZXR1cm4gXCJcXFxcblwiO1xuICAgICAgY2FzZSBcIlxcclwiOiByZXR1cm4gXCJcXFxcclwiO1xuICAgICAgY2FzZSBcIlxcYlwiOiByZXR1cm4gXCJcXFxcYlwiO1xuICAgICAgY2FzZSBcIlxcdFwiOiByZXR1cm4gXCJcXFxcdFwiO1xuICAgICAgY2FzZSBcIlxceDFhXCI6IHJldHVybiBcIlxcXFxaXCI7XG4gICAgICBjYXNlIFwiXFxcXD9cIjogcmV0dXJuIFwiP1wiO1xuICAgICAgZGVmYXVsdDogcmV0dXJuIFwiXFxcXFwiK3M7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIFwiJ1wiK3ZhbCtcIidcIjtcbn07XG5cblNxbFN0cmluZy5hcnJheVRvTGlzdCA9IGZ1bmN0aW9uKGFycmF5LCB0aW1lWm9uZSkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHJldHVybiBhcnJheS5tYXAoZnVuY3Rpb24odikge1xuICAgIGlmIChBcnJheS5pc0FycmF5KHYpKSByZXR1cm4gJygnICsgU3FsU3RyaW5nLmFycmF5VG9MaXN0KHYsIHRpbWVab25lKSArICcpJztcbiAgICByZXR1cm4gc2VsZi5lc2NhcGUodiwgdGltZVpvbmUpO1xuICB9KS5qb2luKCcsICcpO1xufTtcblxuU3FsU3RyaW5nLmZvcm1hdCA9IGZ1bmN0aW9uKHNxbCwgdmFsdWVzLCB0aW1lWm9uZSkge1xuICB2YXIgc2VsZiA9IHRoaXM7XG4gIHZhbHVlcyA9IHZhbHVlcyA9PSBudWxsID8gW10gOiBbXS5jb25jYXQodmFsdWVzKTtcbiAgdmFyIGluZGV4ID0gMDtcbiAgcmV0dXJuIHNxbC5yZXBsYWNlKC9cXFxcP1xcPy9nLCBmdW5jdGlvbihtYXRjaCkge1xuICAgIGlmIChtYXRjaCA9PT0gJ1xcXFw/JykgcmV0dXJuIG1hdGNoO1xuICAgIGlmIChpbmRleCA9PT0gdmFsdWVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIG1hdGNoO1xuICAgIH1cbiAgICB2YXIgdmFsdWUgPSB2YWx1ZXNbaW5kZXgrK107XG4gICAgcmV0dXJuIHNlbGYuZXNjYXBlKHZhbHVlLCB0aW1lWm9uZSlcbiAgfSkucmVwbGFjZSgnXFxcXD8nLCAnPycpO1xufTtcblxuU3FsU3RyaW5nLmRhdGVUb1N0cmluZyA9IGZ1bmN0aW9uKGRhdGUsIHRpbWVab25lKSB7XG4gIHZhciBkdCA9IG5ldyBEYXRlKGRhdGUpO1xuXG4gIGlmICh0aW1lWm9uZSAhPT0gJ2xvY2FsJykge1xuICAgIHZhciB0eiA9IGNvbnZlcnRUaW1lem9uZSh0aW1lWm9uZSk7XG5cbiAgICBkdC5zZXRUaW1lKGR0LmdldFRpbWUoKSArIChkdC5nZXRUaW1lem9uZU9mZnNldCgpICogNjAwMDApKTtcbiAgICBpZiAodHogIT09IGZhbHNlKSB7XG4gICAgICBkdC5zZXRUaW1lKGR0LmdldFRpbWUoKSArICh0eiAqIDYwMDAwKSk7XG4gICAgfVxuICB9XG5cbiAgdmFyIHllYXIgICA9IGR0LmdldEZ1bGxZZWFyKCk7XG4gIHZhciBtb250aCAgPSB6ZXJvUGFkKGR0LmdldE1vbnRoKCkgKyAxLCAyKTtcbiAgdmFyIGRheSAgICA9IHplcm9QYWQoZHQuZ2V0RGF0ZSgpLCAyKTtcbiAgdmFyIGhvdXIgICA9IHplcm9QYWQoZHQuZ2V0SG91cnMoKSwgMik7XG4gIHZhciBtaW51dGUgPSB6ZXJvUGFkKGR0LmdldE1pbnV0ZXMoKSwgMik7XG4gIHZhciBzZWNvbmQgPSB6ZXJvUGFkKGR0LmdldFNlY29uZHMoKSwgMik7XG4gIHZhciBtaWxsaXNlY29uZCA9IHplcm9QYWQoZHQuZ2V0TWlsbGlzZWNvbmRzKCksIDMpO1xuXG4gIHJldHVybiB5ZWFyICsgJy0nICsgbW9udGggKyAnLScgKyBkYXkgKyAnICcgKyBob3VyICsgJzonICsgbWludXRlICsgJzonICsgc2Vjb25kICsgJy4nICsgbWlsbGlzZWNvbmQ7XG59O1xuXG5TcWxTdHJpbmcuYnVmZmVyVG9TdHJpbmcgPSBmdW5jdGlvbiBidWZmZXJUb1N0cmluZyhidWZmZXIpIHtcbiAgcmV0dXJuIFwiWCdcIiArIGJ1ZmZlci50b1N0cmluZygnaGV4JykgKyBcIidcIjtcbn1cblxuZnVuY3Rpb24gemVyb1BhZChudW1iZXIsIGxlbmd0aCkge1xuICBudW1iZXIgPSBudW1iZXIudG9TdHJpbmcoKTtcbiAgd2hpbGUgKG51bWJlci5sZW5ndGggPCBsZW5ndGgpIHtcbiAgICBudW1iZXIgPSAnMCcgKyBudW1iZXI7XG4gIH1cblxuICByZXR1cm4gbnVtYmVyO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0VGltZXpvbmUodHopIHtcbiAgaWYgKHR6ID09PSBcIlpcIikgcmV0dXJuIDA7XG5cbiAgdmFyIG0gPSB0ei5tYXRjaCgvKFtcXCtcXC1cXHNdKShcXGRcXGQpOj8oXFxkXFxkKT8vKTtcbiAgaWYgKG0pIHtcbiAgICByZXR1cm4gKG1bMV0gPT09ICctJyA/IC0xIDogMSkgKiAocGFyc2VJbnQobVsyXSwgMTApICsgKChtWzNdID8gcGFyc2VJbnQobVszXSwgMTApIDogMCkgLyA2MCkpICogNjA7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuIl19