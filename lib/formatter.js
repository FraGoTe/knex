'use strict';

var QueryBuilder = require('./query/builder');
var Raw = require('./raw');
var assign = require('lodash/object/assign');
var transform = require('lodash/object/transform');

function Formatter(client) {
  this.client = client;
  this.bindings = [];
}

assign(Formatter.prototype, {

  // Accepts a string or array of columns to wrap as appropriate.
  columnize: function columnize(target) {
    var columns = typeof target === 'string' ? [target] : target;
    var str = '',
        i = -1;
    while (++i < columns.length) {
      if (i > 0) str += ', ';
      str += this.wrap(columns[i]);
    }
    return str;
  },

  // Turns a list of values into a list of ?'s, joining them with commas unless
  // a "joining" value is specified (e.g. ' and ')
  parameterize: function parameterize(values, notSetValue) {
    if (typeof values === 'function') return this.parameter(values);
    values = Array.isArray(values) ? values : [values];
    var str = '',
        i = -1;
    while (++i < values.length) {
      if (i > 0) str += ', ';
      str += this.parameter(values[i] === undefined ? notSetValue : values[i]);
    }
    return str;
  },

  // Checks whether a value is a function... if it is, we compile it
  // otherwise we check whether it's a raw
  parameter: function parameter(value) {
    if (typeof value === 'function') {
      return this.outputQuery(this.compileCallback(value), true);
    }
    return this.unwrapRaw(value, true) || '?';
  },

  unwrapRaw: function unwrapRaw(value, isParameter) {
    var query;
    if (value instanceof QueryBuilder) {
      query = this.client.queryCompiler(value).toSQL();
      if (query.bindings) {
        this.bindings = this.bindings.concat(query.bindings);
      }
      return this.outputQuery(query, isParameter);
    }
    if (value instanceof Raw) {
      value.client = this.client;
      query = value.toSQL();
      if (query.bindings) {
        this.bindings = this.bindings.concat(query.bindings);
      }
      return query.sql;
    }
    if (isParameter) {
      this.bindings.push(value);
    }
  },

  rawOrFn: function rawOrFn(value, method) {
    if (typeof value === 'function') {
      return this.outputQuery(this.compileCallback(value, method));
    }
    return this.unwrapRaw(value) || '';
  },

  // Puts the appropriate wrapper around a value depending on the database
  // engine, unless it's a knex.raw value, in which case it's left alone.
  wrap: function wrap(value) {
    var raw;
    if (typeof value === 'function') {
      return this.outputQuery(this.compileCallback(value), true);
    }
    raw = this.unwrapRaw(value);
    if (raw) return raw;
    if (typeof value === 'number') return value;
    return this._wrapString(value + '');
  },

  alias: function alias(first, second) {
    return first + ' as ' + second;
  },

  // The operator method takes a value and returns something or other.
  operator: function operator(value) {
    var raw = this.unwrapRaw(value);
    if (raw) return raw;
    if (operators[(value || '').toLowerCase()] !== true) {
      throw new TypeError('The operator "' + value + '" is not permitted');
    }
    return value;
  },

  // Specify the direction of the ordering.
  direction: function direction(value) {
    var raw = this.unwrapRaw(value);
    if (raw) return raw;
    return orderBys.indexOf((value || '').toLowerCase()) !== -1 ? value : 'asc';
  },

  // Compiles a callback using the query builder.
  compileCallback: function compileCallback(callback, method) {
    var client = this.client;

    // Build the callback
    var builder = client.queryBuilder();
    callback.call(builder, builder);

    // Compile the callback, using the current formatter (to track all bindings).
    var compiler = client.queryCompiler(builder);
    compiler.formatter = this;

    // Return the compiled & parameterized sql.
    return compiler.toSQL(method || 'select');
  },

  // Ensures the query is aliased if necessary.
  outputQuery: function outputQuery(compiled, isParameter) {
    var sql = compiled.sql || '';
    if (sql) {
      if (compiled.method === 'select' && (isParameter || compiled.as)) {
        sql = '(' + sql + ')';
        if (compiled.as) return this.alias(sql, this.wrap(compiled.as));
      }
    }
    return sql;
  },

  // Coerce to string to prevent strange errors when it's not a string.
  _wrapString: function _wrapString(value) {
    var segments,
        asIndex = value.toLowerCase().indexOf(' as ');
    if (asIndex !== -1) {
      var first = value.slice(0, asIndex);
      var second = value.slice(asIndex + 4);
      return this.alias(this.wrap(first), this.wrap(second));
    }
    var i = -1,
        wrapped = [];
    segments = value.split('.');
    while (++i < segments.length) {
      value = segments[i];
      if (i === 0 && segments.length > 1) {
        wrapped.push(this.wrap((value || '').trim()));
      } else {
        wrapped.push(this.client.wrapIdentifier((value || '').trim()));
      }
    }
    return wrapped.join('.');
  }

});

// Valid values for the `order by` clause generation.
var orderBys = ['asc', 'desc'];

// Turn this into a lookup map
var operators = transform(['=', '<', '>', '<=', '>=', '<>', '!=', 'like', 'not like', 'between', 'ilike', '&', '|', '^', '<<', '>>', 'rlike', 'regexp', 'not regexp', '~', '~*', '!~', '!~*', '#', '&&', '@>', '<@', '||'], function (obj, key) {
  obj[key] = true;
}, Object.create(null));

module.exports = Formatter;
//# sourceMappingURL=data:application/json;base64,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RUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFDdkQsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FDNUIsRUFBRSxVQUFTLEdBQUcsRUFBRSxHQUFHLEVBQUU7QUFDcEIsS0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQTtDQUNoQixFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTs7QUFFdkIsTUFBTSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUMiLCJmaWxlIjoiZm9ybWF0dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG52YXIgUXVlcnlCdWlsZGVyID0gcmVxdWlyZSgnLi9xdWVyeS9idWlsZGVyJylcbnZhciBSYXcgICAgICAgICAgPSByZXF1aXJlKCcuL3JhdycpXG52YXIgYXNzaWduICAgICAgID0gcmVxdWlyZSgnbG9kYXNoL29iamVjdC9hc3NpZ24nKVxudmFyIHRyYW5zZm9ybSAgICA9IHJlcXVpcmUoJ2xvZGFzaC9vYmplY3QvdHJhbnNmb3JtJylcblxuZnVuY3Rpb24gRm9ybWF0dGVyKGNsaWVudCkge1xuICB0aGlzLmNsaWVudCAgICAgICA9IGNsaWVudFxuICB0aGlzLmJpbmRpbmdzICAgICA9IFtdXG59XG5cbmFzc2lnbihGb3JtYXR0ZXIucHJvdG90eXBlLCB7XG5cbiAgLy8gQWNjZXB0cyBhIHN0cmluZyBvciBhcnJheSBvZiBjb2x1bW5zIHRvIHdyYXAgYXMgYXBwcm9wcmlhdGUuXG4gIGNvbHVtbml6ZTogZnVuY3Rpb24odGFyZ2V0KSB7XG4gICAgdmFyIGNvbHVtbnMgPSB0eXBlb2YgdGFyZ2V0ID09PSAnc3RyaW5nJyA/IFt0YXJnZXRdIDogdGFyZ2V0XG4gICAgdmFyIHN0ciA9ICcnLCBpID0gLTE7XG4gICAgd2hpbGUgKCsraSA8IGNvbHVtbnMubGVuZ3RoKSB7XG4gICAgICBpZiAoaSA+IDApIHN0ciArPSAnLCAnXG4gICAgICBzdHIgKz0gdGhpcy53cmFwKGNvbHVtbnNbaV0pXG4gICAgfVxuICAgIHJldHVybiBzdHJcbiAgfSxcblxuICAvLyBUdXJucyBhIGxpc3Qgb2YgdmFsdWVzIGludG8gYSBsaXN0IG9mID8ncywgam9pbmluZyB0aGVtIHdpdGggY29tbWFzIHVubGVzc1xuICAvLyBhIFwiam9pbmluZ1wiIHZhbHVlIGlzIHNwZWNpZmllZCAoZS5nLiAnIGFuZCAnKVxuICBwYXJhbWV0ZXJpemU6IGZ1bmN0aW9uKHZhbHVlcywgbm90U2V0VmFsdWUpIHtcbiAgICBpZiAodHlwZW9mIHZhbHVlcyA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHRoaXMucGFyYW1ldGVyKHZhbHVlcyk7XG4gICAgdmFsdWVzICA9IEFycmF5LmlzQXJyYXkodmFsdWVzKSA/IHZhbHVlcyA6IFt2YWx1ZXNdO1xuICAgIHZhciBzdHIgPSAnJywgaSA9IC0xO1xuICAgIHdoaWxlICgrK2kgPCB2YWx1ZXMubGVuZ3RoKSB7XG4gICAgICBpZiAoaSA+IDApIHN0ciArPSAnLCAnXG4gICAgICBzdHIgKz0gdGhpcy5wYXJhbWV0ZXIodmFsdWVzW2ldID09PSB1bmRlZmluZWQgPyBub3RTZXRWYWx1ZSA6IHZhbHVlc1tpXSlcbiAgICB9XG4gICAgcmV0dXJuIHN0cjtcbiAgfSxcblxuICAvLyBDaGVja3Mgd2hldGhlciBhIHZhbHVlIGlzIGEgZnVuY3Rpb24uLi4gaWYgaXQgaXMsIHdlIGNvbXBpbGUgaXRcbiAgLy8gb3RoZXJ3aXNlIHdlIGNoZWNrIHdoZXRoZXIgaXQncyBhIHJhd1xuICBwYXJhbWV0ZXI6IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgcmV0dXJuIHRoaXMub3V0cHV0UXVlcnkodGhpcy5jb21waWxlQ2FsbGJhY2sodmFsdWUpLCB0cnVlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudW53cmFwUmF3KHZhbHVlLCB0cnVlKSB8fCAnPyc7XG4gIH0sXG5cbiAgdW53cmFwUmF3OiBmdW5jdGlvbih2YWx1ZSwgaXNQYXJhbWV0ZXIpIHtcbiAgICB2YXIgcXVlcnk7XG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUXVlcnlCdWlsZGVyKSB7XG4gICAgICBxdWVyeSA9IHRoaXMuY2xpZW50LnF1ZXJ5Q29tcGlsZXIodmFsdWUpLnRvU1FMKClcbiAgICAgIGlmIChxdWVyeS5iaW5kaW5ncykge1xuICAgICAgICB0aGlzLmJpbmRpbmdzID0gdGhpcy5iaW5kaW5ncy5jb25jYXQocXVlcnkuYmluZGluZ3MpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMub3V0cHV0UXVlcnkocXVlcnksIGlzUGFyYW1ldGVyKTtcbiAgICB9XG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUmF3KSB7XG4gICAgICB2YWx1ZS5jbGllbnQgPSB0aGlzLmNsaWVudDtcbiAgICAgIHF1ZXJ5ID0gdmFsdWUudG9TUUwoKVxuICAgICAgaWYgKHF1ZXJ5LmJpbmRpbmdzKSB7XG4gICAgICAgIHRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmNvbmNhdChxdWVyeS5iaW5kaW5ncyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcXVlcnkuc3FsXG4gICAgfVxuICAgIGlmIChpc1BhcmFtZXRlcikge1xuICAgICAgdGhpcy5iaW5kaW5ncy5wdXNoKHZhbHVlKTtcbiAgICB9XG4gIH0sXG5cbiAgcmF3T3JGbjogZnVuY3Rpb24odmFsdWUsIG1ldGhvZCkge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHJldHVybiB0aGlzLm91dHB1dFF1ZXJ5KHRoaXMuY29tcGlsZUNhbGxiYWNrKHZhbHVlLCBtZXRob2QpKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudW53cmFwUmF3KHZhbHVlKSB8fCAnJztcbiAgfSxcblxuICAvLyBQdXRzIHRoZSBhcHByb3ByaWF0ZSB3cmFwcGVyIGFyb3VuZCBhIHZhbHVlIGRlcGVuZGluZyBvbiB0aGUgZGF0YWJhc2VcbiAgLy8gZW5naW5lLCB1bmxlc3MgaXQncyBhIGtuZXgucmF3IHZhbHVlLCBpbiB3aGljaCBjYXNlIGl0J3MgbGVmdCBhbG9uZS5cbiAgd3JhcDogZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgcmF3O1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHJldHVybiB0aGlzLm91dHB1dFF1ZXJ5KHRoaXMuY29tcGlsZUNhbGxiYWNrKHZhbHVlKSwgdHJ1ZSk7XG4gICAgfVxuICAgIHJhdyA9IHRoaXMudW53cmFwUmF3KHZhbHVlKTtcbiAgICBpZiAocmF3KSByZXR1cm4gcmF3O1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSByZXR1cm4gdmFsdWU7XG4gICAgcmV0dXJuIHRoaXMuX3dyYXBTdHJpbmcodmFsdWUgKyAnJyk7XG4gIH0sXG5cbiAgYWxpYXM6IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQpIHtcbiAgICByZXR1cm4gZmlyc3QgKyAnIGFzICcgKyBzZWNvbmQ7XG4gIH0sXG5cbiAgLy8gVGhlIG9wZXJhdG9yIG1ldGhvZCB0YWtlcyBhIHZhbHVlIGFuZCByZXR1cm5zIHNvbWV0aGluZyBvciBvdGhlci5cbiAgb3BlcmF0b3I6IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIHJhdyA9IHRoaXMudW53cmFwUmF3KHZhbHVlKTtcbiAgICBpZiAocmF3KSByZXR1cm4gcmF3O1xuICAgIGlmIChvcGVyYXRvcnNbKHZhbHVlIHx8ICcnKS50b0xvd2VyQ2FzZSgpXSAhPT0gdHJ1ZSkge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlIG9wZXJhdG9yIFwiJyArIHZhbHVlICsgJ1wiIGlzIG5vdCBwZXJtaXR0ZWQnKTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9LFxuXG4gIC8vIFNwZWNpZnkgdGhlIGRpcmVjdGlvbiBvZiB0aGUgb3JkZXJpbmcuXG4gIGRpcmVjdGlvbjogZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgcmF3ID0gdGhpcy51bndyYXBSYXcodmFsdWUpO1xuICAgIGlmIChyYXcpIHJldHVybiByYXc7XG4gICAgcmV0dXJuIG9yZGVyQnlzLmluZGV4T2YoKHZhbHVlIHx8ICcnKS50b0xvd2VyQ2FzZSgpKSAhPT0gLTEgPyB2YWx1ZSA6ICdhc2MnO1xuICB9LFxuXG4gIC8vIENvbXBpbGVzIGEgY2FsbGJhY2sgdXNpbmcgdGhlIHF1ZXJ5IGJ1aWxkZXIuXG4gIGNvbXBpbGVDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIG1ldGhvZCkge1xuICAgIHZhciBjbGllbnQgPSB0aGlzLmNsaWVudDtcblxuICAgIC8vIEJ1aWxkIHRoZSBjYWxsYmFja1xuICAgIHZhciBidWlsZGVyICA9IGNsaWVudC5xdWVyeUJ1aWxkZXIoKTtcbiAgICBjYWxsYmFjay5jYWxsKGJ1aWxkZXIsIGJ1aWxkZXIpO1xuXG4gICAgLy8gQ29tcGlsZSB0aGUgY2FsbGJhY2ssIHVzaW5nIHRoZSBjdXJyZW50IGZvcm1hdHRlciAodG8gdHJhY2sgYWxsIGJpbmRpbmdzKS5cbiAgICB2YXIgY29tcGlsZXIgPSBjbGllbnQucXVlcnlDb21waWxlcihidWlsZGVyKTtcbiAgICBjb21waWxlci5mb3JtYXR0ZXIgPSB0aGlzO1xuXG4gICAgLy8gUmV0dXJuIHRoZSBjb21waWxlZCAmIHBhcmFtZXRlcml6ZWQgc3FsLlxuICAgIHJldHVybiBjb21waWxlci50b1NRTChtZXRob2QgfHwgJ3NlbGVjdCcpO1xuICB9LFxuXG4gIC8vIEVuc3VyZXMgdGhlIHF1ZXJ5IGlzIGFsaWFzZWQgaWYgbmVjZXNzYXJ5LlxuICBvdXRwdXRRdWVyeTogZnVuY3Rpb24oY29tcGlsZWQsIGlzUGFyYW1ldGVyKSB7XG4gICAgdmFyIHNxbCA9IGNvbXBpbGVkLnNxbCB8fCAnJztcbiAgICBpZiAoc3FsKSB7XG4gICAgICBpZiAoY29tcGlsZWQubWV0aG9kID09PSAnc2VsZWN0JyAmJiAoaXNQYXJhbWV0ZXIgfHwgY29tcGlsZWQuYXMpKSB7XG4gICAgICAgIHNxbCA9ICcoJyArIHNxbCArICcpJztcbiAgICAgICAgaWYgKGNvbXBpbGVkLmFzKSByZXR1cm4gdGhpcy5hbGlhcyhzcWwsIHRoaXMud3JhcChjb21waWxlZC5hcykpXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzcWw7XG4gIH0sXG5cbiAgLy8gQ29lcmNlIHRvIHN0cmluZyB0byBwcmV2ZW50IHN0cmFuZ2UgZXJyb3JzIHdoZW4gaXQncyBub3QgYSBzdHJpbmcuXG4gIF93cmFwU3RyaW5nOiBmdW5jdGlvbih2YWx1ZSkge1xuICAgIHZhciBzZWdtZW50cywgYXNJbmRleCA9IHZhbHVlLnRvTG93ZXJDYXNlKCkuaW5kZXhPZignIGFzICcpO1xuICAgIGlmIChhc0luZGV4ICE9PSAtMSkge1xuICAgICAgdmFyIGZpcnN0ICA9IHZhbHVlLnNsaWNlKDAsIGFzSW5kZXgpXG4gICAgICB2YXIgc2Vjb25kID0gdmFsdWUuc2xpY2UoYXNJbmRleCArIDQpXG4gICAgICByZXR1cm4gdGhpcy5hbGlhcyh0aGlzLndyYXAoZmlyc3QpLCB0aGlzLndyYXAoc2Vjb25kKSlcbiAgICB9XG4gICAgdmFyIGkgPSAtMSwgd3JhcHBlZCA9IFtdO1xuICAgIHNlZ21lbnRzID0gdmFsdWUuc3BsaXQoJy4nKTtcbiAgICB3aGlsZSAoKytpIDwgc2VnbWVudHMubGVuZ3RoKSB7XG4gICAgICB2YWx1ZSA9IHNlZ21lbnRzW2ldO1xuICAgICAgaWYgKGkgPT09IDAgJiYgc2VnbWVudHMubGVuZ3RoID4gMSkge1xuICAgICAgICB3cmFwcGVkLnB1c2godGhpcy53cmFwKCh2YWx1ZSB8fCAnJykudHJpbSgpKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3cmFwcGVkLnB1c2godGhpcy5jbGllbnQud3JhcElkZW50aWZpZXIoKHZhbHVlIHx8ICcnKS50cmltKCkpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHdyYXBwZWQuam9pbignLicpO1xuICB9XG5cbn0pO1xuXG4vLyBWYWxpZCB2YWx1ZXMgZm9yIHRoZSBgb3JkZXIgYnlgIGNsYXVzZSBnZW5lcmF0aW9uLlxudmFyIG9yZGVyQnlzICA9IFsnYXNjJywgJ2Rlc2MnXTtcblxuLy8gVHVybiB0aGlzIGludG8gYSBsb29rdXAgbWFwXG52YXIgb3BlcmF0b3JzID0gdHJhbnNmb3JtKFtcbiAgJz0nLCAnPCcsICc+JywgJzw9JywgJz49JywgJzw+JywgJyE9JywgJ2xpa2UnLCBcbiAgJ25vdCBsaWtlJywgJ2JldHdlZW4nLCAnaWxpa2UnLCAnJicsICd8JywgJ14nLCAnPDwnLCAnPj4nLCBcbiAgJ3JsaWtlJywgJ3JlZ2V4cCcsICdub3QgcmVnZXhwJywgJ34nLCAnfionLCAnIX4nLCAnIX4qJywgXG4gICcjJywgJyYmJywgJ0A+JywgJzxAJywgJ3x8J1xuXSwgZnVuY3Rpb24ob2JqLCBrZXkpIHtcbiAgb2JqW2tleV0gPSB0cnVlXG59LCBPYmplY3QuY3JlYXRlKG51bGwpKVxuXG5tb2R1bGUuZXhwb3J0cyA9IEZvcm1hdHRlcjtcbiJdfQ==