'use strict';

var Transaction = require('../../transaction');
var assign = require('lodash/object/assign');
var inherits = require('inherits');
var debug = require('debug')('knex:tx');
var helpers = require('../../helpers');

function Transaction_MySQL2() {
  Transaction.apply(this, arguments);
}
inherits(Transaction_MySQL2, Transaction);

assign(Transaction_MySQL2.prototype, {

  query: function query(conn, sql, status, value) {
    var t = this;
    var q = this.trxClient.query(conn, sql)['catch'](function (err) {
      return err.code === 'ER_SP_DOES_NOT_EXIST';
    }, function () {
      helpers.warn('Transaction was implicitly committed, do not mix transactions and DDL with MySQL (#805)');
    })['catch'](function (err) {
      status = 2;
      value = err;
      t._completed = true;
      debug('%s error running transaction query', t.txid);
    }).tap(function () {
      if (status === 1) t._resolver(value);
      if (status === 2) t._rejecter(value);
    });
    if (status === 1 || status === 2) {
      t._completed = true;
    }
    return q;
  }

});

module.exports = Transaction_MySQL2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9teXNxbDIvdHJhbnNhY3Rpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtBQUM5QyxJQUFJLE1BQU0sR0FBUSxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNsRCxJQUFJLFFBQVEsR0FBTSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDckMsSUFBSSxLQUFLLEdBQVMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBQzdDLElBQUksT0FBTyxHQUFPLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQTs7QUFFMUMsU0FBUyxrQkFBa0IsR0FBRztBQUM1QixhQUFXLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQTtDQUNuQztBQUNELFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxXQUFXLENBQUMsQ0FBQTs7QUFFekMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsRUFBRTs7QUFFbkMsT0FBSyxFQUFFLGVBQVMsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFO0FBQ3hDLFFBQUksQ0FBQyxHQUFHLElBQUksQ0FBQTtBQUNaLFFBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsU0FDL0IsQ0FBQyxVQUFTLEdBQUcsRUFBRTtBQUNuQixhQUFPLEdBQUcsQ0FBQyxJQUFJLEtBQUssc0JBQXNCLENBQUE7S0FDM0MsRUFBRSxZQUFXO0FBQ1osYUFBTyxDQUFDLElBQUksQ0FBQyx5RkFBeUYsQ0FBQyxDQUFBO0tBQ3hHLENBQUMsU0FDSSxDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ25CLFlBQU0sR0FBRyxDQUFDLENBQUE7QUFDVixXQUFLLEdBQUksR0FBRyxDQUFBO0FBQ1osT0FBQyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUE7QUFDbkIsV0FBSyxDQUFDLG9DQUFvQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtLQUNwRCxDQUFDLENBQ0QsR0FBRyxDQUFDLFlBQVc7QUFDZCxVQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUNwQyxVQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtLQUNyQyxDQUFDLENBQUE7QUFDSixRQUFJLE1BQU0sS0FBSyxDQUFDLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRTtBQUNoQyxPQUFDLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQTtLQUNwQjtBQUNELFdBQU8sQ0FBQyxDQUFDO0dBQ1Y7O0NBRUYsQ0FBQyxDQUFBOztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsa0JBQWtCLENBQUEiLCJmaWxlIjoidHJhbnNhY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbnZhciBUcmFuc2FjdGlvbiA9IHJlcXVpcmUoJy4uLy4uL3RyYW5zYWN0aW9uJylcbnZhciBhc3NpZ24gICAgICA9IHJlcXVpcmUoJ2xvZGFzaC9vYmplY3QvYXNzaWduJyk7XG52YXIgaW5oZXJpdHMgICAgPSByZXF1aXJlKCdpbmhlcml0cycpXG52YXIgZGVidWcgICAgICAgPSByZXF1aXJlKCdkZWJ1ZycpKCdrbmV4OnR4JylcbnZhciBoZWxwZXJzICAgICA9IHJlcXVpcmUoJy4uLy4uL2hlbHBlcnMnKVxuXG5mdW5jdGlvbiBUcmFuc2FjdGlvbl9NeVNRTDIoKSB7XG4gIFRyYW5zYWN0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cylcbn1cbmluaGVyaXRzKFRyYW5zYWN0aW9uX015U1FMMiwgVHJhbnNhY3Rpb24pXG5cbmFzc2lnbihUcmFuc2FjdGlvbl9NeVNRTDIucHJvdG90eXBlLCB7XG5cbiAgcXVlcnk6IGZ1bmN0aW9uKGNvbm4sIHNxbCwgc3RhdHVzLCB2YWx1ZSkge1xuICAgIHZhciB0ID0gdGhpc1xuICAgIHZhciBxID0gdGhpcy50cnhDbGllbnQucXVlcnkoY29ubiwgc3FsKVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICByZXR1cm4gZXJyLmNvZGUgPT09ICdFUl9TUF9ET0VTX05PVF9FWElTVCdcbiAgICAgIH0sIGZ1bmN0aW9uKCkge1xuICAgICAgICBoZWxwZXJzLndhcm4oJ1RyYW5zYWN0aW9uIHdhcyBpbXBsaWNpdGx5IGNvbW1pdHRlZCwgZG8gbm90IG1peCB0cmFuc2FjdGlvbnMgYW5kIERETCB3aXRoIE15U1FMICgjODA1KScpXG4gICAgICB9KVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICBzdGF0dXMgPSAyXG4gICAgICAgIHZhbHVlICA9IGVyclxuICAgICAgICB0Ll9jb21wbGV0ZWQgPSB0cnVlXG4gICAgICAgIGRlYnVnKCclcyBlcnJvciBydW5uaW5nIHRyYW5zYWN0aW9uIHF1ZXJ5JywgdC50eGlkKVxuICAgICAgfSlcbiAgICAgIC50YXAoZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmIChzdGF0dXMgPT09IDEpIHQuX3Jlc29sdmVyKHZhbHVlKVxuICAgICAgICBpZiAoc3RhdHVzID09PSAyKSB0Ll9yZWplY3Rlcih2YWx1ZSlcbiAgICAgIH0pXG4gICAgaWYgKHN0YXR1cyA9PT0gMSB8fCBzdGF0dXMgPT09IDIpIHtcbiAgICAgIHQuX2NvbXBsZXRlZCA9IHRydWVcbiAgICB9XG4gICAgcmV0dXJuIHE7XG4gIH1cblxufSlcblxubW9kdWxlLmV4cG9ydHMgPSBUcmFuc2FjdGlvbl9NeVNRTDJcbiJdfQ==