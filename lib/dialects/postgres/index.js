
// PostgreSQL
// -------
'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var Client = require('../../client');
var Promise = require('../../promise');
var utils = require('./utils');
var assign = require('lodash/object/assign');

var QueryCompiler = require('./query/compiler');
var ColumnCompiler = require('./schema/columncompiler');
var TableCompiler = require('./schema/tablecompiler');
var SchemaCompiler = require('./schema/compiler');
var PGQueryStream;

function Client_PG(config) {
  Client.apply(this, arguments);
  if (config.returning) {
    this.defaultReturning = config.returning;
  }

  if (config.searchPath) {
    this.searchPath = config.searchPath;
  }
}
inherits(Client_PG, Client);

assign(Client_PG.prototype, {

  QueryCompiler: QueryCompiler,

  ColumnCompiler: ColumnCompiler,

  SchemaCompiler: SchemaCompiler,

  SqlString: require('./query/string'),

  TableCompiler: TableCompiler,

  dialect: 'postgresql',

  driverName: 'pg',

  _driver: function _driver() {
    return require('pg');
  },

  wrapIdentifier: function wrapIdentifier(value) {
    if (value === '*') return value;
    var matched = value.match(/(.*?)(\[[0-9]\])/);
    if (matched) return this.wrapIdentifier(matched[1]) + matched[2];
    return '"' + value.replace(/"/g, '""') + '"';
  },

  // Prep the bindings as needed by PostgreSQL.
  prepBindings: function prepBindings(bindings, tz) {
    return _.map(bindings, function (binding) {
      return utils.prepareValue(binding, tz, this.valueForUndefined);
    }, this);
  },

  // Get a raw connection, called by the `pool` whenever a new
  // connection needs to be added to the pool.
  acquireRawConnection: function acquireRawConnection() {
    var client = this;
    return new Promise(function (resolver, rejecter) {
      var connection = new client.driver.Client(client.connectionSettings);
      connection.connect(function (err, connection) {
        if (err) return rejecter(err);
        connection.on('error', client.__endConnection.bind(client, connection));
        connection.on('end', client.__endConnection.bind(client, connection));
        if (!client.version) {
          return client.checkVersion(connection).then(function (version) {
            client.version = version;
            resolver(connection);
          });
        }
        resolver(connection);
      });
    }).tap(function setSearchPath(connection) {
      return client.setSchemaSearchPath(connection);
    });
  },

  // Used to explicitly close a connection, called internally by the pool
  // when a connection times out or the pool is shutdown.
  destroyRawConnection: function destroyRawConnection(connection, cb) {
    connection.end();
    cb();
  },

  // In PostgreSQL, we need to do a version check to do some feature
  // checking on the database.
  checkVersion: function checkVersion(connection) {
    return new Promise(function (resolver, rejecter) {
      connection.query('select version();', function (err, resp) {
        if (err) return rejecter(err);
        resolver(/^PostgreSQL (.*?) /.exec(resp.rows[0].version)[1]);
      });
    });
  },

  // Position the bindings for the query. The escape sequence for question mark
  // is \? (e.g. knex.raw("\\?") since javascript requires '\' to be escaped too...)
  positionBindings: function positionBindings(sql) {
    var questionCount = 0;
    return sql.replace(/(\\*)(\?)/g, function (match, escapes) {
      if (escapes.length % 2) {
        return '?';
      } else {
        questionCount++;
        return '$' + questionCount;
      }
    });
  },

  setSchemaSearchPath: function setSchemaSearchPath(connection, searchPath) {
    var path = searchPath || this.searchPath;

    if (!path) return Promise.resolve(true);

    return new Promise(function (resolver, rejecter) {
      connection.query('set search_path to ' + path, function (err) {
        if (err) return rejecter(err);
        resolver(true);
      });
    });
  },

  _stream: function _stream(connection, obj, stream, options) {
    PGQueryStream = process.browser ? undefined : require('pg-query-stream');
    var sql = obj.sql = this.positionBindings(obj.sql);
    return new Promise(function (resolver, rejecter) {
      var queryStream = connection.query(new PGQueryStream(sql, obj.bindings, options));
      queryStream.on('error', rejecter);
      // 'error' is not propagated by .pipe, but it breaks the pipe
      stream.on('error', rejecter);
      // 'end' IS propagated by .pipe, by default
      stream.on('end', resolver);
      queryStream.pipe(stream);
    });
  },

  // Runs the query on the specified connection, providing the bindings
  // and any other necessary prep work.
  _query: function _query(connection, obj) {
    var sql = obj.sql = this.positionBindings(obj.sql);
    if (obj.options) sql = _.extend({ text: sql }, obj.options);
    return new Promise(function (resolver, rejecter) {
      connection.query(sql, obj.bindings, function (err, response) {
        if (err) return rejecter(err);
        obj.response = response;
        resolver(obj);
      });
    });
  },

  // Ensures the response is returned in the same format as other clients.
  processResponse: function processResponse(obj, runner) {
    var resp = obj.response;
    if (obj.output) return obj.output.call(runner, resp);
    if (obj.method === 'raw') return resp;
    var returning = obj.returning;
    if (resp.command === 'SELECT') {
      if (obj.method === 'first') return resp.rows[0];
      if (obj.method === 'pluck') return _.pluck(resp.rows, obj.pluck);
      return resp.rows;
    }
    if (returning) {
      var returns = [];
      for (var i = 0, l = resp.rows.length; i < l; i++) {
        var row = resp.rows[i];
        if (returning === '*' || Array.isArray(returning)) {
          returns[i] = row;
        } else {
          returns[i] = row[returning];
        }
      }
      return returns;
    }
    if (resp.command === 'UPDATE' || resp.command === 'DELETE') {
      return resp.rowCount;
    }
    return resp;
  },

  __endConnection: function __endConnection(connection) {
    if (!connection || connection.__knex__disposed) return;
    if (this.pool) {
      connection.__knex__disposed = true;
      this.pool.destroy(connection);
    }
  }

});

module.exports = Client_PG;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9wb3N0Z3Jlcy9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUdBLElBQUksQ0FBQyxHQUFnQixPQUFPLENBQUMsUUFBUSxDQUFDLENBQUE7QUFDdEMsSUFBSSxRQUFRLEdBQVMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFBO0FBQ3hDLElBQUksTUFBTSxHQUFXLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQTtBQUM1QyxJQUFJLE9BQU8sR0FBVSxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7QUFDN0MsSUFBSSxLQUFLLEdBQVksT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBQ3ZDLElBQUksTUFBTSxHQUFXLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBOztBQUVwRCxJQUFJLGFBQWEsR0FBSSxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtBQUNoRCxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQTtBQUN2RCxJQUFJLGFBQWEsR0FBSSxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtBQUN0RCxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtBQUNqRCxJQUFJLGFBQWEsQ0FBQzs7QUFFbEIsU0FBUyxTQUFTLENBQUMsTUFBTSxFQUFFO0FBQ3pCLFFBQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFBO0FBQzdCLE1BQUksTUFBTSxDQUFDLFNBQVMsRUFBRTtBQUNwQixRQUFJLENBQUMsZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQztHQUMxQzs7QUFFRCxNQUFJLE1BQU0sQ0FBQyxVQUFVLEVBQUU7QUFDckIsUUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDO0dBQ3JDO0NBQ0Y7QUFDRCxRQUFRLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFBOztBQUUzQixNQUFNLENBQUMs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QUNqQixXQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUNoRCxZQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZCLFlBQUksU0FBUyxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO0FBQ2pELGlCQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO1NBQ2xCLE1BQU07QUFDTCxpQkFBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUM3QjtPQUNGO0FBQ0QsYUFBTyxPQUFPLENBQUM7S0FDaEI7QUFDRCxRQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssUUFBUSxJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssUUFBUSxFQUFFO0FBQzFELGFBQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztLQUN0QjtBQUNELFdBQU8sSUFBSSxDQUFDO0dBQ2I7O0FBRUQsaUJBQWUsRUFBRSx5QkFBUyxVQUFVLEVBQUU7QUFDcEMsUUFBSSxDQUFDLFVBQVUsSUFBSSxVQUFVLENBQUMsZ0JBQWdCLEVBQUUsT0FBTztBQUN2RCxRQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7QUFDYixnQkFBVSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztBQUNuQyxVQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztLQUMvQjtHQUNGOztDQUdGLENBQUMsQ0FBQTs7QUFFRixNQUFNLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLy8gUG9zdGdyZVNRTFxuLy8gLS0tLS0tLVxudmFyIF8gICAgICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJylcbnZhciBpbmhlcml0cyAgICAgICA9IHJlcXVpcmUoJ2luaGVyaXRzJylcbnZhciBDbGllbnQgICAgICAgICA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudCcpXG52YXIgUHJvbWlzZSAgICAgICAgPSByZXF1aXJlKCcuLi8uLi9wcm9taXNlJylcbnZhciB1dGlscyAgICAgICAgICA9IHJlcXVpcmUoJy4vdXRpbHMnKVxudmFyIGFzc2lnbiAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoL29iamVjdC9hc3NpZ24nKVxuXG52YXIgUXVlcnlDb21waWxlciAgPSByZXF1aXJlKCcuL3F1ZXJ5L2NvbXBpbGVyJylcbnZhciBDb2x1bW5Db21waWxlciA9IHJlcXVpcmUoJy4vc2NoZW1hL2NvbHVtbmNvbXBpbGVyJylcbnZhciBUYWJsZUNvbXBpbGVyICA9IHJlcXVpcmUoJy4vc2NoZW1hL3RhYmxlY29tcGlsZXInKVxudmFyIFNjaGVtYUNvbXBpbGVyID0gcmVxdWlyZSgnLi9zY2hlbWEvY29tcGlsZXInKVxudmFyIFBHUXVlcnlTdHJlYW07XG5cbmZ1bmN0aW9uIENsaWVudF9QRyhjb25maWcpIHtcbiAgQ2xpZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cylcbiAgaWYgKGNvbmZpZy5yZXR1cm5pbmcpIHtcbiAgICB0aGlzLmRlZmF1bHRSZXR1cm5pbmcgPSBjb25maWcucmV0dXJuaW5nO1xuICB9XG5cbiAgaWYgKGNvbmZpZy5zZWFyY2hQYXRoKSB7XG4gICAgdGhpcy5zZWFyY2hQYXRoID0gY29uZmlnLnNlYXJjaFBhdGg7XG4gIH1cbn1cbmluaGVyaXRzKENsaWVudF9QRywgQ2xpZW50KVxuXG5hc3NpZ24oQ2xpZW50X1BHLnByb3RvdHlwZSwge1xuXG4gIFF1ZXJ5Q29tcGlsZXI6IFF1ZXJ5Q29tcGlsZXIsXG5cbiAgQ29sdW1uQ29tcGlsZXI6IENvbHVtbkNvbXBpbGVyLFxuXG4gIFNjaGVtYUNvbXBpbGVyOiBTY2hlbWFDb21waWxlcixcblxuICBTcWxTdHJpbmc6IHJlcXVpcmUoJy4vcXVlcnkvc3RyaW5nJyksXG5cbiAgVGFibGVDb21waWxlcjogVGFibGVDb21waWxlcixcblxuICBkaWFsZWN0OiAncG9zdGdyZXNxbCcsXG5cbiAgZHJpdmVyTmFtZTogJ3BnJyxcblxuICBfZHJpdmVyOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gcmVxdWlyZSgncGcnKVxuICB9LFxuXG4gIHdyYXBJZGVudGlmaWVyOiBmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh2YWx1ZSA9PT0gJyonKSByZXR1cm4gdmFsdWU7XG4gICAgdmFyIG1hdGNoZWQgPSB2YWx1ZS5tYXRjaCgvKC4qPykoXFxbWzAtOV1cXF0pLyk7XG4gICAgaWYgKG1hdGNoZWQpIHJldHVybiB0aGlzLndyYXBJZGVudGlmaWVyKG1hdGNoZWRbMV0pICsgbWF0Y2hlZFsyXTtcbiAgICByZXR1cm4gJ1wiJyArIHZhbHVlLnJlcGxhY2UoL1wiL2csICdcIlwiJykgKyAnXCInO1xuICB9LFxuXG4gIC8vIFByZXAgdGhlIGJpbmRpbmdzIGFzIG5lZWRlZCBieSBQb3N0Z3JlU1FMLlxuICBwcmVwQmluZGluZ3M6IGZ1bmN0aW9uKGJpbmRpbmdzLCB0eikge1xuICAgIHJldHVybiBfLm1hcChiaW5kaW5ncywgZnVuY3Rpb24oYmluZGluZykge1xuICAgICAgcmV0dXJuIHV0aWxzLnByZXBhcmVWYWx1ZShiaW5kaW5nLCB0eiwgdGhpcy52YWx1ZUZvclVuZGVmaW5lZClcbiAgICB9LCB0aGlzKTtcbiAgfSxcblxuICAvLyBHZXQgYSByYXcgY29ubmVjdGlvbiwgY2FsbGVkIGJ5IHRoZSBgcG9vbGAgd2hlbmV2ZXIgYSBuZXdcbiAgLy8gY29ubmVjdGlvbiBuZWVkcyB0byBiZSBhZGRlZCB0byB0aGUgcG9vbC5cbiAgYWNxdWlyZVJhd0Nvbm5lY3Rpb246IGZ1bmN0aW9uKCkge1xuICAgIHZhciBjbGllbnQgPSB0aGlzO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHtcbiAgICAgIHZhciBjb25uZWN0aW9uID0gbmV3IGNsaWVudC5kcml2ZXIuQ2xpZW50KGNsaWVudC5jb25uZWN0aW9uU2V0dGluZ3MpO1xuICAgICAgY29ubmVjdGlvbi5jb25uZWN0KGZ1bmN0aW9uKGVyciwgY29ubmVjdGlvbikge1xuICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0ZXIoZXJyKTtcbiAgICAgICAgY29ubmVjdGlvbi5vbignZXJyb3InLCBjbGllbnQuX19lbmRDb25uZWN0aW9uLmJpbmQoY2xpZW50LCBjb25uZWN0aW9uKSk7XG4gICAgICAgIGNvbm5lY3Rpb24ub24oJ2VuZCcsIGNsaWVudC5fX2VuZENvbm5lY3Rpb24uYmluZChjbGllbnQsIGNvbm5lY3Rpb24pKTtcbiAgICAgICAgaWYgKCFjbGllbnQudmVyc2lvbikge1xuICAgICAgICAgIHJldHVybiBjbGllbnQuY2hlY2tWZXJzaW9uKGNvbm5lY3Rpb24pLnRoZW4oZnVuY3Rpb24odmVyc2lvbikge1xuICAgICAgICAgICAgY2xpZW50LnZlcnNpb24gPSB2ZXJzaW9uO1xuICAgICAgICAgICAgcmVzb2x2ZXIoY29ubmVjdGlvbik7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZXIoY29ubmVjdGlvbik7XG4gICAgICB9KTtcbiAgICB9KS50YXAoZnVuY3Rpb24gc2V0U2VhcmNoUGF0aChjb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm4gY2xpZW50LnNldFNjaGVtYVNlYXJjaFBhdGgoY29ubmVjdGlvbik7XG4gICAgfSk7XG4gIH0sXG5cbiAgLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2xcbiAgLy8gd2hlbiBhIGNvbm5lY3Rpb24gdGltZXMgb3V0IG9yIHRoZSBwb29sIGlzIHNodXRkb3duLlxuICBkZXN0cm95UmF3Q29ubmVjdGlvbjogZnVuY3Rpb24oY29ubmVjdGlvbiwgY2IpIHtcbiAgICBjb25uZWN0aW9uLmVuZCgpXG4gICAgY2IoKVxuICB9LFxuXG4gIC8vIEluIFBvc3RncmVTUUwsIHdlIG5lZWQgdG8gZG8gYSB2ZXJzaW9uIGNoZWNrIHRvIGRvIHNvbWUgZmVhdHVyZVxuICAvLyBjaGVja2luZyBvbiB0aGUgZGF0YWJhc2UuXG4gIGNoZWNrVmVyc2lvbjogZnVuY3Rpb24oY29ubmVjdGlvbikge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHtcbiAgICAgIGNvbm5lY3Rpb24ucXVlcnkoJ3NlbGVjdCB2ZXJzaW9uKCk7JywgZnVuY3Rpb24oZXJyLCByZXNwKSB7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3RlcihlcnIpO1xuICAgICAgICByZXNvbHZlcigvXlBvc3RncmVTUUwgKC4qPykgLy5leGVjKHJlc3Aucm93c1swXS52ZXJzaW9uKVsxXSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSxcblxuICAvLyBQb3NpdGlvbiB0aGUgYmluZGluZ3MgZm9yIHRoZSBxdWVyeS4gVGhlIGVzY2FwZSBzZXF1ZW5jZSBmb3IgcXVlc3Rpb24gbWFya1xuICAvLyBpcyBcXD8gKGUuZy4ga25leC5yYXcoXCJcXFxcP1wiKSBzaW5jZSBqYXZhc2NyaXB0IHJlcXVpcmVzICdcXCcgdG8gYmUgZXNjYXBlZCB0b28uLi4pXG4gIHBvc2l0aW9uQmluZGluZ3M6IGZ1bmN0aW9uKHNxbCkge1xuICAgIHZhciBxdWVzdGlvbkNvdW50ID0gMDtcbiAgICByZXR1cm4gc3FsLnJlcGxhY2UoLyhcXFxcKikoXFw/KS9nLCBmdW5jdGlvbiAobWF0Y2gsIGVzY2FwZXMpIHtcbiAgICAgIGlmIChlc2NhcGVzLmxlbmd0aCAlIDIpIHtcbiAgICAgICAgcmV0dXJuICc/JztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHF1ZXN0aW9uQ291bnQrKztcbiAgICAgICAgcmV0dXJuICckJyArIHF1ZXN0aW9uQ291bnQ7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sXG5cbiAgc2V0U2NoZW1hU2VhcmNoUGF0aDogZnVuY3Rpb24oY29ubmVjdGlvbiwgc2VhcmNoUGF0aCkge1xuICAgIHZhciBwYXRoID0gKHNlYXJjaFBhdGggfHwgdGhpcy5zZWFyY2hQYXRoKTtcblxuICAgIGlmICghcGF0aCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHtcbiAgICAgIGNvbm5lY3Rpb24ucXVlcnkoJ3NldCBzZWFyY2hfcGF0aCB0byAnICsgcGF0aCwgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3RlcihlcnIpO1xuICAgICAgICByZXNvbHZlcih0cnVlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9LFxuXG4gIF9zdHJlYW06IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIG9iaiwgc3RyZWFtLCBvcHRpb25zKSB7XG4gICAgUEdRdWVyeVN0cmVhbSA9IHByb2Nlc3MuYnJvd3NlciA/IHVuZGVmaW5lZCA6IHJlcXVpcmUoJ3BnLXF1ZXJ5LXN0cmVhbScpO1xuICAgIHZhciBzcWwgPSBvYmouc3FsID0gdGhpcy5wb3NpdGlvbkJpbmRpbmdzKG9iai5zcWwpXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgICAgdmFyIHF1ZXJ5U3RyZWFtID0gY29ubmVjdGlvbi5xdWVyeShuZXcgUEdRdWVyeVN0cmVhbShzcWwsIG9iai5iaW5kaW5ncywgb3B0aW9ucykpO1xuICAgICAgcXVlcnlTdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0ZXIpO1xuICAgICAgLy8gJ2Vycm9yJyBpcyBub3QgcHJvcGFnYXRlZCBieSAucGlwZSwgYnV0IGl0IGJyZWFrcyB0aGUgcGlwZVxuICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdGVyKTtcbiAgICAgIC8vICdlbmQnIElTIHByb3BhZ2F0ZWQgYnkgLnBpcGUsIGJ5IGRlZmF1bHRcbiAgICAgIHN0cmVhbS5vbignZW5kJywgcmVzb2x2ZXIpO1xuICAgICAgcXVlcnlTdHJlYW0ucGlwZShzdHJlYW0pO1xuICAgIH0pO1xuICB9LFxuXG4gIC8vIFJ1bnMgdGhlIHF1ZXJ5IG9uIHRoZSBzcGVjaWZpZWQgY29ubmVjdGlvbiwgcHJvdmlkaW5nIHRoZSBiaW5kaW5nc1xuICAvLyBhbmQgYW55IG90aGVyIG5lY2Vzc2FyeSBwcmVwIHdvcmsuXG4gIF9xdWVyeTogZnVuY3Rpb24oY29ubmVjdGlvbiwgb2JqKSB7XG4gICAgdmFyIHNxbCA9IG9iai5zcWwgPSB0aGlzLnBvc2l0aW9uQmluZGluZ3Mob2JqLnNxbClcbiAgICBpZiAob2JqLm9wdGlvbnMpIHNxbCA9IF8uZXh0ZW5kKHt0ZXh0OiBzcWx9LCBvYmoub3B0aW9ucyk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgICAgY29ubmVjdGlvbi5xdWVyeShzcWwsIG9iai5iaW5kaW5ncywgZnVuY3Rpb24oZXJyLCByZXNwb25zZSkge1xuICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0ZXIoZXJyKTtcbiAgICAgICAgb2JqLnJlc3BvbnNlID0gcmVzcG9uc2U7XG4gICAgICAgIHJlc29sdmVyKG9iaik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSxcblxuICAvLyBFbnN1cmVzIHRoZSByZXNwb25zZSBpcyByZXR1cm5lZCBpbiB0aGUgc2FtZSBmb3JtYXQgYXMgb3RoZXIgY2xpZW50cy5cbiAgcHJvY2Vzc1Jlc3BvbnNlOiBmdW5jdGlvbihvYmosIHJ1bm5lcikge1xuICAgIHZhciByZXNwID0gb2JqLnJlc3BvbnNlO1xuICAgIGlmIChvYmoub3V0cHV0KSByZXR1cm4gb2JqLm91dHB1dC5jYWxsKHJ1bm5lciwgcmVzcCk7XG4gICAgaWYgKG9iai5tZXRob2QgPT09ICdyYXcnKSByZXR1cm4gcmVzcDtcbiAgICB2YXIgcmV0dXJuaW5nID0gb2JqLnJldHVybmluZztcbiAgICBpZiAocmVzcC5jb21tYW5kID09PSAnU0VMRUNUJykge1xuICAgICAgaWYgKG9iai5tZXRob2QgPT09ICdmaXJzdCcpIHJldHVybiByZXNwLnJvd3NbMF07XG4gICAgICBpZiAob2JqLm1ldGhvZCA9PT0gJ3BsdWNrJykgcmV0dXJuIF8ucGx1Y2socmVzcC5yb3dzLCBvYmoucGx1Y2spO1xuICAgICAgcmV0dXJuIHJlc3Aucm93cztcbiAgICB9XG4gICAgaWYgKHJldHVybmluZykge1xuICAgICAgdmFyIHJldHVybnMgPSBbXTtcbiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gcmVzcC5yb3dzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICB2YXIgcm93ID0gcmVzcC5yb3dzW2ldO1xuICAgICAgICBpZiAocmV0dXJuaW5nID09PSAnKicgfHwgQXJyYXkuaXNBcnJheShyZXR1cm5pbmcpKSB7XG4gICAgICAgICAgcmV0dXJuc1tpXSA9IHJvdztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm5zW2ldID0gcm93W3JldHVybmluZ107XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiByZXR1cm5zO1xuICAgIH1cbiAgICBpZiAocmVzcC5jb21tYW5kID09PSAnVVBEQVRFJyB8fCByZXNwLmNvbW1hbmQgPT09ICdERUxFVEUnKSB7XG4gICAgICByZXR1cm4gcmVzcC5yb3dDb3VudDtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3A7XG4gIH0sXG5cbiAgX19lbmRDb25uZWN0aW9uOiBmdW5jdGlvbihjb25uZWN0aW9uKSB7XG4gICAgaWYgKCFjb25uZWN0aW9uIHx8IGNvbm5lY3Rpb24uX19rbmV4X19kaXNwb3NlZCkgcmV0dXJuO1xuICAgIGlmICh0aGlzLnBvb2wpIHtcbiAgICAgIGNvbm5lY3Rpb24uX19rbmV4X19kaXNwb3NlZCA9IHRydWU7XG4gICAgICB0aGlzLnBvb2wuZGVzdHJveShjb25uZWN0aW9uKTtcbiAgICB9XG4gIH0sXG5cblxufSlcblxubW9kdWxlLmV4cG9ydHMgPSBDbGllbnRfUEdcbiJdfQ==