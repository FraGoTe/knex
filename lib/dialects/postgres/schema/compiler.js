// PostgreSQL Schema Compiler
// -------

'use strict';

var inherits = require('inherits');
var SchemaCompiler = require('../../../schema/compiler');

function SchemaCompiler_PG() {
  SchemaCompiler.apply(this, arguments);
}
inherits(SchemaCompiler_PG, SchemaCompiler);

// Check whether the current table
SchemaCompiler_PG.prototype.hasTable = function (tableName) {
  var sql = 'select * from information_schema.tables where table_name = ?';
  var bindings = [tableName];

  if (this.schema) {
    sql += ' and table_schema = ?';
    bindings.push(this.schema);
  } else {
    sql += ' and table_schema = current_schema';
  }

  this.pushQuery({
    sql: sql,
    bindings: bindings,
    output: function output(resp) {
      return resp.rows.length > 0;
    }
  });
};

// Compile the query to determine if a column exists in a table.
SchemaCompiler_PG.prototype.hasColumn = function (tableName, columnName) {
  var sql = 'select * from information_schema.columns where table_name = ? and column_name = ?';
  var bindings = [tableName, columnName];

  if (this.schema) {
    sql += ' and table_schema = ?';
    bindings.push(this.schema);
  } else {
    sql += ' and table_schema = current_schema';
  }

  this.pushQuery({
    sql: sql,
    bindings: bindings,
    output: function output(resp) {
      return resp.rows.length > 0;
    }
  });
};

SchemaCompiler_PG.prototype.qualifiedTableName = function (tableName) {
  var name = this.schema ? this.schema + '.' + tableName : tableName;
  return this.formatter.wrap(name);
};

// Compile a rename table command.
SchemaCompiler_PG.prototype.renameTable = function (from, to) {
  this.pushQuery('alter table ' + this.qualifiedTableName(from) + ' rename to ' + this.qualifiedTableName(to));
};

SchemaCompiler_PG.prototype.createSchema = function (schemaName) {
  this.pushQuery('create schema ' + this.formatter.wrap(schemaName));
};

SchemaCompiler_PG.prototype.createSchemaIfNotExists = function (schemaName) {
  this.pushQuery('create schema if not exists ' + this.formatter.wrap(schemaName));
};

SchemaCompiler_PG.prototype.dropSchema = function (schemaName) {
  this.pushQuery('drop schema ' + this.formatter.wrap(schemaName));
};

SchemaCompiler_PG.prototype.dropSchemaIfExists = function (schemaName) {
  this.pushQuery('drop schema if exists ' + this.formatter.wrap(schemaName));
};

SchemaCompiler_PG.prototype.dropExtension = function (extensionName) {
  this.pushQuery('drop extension ' + this.formatter.wrap(extensionName));
};

SchemaCompiler_PG.prototype.dropExtensionIfExists = function (extensionName) {
  this.pushQuery('drop extension if exists ' + this.formatter.wrap(extensionName));
};

SchemaCompiler_PG.prototype.createExtension = function (extensionName) {
  this.pushQuery('create extension ' + this.formatter.wrap(extensionName));
};

SchemaCompiler_PG.prototype.createExtensionIfNotExists = function (extensionName) {
  this.pushQuery('create extension if not exists ' + this.formatter.wrap(extensionName));
};

module.exports = SchemaCompiler_PG;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9wb3N0Z3Jlcy9zY2hlbWEvY29tcGlsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFJQSxJQUFJLFFBQVEsR0FBUyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDekMsSUFBSSxjQUFjLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7O0FBRXpELFNBQVMsaUJBQWlCLEdBQUc7QUFDM0IsZ0JBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0NBQ3ZDO0FBQ0QsUUFBUSxDQUFDLGlCQUFpQixFQUFFLGNBQWMsQ0FBQyxDQUFDOzs7QUFHNUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLFFBQVEsR0FBRyxVQUFTLFNBQVMsRUFBRTtBQUN6RCxNQUFJLEdBQUcsR0FBRyw4REFBOEQsQ0FBQztBQUN6RSxNQUFJLFFBQVEsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDOztBQUUzQixNQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7QUFDZixPQUFHLElBQUksdUJBQXVCLENBQUM7QUFDL0IsWUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7R0FDNUIsTUFBTTtBQUNMLE9BQUcsSUFBSSxvQ0FBb0MsQ0FBQztHQUM3Qzs7QUFFRCxNQUFJLENBQUMsU0FBUyxDQUFDO0FBQ2IsT0FBRyxFQUFFLEdBQUc7QUFDUixZQUFRLEVBQUUsUUFBUTtBQUNsQixVQUFNLEVBQUUsZ0JBQVMsSUFBSSxFQUFFO0FBQ3JCLGFBQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0tBQzdCO0dBQ0YsQ0FBQyxDQUFDO0NBQ0osQ0FBQzs7O0FBR0YsaUJBQWlCLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxVQUFTLFNBQVMsRUFBRSxVQUFVLEVBQUU7QUFDdEUsTUFBSSxHQUFHLEdBQUcsbUZBQW1GLENBQUM7QUFDOUYsTUFBSSxRQUFR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SUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7Q0FDMUUsQ0FBQzs7QUFFRixpQkFBaUIsQ0FBQyxTQUFTLENBQUMsMEJBQTBCLEdBQUcsVUFBUyxhQUFhLEVBQUU7QUFDL0UsTUFBSSxDQUFDLFNBQVMsQ0FBQyxpQ0FBaUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0NBQ3hGLENBQUM7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyIsImZpbGUiOiJjb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFBvc3RncmVTUUwgU2NoZW1hIENvbXBpbGVyXG4vLyAtLS0tLS0tXG5cblxudmFyIGluaGVyaXRzICAgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTtcbnZhciBTY2hlbWFDb21waWxlciA9IHJlcXVpcmUoJy4uLy4uLy4uL3NjaGVtYS9jb21waWxlcicpO1xuXG5mdW5jdGlvbiBTY2hlbWFDb21waWxlcl9QRygpIHtcbiAgU2NoZW1hQ29tcGlsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn1cbmluaGVyaXRzKFNjaGVtYUNvbXBpbGVyX1BHLCBTY2hlbWFDb21waWxlcik7XG5cbi8vIENoZWNrIHdoZXRoZXIgdGhlIGN1cnJlbnQgdGFibGVcblNjaGVtYUNvbXBpbGVyX1BHLnByb3RvdHlwZS5oYXNUYWJsZSA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkge1xuICB2YXIgc3FsID0gJ3NlbGVjdCAqIGZyb20gaW5mb3JtYXRpb25fc2NoZW1hLnRhYmxlcyB3aGVyZSB0YWJsZV9uYW1lID0gPyc7XG4gIHZhciBiaW5kaW5ncyA9IFt0YWJsZU5hbWVdO1xuXG4gIGlmICh0aGlzLnNjaGVtYSkge1xuICAgIHNxbCArPSAnIGFuZCB0YWJsZV9zY2hlbWEgPSA/JztcbiAgICBiaW5kaW5ncy5wdXNoKHRoaXMuc2NoZW1hKTtcbiAgfSBlbHNlIHtcbiAgICBzcWwgKz0gJyBhbmQgdGFibGVfc2NoZW1hID0gY3VycmVudF9zY2hlbWEnO1xuICB9XG5cbiAgdGhpcy5wdXNoUXVlcnkoe1xuICAgIHNxbDogc3FsLFxuICAgIGJpbmRpbmdzOiBiaW5kaW5ncyxcbiAgICBvdXRwdXQ6IGZ1bmN0aW9uKHJlc3ApIHtcbiAgICAgIHJldHVybiByZXNwLnJvd3MubGVuZ3RoID4gMDtcbiAgICB9XG4gIH0pO1xufTtcblxuLy8gQ29tcGlsZSB0aGUgcXVlcnkgdG8gZGV0ZXJtaW5lIGlmIGEgY29sdW1uIGV4aXN0cyBpbiBhIHRhYmxlLlxuU2NoZW1hQ29tcGlsZXJfUEcucHJvdG90eXBlLmhhc0NvbHVtbiA9IGZ1bmN0aW9uKHRhYmxlTmFtZSwgY29sdW1uTmFtZSkge1xuICB2YXIgc3FsID0gJ3NlbGVjdCAqIGZyb20gaW5mb3JtYXRpb25fc2NoZW1hLmNvbHVtbnMgd2hlcmUgdGFibGVfbmFtZSA9ID8gYW5kIGNvbHVtbl9uYW1lID0gPyc7XG4gIHZhciBiaW5kaW5ncyA9IFt0YWJsZU5hbWUsIGNvbHVtbk5hbWVdO1xuXG4gIGlmICh0aGlzLnNjaGVtYSkge1xuICAgIHNxbCArPSAnIGFuZCB0YWJsZV9zY2hlbWEgPSA/JztcbiAgICBiaW5kaW5ncy5wdXNoKHRoaXMuc2NoZW1hKTtcbiAgfSBlbHNlIHtcbiAgICBzcWwgKz0gJyBhbmQgdGFibGVfc2NoZW1hID0gY3VycmVudF9zY2hlbWEnO1xuICB9XG5cbiAgdGhpcy5wdXNoUXVlcnkoe1xuICAgIHNxbDogc3FsLFxuICAgIGJpbmRpbmdzOiBiaW5kaW5ncyxcbiAgICBvdXRwdXQ6IGZ1bmN0aW9uKHJlc3ApIHtcbiAgICAgIHJldHVybiByZXNwLnJvd3MubGVuZ3RoID4gMDtcbiAgICB9XG4gIH0pO1xufTtcblxuU2NoZW1hQ29tcGlsZXJfUEcucHJvdG90eXBlLnF1YWxpZmllZFRhYmxlTmFtZSA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkge1xuICB2YXIgbmFtZSA9IHRoaXMuc2NoZW1hID8gYCR7dGhpcy5zY2hlbWF9LiR7dGFibGVOYW1lfWAgOiB0YWJsZU5hbWU7XG4gIHJldHVybiB0aGlzLmZvcm1hdHRlci53cmFwKG5hbWUpO1xufTtcblxuLy8gQ29tcGlsZSBhIHJlbmFtZSB0YWJsZSBjb21tYW5kLlxuU2NoZW1hQ29tcGlsZXJfUEcucHJvdG90eXBlLnJlbmFtZVRhYmxlID0gZnVuY3Rpb24oZnJvbSwgdG8pIHtcbiAgdGhpcy5wdXNoUXVlcnkoJ2FsdGVyIHRhYmxlICcgKyB0aGlzLnF1YWxpZmllZFRhYmxlTmFtZShmcm9tKSArICcgcmVuYW1lIHRvICcgKyB0aGlzLnF1YWxpZmllZFRhYmxlTmFtZSh0bykpO1xufTtcblxuU2NoZW1hQ29tcGlsZXJfUEcucHJvdG90eXBlLmNyZWF0ZVNjaGVtYSA9IGZ1bmN0aW9uKHNjaGVtYU5hbWUpIHtcbiAgdGhpcy5wdXNoUXVlcnkoJ2NyZWF0ZSBzY2hlbWEgJyArIHRoaXMuZm9ybWF0dGVyLndyYXAoc2NoZW1hTmFtZSkpO1xufTtcblxuU2NoZW1hQ29tcGlsZXJfUEcucHJvdG90eXBlLmNyZWF0ZVNjaGVtYUlmTm90RXhpc3RzID0gZnVuY3Rpb24oc2NoZW1hTmFtZSkge1xuICB0aGlzLnB1c2hRdWVyeSgnY3JlYXRlIHNjaGVtYSBpZiBub3QgZXhpc3RzICcgKyB0aGlzLmZvcm1hdHRlci53cmFwKHNjaGVtYU5hbWUpKTtcbn07XG5cblNjaGVtYUNvbXBpbGVyX1BHLnByb3RvdHlwZS5kcm9wU2NoZW1hID0gZnVuY3Rpb24oc2NoZW1hTmFtZSkge1xuICB0aGlzLnB1c2hRdWVyeSgnZHJvcCBzY2hlbWEgJyArIHRoaXMuZm9ybWF0dGVyLndyYXAoc2NoZW1hTmFtZSkpO1xufTtcblxuU2NoZW1hQ29tcGlsZXJfUEcucHJvdG90eXBlLmRyb3BTY2hlbWFJZkV4aXN0cyA9IGZ1bmN0aW9uKHNjaGVtYU5hbWUpIHtcbiAgdGhpcy5wdXNoUXVlcnkoJ2Ryb3Agc2NoZW1hIGlmIGV4aXN0cyAnICsgdGhpcy5mb3JtYXR0ZXIud3JhcChzY2hlbWFOYW1lKSk7XG59O1xuXG5TY2hlbWFDb21waWxlcl9QRy5wcm90b3R5cGUuZHJvcEV4dGVuc2lvbiA9IGZ1bmN0aW9uKGV4dGVuc2lvbk5hbWUpIHtcbiAgdGhpcy5wdXNoUXVlcnkoJ2Ryb3AgZXh0ZW5zaW9uICcgKyB0aGlzLmZvcm1hdHRlci53cmFwKGV4dGVuc2lvbk5hbWUpKTtcbn07XG5cblNjaGVtYUNvbXBpbGVyX1BHLnByb3RvdHlwZS5kcm9wRXh0ZW5zaW9uSWZFeGlzdHMgPSBmdW5jdGlvbihleHRlbnNpb25OYW1lKSB7XG4gIHRoaXMucHVzaFF1ZXJ5KCdkcm9wIGV4dGVuc2lvbiBpZiBleGlzdHMgJyArIHRoaXMuZm9ybWF0dGVyLndyYXAoZXh0ZW5zaW9uTmFtZSkpO1xufTtcblxuU2NoZW1hQ29tcGlsZXJfUEcucHJvdG90eXBlLmNyZWF0ZUV4dGVuc2lvbiA9IGZ1bmN0aW9uKGV4dGVuc2lvbk5hbWUpIHtcbiAgdGhpcy5wdXNoUXVlcnkoJ2NyZWF0ZSBleHRlbnNpb24gJyArIHRoaXMuZm9ybWF0dGVyLndyYXAoZXh0ZW5zaW9uTmFtZSkpO1xufTtcblxuU2NoZW1hQ29tcGlsZXJfUEcucHJvdG90eXBlLmNyZWF0ZUV4dGVuc2lvbklmTm90RXhpc3RzID0gZnVuY3Rpb24oZXh0ZW5zaW9uTmFtZSkge1xuICB0aGlzLnB1c2hRdWVyeSgnY3JlYXRlIGV4dGVuc2lvbiBpZiBub3QgZXhpc3RzICcgKyB0aGlzLmZvcm1hdHRlci53cmFwKGV4dGVuc2lvbk5hbWUpKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gU2NoZW1hQ29tcGlsZXJfUEc7XG4iXX0=