
// MariaSQL Client
// -------
'use strict';

var inherits = require('inherits');
var assign = require('lodash/object/assign');
var Client_MySQL = require('../mysql');
var Promise = require('../../promise');
var SqlString = require('../../query/string');
var helpers = require('../../helpers');
var pluck = require('lodash/collection/pluck');
var Transaction = require('./transaction');

function Client_MariaSQL(config) {
  Client_MySQL.call(this, config);
}
inherits(Client_MariaSQL, Client_MySQL);

assign(Client_MariaSQL.prototype, {

  dialect: 'mariadb',

  driverName: 'mariasql',

  Transaction: Transaction,

  _driver: function _driver() {
    return require('mariasql');
  },

  // Get a raw connection, called by the `pool` whenever a new
  // connection needs to be added to the pool.
  acquireRawConnection: function acquireRawConnection() {
    var connection = new this.driver();
    connection.connect(assign({ metadata: true }, this.connectionSettings));
    return new Promise(function (resolver, rejecter) {
      connection.on('ready', function () {
        connection.removeAllListeners('end');
        connection.removeAllListeners('error');
        resolver(connection);
      }).on('error', rejecter);
    });
  },

  // Used to explicitly close a connection, called internally by the pool
  // when a connection times out or the pool is shutdown.
  destroyRawConnection: function destroyRawConnection(connection, cb) {
    connection.end();
    cb();
  },

  // Return the database for the MariaSQL client.
  database: function database() {
    return this.connectionSettings.db;
  },

  // Grab a connection, run the query via the MariaSQL streaming interface,
  // and pass that through to the stream we've sent back to the client.
  _stream: function _stream(connection, sql, stream) {
    return new Promise(function (resolver, rejecter) {
      connection.query(sql.sql, sql.bindings).on('result', function (res) {
        res.on('error', rejecter).on('end', function () {
          resolver(res.info);
        }).on('data', function (data) {
          stream.write(handleRow(data, res.info.metadata));
        });
      }).on('error', rejecter);
    });
  },

  // Runs the query on the specified connection, providing the bindings
  // and any other necessary prep work.
  _query: function _query(connection, obj) {
    var tz = this.connectionSettings.timezone || 'local';
    return new Promise(function (resolver, rejecter) {
      if (!obj.sql) return resolver();
      var sql = SqlString.format(obj.sql, obj.bindings, tz);
      connection.query(sql, function (err, rows) {
        if (err) {
          return rejecter(err);
        }
        handleRows(rows, rows.info.metadata);
        obj.response = [rows, rows.info];
        resolver(obj);
      });
    });
  },

  // Process the response as returned from the query.
  processResponse: function processResponse(obj, runner) {
    var response = obj.response;
    var method = obj.method;
    var rows = response[0];
    var data = response[1];
    if (obj.output) return obj.output.call(runner, rows /*, fields*/);
    switch (method) {
      case 'select':
      case 'pluck':
      case 'first':
        var resp = helpers.skim(rows);
        if (method === 'pluck') return pluck(resp, obj.pluck);
        return method === 'first' ? resp[0] : resp;
      case 'insert':
        return [data.insertId];
      case 'del':
      case 'update':
      case 'counter':
        return parseInt(data.affectedRows, 10);
      default:
        return response;
    }
  }

});

function parseType(value, type) {
  switch (type) {
    case 'DATETIME':
    case 'TIMESTAMP':
      return new Date(value);
    case 'INTEGER':
      return parseInt(value, 10);
    default:
      return value;
  }
}

function handleRow(row, metadata) {
  var keys = Object.keys(metadata);
  for (var i = 0; i < keys.length; i++) {
    var key = keys[i];
    var type = metadata[key].type;
    row[key] = parseType(row[key], type);
  }
  return row;
}

function handleRows(rows, metadata) {
  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    handleRow(row, metadata);
  }
  return rows;
}

module.exports = Client_MariaSQL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9tYXJpYS9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUdBLElBQUksUUFBUSxHQUFRLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtBQUN2QyxJQUFJLE1BQU0sR0FBVSxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtBQUNuRCxJQUFJLFlBQVksR0FBSSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDdkMsSUFBSSxPQUFPLEdBQVMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0FBQzVDLElBQUksU0FBUyxHQUFPLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO0FBQ2pELElBQUksT0FBTyxHQUFTLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQTtBQUM1QyxJQUFJLEtBQUssR0FBVyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQTtBQUN0RCxJQUFJLFdBQVcsR0FBSyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7O0FBRTVDLFNBQVMsZUFBZSxDQUFDLE1BQU0sRUFBRTtBQUMvQixjQUFZLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQTtDQUNoQztBQUNELFFBQVEsQ0FBQyxlQUFlLEVBQUUsWUFBWSxDQUFDLENBQUE7O0FBRXZDLE1BQU0sQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFOztBQUVoQyxTQUFPLEVBQUUsU0FBUzs7QUFFbEIsWUFBVSxFQUFFLFVBQVU7O0FBRXRCLGFBQVcsRUFBRSxXQUFXOztBQUV4QixTQUFPLEVBQUUsbUJBQVc7QUFDbEIsV0FBTyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7R0FDM0I7Ozs7QUFJRCxzQkFBb0IsRUFBRSxnQ0FBVztBQUMvQixRQUFJLFVBQVUsR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUNuQyxjQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUMs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QUFDO0FBQUEsQUFDN0I7QUFDRSxhQUFPLEtBQUssQ0FBQztBQUFBLEdBQ2hCO0NBQ0Y7O0FBRUQsU0FBUyxTQUFTLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRTtBQUNoQyxNQUFJLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2pDLE9BQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ3BDLFFBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNsQixRQUFJLElBQUksR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQzlCLE9BQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0dBQ3RDO0FBQ0QsU0FBTyxHQUFHLENBQUM7Q0FDWjs7QUFFRCxTQUFTLFVBQVUsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFO0FBQ2xDLE9BQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ3BDLFFBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNsQixhQUFTLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0dBQzFCO0FBQ0QsU0FBTyxJQUFJLENBQUM7Q0FDYjs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLGVBQWUsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLy8gTWFyaWFTUUwgQ2xpZW50XG4vLyAtLS0tLS0tXG52YXIgaW5oZXJpdHMgICAgICA9IHJlcXVpcmUoJ2luaGVyaXRzJylcbnZhciBhc3NpZ24gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoL29iamVjdC9hc3NpZ24nKVxudmFyIENsaWVudF9NeVNRTCAgPSByZXF1aXJlKCcuLi9teXNxbCcpXG52YXIgUHJvbWlzZSAgICAgICA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKVxudmFyIFNxbFN0cmluZyAgICAgPSByZXF1aXJlKCcuLi8uLi9xdWVyeS9zdHJpbmcnKVxudmFyIGhlbHBlcnMgICAgICAgPSByZXF1aXJlKCcuLi8uLi9oZWxwZXJzJylcbnZhciBwbHVjayAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoL2NvbGxlY3Rpb24vcGx1Y2snKVxudmFyIFRyYW5zYWN0aW9uICAgPSByZXF1aXJlKCcuL3RyYW5zYWN0aW9uJylcblxuZnVuY3Rpb24gQ2xpZW50X01hcmlhU1FMKGNvbmZpZykge1xuICBDbGllbnRfTXlTUUwuY2FsbCh0aGlzLCBjb25maWcpXG59XG5pbmhlcml0cyhDbGllbnRfTWFyaWFTUUwsIENsaWVudF9NeVNRTClcblxuYXNzaWduKENsaWVudF9NYXJpYVNRTC5wcm90b3R5cGUsIHtcblxuICBkaWFsZWN0OiAnbWFyaWFkYicsXG5cbiAgZHJpdmVyTmFtZTogJ21hcmlhc3FsJyxcblxuICBUcmFuc2FjdGlvbjogVHJhbnNhY3Rpb24sXG5cbiAgX2RyaXZlcjogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHJlcXVpcmUoJ21hcmlhc3FsJylcbiAgfSxcblxuICAvLyBHZXQgYSByYXcgY29ubmVjdGlvbiwgY2FsbGVkIGJ5IHRoZSBgcG9vbGAgd2hlbmV2ZXIgYSBuZXdcbiAgLy8gY29ubmVjdGlvbiBuZWVkcyB0byBiZSBhZGRlZCB0byB0aGUgcG9vbC5cbiAgYWNxdWlyZVJhd0Nvbm5lY3Rpb246IGZ1bmN0aW9uKCkge1xuICAgIHZhciBjb25uZWN0aW9uID0gbmV3IHRoaXMuZHJpdmVyKCk7XG4gICAgY29ubmVjdGlvbi5jb25uZWN0KGFzc2lnbih7bWV0YWRhdGE6IHRydWV9LCB0aGlzLmNvbm5lY3Rpb25TZXR0aW5ncykpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHtcbiAgICAgIGNvbm5lY3Rpb25cbiAgICAgICAgLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgIGNvbm5lY3Rpb24ucmVtb3ZlQWxsTGlzdGVuZXJzKCdlbmQnKTtcbiAgICAgICAgICBjb25uZWN0aW9uLnJlbW92ZUFsbExpc3RlbmVycygnZXJyb3InKTtcbiAgICAgICAgICByZXNvbHZlcihjb25uZWN0aW9uKTtcbiAgICAgICAgfSlcbiAgICAgICAgLm9uKCdlcnJvcicsIHJlamVjdGVyKTtcbiAgICB9KVxuICB9LFxuXG4gIC8vIFVzZWQgdG8gZXhwbGljaXRseSBjbG9zZSBhIGNvbm5lY3Rpb24sIGNhbGxlZCBpbnRlcm5hbGx5IGJ5IHRoZSBwb29sXG4gIC8vIHdoZW4gYSBjb25uZWN0aW9uIHRpbWVzIG91dCBvciB0aGUgcG9vbCBpcyBzaHV0ZG93bi5cbiAgZGVzdHJveVJhd0Nvbm5lY3Rpb246IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIGNiKSB7XG4gICAgY29ubmVjdGlvbi5lbmQoKVxuICAgIGNiKClcbiAgfSxcblxuICAvLyBSZXR1cm4gdGhlIGRhdGFiYXNlIGZvciB0aGUgTWFyaWFTUUwgY2xpZW50LlxuICBkYXRhYmFzZTogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvblNldHRpbmdzLmRiO1xuICB9LFxuXG4gIC8vIEdyYWIgYSBjb25uZWN0aW9uLCBydW4gdGhlIHF1ZXJ5IHZpYSB0aGUgTWFyaWFTUUwgc3RyZWFtaW5nIGludGVyZmFjZSxcbiAgLy8gYW5kIHBhc3MgdGhhdCB0aHJvdWdoIHRvIHRoZSBzdHJlYW0gd2UndmUgc2VudCBiYWNrIHRvIHRoZSBjbGllbnQuXG4gIF9zdHJlYW06IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIHNxbCwgc3RyZWFtKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgICAgY29ubmVjdGlvbi5xdWVyeShzcWwuc3FsLCBzcWwuYmluZGluZ3MpXG4gICAgICAgIC5vbigncmVzdWx0JywgZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgcmVzXG4gICAgICAgICAgICAub24oJ2Vycm9yJywgcmVqZWN0ZXIpXG4gICAgICAgICAgICAub24oJ2VuZCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICByZXNvbHZlcihyZXMuaW5mbyk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdkYXRhJywgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgc3RyZWFtLndyaXRlKGhhbmRsZVJvdyhkYXRhLCByZXMuaW5mby5tZXRhZGF0YSkpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgICAgLm9uKCdlcnJvcicsIHJlamVjdGVyKTtcbiAgICB9KTtcbiAgfSxcblxuICAvLyBSdW5zIHRoZSBxdWVyeSBvbiB0aGUgc3BlY2lmaWVkIGNvbm5lY3Rpb24sIHByb3ZpZGluZyB0aGUgYmluZGluZ3NcbiAgLy8gYW5kIGFueSBvdGhlciBuZWNlc3NhcnkgcHJlcCB3b3JrLlxuICBfcXVlcnk6IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIG9iaikge1xuICAgIHZhciB0eiAgPSB0aGlzLmNvbm5lY3Rpb25TZXR0aW5ncy50aW1lem9uZSB8fCAnbG9jYWwnO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHtcbiAgICAgIGlmICghb2JqLnNxbCkgcmV0dXJuIHJlc29sdmVyKClcbiAgICAgIHZhciBzcWwgPSBTcWxTdHJpbmcuZm9ybWF0KG9iai5zcWwsIG9iai5iaW5kaW5ncywgdHopO1xuICAgICAgY29ubmVjdGlvbi5xdWVyeShzcWwsIGZ1bmN0aW9uIChlcnIsIHJvd3MpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiByZWplY3RlcihlcnIpO1xuICAgICAgICB9XG4gICAgICAgIGhhbmRsZVJvd3Mocm93cywgcm93cy5pbmZvLm1ldGFkYXRhKTtcbiAgICAgICAgb2JqLnJlc3BvbnNlID0gW3Jvd3MsIHJvd3MuaW5mb107XG4gICAgICAgIHJlc29sdmVyKG9iaik7XG4gICAgICB9KVxuICAgIH0pO1xuICB9LFxuXG4gIC8vIFByb2Nlc3MgdGhlIHJlc3BvbnNlIGFzIHJldHVybmVkIGZyb20gdGhlIHF1ZXJ5LlxuICBwcm9jZXNzUmVzcG9uc2U6IGZ1bmN0aW9uKG9iaiwgcnVubmVyKSB7XG4gICAgdmFyIHJlc3BvbnNlID0gb2JqLnJlc3BvbnNlO1xuICAgIHZhciBtZXRob2QgICA9IG9iai5tZXRob2Q7XG4gICAgdmFyIHJvd3MgICAgID0gcmVzcG9uc2VbMF07XG4gICAgdmFyIGRhdGEgICAgID0gcmVzcG9uc2VbMV07XG4gICAgaWYgKG9iai5vdXRwdXQpIHJldHVybiBvYmoub3V0cHV0LmNhbGwocnVubmVyLCByb3dzLyosIGZpZWxkcyovKTtcbiAgICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgIGNhc2UgJ3BsdWNrJzpcbiAgICAgIGNhc2UgJ2ZpcnN0JzpcbiAgICAgICAgdmFyIHJlc3AgPSBoZWxwZXJzLnNraW0ocm93cyk7XG4gICAgICAgIGlmIChtZXRob2QgPT09ICdwbHVjaycpIHJldHVybiBwbHVjayhyZXNwLCBvYmoucGx1Y2spO1xuICAgICAgICByZXR1cm4gbWV0aG9kID09PSAnZmlyc3QnID8gcmVzcFswXSA6IHJlc3A7XG4gICAgICBjYXNlICdpbnNlcnQnOlxuICAgICAgICByZXR1cm4gW2RhdGEuaW5zZXJ0SWRdO1xuICAgICAgY2FzZSAnZGVsJzpcbiAgICAgIGNhc2UgJ3VwZGF0ZSc6XG4gICAgICBjYXNlICdjb3VudGVyJzpcbiAgICAgICAgcmV0dXJuIHBhcnNlSW50KGRhdGEuYWZmZWN0ZWRSb3dzLCAxMCk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxuICB9XG5cbn0pXG5cbmZ1bmN0aW9uIHBhcnNlVHlwZSh2YWx1ZSwgdHlwZSkge1xuICBzd2l0Y2ggKHR5cGUpIHtcbiAgICBjYXNlICdEQVRFVElNRSc6XG4gICAgY2FzZSAnVElNRVNUQU1QJzpcbiAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7XG4gICAgY2FzZSAnSU5URUdFUic6XG4gICAgICByZXR1cm4gcGFyc2VJbnQodmFsdWUsIDEwKTtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIHZhbHVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIGhhbmRsZVJvdyhyb3csIG1ldGFkYXRhKSB7XG4gIHZhciBrZXlzID0gT2JqZWN0LmtleXMobWV0YWRhdGEpO1xuICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcbiAgICB2YXIga2V5ID0ga2V5c1tpXTtcbiAgICB2YXIgdHlwZSA9IG1ldGFkYXRhW2tleV0udHlwZTtcbiAgICByb3dba2V5XSA9IHBhcnNlVHlwZShyb3dba2V5XSwgdHlwZSk7XG4gIH1cbiAgcmV0dXJuIHJvdztcbn1cblxuZnVuY3Rpb24gaGFuZGxlUm93cyhyb3dzLCBtZXRhZGF0YSkge1xuICBmb3IgKHZhciBpID0gMDsgaSA8IHJvd3MubGVuZ3RoOyBpKyspIHtcbiAgICB2YXIgcm93ID0gcm93c1tpXTtcbiAgICBoYW5kbGVSb3cocm93LCBtZXRhZGF0YSk7XG4gIH1cbiAgcmV0dXJuIHJvd3M7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ2xpZW50X01hcmlhU1FMXG4iXX0=