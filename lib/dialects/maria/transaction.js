'use strict';

var Transaction = require('../../transaction');
var assign = require('lodash/object/assign');
var inherits = require('inherits');
var debug = require('debug')('knex:tx');
var helpers = require('../../helpers');

function Transaction_Maria() {
  Transaction.apply(this, arguments);
}
inherits(Transaction_Maria, Transaction);

assign(Transaction_Maria.prototype, {

  query: function query(conn, sql, status, value) {
    var t = this;
    var q = this.trxClient.query(conn, sql)['catch'](function (err) {
      return err.code === 1305;
    }, function () {
      helpers.warn('Transaction was implicitly committed, do not mix transactions and DDL with MariaDB (#805)');
    })['catch'](function (err) {
      status = 2;
      value = err;
      t._completed = true;
      debug('%s error running transaction query', t.txid);
    }).tap(function () {
      if (status === 1) t._resolver(value);
      if (status === 2) t._rejecter(value);
    });
    if (status === 1 || status === 2) {
      t._completed = true;
    }
    return q;
  }

});

module.exports = Transaction_Maria;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9tYXJpYS90cmFuc2FjdGlvbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO0FBQzlDLElBQUksTUFBTSxHQUFRLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2xELElBQUksUUFBUSxHQUFNLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtBQUNyQyxJQUFJLEtBQUssR0FBUyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUE7QUFDN0MsSUFBSSxPQUFPLEdBQU8sT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBOztBQUUxQyxTQUFTLGlCQUFpQixHQUFHO0FBQzNCLGFBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFBO0NBQ25DO0FBQ0QsUUFBUSxDQUFDLGlCQUFpQixFQUFFLFdBQVcsQ0FBQyxDQUFBOztBQUV4QyxNQUFNLENBQUMsaUJBQWlCLENBQUMsU0FBUyxFQUFFOztBQUVsQyxPQUFLLEVBQUUsZUFBUyxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7QUFDeEMsUUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFBO0FBQ1osUUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxTQUMvQixDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ25CLGFBQU8sR0FBRyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUE7S0FDekIsRUFBRSxZQUFXO0FBQ1osYUFBTyxDQUFDLElBQUksQ0FBQywyRkFBMkYsQ0FBQyxDQUFBO0tBQzFHLENBQUMsU0FDSSxDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ25CLFlBQU0sR0FBRyxDQUFDLENBQUE7QUFDVixXQUFLLEdBQUksR0FBRyxDQUFBO0FBQ1osT0FBQyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUE7QUFDbkIsV0FBSyxDQUFDLG9DQUFvQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtLQUNwRCxDQUFDLENBQ0QsR0FBRyxDQUFDLFlBQVc7QUFDZCxVQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUNwQyxVQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtLQUNyQyxDQUFDLENBQUE7QUFDSixRQUFJLE1BQU0sS0FBSyxDQUFDLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRTtBQUNoQyxPQUFDLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQTtLQUNwQjtBQUNELFdBQU8sQ0FBQyxDQUFDO0dBQ1Y7O0NBRUYsQ0FBQyxDQUFBOztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUEiLCJmaWxlIjoidHJhbnNhY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbnZhciBUcmFuc2FjdGlvbiA9IHJlcXVpcmUoJy4uLy4uL3RyYW5zYWN0aW9uJylcbnZhciBhc3NpZ24gICAgICA9IHJlcXVpcmUoJ2xvZGFzaC9vYmplY3QvYXNzaWduJyk7XG52YXIgaW5oZXJpdHMgICAgPSByZXF1aXJlKCdpbmhlcml0cycpXG52YXIgZGVidWcgICAgICAgPSByZXF1aXJlKCdkZWJ1ZycpKCdrbmV4OnR4JylcbnZhciBoZWxwZXJzICAgICA9IHJlcXVpcmUoJy4uLy4uL2hlbHBlcnMnKVxuXG5mdW5jdGlvbiBUcmFuc2FjdGlvbl9NYXJpYSgpIHtcbiAgVHJhbnNhY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKVxufVxuaW5oZXJpdHMoVHJhbnNhY3Rpb25fTWFyaWEsIFRyYW5zYWN0aW9uKVxuXG5hc3NpZ24oVHJhbnNhY3Rpb25fTWFyaWEucHJvdG90eXBlLCB7XG5cbiAgcXVlcnk6IGZ1bmN0aW9uKGNvbm4sIHNxbCwgc3RhdHVzLCB2YWx1ZSkge1xuICAgIHZhciB0ID0gdGhpc1xuICAgIHZhciBxID0gdGhpcy50cnhDbGllbnQucXVlcnkoY29ubiwgc3FsKVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICByZXR1cm4gZXJyLmNvZGUgPT09IDEzMDVcbiAgICAgIH0sIGZ1bmN0aW9uKCkge1xuICAgICAgICBoZWxwZXJzLndhcm4oJ1RyYW5zYWN0aW9uIHdhcyBpbXBsaWNpdGx5IGNvbW1pdHRlZCwgZG8gbm90IG1peCB0cmFuc2FjdGlvbnMgYW5kIERETCB3aXRoIE1hcmlhREIgKCM4MDUpJylcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIHN0YXR1cyA9IDJcbiAgICAgICAgdmFsdWUgID0gZXJyXG4gICAgICAgIHQuX2NvbXBsZXRlZCA9IHRydWVcbiAgICAgICAgZGVidWcoJyVzIGVycm9yIHJ1bm5pbmcgdHJhbnNhY3Rpb24gcXVlcnknLCB0LnR4aWQpXG4gICAgICB9KVxuICAgICAgLnRhcChmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKHN0YXR1cyA9PT0gMSkgdC5fcmVzb2x2ZXIodmFsdWUpXG4gICAgICAgIGlmIChzdGF0dXMgPT09IDIpIHQuX3JlamVjdGVyKHZhbHVlKVxuICAgICAgfSlcbiAgICBpZiAoc3RhdHVzID09PSAxIHx8IHN0YXR1cyA9PT0gMikge1xuICAgICAgdC5fY29tcGxldGVkID0gdHJ1ZVxuICAgIH1cbiAgICByZXR1cm4gcTtcbiAgfVxuXG59KVxuXG5tb2R1bGUuZXhwb3J0cyA9IFRyYW5zYWN0aW9uX01hcmlhIl19