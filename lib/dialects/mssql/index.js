
// MSSQL Client
// -------
'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var assign = require('lodash/object/assign');

var Formatter = require('./formatter');
var Client = require('../../client');
var Promise = require('../../promise');
var helpers = require('../../helpers');

var Transaction = require('./transaction');
var QueryCompiler = require('./query/compiler');
var SchemaCompiler = require('./schema/compiler');
var TableCompiler = require('./schema/tablecompiler');
var ColumnCompiler = require('./schema/columncompiler');

// Always initialize with the "QueryBuilder" and "QueryCompiler"
// objects, which extend the base 'lib/query/builder' and
// 'lib/query/compiler', respectively.
function Client_MSSQL(config) {
  Client.call(this, config);
}
inherits(Client_MSSQL, Client);

assign(Client_MSSQL.prototype, {

  dialect: 'mssql',

  driverName: 'mssql',

  _driver: function _driver() {
    return require('mssql');
  },

  Transaction: Transaction,

  Formatter: Formatter,

  QueryCompiler: QueryCompiler,

  SchemaCompiler: SchemaCompiler,

  TableCompiler: TableCompiler,

  ColumnCompiler: ColumnCompiler,

  wrapIdentifier: function wrapIdentifier(value) {
    return value !== '*' ? '[' + value.replace(/\[/g, '\[') + ']' : '*';
  },

  // Get a raw connection, called by the `pool` whenever a new
  // connection needs to be added to the pool.
  acquireRawConnection: function acquireRawConnection() {
    var client = this;
    var connection = new this.driver.Connection(this.connectionSettings);
    return new Promise(function (resolver, rejecter) {
      connection.connect(function (err) {
        if (err) return rejecter(err);
        connection.on('error', connectionErrorHandler.bind(null, client, connection));
        connection.on('end', connectionErrorHandler.bind(null, client, connection));
        resolver(connection);
      });
    });
  },

  // Used to explicitly close a connection, called internally by the pool
  // when a connection times out or the pool is shutdown.
  destroyRawConnection: function destroyRawConnection(connection, cb) {
    connection.close(cb);
  },

  // Position the bindings for the query.
  positionBindings: function positionBindings(sql) {
    var questionCount = -1;
    return sql.replace(/\?/g, function () {
      questionCount += 1;
      return '@p' + questionCount;
    });
  },

  prepBindings: function prepBindings(bindings) {
    return _.map(bindings, function (value) {
      if (value === undefined) {
        return this.valueForUndefined;
      }
      return value;
    }, this);
  },

  // Grab a connection, run the query via the MSSQL streaming interface,
  // and pass that through to the stream we've sent back to the client.
  _stream: function _stream(connection, obj, stream, options) {
    options = options || {};
    if (!obj || typeof obj === 'string') obj = { sql: obj };
    // convert ? params into positional bindings (@p1)
    obj.sql = this.positionBindings(obj.sql);
    obj.bindings = this.prepBindings(obj.bindings) || [];
    return new Promise(function (resolver, rejecter) {
      stream.on('error', rejecter);
      stream.on('end', resolver);
      var sql = obj.sql;
      if (!sql) return resolver();
      if (obj.options) sql = assign({ sql: sql }, obj.options).sql;
      var req = (connection.tx_ || connection).request();
      //req.verbose = true;
      req.multiple = true;
      req.stream = true;
      if (obj.bindings) {
        for (var i = 0; i < obj.bindings.length; i++) {
          req.input('p' + i, obj.bindings[i]);
        }
      }
      req.pipe(stream);
      req.query(sql);
    });
  },

  // Runs the query on the specified connection, providing the bindings
  // and any other necessary prep work.
  _query: function _query(connection, obj) {
    if (!obj || typeof obj === 'string') obj = { sql: obj };
    // convert ? params into positional bindings (@p1)
    obj.sql = this.positionBindings(obj.sql);
    obj.bindings = this.prepBindings(obj.bindings) || [];
    return new Promise(function (resolver, rejecter) {
      var sql = obj.sql;
      if (!sql) return resolver();
      if (obj.options) sql = assign({ sql: sql }, obj.options).sql;
      var req = (connection.tx_ || connection).request();
      // req.verbose = true;
      req.multiple = true;
      if (obj.bindings) {
        for (var i = 0; i < obj.bindings.length; i++) {
          req.input('p' + i, obj.bindings[i]);
        }
      }
      req.query(sql, function (err, recordset) {
        if (err) return rejecter(err);
        obj.response = recordset[0];
        resolver(obj);
      });
    });
  },

  // Process the response as returned from the query.
  processResponse: function processResponse(obj, runner) {
    if (obj == null) return;
    var response = obj.response;
    var method = obj.method;
    if (obj.output) return obj.output.call(runner, response);
    switch (method) {
      case 'select':
      case 'pluck':
      case 'first':
        response = helpers.skim(response);
        if (method === 'pluck') return _.pluck(response, obj.pluck);
        return method === 'first' ? response[0] : response;
      case 'insert':
      case 'del':
      case 'update':
      case 'counter':
        if (obj.returning) {
          if (obj.returning === '@@rowcount') {
            return response[0][''];
          }
          if (Array.isArray(obj.returning) && obj.returning.length > 1 || obj.returning[0] === '*') {
            return response;
          }
          // return an array with values if only one returning value was specified
          return _.flatten(_.map(response, _.values));
        }
        return response;
      default:
        return response;
    }
  }

});

// MSSQL Specific error handler
function connectionErrorHandler(client, connection, err) {
  if (connection && err && err.fatal) {
    if (connection.__knex__disposed) return;
    connection.__knex__disposed = true;
    client.pool.destroy(connection);
  }
}

module.exports = Client_MSSQL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9tc3NxbC9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUdBLElBQUksQ0FBQyxHQUFnQixPQUFPLENBQUMsUUFBUSxDQUFDLENBQUE7QUFDdEMsSUFBSSxRQUFRLEdBQVMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFBO0FBQ3hDLElBQUksTUFBTSxHQUFXLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBOztBQUVwRCxJQUFJLFNBQVMsR0FBUSxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUE7QUFDM0MsSUFBSSxNQUFNLEdBQVcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBQzVDLElBQUksT0FBTyxHQUFVLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQTtBQUM3QyxJQUFJLE9BQU8sR0FBVSxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7O0FBRTdDLElBQUksV0FBVyxHQUFNLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQTtBQUM3QyxJQUFJLGFBQWEsR0FBSSxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtBQUNoRCxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtBQUNqRCxJQUFJLGFBQWEsR0FBSSxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtBQUN0RCxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQTs7Ozs7QUFLdkQsU0FBUyxZQUFZLENBQUMsTUFBTSxFQUFFO0FBQzVCLFFBQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0NBQzNCO0FBQ0QsUUFBUSxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQzs7QUFFL0IsTUFBTSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUU7O0FBRTdCLFNBQU8sRUFBRSxPQUFPOztBQUVoQixZQUFVLEVBQUUsT0FBTzs7QUFFbkIsU0FBTyxFQUFFLG1CQUFXO0FBQ2xCLFdB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QUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtBQUMxRixtQkFBTyxRQUFRLENBQUM7V0FDakI7O0FBRUQsaUJBQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztTQUM3QztBQUNELGVBQU8sUUFBUSxDQUFDO0FBQUEsQUFDbEI7QUFDRSxlQUFPLFFBQVEsQ0FBQTtBQUFBLEtBQ2xCO0dBQ0Y7O0NBRUYsQ0FBQyxDQUFBOzs7QUFHRixTQUFTLHNCQUFzQixDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFO0FBQ3ZELE1BQUksVUFBVSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFO0FBQ2xDLFFBQUksVUFBVSxDQUFDLGdCQUFnQixFQUFFLE9BQU87QUFDeEMsY0FBVSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztBQUNuQyxVQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztHQUNqQztDQUNGOztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBNU1NRTCBDbGllbnRcbi8vIC0tLS0tLS1cbnZhciBfICAgICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpXG52YXIgaW5oZXJpdHMgICAgICAgPSByZXF1aXJlKCdpbmhlcml0cycpXG52YXIgYXNzaWduICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gvb2JqZWN0L2Fzc2lnbicpXG5cbnZhciBGb3JtYXR0ZXIgICAgICA9IHJlcXVpcmUoJy4vZm9ybWF0dGVyJylcbnZhciBDbGllbnQgICAgICAgICA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudCcpXG52YXIgUHJvbWlzZSAgICAgICAgPSByZXF1aXJlKCcuLi8uLi9wcm9taXNlJylcbnZhciBoZWxwZXJzICAgICAgICA9IHJlcXVpcmUoJy4uLy4uL2hlbHBlcnMnKVxuXG52YXIgVHJhbnNhY3Rpb24gICAgPSByZXF1aXJlKCcuL3RyYW5zYWN0aW9uJylcbnZhciBRdWVyeUNvbXBpbGVyICA9IHJlcXVpcmUoJy4vcXVlcnkvY29tcGlsZXInKVxudmFyIFNjaGVtYUNvbXBpbGVyID0gcmVxdWlyZSgnLi9zY2hlbWEvY29tcGlsZXInKVxudmFyIFRhYmxlQ29tcGlsZXIgID0gcmVxdWlyZSgnLi9zY2hlbWEvdGFibGVjb21waWxlcicpXG52YXIgQ29sdW1uQ29tcGlsZXIgPSByZXF1aXJlKCcuL3NjaGVtYS9jb2x1bW5jb21waWxlcicpXG5cbi8vIEFsd2F5cyBpbml0aWFsaXplIHdpdGggdGhlIFwiUXVlcnlCdWlsZGVyXCIgYW5kIFwiUXVlcnlDb21waWxlclwiXG4vLyBvYmplY3RzLCB3aGljaCBleHRlbmQgdGhlIGJhc2UgJ2xpYi9xdWVyeS9idWlsZGVyJyBhbmRcbi8vICdsaWIvcXVlcnkvY29tcGlsZXInLCByZXNwZWN0aXZlbHkuXG5mdW5jdGlvbiBDbGllbnRfTVNTUUwoY29uZmlnKSB7XG4gIENsaWVudC5jYWxsKHRoaXMsIGNvbmZpZyk7XG59XG5pbmhlcml0cyhDbGllbnRfTVNTUUwsIENsaWVudCk7XG5cbmFzc2lnbihDbGllbnRfTVNTUUwucHJvdG90eXBlLCB7XG5cbiAgZGlhbGVjdDogJ21zc3FsJyxcblxuICBkcml2ZXJOYW1lOiAnbXNzcWwnLFxuXG4gIF9kcml2ZXI6IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiByZXF1aXJlKCdtc3NxbCcpO1xuICB9LFxuXG4gIFRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbixcblxuICBGb3JtYXR0ZXI6IEZvcm1hdHRlcixcblxuICBRdWVyeUNvbXBpbGVyOiBRdWVyeUNvbXBpbGVyLFxuICBcbiAgU2NoZW1hQ29tcGlsZXI6IFNjaGVtYUNvbXBpbGVyLFxuXG4gIFRhYmxlQ29tcGlsZXI6IFRhYmxlQ29tcGlsZXIsXG5cbiAgQ29sdW1uQ29tcGlsZXI6IENvbHVtbkNvbXBpbGVyLFxuXG4gIHdyYXBJZGVudGlmaWVyOiBmdW5jdGlvbih2YWx1ZSkge1xuICAgIHJldHVybiAodmFsdWUgIT09ICcqJyA/ICdbJyArIHZhbHVlLnJlcGxhY2UoL1xcWy9nLCAnXFxbJykgKyAnXScgOiAnKicpXG4gIH0sXG5cbiAgLy8gR2V0IGEgcmF3IGNvbm5lY3Rpb24sIGNhbGxlZCBieSB0aGUgYHBvb2xgIHdoZW5ldmVyIGEgbmV3XG4gIC8vIGNvbm5lY3Rpb24gbmVlZHMgdG8gYmUgYWRkZWQgdG8gdGhlIHBvb2wuXG4gIGFjcXVpcmVSYXdDb25uZWN0aW9uOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgY2xpZW50ID0gdGhpcztcbiAgICB2YXIgY29ubmVjdGlvbiA9IG5ldyB0aGlzLmRyaXZlci5Db25uZWN0aW9uKHRoaXMuY29ubmVjdGlvblNldHRpbmdzKTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZXIsIHJlamVjdGVyKSB7XG4gICAgICBjb25uZWN0aW9uLmNvbm5lY3QoZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3RlcihlcnIpO1xuICAgICAgICBjb25uZWN0aW9uLm9uKCdlcnJvcicsIGNvbm5lY3Rpb25FcnJvckhhbmRsZXIuYmluZChudWxsLCBjbGllbnQsIGNvbm5lY3Rpb24pKTtcbiAgICAgICAgY29ubmVjdGlvbi5vbignZW5kJywgY29ubmVjdGlvbkVycm9ySGFuZGxlci5iaW5kKG51bGwsIGNsaWVudCwgY29ubmVjdGlvbikpO1xuICAgICAgICByZXNvbHZlcihjb25uZWN0aW9uKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9LFxuXG4gIC8vIFVzZWQgdG8gZXhwbGljaXRseSBjbG9zZSBhIGNvbm5lY3Rpb24sIGNhbGxlZCBpbnRlcm5hbGx5IGJ5IHRoZSBwb29sXG4gIC8vIHdoZW4gYSBjb25uZWN0aW9uIHRpbWVzIG91dCBvciB0aGUgcG9vbCBpcyBzaHV0ZG93bi5cbiAgZGVzdHJveVJhd0Nvbm5lY3Rpb246IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIGNiKSB7XG4gICAgY29ubmVjdGlvbi5jbG9zZShjYik7XG4gIH0sXG5cbiAgLy8gUG9zaXRpb24gdGhlIGJpbmRpbmdzIGZvciB0aGUgcXVlcnkuXG4gIHBvc2l0aW9uQmluZGluZ3M6IGZ1bmN0aW9uKHNxbCkge1xuICAgIHZhciBxdWVzdGlvbkNvdW50ID0gLTFcbiAgICByZXR1cm4gc3FsLnJlcGxhY2UoL1xcPy9nLCBmdW5jdGlvbigpIHtcbiAgICAgIHF1ZXN0aW9uQ291bnQgKz0gMVxuICAgICAgcmV0dXJuICdAcCcgKyBxdWVzdGlvbkNvdW50XG4gICAgfSlcbiAgfSxcblxuICBwcmVwQmluZGluZ3M6IGZ1bmN0aW9uKGJpbmRpbmdzKSB7XG4gICAgcmV0dXJuIF8ubWFwKGJpbmRpbmdzLCBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVGb3JVbmRlZmluZWRcbiAgICAgIH1cbiAgICAgIHJldHVybiB2YWx1ZVxuICAgIH0sIHRoaXMpXG4gIH0sXG5cbiAgLy8gR3JhYiBhIGNvbm5lY3Rpb24sIHJ1biB0aGUgcXVlcnkgdmlhIHRoZSBNU1NRTCBzdHJlYW1pbmcgaW50ZXJmYWNlLFxuICAvLyBhbmQgcGFzcyB0aGF0IHRocm91Z2ggdG8gdGhlIHN0cmVhbSB3ZSd2ZSBzZW50IGJhY2sgdG8gdGhlIGNsaWVudC5cbiAgX3N0cmVhbTogZnVuY3Rpb24oY29ubmVjdGlvbiwgb2JqLCBzdHJlYW0sIG9wdGlvbnMpIHtcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fVxuICAgIGlmICghb2JqIHx8IHR5cGVvZiBvYmogPT09ICdzdHJpbmcnKSBvYmogPSB7c3FsOiBvYmp9XG4gICAgLy8gY29udmVydCA/IHBhcmFtcyBpbnRvIHBvc2l0aW9uYWwgYmluZGluZ3MgKEBwMSlcbiAgICBvYmouc3FsID0gdGhpcy5wb3NpdGlvbkJpbmRpbmdzKG9iai5zcWwpO1xuICAgIG9iai5iaW5kaW5ncyA9IHRoaXMucHJlcEJpbmRpbmdzKG9iai5iaW5kaW5ncykgfHwgW107XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdGVyKTtcbiAgICAgIHN0cmVhbS5vbignZW5kJywgcmVzb2x2ZXIpO1xuICAgICAgdmFyIHNxbCA9IG9iai5zcWxcbiAgICAgIGlmICghc3FsKSByZXR1cm4gcmVzb2x2ZXIoKVxuICAgICAgaWYgKG9iai5vcHRpb25zKSBzcWwgPSBhc3NpZ24oe3NxbDogc3FsfSwgb2JqLm9wdGlvbnMpLnNxbFxuICAgICAgdmFyIHJlcSA9IChjb25uZWN0aW9uLnR4XyB8fCBjb25uZWN0aW9uKS5yZXF1ZXN0KCk7XG4gICAgICAvL3JlcS52ZXJib3NlID0gdHJ1ZTtcbiAgICAgIHJlcS5tdWx0aXBsZSA9IHRydWU7XG4gICAgICByZXEuc3RyZWFtID0gdHJ1ZTtcbiAgICAgIGlmIChvYmouYmluZGluZ3MpIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouYmluZGluZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICByZXEuaW5wdXQoJ3AnK2ksIG9iai5iaW5kaW5nc1tpXSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmVxLnBpcGUoc3RyZWFtKVxuICAgICAgcmVxLnF1ZXJ5KHNxbClcbiAgICB9KVxuICB9LFxuXG4gIC8vIFJ1bnMgdGhlIHF1ZXJ5IG9uIHRoZSBzcGVjaWZpZWQgY29ubmVjdGlvbiwgcHJvdmlkaW5nIHRoZSBiaW5kaW5nc1xuICAvLyBhbmQgYW55IG90aGVyIG5lY2Vzc2FyeSBwcmVwIHdvcmsuXG4gIF9xdWVyeTogZnVuY3Rpb24oY29ubmVjdGlvbiwgb2JqKSB7XG4gICAgaWYgKCFvYmogfHwgdHlwZW9mIG9iaiA9PT0gJ3N0cmluZycpIG9iaiA9IHtzcWw6IG9ian1cbiAgICAvLyBjb252ZXJ0ID8gcGFyYW1zIGludG8gcG9zaXRpb25hbCBiaW5kaW5ncyAoQHAxKVxuICAgIG9iai5zcWwgPSB0aGlzLnBvc2l0aW9uQmluZGluZ3Mob2JqLnNxbCk7XG4gICAgb2JqLmJpbmRpbmdzID0gdGhpcy5wcmVwQmluZGluZ3Mob2JqLmJpbmRpbmdzKSB8fCBbXTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZXIsIHJlamVjdGVyKSB7XG4gICAgICB2YXIgc3FsID0gb2JqLnNxbFxuICAgICAgaWYgKCFzcWwpIHJldHVybiByZXNvbHZlcigpXG4gICAgICBpZiAob2JqLm9wdGlvbnMpIHNxbCA9IGFzc2lnbih7c3FsOiBzcWx9LCBvYmoub3B0aW9ucykuc3FsXG4gICAgICB2YXIgcmVxID0gKGNvbm5lY3Rpb24udHhfIHx8IGNvbm5lY3Rpb24pLnJlcXVlc3QoKTtcbiAgICAgIC8vIHJlcS52ZXJib3NlID0gdHJ1ZTtcbiAgICAgIHJlcS5tdWx0aXBsZSA9IHRydWU7XG4gICAgICBpZiAob2JqLmJpbmRpbmdzKSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgcmVxLmlucHV0KCdwJytpLCBvYmouYmluZGluZ3NbaV0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJlcS5xdWVyeShzcWwsIGZ1bmN0aW9uKGVyciwgcmVjb3Jkc2V0KSB7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3RlcihlcnIpXG4gICAgICAgIG9iai5yZXNwb25zZSA9IHJlY29yZHNldFswXVxuICAgICAgICByZXNvbHZlcihvYmopXG4gICAgICB9KVxuICAgIH0pXG4gIH0sXG5cbiAgLy8gUHJvY2VzcyB0aGUgcmVzcG9uc2UgYXMgcmV0dXJuZWQgZnJvbSB0aGUgcXVlcnkuXG4gIHByb2Nlc3NSZXNwb25zZTogZnVuY3Rpb24ob2JqLCBydW5uZXIpIHtcbiAgICBpZiAob2JqID09IG51bGwpIHJldHVybjtcbiAgICB2YXIgcmVzcG9uc2UgPSBvYmoucmVzcG9uc2VcbiAgICB2YXIgbWV0aG9kICAgPSBvYmoubWV0aG9kXG4gICAgaWYgKG9iai5vdXRwdXQpIHJldHVybiBvYmoub3V0cHV0LmNhbGwocnVubmVyLCByZXNwb25zZSlcbiAgICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgIGNhc2UgJ3BsdWNrJzpcbiAgICAgIGNhc2UgJ2ZpcnN0JzpcbiAgICAgICAgcmVzcG9uc2UgPSBoZWxwZXJzLnNraW0ocmVzcG9uc2UpXG4gICAgICAgIGlmIChtZXRob2QgPT09ICdwbHVjaycpIHJldHVybiBfLnBsdWNrKHJlc3BvbnNlLCBvYmoucGx1Y2spXG4gICAgICAgIHJldHVybiBtZXRob2QgPT09ICdmaXJzdCcgPyByZXNwb25zZVswXSA6IHJlc3BvbnNlXG4gICAgICBjYXNlICdpbnNlcnQnOlxuICAgICAgY2FzZSAnZGVsJzpcbiAgICAgIGNhc2UgJ3VwZGF0ZSc6XG4gICAgICBjYXNlICdjb3VudGVyJzpcbiAgICAgICAgaWYgKG9iai5yZXR1cm5pbmcpIHtcbiAgICAgICAgICBpZiAob2JqLnJldHVybmluZyA9PT0gJ0BAcm93Y291bnQnKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VbMF1bJyddXG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICgoQXJyYXkuaXNBcnJheShvYmoucmV0dXJuaW5nKSAmJiBvYmoucmV0dXJuaW5nLmxlbmd0aCA+IDEpIHx8IG9iai5yZXR1cm5pbmdbMF0gPT09ICcqJykge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyByZXR1cm4gYW4gYXJyYXkgd2l0aCB2YWx1ZXMgaWYgb25seSBvbmUgcmV0dXJuaW5nIHZhbHVlIHdhcyBzcGVjaWZpZWRcbiAgICAgICAgICByZXR1cm4gXy5mbGF0dGVuKF8ubWFwKHJlc3BvbnNlLCBfLnZhbHVlcykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiByZXNwb25zZVxuICAgIH1cbiAgfVxuXG59KVxuXG4vLyBNU1NRTCBTcGVjaWZpYyBlcnJvciBoYW5kbGVyXG5mdW5jdGlvbiBjb25uZWN0aW9uRXJyb3JIYW5kbGVyKGNsaWVudCwgY29ubmVjdGlvbiwgZXJyKSB7XG4gIGlmIChjb25uZWN0aW9uICYmIGVyciAmJiBlcnIuZmF0YWwpIHtcbiAgICBpZiAoY29ubmVjdGlvbi5fX2tuZXhfX2Rpc3Bvc2VkKSByZXR1cm47XG4gICAgY29ubmVjdGlvbi5fX2tuZXhfX2Rpc3Bvc2VkID0gdHJ1ZTtcbiAgICBjbGllbnQucG9vbC5kZXN0cm95KGNvbm5lY3Rpb24pO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ2xpZW50X01TU1FMXG4iXX0=