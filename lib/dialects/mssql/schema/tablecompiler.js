
// MSSQL Table Builder & Compiler
// -------
'use strict';

var inherits = require('inherits');
var TableCompiler = require('../../../schema/tablecompiler');
var helpers = require('../../../helpers');
var Promise = require('../../../promise');
var assign = require('lodash/object/assign');

// Table Compiler
// ------

function TableCompiler_MSSQL() {
  TableCompiler.apply(this, arguments);
}
inherits(TableCompiler_MSSQL, TableCompiler);

assign(TableCompiler_MSSQL.prototype, {

  createAlterTableMethods: ['foreign', 'primary', 'unique'],
  createQuery: function createQuery(columns, ifNot) {
    var createStatement = ifNot ? 'if object_id(\'' + this.tableName() + '\', \'U\') is not null CREATE TABLE ' : 'CREATE TABLE ';
    var sql = createStatement + this.tableName() + (this._formatting ? ' (\n    ' : ' (') + columns.sql.join(this._formatting ? ',\n    ' : ', ') + ')';

    if (this.single.comment) {
      var comment = this.single.comment || '';
      if (comment.length > 60) helpers.warn('The max length for a table comment is 60 characters');
    }

    this.pushQuery(sql);
  },

  lowerCase: false,

  addColumnsPrefix: 'ADD ',

  dropColumnPrefix: 'DROP COLUMN ',

  // Compiles the comment on the table.
  comment: function comment() {},

  changeType: function changeType() {},

  // Renames a column on the table.
  renameColumn: function renameColumn(from, to) {
    this.pushQuery('exec sp_rename ' + this.formatter.parameter(this.tableName() + '.' + from) + ', ' + this.formatter.parameter(to) + ', \'COLUMN\'');
  },

  dropFKRefs: function dropFKRefs(runner, refs) {
    var formatter = this.client.formatter();
    return Promise.all(refs.map(function (ref) {
      var constraintName = formatter.wrap(ref.CONSTRAINT_NAME);
      var tableName = formatter.wrap(ref.TABLE_NAME);
      return runner.query({
        sql: 'ALTER TABLE ' + tableName + ' DROP CONSTRAINT ' + constraintName
      });
    }));
  },
  createFKRefs: function createFKRefs(runner, refs) {
    var formatter = this.client.formatter();

    return Promise.all(refs.map(function (ref) {
      var tableName = formatter.wrap(ref.TABLE_NAME);
      var keyName = formatter.wrap(ref.CONSTRAINT_NAME);
      var column = formatter.columnize(ref.COLUMN_NAME);
      var references = formatter.columnize(ref.REFERENCED_COLUMN_NAME);
      var inTable = formatter.wrap(ref.REFERENCED_TABLE_NAME);
      var onUpdate = ' ON UPDATE ' + ref.UPDATE_RULE;
      var onDelete = ' ON DELETE ' + ref.DELETE_RULE;

      return runner.query({
        sql: 'ALTER TABLE ' + tableName + ' ADD CONSTRAINT ' + keyName + ' FOREIGN KEY (' + column + ') REFERENCES ' + inTable + ' (' + references + ')' + onUpdate + onDelete
      });
    }));
  },

  index: function index(columns, indexName) {
    indexName = indexName || this._indexCommand('index', this.tableNameRaw, columns);
    this.pushQuery('CREATE INDEX ' + indexName + ' ON ' + this.tableName() + ' (' + this.formatter.columnize(columns) + ')');
  },

  primary: function primary(columns, indexName) {
    indexName = indexName || this._indexCommand('primary', this.tableNameRaw, columns);
    if (!this.forCreate) {
      this.pushQuery('ALTER TABLE ' + this.tableName() + ' ADD PRIMARY KEY (' + this.formatter.columnize(columns) + ')');
    } else {
      this.pushQuery('CONSTRAINT ' + indexName + ' PRIMARY KEY (' + this.formatter.columnize(columns) + ')');
    }
  },

  unique: function unique(columns, indexName) {
    indexName = indexName || this._indexCommand('unique', this.tableNameRaw, columns);
    if (!this.forCreate) {
      this.pushQuery('CREATE UNIQUE INDEX ' + indexName + ' ON ' + this.tableName() + ' (' + this.formatter.columnize(columns) + ')');
    } else {
      this.pushQuery('CONSTRAINT ' + indexName + ' UNIQUE (' + this.formatter.columnize(columns) + ')');
    }
  },

  // Compile a drop index command.
  dropIndex: function dropIndex(columns, indexName) {
    indexName = indexName || this._indexCommand('index', this.tableNameRaw, columns);
    this.pushQuery('DROP INDEX ' + indexName + ' ON ' + this.tableName());
  },

  // Compile a drop foreign key command.
  dropForeign: function dropForeign(columns, indexName) {
    indexName = indexName || this._indexCommand('foreign', this.tableNameRaw, columns);
    this.pushQuery('ALTER TABLE ' + this.tableName() + ' DROP CONSTRAINT ' + indexName);
  },

  // Compile a drop primary key command.
  dropPrimary: function dropPrimary() {
    this.pushQuery('ALTER TABLE ' + this.tableName() + ' DROP PRIMARY KEY');
  },

  // Compile a drop unique key command.
  dropUnique: function dropUnique(column, indexName) {
    indexName = indexName || this._indexCommand('unique', this.tableNameRaw, column);
    this.pushQuery('ALTER TABLE ' + this.tableName() + ' DROP CONSTRAINT ' + indexName);
  }

});

module.exports = TableCompiler_MSSQL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9tc3NxbC9zY2hlbWEvdGFibGVjb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUdBLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNuQyxJQUFJLGFBQWEsR0FBRyxPQUFPLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUM3RCxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUMxQyxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUMxQyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQzs7Ozs7QUFLN0MsU0FBUyxtQkFBbUIsR0FBRztBQUM3QixlQUFhLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztDQUN0QztBQUNELFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxhQUFhLENBQUMsQ0FBQzs7QUFFN0MsTUFBTSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsRUFBRTs7QUFFcEMseUJBQXVCLEVBQUUsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQztBQUN6RCxhQUFXLEVBQUUscUJBQVUsT0FBTyxFQUFFLEtBQUssRUFBRTtBQUNyQyxRQUFJLGVBQWUsR0FBRyxLQUFLLEdBQUcsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLHNDQUFzQyxHQUFHLGVBQWUsQ0FBQztBQUM5SCxRQUFJLEdBQUcsR0FBRyxlQUFlLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxHQUFHLElBQUksQ0FBQSxBQUFDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDOztBQUVwSixRQUFJ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QkFBVSxNQUFNLEVBQUUsU0FBUyxFQUFFO0FBQ3ZDLGFBQVMsR0FBRyxTQUFTLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQztBQUNqRixRQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsbUJBQW1CLEdBQUcsU0FBUyxDQUFDLENBQUM7R0FDckY7O0NBRUYsQ0FBQyxDQUFBOztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsbUJBQW1CLENBQUMiLCJmaWxlIjoidGFibGVjb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLy8gTVNTUUwgVGFibGUgQnVpbGRlciAmIENvbXBpbGVyXG4vLyAtLS0tLS0tXG52YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpO1xudmFyIFRhYmxlQ29tcGlsZXIgPSByZXF1aXJlKCcuLi8uLi8uLi9zY2hlbWEvdGFibGVjb21waWxlcicpO1xudmFyIGhlbHBlcnMgPSByZXF1aXJlKCcuLi8uLi8uLi9oZWxwZXJzJyk7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4uLy4uLy4uL3Byb21pc2UnKTtcbnZhciBhc3NpZ24gPSByZXF1aXJlKCdsb2Rhc2gvb2JqZWN0L2Fzc2lnbicpO1xuXG4vLyBUYWJsZSBDb21waWxlclxuLy8gLS0tLS0tXG5cbmZ1bmN0aW9uIFRhYmxlQ29tcGlsZXJfTVNTUUwoKSB7XG4gIFRhYmxlQ29tcGlsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn1cbmluaGVyaXRzKFRhYmxlQ29tcGlsZXJfTVNTUUwsIFRhYmxlQ29tcGlsZXIpO1xuXG5hc3NpZ24oVGFibGVDb21waWxlcl9NU1NRTC5wcm90b3R5cGUsIHtcblxuICBjcmVhdGVBbHRlclRhYmxlTWV0aG9kczogWydmb3JlaWduJywgJ3ByaW1hcnknLCAndW5pcXVlJ10sXG4gIGNyZWF0ZVF1ZXJ5OiBmdW5jdGlvbiAoY29sdW1ucywgaWZOb3QpIHtcbiAgICB2YXIgY3JlYXRlU3RhdGVtZW50ID0gaWZOb3QgPyAnaWYgb2JqZWN0X2lkKFxcJycgKyB0aGlzLnRhYmxlTmFtZSgpICsgJ1xcJywgXFwnVVxcJykgaXMgbm90IG51bGwgQ1JFQVRFIFRBQkxFICcgOiAnQ1JFQVRFIFRBQkxFICc7XG4gICAgdmFyIHNxbCA9IGNyZWF0ZVN0YXRlbWVudCArIHRoaXMudGFibGVOYW1lKCkgKyAodGhpcy5fZm9ybWF0dGluZyA/ICcgKFxcbiAgICAnIDogJyAoJykgKyBjb2x1bW5zLnNxbC5qb2luKHRoaXMuX2Zvcm1hdHRpbmcgPyAnLFxcbiAgICAnIDogJywgJykgKyAnKSc7XG5cbiAgICBpZiAodGhpcy5zaW5nbGUuY29tbWVudCkge1xuICAgICAgdmFyIGNvbW1lbnQgPSAodGhpcy5zaW5nbGUuY29tbWVudCB8fCAnJyk7XG4gICAgICBpZiAoY29tbWVudC5sZW5ndGggPiA2MCkgaGVscGVycy53YXJuKCdUaGUgbWF4IGxlbmd0aCBmb3IgYSB0YWJsZSBjb21tZW50IGlzIDYwIGNoYXJhY3RlcnMnKTtcbiAgICB9XG5cbiAgICB0aGlzLnB1c2hRdWVyeShzcWwpO1xuICB9LFxuXG4gIGxvd2VyQ2FzZTogZmFsc2UsXG5cbiAgYWRkQ29sdW1uc1ByZWZpeDogJ0FERCAnLFxuXG4gIGRyb3BDb2x1bW5QcmVmaXg6ICdEUk9QIENPTFVNTiAnLFxuXG4gIC8vIENvbXBpbGVzIHRoZSBjb21tZW50IG9uIHRoZSB0YWJsZS5cbiAgY29tbWVudDogZnVuY3Rpb24gKCkge1xuICB9LFxuXG4gIGNoYW5nZVR5cGU6IGZ1bmN0aW9uICgpIHtcbiAgfSxcblxuICAvLyBSZW5hbWVzIGEgY29sdW1uIG9uIHRoZSB0YWJsZS5cbiAgcmVuYW1lQ29sdW1uOiBmdW5jdGlvbiAoZnJvbSwgdG8pIHtcbiAgICB0aGlzLnB1c2hRdWVyeSgnZXhlYyBzcF9yZW5hbWUgJyArIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnRhYmxlTmFtZSgpICsgJy4nICsgZnJvbSkgKyAnLCAnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKHRvKSArICcsIFxcJ0NPTFVNTlxcJycpO1xuICB9LFxuXG4gIGRyb3BGS1JlZnM6IGZ1bmN0aW9uIChydW5uZXIsIHJlZnMpIHtcbiAgICB2YXIgZm9ybWF0dGVyID0gdGhpcy5jbGllbnQuZm9ybWF0dGVyKCk7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHJlZnMubWFwKGZ1bmN0aW9uIChyZWYpIHtcbiAgICAgIHZhciBjb25zdHJhaW50TmFtZSA9IGZvcm1hdHRlci53cmFwKHJlZi5DT05TVFJBSU5UX05BTUUpO1xuICAgICAgdmFyIHRhYmxlTmFtZSA9IGZvcm1hdHRlci53cmFwKHJlZi5UQUJMRV9OQU1FKTtcbiAgICAgIHJldHVybiBydW5uZXIucXVlcnkoe1xuICAgICAgICBzcWw6ICdBTFRFUiBUQUJMRSAnICsgdGFibGVOYW1lICsgJyBEUk9QIENPTlNUUkFJTlQgJyArIGNvbnN0cmFpbnROYW1lXG4gICAgICB9KTtcbiAgICB9KSk7XG4gIH0sXG4gIGNyZWF0ZUZLUmVmczogZnVuY3Rpb24gKHJ1bm5lciwgcmVmcykge1xuICAgIHZhciBmb3JtYXR0ZXIgPSB0aGlzLmNsaWVudC5mb3JtYXR0ZXIoKTtcblxuICAgIHJldHVybiBQcm9taXNlLmFsbChyZWZzLm1hcChmdW5jdGlvbiAocmVmKSB7XG4gICAgICB2YXIgdGFibGVOYW1lID0gZm9ybWF0dGVyLndyYXAocmVmLlRBQkxFX05BTUUpO1xuICAgICAgdmFyIGtleU5hbWUgPSBmb3JtYXR0ZXIud3JhcChyZWYuQ09OU1RSQUlOVF9OQU1FKTtcbiAgICAgIHZhciBjb2x1bW4gPSBmb3JtYXR0ZXIuY29sdW1uaXplKHJlZi5DT0xVTU5fTkFNRSk7XG4gICAgICB2YXIgcmVmZXJlbmNlcyA9IGZvcm1hdHRlci5jb2x1bW5pemUocmVmLlJFRkVSRU5DRURfQ09MVU1OX05BTUUpO1xuICAgICAgdmFyIGluVGFibGUgPSBmb3JtYXR0ZXIud3JhcChyZWYuUkVGRVJFTkNFRF9UQUJMRV9OQU1FKTtcbiAgICAgIHZhciBvblVwZGF0ZSA9ICcgT04gVVBEQVRFICcgKyByZWYuVVBEQVRFX1JVTEU7XG4gICAgICB2YXIgb25EZWxldGUgPSAnIE9OIERFTEVURSAnICsgcmVmLkRFTEVURV9SVUxFO1xuXG4gICAgICByZXR1cm4gcnVubmVyLnF1ZXJ5KHtcbiAgICAgICAgc3FsOiAnQUxURVIgVEFCTEUgJyArIHRhYmxlTmFtZSArICcgQUREIENPTlNUUkFJTlQgJyArIGtleU5hbWUgK1xuICAgICAgICAnIEZPUkVJR04gS0VZICgnICsgY29sdW1uICsgJykgUkVGRVJFTkNFUyAnICsgaW5UYWJsZSArICcgKCcgKyByZWZlcmVuY2VzICsgJyknICsgb25VcGRhdGUgKyBvbkRlbGV0ZVxuICAgICAgfSk7XG4gICAgfSkpO1xuICB9LFxuXG4gIGluZGV4OiBmdW5jdGlvbiAoY29sdW1ucywgaW5kZXhOYW1lKSB7XG4gICAgaW5kZXhOYW1lID0gaW5kZXhOYW1lIHx8IHRoaXMuX2luZGV4Q29tbWFuZCgnaW5kZXgnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gICAgdGhpcy5wdXNoUXVlcnkoJ0NSRUFURSBJTkRFWCAnICsgaW5kZXhOYW1lICsgJyBPTiAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgKCcgKyB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucykgKyAnKScpO1xuICB9LFxuXG4gIHByaW1hcnk6IGZ1bmN0aW9uIChjb2x1bW5zLCBpbmRleE5hbWUpIHtcbiAgICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCdwcmltYXJ5JywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpO1xuICAgIGlmICghdGhpcy5mb3JDcmVhdGUpIHtcbiAgICAgIHRoaXMucHVzaFF1ZXJ5KCdBTFRFUiBUQUJMRSAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgQUREIFBSSU1BUlkgS0VZICgnICsgdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGNvbHVtbnMpICsgJyknKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wdXNoUXVlcnkoJ0NPTlNUUkFJTlQgJyArIGluZGV4TmFtZSArICcgUFJJTUFSWSBLRVkgKCcgKyB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucykgKyAnKScpO1xuICAgIH1cbiAgfSxcblxuICB1bmlxdWU6IGZ1bmN0aW9uIChjb2x1bW5zLCBpbmRleE5hbWUpIHtcbiAgICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCd1bmlxdWUnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gICAgaWYgKCF0aGlzLmZvckNyZWF0ZSkge1xuICAgICAgdGhpcy5wdXNoUXVlcnkoJ0NSRUFURSBVTklRVUUgSU5ERVggJyArIGluZGV4TmFtZSArICcgT04gJyArIHRoaXMudGFibGVOYW1lKCkgKyAnICgnICsgdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGNvbHVtbnMpICsgJyknKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wdXNoUXVlcnkoJ0NPTlNUUkFJTlQgJyArIGluZGV4TmFtZSArICcgVU5JUVVFICgnICsgdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGNvbHVtbnMpICsgJyknKTtcbiAgICB9XG4gIH0sXG5cbiAgLy8gQ29tcGlsZSBhIGRyb3AgaW5kZXggY29tbWFuZC5cbiAgZHJvcEluZGV4OiBmdW5jdGlvbiAoY29sdW1ucywgaW5kZXhOYW1lKSB7XG4gICAgaW5kZXhOYW1lID0gaW5kZXhOYW1lIHx8IHRoaXMuX2luZGV4Q29tbWFuZCgnaW5kZXgnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gICAgdGhpcy5wdXNoUXVlcnkoJ0RST1AgSU5ERVggJyArIGluZGV4TmFtZSArICcgT04gJyArIHRoaXMudGFibGVOYW1lKCkpO1xuICB9LFxuXG4gIC8vIENvbXBpbGUgYSBkcm9wIGZvcmVpZ24ga2V5IGNvbW1hbmQuXG4gIGRyb3BGb3JlaWduOiBmdW5jdGlvbiAoY29sdW1ucywgaW5kZXhOYW1lKSB7XG4gICAgaW5kZXhOYW1lID0gaW5kZXhOYW1lIHx8IHRoaXMuX2luZGV4Q29tbWFuZCgnZm9yZWlnbicsIHRoaXMudGFibGVOYW1lUmF3LCBjb2x1bW5zKTtcbiAgICB0aGlzLnB1c2hRdWVyeSgnQUxURVIgVEFCTEUgJyArIHRoaXMudGFibGVOYW1lKCkgKyAnIERST1AgQ09OU1RSQUlOVCAnICsgaW5kZXhOYW1lKTtcbiAgfSxcblxuICAvLyBDb21waWxlIGEgZHJvcCBwcmltYXJ5IGtleSBjb21tYW5kLlxuICBkcm9wUHJpbWFyeTogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMucHVzaFF1ZXJ5KCdBTFRFUiBUQUJMRSAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgRFJPUCBQUklNQVJZIEtFWScpO1xuICB9LFxuXG4gIC8vIENvbXBpbGUgYSBkcm9wIHVuaXF1ZSBrZXkgY29tbWFuZC5cbiAgZHJvcFVuaXF1ZTogZnVuY3Rpb24gKGNvbHVtbiwgaW5kZXhOYW1lKSB7XG4gICAgaW5kZXhOYW1lID0gaW5kZXhOYW1lIHx8IHRoaXMuX2luZGV4Q29tbWFuZCgndW5pcXVlJywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbik7XG4gICAgdGhpcy5wdXNoUXVlcnkoJ0FMVEVSIFRBQkxFICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyBEUk9QIENPTlNUUkFJTlQgJyArIGluZGV4TmFtZSk7XG4gIH1cblxufSlcblxubW9kdWxlLmV4cG9ydHMgPSBUYWJsZUNvbXBpbGVyX01TU1FMO1xuIl19