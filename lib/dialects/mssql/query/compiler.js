
// MSSQL Query Compiler
// ------
'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var QueryCompiler = require('../../../query/compiler');
var assign = require('lodash/object/assign');

function QueryCompiler_MSSQL(client, builder) {
  QueryCompiler.call(this, client, builder);
}
inherits(QueryCompiler_MSSQL, QueryCompiler);

assign(QueryCompiler_MSSQL.prototype, {

  _emptyInsertValue: 'default values',

  // Compiles an "insert" query, allowing for multiple
  // inserts using a single query statement.
  insert: function insert() {
    var insertValues = this.single.insert || [];
    var sql = 'insert into ' + this.tableName + ' ';
    var returning = this.single.returning;
    var returningSql = returning ? this._returning('insert', returning) + ' ' : '';

    if (Array.isArray(insertValues)) {
      if (insertValues.length === 0) {
        return '';
      }
    } else if (typeof insertValues === 'object' && _.isEmpty(insertValues)) {
      return {
        sql: sql + returningSql + this._emptyInsertValue,
        returning: returning
      };
    }

    var insertData = this._prepInsert(insertValues);
    if (typeof insertData === 'string') {
      sql += insertData;
    } else {
      if (insertData.columns.length) {
        sql += '(' + this.formatter.columnize(insertData.columns);
        sql += ') ' + returningSql + 'values (';
        var i = -1;
        while (++i < insertData.values.length) {
          if (i !== 0) sql += '), (';
          sql += this.formatter.parameterize(insertData.values[i]);
        }
        sql += ')';
      } else if (insertValues.length === 1 && insertValues[0]) {
        sql += returningSql + this._emptyInsertValue;
      } else {
        sql = '';
      }
    }
    return {
      sql: sql,
      returning: returning
    };
  },

  // Compiles an `update` query, allowing for a return value.
  update: function update() {
    var updates = this._prepUpdate(this.single.update);
    var join = this.join();
    var where = this.where();
    var order = this.order();
    var top = this.top();
    var returning = this.single.returning;
    return {
      sql: 'update ' + (top ? top + ' ' : '') + this.tableName + (join ? ' ' + join : '') + ' set ' + updates.join(', ') + (returning ? ' ' + this._returning('update', returning) : '') + (where ? ' ' + where : '') + (order ? ' ' + order : '') + (!returning ? this._returning('rowcount', '@@rowcount') : ''),
      returning: returning || '@@rowcount'
    };
  },

  // Compiles a `delete` query.
  del: function del() {
    // Make sure tableName is processed by the formatter first.
    var tableName = this.tableName;
    var wheres = this.where();
    var returning = this.single.returning;
    return {
      sql: 'delete from ' + tableName + (returning ? ' ' + this._returning('del', returning) : '') + (wheres ? ' ' + wheres : '') + (!returning ? this._returning('rowcount', '@@rowcount') : ''),
      returning: returning || '@@rowcount'
    };
  },

  // Compiles the columns in the query, specifying if an item was distinct.
  columns: function columns() {
    var distinct = false;
    if (this.onlyUnions()) return '';
    var columns = this.grouped.columns || [];
    var i = -1,
        sql = [];
    if (columns) {
      while (++i < columns.length) {
        var stmt = columns[i];
        if (stmt.distinct) distinct = true;
        if (stmt.type === 'aggregate') {
          sql.push(this.aggregate(stmt));
        } else if (stmt.value && stmt.value.length > 0) {
          sql.push(this.formatter.columnize(stmt.value));
        }
      }
    }
    if (sql.length === 0) sql = ['*'];
    var top = this.top();
    return 'select ' + (distinct ? 'distinct ' : '') + (top ? top + ' ' : '') + sql.join(', ') + (this.tableName ? ' from ' + this.tableName : '');
  },

  _returning: function _returning(method, value) {
    switch (method) {
      case 'update':
      case 'insert':
        return value ? 'output ' + this.formatter.columnizeWithPrefix('inserted.', value) : '';
      case 'del':
        return value ? 'output ' + this.formatter.columnizeWithPrefix('deleted.', value) : '';
      case 'rowcount':
        return value ? ';select @@rowcount' : '';
    }
  },

  // Compiles a `truncate` query.
  truncate: function truncate() {
    return 'truncate table ' + this.tableName;
  },

  forUpdate: function forUpdate() {
    return 'with (READCOMMITTEDLOCK)';
  },

  forShare: function forShare() {
    return 'with (NOLOCK)';
  },

  // Compiles a `columnInfo` query.
  columnInfo: function columnInfo() {
    var column = this.single.columnInfo;
    return {
      sql: 'select * from information_schema.columns where table_name = ? and table_schema = \'dbo\'',
      bindings: [this.single.table],
      output: function output(resp) {
        var out = resp.reduce(function (columns, val) {
          columns[val.COLUMN_NAME] = {
            defaultValue: val.COLUMN_DEFAULT,
            type: val.DATA_TYPE,
            maxLength: val.CHARACTER_MAXIMUM_LENGTH,
            nullable: val.IS_NULLABLE === 'YES'
          };
          return columns;
        }, {});
        return column && out[column] || out;
      }
    };
  },

  top: function top() {
    var noLimit = !this.single.limit && this.single.limit !== 0;
    var noOffset = !this.single.offset;
    if (noLimit || !noOffset) return '';
    return 'top (' + this.formatter.parameter(this.single.limit) + ')';
  },

  limit: function limit() {
    return '';
  },

  offset: function offset() {
    var noLimit = !this.single.limit && this.single.limit !== 0;
    var noOffset = !this.single.offset;
    if (noOffset) return '';
    var offset = 'offset ' + (noOffset ? '0' : this.formatter.parameter(this.single.offset)) + ' rows';
    if (!noLimit) {
      offset += ' fetch next ' + this.formatter.parameter(this.single.limit) + ' rows only';
    }
    return offset;
  }

});

// Set the QueryBuilder & QueryCompiler on the client object,
// incase anyone wants to modify things to suit their own purposes.
module.exports = QueryCompiler_MSSQL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9tc3NxbC9xdWVyeS9jb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUdBLElBQUksQ0FBQyxHQUFlLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN0QyxJQUFJLFFBQVEsR0FBUSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDdkMsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLHlCQUF5QixDQUFDLENBQUE7QUFDdEQsSUFBSSxNQUFNLEdBQVUsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7O0FBRXBELFNBQVMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRTtBQUM1QyxlQUFhLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUE7Q0FDMUM7QUFDRCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsYUFBYSxDQUFDLENBQUE7O0FBRTVDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUU7O0FBRXBDLG1CQUFpQixFQUFFLGdCQUFnQjs7OztBQUluQyxRQUFNLEVBQUUsa0JBQVc7QUFDakIsUUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO0FBQzVDLFFBQUksR0FBRyxHQUFHLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQztBQUNoRCxRQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztBQUN0QyxRQUFJLFlBQVksR0FBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLEdBQUcsR0FBRyxHQUFHLEVBQUUsQUFBQyxDQUFBOztBQUVoRixRQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUU7QUFDL0IsVUFBSSxZQUFZLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtBQUM3QixlQUFPLEVBQUUsQ0FBQTtPQUNWO0tBQ0YsTUFBTSxJQUFJLE9BQU8sWUFBWSxLQUFLLFFBQVEsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFFO0FBQ3RFLGFBQU87QUFDTCxXQUFHLEVBQUUsR0FBRyxHQUFHLFlBQVksR0FBRyxJQUFJLENBQUMsaUJBQWlCO0FBQ2hELGlCQUFTLEVBQUUsU0FBUztPQUNyQixDQUFDO0tBQ0g7O0FBRUQsUUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNoRCxRQUFJLE9BQU8sVUFBVSxLQUFLLFFBQVEsRUFBRTtBQUNsQyxTQUFHLElBQUksVUFBVSxDQUFDO0tBQ25CLE1BQU87QUFDTixVQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFO0FBQzdCLFdBQUcsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0FBQ3pELFdBQUcsSUFBSSxJQUFJLEdBQUcsWUFBWSxHQUFHLFVBQVUsQ0FBQTtBQUN2QyxZQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUNWLGVBQU8sRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUU7QUFDckMsY0FBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsSUFBSSxNQUFNLENBQUE7QUFDMUIsYUFBRyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtTQUN6RDtBQUNELFdBQUcsSUFBSSxHQUFHLENBQUM7T0FDWixNQUFNLElBQUksWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFO0FBQ3ZELFdBQUcsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFBO09BQzdDLE1BQU07QUFDTCxXQUFHLEdBQUcsRUFBRSxDQUFBO09BQ1Q7S0FDRjtBQUNELFdBQU87QUFDTCxTQUFHLEVBQUUsR0FBRztBQUNSLGVBQVMsRUFBRSxTQUFTO0tBQ3JCLENBQUM7R0FDSDs7O0FBR0QsUUFBTSxFQUFFLGtCQUFXO0FBQ2pCLFFBQUksT0FBTyxHQUFLLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNyRCxRQUFJLElBQUksR0FBUSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDNUIsUUFBSSxLQUFLLEdBQU8sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQzdCLFFBQUksS0FBSyxHQUFPLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUM3QixRQUFJLEdBQUcsR0FBUyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDM0IsUUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7QUFDdEMsV0FBTztBQUNMLFNBQUcsRUFBRSxTQUFTLElBQUksR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFBLEFBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUNyRCxJQUFJLEdBQUcsR0FBRyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUEsQUFBQyxHQUN4QixPQUFPLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFDM0IsU0FBUyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUEsQUFBQyxJQUM1RCxLQUFLLEdBQUcsR0FBRyxHQUFHLEtBQUssR0FBRyxFQUFFLENBQUEsQUFBQyxJQUN6QixLQUFLLEdBQUcsR0FBRyxHQUFHLEtBQUssR0FBRyxFQUFFLENBQUEsQUFBQyxJQUN6QixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxZQUFZLENBQUMsR0FBRyxFQUFFLENBQUEsQUFBQztBQUMvRCxlQUFTLEVBQUUsU0FBUyxJQUFJLFlBQVk7S0FDckMsQ0FBQztHQUNIOzs7QUFHRCxLQUFHLEVBQUUsZUFBVzs7QUFFZCxRQUFJLFNBQVMsR0FBSSxJQUFJLENBQUMsU0FBUyxDQUFDO0FBQ2hDLFFBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUMxQixRQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztBQUN0QyxXQUFPO0FBQ0wsU0FBRyxFQUFFLGNBQWMsR0FBRyxTQUFTLElBQzVCLFNBQVMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFBLEFBQUMsSUFDekQsTUFBTSxHQUFHLEdBQUcsR0FBRyxNQUFNLEdBQUcsRUFBRSxDQUFBLEFBQUMsSUFDM0IsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUFBLEFBQUM7QUFDL0QsZUFBUyxFQUFFLFNBQVMsSUFBSSxZQUFZO0tBQ3JDLENBQUM7R0FDSDs7O0FBSUQsU0FBTyxFQUFFLG1CQUFXO0FBQ2xCLFFBQUksUUFBUSxHQUFHLEtBQUssQ0FBQztBQUNyQixRQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsRUFBRSxPQUFPLEVBQUUsQ0FBQTtBQUNoQyxRQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUE7QUFDeEMsUUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQUUsR0FBRyxHQUFHLEVBQUUsQ0FBQztBQUNyQixRQUFJLE9BQU8sRUFBRTtBQUNYLGFBQU8sRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRTtBQUMzQixZQUFJLElBQUksR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEIsWUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsR0FBRyxJQUFJLENBQUE7QUFDbEMsWUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRTtBQUM3QixhQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtTQUMvQixNQUNJLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7QUFDNUMsYUFBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtTQUMvQztPQUNGO0tBQ0Y7QUFDRCxRQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2xDLFFBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNyQixXQUFPLFNBQVMsSUFBSSxRQUFRLEdBQUcsV0FBVyxHQUFHLEVBQUUsQ0FBQSxBQUFDLElBQzdDLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQSxBQUFDLEdBQ3RCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUEsQUFBQyxDQUFDO0dBQ3RFOztBQUVELFlBQVUsRUFBRSxvQkFBUyxNQUFNLEVBQUUsS0FBSyxFQUFFO0FBQ2xDLFlBQVEsTUFBTTtBQUNaLFdBQUssUUFBUSxDQUFDO0FBQ2QsV0FBSyxRQUFRO0FBQUUsZUFBTyxLQUFLLEdBQUcsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUFBLEFBQ3RHLFdBQUssS0FBSztBQUFFLGVBQU8sS0FBSyxHQUFHLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7QUFBQSxBQUNsRyxXQUFLLFVBQVU7QUFBRSxlQUFPLEtBQUssR0FBRyxvQkFBb0IsR0FBRyxFQUFFLENBQUM7QUFBQSxLQUMzRDtHQUNGOzs7QUFHRCxVQUFRLEVBQUUsb0JBQVc7QUFDbkIsV0FBTyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO0dBQzNDOztBQUVELFdBQVMsRUFBRSxxQkFBVztBQUNwQixXQUFPLDBCQUEwQixDQUFDO0dBQ25DOztBQUVELFVBQVEsRUFBRSxvQkFBVztBQUNuQixXQUFPLGVBQWUsQ0FBQztHQUN4Qjs7O0FBR0QsWUFBVSxFQUFFLHNCQUFXO0FBQ3JCLFFBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO0FBQ3BDLFdBQU87QUFDTCxTQUFHLEVBQUUsMEZBQTBGO0FBQy9GLGNBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO0FBQzdCLFlBQU0sRUFBRSxnQkFBUyxJQUFJLEVBQUU7QUFDckIsWUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFTLE9BQU8sRUFBRSxHQUFHLEVBQUU7QUFDM0MsaUJBQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEdBQUc7QUFDekIsd0JBQVksRUFBRSxHQUFHLENBQUMsY0FBYztBQUNoQyxnQkFBSSxFQUFFLEdBQUcsQ0FBQyxTQUFTO0FBQ25CLHFCQUFTLEVBQUUsR0FBRyxDQUFDLHdCQUF3QjtBQUN2QyxvQkFBUSxFQUFHLEdBQUcsQ0FBQyxXQUFXLEtBQUssS0FBSyxBQUFDO1dBQ3RDLENBQUM7QUFDRixpQkFBTyxPQUFPLENBQUE7U0FDZixFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ04sZUFBTyxNQUFNLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQztPQUNyQztLQUNGLENBQUM7R0FDSDs7QUFFRCxLQUFHLEVBQUUsZUFBVztBQUNkLFFBQUksT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDO0FBQzVELFFBQUksUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7QUFDbkMsUUFBSSxPQUFPLElBQUksQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUM7QUFDcEMsV0FBTyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUM7R0FDcEU7O0FBRUQsT0FBSyxFQUFFLGlCQUFXO0FBQ2hCLFdBQU8sRUFBRSxDQUFDO0dBQ1g7O0FBRUQsUUFBTSxFQUFFLGtCQUFXO0FBQ2pCLFFBQUksT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDO0FBQzVELFFBQUksUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7QUFDbkMsUUFBSSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUM7QUFDeEIsUUFBSSxNQUFNLEdBQUcsU0FBUyxJQUFJLFFBQVEsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQSxBQUFDLEdBQUcsT0FBTyxDQUFDO0FBQ25HLFFBQUksQ0FBQyxPQUFPLEVBQUU7QUFDWixZQUFNLElBQUksY0FBYyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsWUFBWSxDQUFDO0tBQ3ZGO0FBQ0QsV0FBTyxNQUFNLENBQUM7R0FDZjs7Q0FFRixDQUFDLENBQUE7Ozs7QUFJRixNQUFNLENBQUMsT0FBTyxHQUFHLG1CQUFtQixDQUFDIiwiZmlsZSI6ImNvbXBpbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBNU1NRTCBRdWVyeSBDb21waWxlclxuLy8gLS0tLS0tXG52YXIgXyAgICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIGluaGVyaXRzICAgICAgPSByZXF1aXJlKCdpbmhlcml0cycpXG52YXIgUXVlcnlDb21waWxlciA9IHJlcXVpcmUoJy4uLy4uLy4uL3F1ZXJ5L2NvbXBpbGVyJylcbnZhciBhc3NpZ24gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoL29iamVjdC9hc3NpZ24nKTtcblxuZnVuY3Rpb24gUXVlcnlDb21waWxlcl9NU1NRTChjbGllbnQsIGJ1aWxkZXIpIHtcbiAgUXVlcnlDb21waWxlci5jYWxsKHRoaXMsIGNsaWVudCwgYnVpbGRlcilcbn1cbmluaGVyaXRzKFF1ZXJ5Q29tcGlsZXJfTVNTUUwsIFF1ZXJ5Q29tcGlsZXIpXG5cbmFzc2lnbihRdWVyeUNvbXBpbGVyX01TU1FMLnByb3RvdHlwZSwge1xuXG4gIF9lbXB0eUluc2VydFZhbHVlOiAnZGVmYXVsdCB2YWx1ZXMnLFxuXG4gIC8vIENvbXBpbGVzIGFuIFwiaW5zZXJ0XCIgcXVlcnksIGFsbG93aW5nIGZvciBtdWx0aXBsZVxuICAvLyBpbnNlcnRzIHVzaW5nIGEgc2luZ2xlIHF1ZXJ5IHN0YXRlbWVudC5cbiAgaW5zZXJ0OiBmdW5jdGlvbigpIHtcbiAgICB2YXIgaW5zZXJ0VmFsdWVzID0gdGhpcy5zaW5nbGUuaW5zZXJ0IHx8IFtdO1xuICAgIHZhciBzcWwgPSAnaW5zZXJ0IGludG8gJyArIHRoaXMudGFibGVOYW1lICsgJyAnO1xuICAgIHZhciByZXR1cm5pbmcgPSB0aGlzLnNpbmdsZS5yZXR1cm5pbmc7XG4gICAgdmFyIHJldHVybmluZ1NxbCA9IChyZXR1cm5pbmcgPyB0aGlzLl9yZXR1cm5pbmcoJ2luc2VydCcsIHJldHVybmluZykgKyAnICcgOiAnJylcblxuICAgIGlmIChBcnJheS5pc0FycmF5KGluc2VydFZhbHVlcykpIHtcbiAgICAgIGlmIChpbnNlcnRWYWx1ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiAnJ1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc2VydFZhbHVlcyA9PT0gJ29iamVjdCcgJiYgXy5pc0VtcHR5KGluc2VydFZhbHVlcykpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHNxbDogc3FsICsgcmV0dXJuaW5nU3FsICsgdGhpcy5fZW1wdHlJbnNlcnRWYWx1ZSxcbiAgICAgICAgcmV0dXJuaW5nOiByZXR1cm5pbmdcbiAgICAgIH07XG4gICAgfVxuXG4gICAgdmFyIGluc2VydERhdGEgPSB0aGlzLl9wcmVwSW5zZXJ0KGluc2VydFZhbHVlcyk7XG4gICAgaWYgKHR5cGVvZiBpbnNlcnREYXRhID09PSAnc3RyaW5nJykge1xuICAgICAgc3FsICs9IGluc2VydERhdGE7XG4gICAgfSBlbHNlICB7XG4gICAgICBpZiAoaW5zZXJ0RGF0YS5jb2x1bW5zLmxlbmd0aCkge1xuICAgICAgICBzcWwgKz0gJygnICsgdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGluc2VydERhdGEuY29sdW1ucykgXG4gICAgICAgIHNxbCArPSAnKSAnICsgcmV0dXJuaW5nU3FsICsgJ3ZhbHVlcyAoJ1xuICAgICAgICB2YXIgaSA9IC0xXG4gICAgICAgIHdoaWxlICgrK2kgPCBpbnNlcnREYXRhLnZhbHVlcy5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAoaSAhPT0gMCkgc3FsICs9ICcpLCAoJ1xuICAgICAgICAgIHNxbCArPSB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXJpemUoaW5zZXJ0RGF0YS52YWx1ZXNbaV0pXG4gICAgICAgIH1cbiAgICAgICAgc3FsICs9ICcpJztcbiAgICAgIH0gZWxzZSBpZiAoaW5zZXJ0VmFsdWVzLmxlbmd0aCA9PT0gMSAmJiBpbnNlcnRWYWx1ZXNbMF0pIHtcbiAgICAgICAgc3FsICs9IHJldHVybmluZ1NxbCArIHRoaXMuX2VtcHR5SW5zZXJ0VmFsdWVcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNxbCA9ICcnXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBzcWw6IHNxbCxcbiAgICAgIHJldHVybmluZzogcmV0dXJuaW5nXG4gICAgfTtcbiAgfSxcbiAgXG4gIC8vIENvbXBpbGVzIGFuIGB1cGRhdGVgIHF1ZXJ5LCBhbGxvd2luZyBmb3IgYSByZXR1cm4gdmFsdWUuXG4gIHVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgdmFyIHVwZGF0ZXMgICA9IHRoaXMuX3ByZXBVcGRhdGUodGhpcy5zaW5nbGUudXBkYXRlKTtcbiAgICB2YXIgam9pbiAgICAgID0gdGhpcy5qb2luKCk7XG4gICAgdmFyIHdoZXJlICAgICA9IHRoaXMud2hlcmUoKTtcbiAgICB2YXIgb3JkZXIgICAgID0gdGhpcy5vcmRlcigpO1xuICAgIHZhciB0b3AgICAgICAgPSB0aGlzLnRvcCgpO1xuICAgIHZhciByZXR1cm5pbmcgPSB0aGlzLnNpbmdsZS5yZXR1cm5pbmc7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNxbDogJ3VwZGF0ZSAnICsgKHRvcCA/IHRvcCArICcgJyA6ICcnKSArIHRoaXMudGFibGVOYW1lICtcbiAgICAgICAgKGpvaW4gPyAnICcgKyBqb2luIDogJycpICtcbiAgICAgICAgJyBzZXQgJyArIHVwZGF0ZXMuam9pbignLCAnKSArXG4gICAgICAgIChyZXR1cm5pbmcgPyAnICcgKyB0aGlzLl9yZXR1cm5pbmcoJ3VwZGF0ZScsIHJldHVybmluZykgOiAnJykgK1xuICAgICAgICAod2hlcmUgPyAnICcgKyB3aGVyZSA6ICcnKSArXG4gICAgICAgIChvcmRlciA/ICcgJyArIG9yZGVyIDogJycpICtcbiAgICAgICAgKCFyZXR1cm5pbmcgPyB0aGlzLl9yZXR1cm5pbmcoJ3Jvd2NvdW50JywgJ0BAcm93Y291bnQnKSA6ICcnKSxcbiAgICAgIHJldHVybmluZzogcmV0dXJuaW5nIHx8ICdAQHJvd2NvdW50J1xuICAgIH07XG4gIH0sXG5cbiAgLy8gQ29tcGlsZXMgYSBgZGVsZXRlYCBxdWVyeS5cbiAgZGVsOiBmdW5jdGlvbigpIHtcbiAgICAvLyBNYWtlIHN1cmUgdGFibGVOYW1lIGlzIHByb2Nlc3NlZCBieSB0aGUgZm9ybWF0dGVyIGZpcnN0LlxuICAgIHZhciB0YWJsZU5hbWUgID0gdGhpcy50YWJsZU5hbWU7XG4gICAgdmFyIHdoZXJlcyA9IHRoaXMud2hlcmUoKTtcbiAgICB2YXIgcmV0dXJuaW5nID0gdGhpcy5zaW5nbGUucmV0dXJuaW5nO1xuICAgIHJldHVybiB7XG4gICAgICBzcWw6ICdkZWxldGUgZnJvbSAnICsgdGFibGVOYW1lICtcbiAgICAgICAgKHJldHVybmluZyA/ICcgJyArIHRoaXMuX3JldHVybmluZygnZGVsJywgcmV0dXJuaW5nKSA6ICcnKSArXG4gICAgICAgICh3aGVyZXMgPyAnICcgKyB3aGVyZXMgOiAnJykgK1xuICAgICAgICAoIXJldHVybmluZyA/IHRoaXMuX3JldHVybmluZygncm93Y291bnQnLCAnQEByb3djb3VudCcpIDogJycpLFxuICAgICAgcmV0dXJuaW5nOiByZXR1cm5pbmcgfHwgJ0BAcm93Y291bnQnXG4gICAgfTtcbiAgfSxcblxuXG4gIC8vIENvbXBpbGVzIHRoZSBjb2x1bW5zIGluIHRoZSBxdWVyeSwgc3BlY2lmeWluZyBpZiBhbiBpdGVtIHdhcyBkaXN0aW5jdC5cbiAgY29sdW1uczogZnVuY3Rpb24oKSB7XG4gICAgdmFyIGRpc3RpbmN0ID0gZmFsc2U7XG4gICAgaWYgKHRoaXMub25seVVuaW9ucygpKSByZXR1cm4gJydcbiAgICB2YXIgY29sdW1ucyA9IHRoaXMuZ3JvdXBlZC5jb2x1bW5zIHx8IFtdXG4gICAgdmFyIGkgPSAtMSwgc3FsID0gW107XG4gICAgaWYgKGNvbHVtbnMpIHtcbiAgICAgIHdoaWxlICgrK2kgPCBjb2x1bW5zLmxlbmd0aCkge1xuICAgICAgICB2YXIgc3RtdCA9IGNvbHVtbnNbaV07XG4gICAgICAgIGlmIChzdG10LmRpc3RpbmN0KSBkaXN0aW5jdCA9IHRydWVcbiAgICAgICAgaWYgKHN0bXQudHlwZSA9PT0gJ2FnZ3JlZ2F0ZScpIHtcbiAgICAgICAgICBzcWwucHVzaCh0aGlzLmFnZ3JlZ2F0ZShzdG10KSlcbiAgICAgICAgfSBcbiAgICAgICAgZWxzZSBpZiAoc3RtdC52YWx1ZSAmJiBzdG10LnZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBzcWwucHVzaCh0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoc3RtdC52YWx1ZSkpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHNxbC5sZW5ndGggPT09IDApIHNxbCA9IFsnKiddO1xuICAgIHZhciB0b3AgPSB0aGlzLnRvcCgpO1xuICAgIHJldHVybiAnc2VsZWN0ICcgKyAoZGlzdGluY3QgPyAnZGlzdGluY3QgJyA6ICcnKSArIFxuICAgICAgKHRvcCA/IHRvcCArICcgJyA6ICcnKSArXG4gICAgICBzcWwuam9pbignLCAnKSArICh0aGlzLnRhYmxlTmFtZSA/ICcgZnJvbSAnICsgdGhpcy50YWJsZU5hbWUgOiAnJyk7XG4gIH0sXG5cbiAgX3JldHVybmluZzogZnVuY3Rpb24obWV0aG9kLCB2YWx1ZSkge1xuICAgIHN3aXRjaCAobWV0aG9kKSB7XG4gICAgICBjYXNlICd1cGRhdGUnOlxuICAgICAgY2FzZSAnaW5zZXJ0JzogcmV0dXJuIHZhbHVlID8gJ291dHB1dCAnICsgdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplV2l0aFByZWZpeCgnaW5zZXJ0ZWQuJywgdmFsdWUpIDogJyc7XG4gICAgICBjYXNlICdkZWwnOiByZXR1cm4gdmFsdWUgPyAnb3V0cHV0ICcgKyB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemVXaXRoUHJlZml4KCdkZWxldGVkLicsIHZhbHVlKSA6ICcnO1xuICAgICAgY2FzZSAncm93Y291bnQnOiByZXR1cm4gdmFsdWUgPyAnO3NlbGVjdCBAQHJvd2NvdW50JyA6ICcnO1xuICAgIH1cbiAgfSxcbiAgXG4gIC8vIENvbXBpbGVzIGEgYHRydW5jYXRlYCBxdWVyeS5cbiAgdHJ1bmNhdGU6IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAndHJ1bmNhdGUgdGFibGUgJyArIHRoaXMudGFibGVOYW1lO1xuICB9LFxuXG4gIGZvclVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuICd3aXRoIChSRUFEQ09NTUlUVEVETE9DSyknO1xuICB9LFxuXG4gIGZvclNoYXJlOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gJ3dpdGggKE5PTE9DSyknO1xuICB9LFxuXG4gIC8vIENvbXBpbGVzIGEgYGNvbHVtbkluZm9gIHF1ZXJ5LlxuICBjb2x1bW5JbmZvOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgY29sdW1uID0gdGhpcy5zaW5nbGUuY29sdW1uSW5mbztcbiAgICByZXR1cm4ge1xuICAgICAgc3FsOiAnc2VsZWN0ICogZnJvbSBpbmZvcm1hdGlvbl9zY2hlbWEuY29sdW1ucyB3aGVyZSB0YWJsZV9uYW1lID0gPyBhbmQgdGFibGVfc2NoZW1hID0gXFwnZGJvXFwnJyxcbiAgICAgIGJpbmRpbmdzOiBbdGhpcy5zaW5nbGUudGFibGVdLFxuICAgICAgb3V0cHV0OiBmdW5jdGlvbihyZXNwKSB7XG4gICAgICAgIHZhciBvdXQgPSByZXNwLnJlZHVjZShmdW5jdGlvbihjb2x1bW5zLCB2YWwpIHtcbiAgICAgICAgICBjb2x1bW5zW3ZhbC5DT0xVTU5fTkFNRV0gPSB7XG4gICAgICAgICAgICBkZWZhdWx0VmFsdWU6IHZhbC5DT0xVTU5fREVGQVVMVCxcbiAgICAgICAgICAgIHR5cGU6IHZhbC5EQVRBX1RZUEUsXG4gICAgICAgICAgICBtYXhMZW5ndGg6IHZhbC5DSEFSQUNURVJfTUFYSU1VTV9MRU5HVEgsXG4gICAgICAgICAgICBudWxsYWJsZTogKHZhbC5JU19OVUxMQUJMRSA9PT0gJ1lFUycpXG4gICAgICAgICAgfTtcbiAgICAgICAgICByZXR1cm4gY29sdW1uc1xuICAgICAgICB9LCB7fSlcbiAgICAgICAgcmV0dXJuIGNvbHVtbiAmJiBvdXRbY29sdW1uXSB8fCBvdXQ7XG4gICAgICB9XG4gICAgfTtcbiAgfSxcblxuICB0b3A6IGZ1bmN0aW9uKCkge1xuICAgIHZhciBub0xpbWl0ID0gIXRoaXMuc2luZ2xlLmxpbWl0ICYmIHRoaXMuc2luZ2xlLmxpbWl0ICE9PSAwO1xuICAgIHZhciBub09mZnNldCA9ICF0aGlzLnNpbmdsZS5vZmZzZXQ7XG4gICAgaWYgKG5vTGltaXQgfHwgIW5vT2Zmc2V0KSByZXR1cm4gJyc7XG4gICAgcmV0dXJuICd0b3AgKCcgKyB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIodGhpcy5zaW5nbGUubGltaXQpICsgJyknO1xuICB9LFxuXG4gIGxpbWl0OiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gJyc7XG4gIH0sXG4gIFxuICBvZmZzZXQ6IGZ1bmN0aW9uKCkge1xuICAgIHZhciBub0xpbWl0ID0gIXRoaXMuc2luZ2xlLmxpbWl0ICYmIHRoaXMuc2luZ2xlLmxpbWl0ICE9PSAwO1xuICAgIHZhciBub09mZnNldCA9ICF0aGlzLnNpbmdsZS5vZmZzZXQ7XG4gICAgaWYgKG5vT2Zmc2V0KSByZXR1cm4gJyc7XG4gICAgdmFyIG9mZnNldCA9ICdvZmZzZXQgJyArIChub09mZnNldCA/ICcwJyA6IHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnNpbmdsZS5vZmZzZXQpKSArICcgcm93cyc7XG4gICAgaWYgKCFub0xpbWl0KSB7XG4gICAgICBvZmZzZXQgKz0gJyBmZXRjaCBuZXh0ICcgKyB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIodGhpcy5zaW5nbGUubGltaXQpICsgJyByb3dzIG9ubHknO1xuICAgIH1cbiAgICByZXR1cm4gb2Zmc2V0O1xuICB9LFxuICBcbn0pXG5cbi8vIFNldCB0aGUgUXVlcnlCdWlsZGVyICYgUXVlcnlDb21waWxlciBvbiB0aGUgY2xpZW50IG9iamVjdCxcbi8vIGluY2FzZSBhbnlvbmUgd2FudHMgdG8gbW9kaWZ5IHRoaW5ncyB0byBzdWl0IHRoZWlyIG93biBwdXJwb3Nlcy5cbm1vZHVsZS5leHBvcnRzID0gUXVlcnlDb21waWxlcl9NU1NRTDtcbiJdfQ==