
// Firebird Table Builder & Compiler
// -------
'use strict';

var inherits = require('inherits');
var TableCompiler = require('../../../schema/tablecompiler');
var Promise = require('../../../promise');
var assign = require('lodash/object/assign');

// Table Compiler
// ------

function TableCompiler_Firebird() {
  TableCompiler.apply(this, arguments);
}
inherits(TableCompiler_Firebird, TableCompiler);

assign(TableCompiler_Firebird.prototype, {

  createQuery: function createQuery(columns) {
    var sql = 'create table ' + this.tableName() + ' (' + columns.sql.join(', ') + ')';
    this.pushQuery({
      sql: sql,
      bindings: columns.bindings
    });
    if (this.single.comment) this.comment(this.single.comment);
  },

  addColumnsPrefix: 'add ',

  dropColumnPrefix: 'drop ',

  // Compiles the comment on the table.
  comment: function comment(_comment) {
    this.pushQuery('alter table ' + this.tableName() + " comment = '" + _comment + "'");
  },

  changeType: function changeType() {
    // alter table + table + ' modify ' + wrapped + '// type';
  },

  // Renames a column on the table.
  renameColumn: function renameColumn(from, to) {
    var compiler = this;
    var table = this.tableName();
    var wrapped = this.formatter.wrap(from) + ' ' + this.formatter.wrap(to);

    this.pushQuery({
      sql: 'show fields from ' + table + ' where field = ' + this.formatter.parameter(from),
      output: function output(resp) {
        var column = resp[0];
        var runner = this;
        return compiler.getFKRefs(runner).get(0).then(function (refs) {
          return Promise['try'](function () {
            if (!refs.length) {
              return;
            }
            return compiler.dropFKRefs(runner, refs);
          }).then(function () {
            return runner.query({
              sql: 'alter table ' + table + ' change ' + wrapped + ' ' + column.Type
            });
          }).then(function () {
            if (!refs.length) {
              return;
            }
            return compiler.createFKRefs(runner, refs.map(function (ref) {
              if (ref.REFERENCED_COLUMN_NAME === from) {
                ref.REFERENCED_COLUMN_NAME = to;
              }
              if (ref.COLUMN_NAME === from) {
                ref.COLUMN_NAME = to;
              }
              return ref;
            }));
          });
        });
      }
    });
  },

  getFKRefs: function getFKRefs(runner) {
    var formatter = this.client.formatter();
    var sql = 'SELECT KCU.CONSTRAINT_NAME, KCU.TABLE_NAME, KCU.COLUMN_NAME, ' + '       KCU.REFERENCED_TABLE_NAME, KCU.REFERENCED_COLUMN_NAME, ' + '       RC.UPDATE_RULE, RC.DELETE_RULE ' + 'FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE AS KCU ' + 'JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS AS RC ' + '       USING(CONSTRAINT_NAME)' + 'WHERE KCU.REFERENCED_TABLE_NAME = ' + formatter.parameter(this.tableNameRaw) + ' ' + '  AND KCU.CONSTRAINT_SCHEMA = ' + formatter.parameter(this.client.database()) + ' ' + '  AND RC.CONSTRAINT_SCHEMA = ' + formatter.parameter(this.client.database());

    return runner.query({
      sql: sql,
      bindings: formatter.bindings
    });
  },

  dropFKRefs: function dropFKRefs(runner, refs) {
    var formatter = this.client.formatter();

    return Promise.all(refs.map(function (ref) {
      var constraintName = formatter.wrap(ref.CONSTRAINT_NAME);
      var tableName = formatter.wrap(ref.TABLE_NAME);
      return runner.query({
        sql: 'alter table ' + tableName + ' drop foreign key ' + constraintName
      });
    }));
  },
  createFKRefs: function createFKRefs(runner, refs) {
    var formatter = this.client.formatter();

    return Promise.all(refs.map(function (ref) {
      var tableName = formatter.wrap(ref.TABLE_NAME);
      var keyName = formatter.wrap(ref.CONSTRAINT_NAME);
      var column = formatter.columnize(ref.COLUMN_NAME);
      var references = formatter.columnize(ref.REFERENCED_COLUMN_NAME);
      var inTable = formatter.wrap(ref.REFERENCED_TABLE_NAME);
      var onUpdate = ' ON UPDATE ' + ref.UPDATE_RULE;
      var onDelete = ' ON DELETE ' + ref.DELETE_RULE;

      return runner.query({
        sql: 'alter table ' + tableName + ' add constraint ' + keyName + ' ' + 'foreign key (' + column + ') references ' + inTable + ' (' + references + ')' + onUpdate + onDelete
      });
    }));
  },
  index: function index(columns, indexName) {
    indexName = indexName || this._indexCommand('index', this.tableNameRaw, columns);
    this.pushQuery('alter table ' + this.tableName() + " add index " + indexName + "(" + this.formatter.columnize(columns) + ")");
  },

  primary: function primary(columns, indexName) {
    indexName = indexName || this._indexCommand('primary', this.tableNameRaw, columns);
    this.pushQuery('alter table ' + this.tableName() + " add primary key " + indexName + "(" + this.formatter.columnize(columns) + ")");
  },

  unique: function unique(columns, indexName) {
    indexName = indexName || this._indexCommand('unique', this.tableNameRaw, columns);
    this.pushQuery('alter table ' + this.tableName() + " add unique " + indexName + "(" + this.formatter.columnize(columns) + ")");
  },

  // Compile a drop index command.
  dropIndex: function dropIndex(columns, indexName) {
    indexName = indexName || this._indexCommand('index', this.tableNameRaw, columns);
    this.pushQuery('alter table ' + this.tableName() + ' drop index ' + indexName);
  },

  // Compile a drop foreign key command.
  dropForeign: function dropForeign(columns, indexName) {
    indexName = indexName || this._indexCommand('foreign', this.tableNameRaw, columns);
    this.pushQuery('alter table ' + this.tableName() + ' drop foreign key ' + indexName);
  },

  // Compile a drop primary key command.
  dropPrimary: function dropPrimary() {
    this.pushQuery('alter table ' + this.tableName() + ' drop primary key');
  },

  // Compile a drop unique key command.
  dropUnique: function dropUnique(column, indexName) {
    indexName = indexName || this._indexCommand('unique', this.tableNameRaw, column);
    this.pushQuery('alter table ' + this.tableName() + ' drop index ' + indexName);
  }

});

module.exports = TableCompiler_Firebird;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9maXJlYmlyZC9zY2hlbWEvdGFibGVjb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSxZQUFZLENBQUM7O0FBRWIsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ25DLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQzdELElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQzFDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDOzs7OztBQUs3QyxTQUFTLHNCQUFzQixHQUFHO0FBQ2hDLGVBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0NBQ3RDO0FBQ0QsUUFBUSxDQUFDLHNCQUFzQixFQUFFLGFBQWEsQ0FBQyxDQUFDOztBQUVoRCxNQUFNLENBQUMsc0JBQXNCLENBQUMsU0FBUyxFQUFFOztBQUV2QyxhQUFXLEVBQUUsU0FBUyxXQUFXLENBQUMsT0FBTyxFQUFFO0FBQ3pDLFFBQUksR0FBRyxHQUFHLGVBQWUsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQztBQUNuRixRQUFJLENBQUMsU0FBUyxDQUFDO0FBQ2IsU0FBRyxFQUFFLEdBQUc7QUFDUixjQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7S0FDM0IsQ0FBQyxDQUFDO0FBQ0gsUUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7R0FDNUQ7O0FBRUQsa0JBQWdCLEVBQUUsTUFBTTs7QUFFeEIsa0JBQWdCLEVBQUUsT0FBTzs7O0FBR3pCLFNBQU8sRUFB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QyxTQUFTLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNuRixRQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsb0JBQW9CLEdBQUcsU0FBUyxDQUFDLENBQUM7R0FDdEY7OztBQUdELGFBQVcsRUFBRSxTQUFTLFdBQVcsR0FBRztBQUNsQyxRQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsbUJBQW1CLENBQUMsQ0FBQztHQUN6RTs7O0FBR0QsWUFBVSxFQUFFLFNBQVMsVUFBVSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUU7QUFDakQsYUFBUyxHQUFHLFNBQVMsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ2pGLFFBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxjQUFjLEdBQUcsU0FBUyxDQUFDLENBQUM7R0FDaEY7O0NBRUYsQ0FBQyxDQUFDOztBQUVILE1BQU0sQ0FBQyxPQUFPLEdBQUcsc0JBQXNCLENBQUMiLCJmaWxlIjoidGFibGVjb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLy8gRmlyZWJpcmQgVGFibGUgQnVpbGRlciAmIENvbXBpbGVyXG4vLyAtLS0tLS0tXG4ndXNlIHN0cmljdCc7XG5cbnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7XG52YXIgVGFibGVDb21waWxlciA9IHJlcXVpcmUoJy4uLy4uLy4uL3NjaGVtYS90YWJsZWNvbXBpbGVyJyk7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4uLy4uLy4uL3Byb21pc2UnKTtcbnZhciBhc3NpZ24gPSByZXF1aXJlKCdsb2Rhc2gvb2JqZWN0L2Fzc2lnbicpO1xuXG4vLyBUYWJsZSBDb21waWxlclxuLy8gLS0tLS0tXG5cbmZ1bmN0aW9uIFRhYmxlQ29tcGlsZXJfRmlyZWJpcmQoKSB7XG4gIFRhYmxlQ29tcGlsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn1cbmluaGVyaXRzKFRhYmxlQ29tcGlsZXJfRmlyZWJpcmQsIFRhYmxlQ29tcGlsZXIpO1xuXG5hc3NpZ24oVGFibGVDb21waWxlcl9GaXJlYmlyZC5wcm90b3R5cGUsIHtcblxuICBjcmVhdGVRdWVyeTogZnVuY3Rpb24gY3JlYXRlUXVlcnkoY29sdW1ucykge1xuICAgIHZhciBzcWwgPSAnY3JlYXRlIHRhYmxlICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyAoJyArIGNvbHVtbnMuc3FsLmpvaW4oJywgJykgKyAnKSc7XG4gICAgdGhpcy5wdXNoUXVlcnkoe1xuICAgICAgc3FsOiBzcWwsXG4gICAgICBiaW5kaW5nczogY29sdW1ucy5iaW5kaW5nc1xuICAgIH0pO1xuICAgIGlmICh0aGlzLnNpbmdsZS5jb21tZW50KSB0aGlzLmNvbW1lbnQodGhpcy5zaW5nbGUuY29tbWVudCk7XG4gIH0sXG5cbiAgYWRkQ29sdW1uc1ByZWZpeDogJ2FkZCAnLFxuXG4gIGRyb3BDb2x1bW5QcmVmaXg6ICdkcm9wICcsXG5cbiAgLy8gQ29tcGlsZXMgdGhlIGNvbW1lbnQgb24gdGhlIHRhYmxlLlxuICBjb21tZW50OiBmdW5jdGlvbiBjb21tZW50KF9jb21tZW50KSB7XG4gICAgdGhpcy5wdXNoUXVlcnkoJ2FsdGVyIHRhYmxlICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgXCIgY29tbWVudCA9ICdcIiArIF9jb21tZW50ICsgXCInXCIpO1xuICB9LFxuXG4gIGNoYW5nZVR5cGU6IGZ1bmN0aW9uIGNoYW5nZVR5cGUoKSB7XG4gICAgLy8gYWx0ZXIgdGFibGUgKyB0YWJsZSArICcgbW9kaWZ5ICcgKyB3cmFwcGVkICsgJy8vIHR5cGUnO1xuICB9LFxuXG4gIC8vIFJlbmFtZXMgYSBjb2x1bW4gb24gdGhlIHRhYmxlLlxuICByZW5hbWVDb2x1bW46IGZ1bmN0aW9uIHJlbmFtZUNvbHVtbihmcm9tLCB0bykge1xuICAgIHZhciBjb21waWxlciA9IHRoaXM7XG4gICAgdmFyIHRhYmxlID0gdGhpcy50YWJsZU5hbWUoKTtcbiAgICB2YXIgd3JhcHBlZCA9IHRoaXMuZm9ybWF0dGVyLndyYXAoZnJvbSkgKyAnICcgKyB0aGlzLmZvcm1hdHRlci53cmFwKHRvKTtcblxuICAgIHRoaXMucHVzaFF1ZXJ5KHtcbiAgICAgIHNxbDogJ3Nob3cgZmllbGRzIGZyb20gJyArIHRhYmxlICsgJyB3aGVyZSBmaWVsZCA9ICcgKyB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIoZnJvbSksXG4gICAgICBvdXRwdXQ6IGZ1bmN0aW9uIG91dHB1dChyZXNwKSB7XG4gICAgICAgIHZhciBjb2x1bW4gPSByZXNwWzBdO1xuICAgICAgICB2YXIgcnVubmVyID0gdGhpcztcbiAgICAgICAgcmV0dXJuIGNvbXBpbGVyLmdldEZLUmVmcyhydW5uZXIpLmdldCgwKS50aGVuKGZ1bmN0aW9uIChyZWZzKSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2VbJ3RyeSddKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICghcmVmcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNvbXBpbGVyLmRyb3BGS1JlZnMocnVubmVyLCByZWZzKTtcbiAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBydW5uZXIucXVlcnkoe1xuICAgICAgICAgICAgICBzcWw6ICdhbHRlciB0YWJsZSAnICsgdGFibGUgKyAnIGNoYW5nZSAnICsgd3JhcHBlZCArICcgJyArIGNvbHVtbi5UeXBlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICghcmVmcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNvbXBpbGVyLmNyZWF0ZUZLUmVmcyhydW5uZXIsIHJlZnMubWFwKGZ1bmN0aW9uIChyZWYpIHtcbiAgICAgICAgICAgICAgaWYgKHJlZi5SRUZFUkVOQ0VEX0NPTFVNTl9OQU1FID09PSBmcm9tKSB7XG4gICAgICAgICAgICAgICAgcmVmLlJFRkVSRU5DRURfQ09MVU1OX05BTUUgPSB0bztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAocmVmLkNPTFVNTl9OQU1FID09PSBmcm9tKSB7XG4gICAgICAgICAgICAgICAgcmVmLkNPTFVNTl9OQU1FID0gdG87XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIHJlZjtcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sXG5cbiAgZ2V0RktSZWZzOiBmdW5jdGlvbiBnZXRGS1JlZnMocnVubmVyKSB7XG4gICAgdmFyIGZvcm1hdHRlciA9IHRoaXMuY2xpZW50LmZvcm1hdHRlcigpO1xuICAgIHZhciBzcWwgPSAnU0VMRUNUIEtDVS5DT05TVFJBSU5UX05BTUUsIEtDVS5UQUJMRV9OQU1FLCBLQ1UuQ09MVU1OX05BTUUsICcgKyAnICAgICAgIEtDVS5SRUZFUkVOQ0VEX1RBQkxFX05BTUUsIEtDVS5SRUZFUkVOQ0VEX0NPTFVNTl9OQU1FLCAnICsgJyAgICAgICBSQy5VUERBVEVfUlVMRSwgUkMuREVMRVRFX1JVTEUgJyArICdGUk9NIElORk9STUFUSU9OX1NDSEVNQS5LRVlfQ09MVU1OX1VTQUdFIEFTIEtDVSAnICsgJ0pPSU4gSU5GT1JNQVRJT05fU0NIRU1BLlJFRkVSRU5USUFMX0NPTlNUUkFJTlRTIEFTIFJDICcgKyAnICAgICAgIFVTSU5HKENPTlNUUkFJTlRfTkFNRSknICsgJ1dIRVJFIEtDVS5SRUZFUkVOQ0VEX1RBQkxFX05BTUUgPSAnICsgZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnRhYmxlTmFtZVJhdykgKyAnICcgKyAnICBBTkQgS0NVLkNPTlNUUkFJTlRfU0NIRU1BID0gJyArIGZvcm1hdHRlci5wYXJhbWV0ZXIodGhpcy5jbGllbnQuZGF0YWJhc2UoKSkgKyAnICcgKyAnICBBTkQgUkMuQ09OU1RSQUlOVF9TQ0hFTUEgPSAnICsgZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLmNsaWVudC5kYXRhYmFzZSgpKTtcblxuICAgIHJldHVybiBydW5uZXIucXVlcnkoe1xuICAgICAgc3FsOiBzcWwsXG4gICAgICBiaW5kaW5nczogZm9ybWF0dGVyLmJpbmRpbmdzXG4gICAgfSk7XG4gIH0sXG5cbiAgZHJvcEZLUmVmczogZnVuY3Rpb24gZHJvcEZLUmVmcyhydW5uZXIsIHJlZnMpIHtcbiAgICB2YXIgZm9ybWF0dGVyID0gdGhpcy5jbGllbnQuZm9ybWF0dGVyKCk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVmcy5tYXAoZnVuY3Rpb24gKHJlZikge1xuICAgICAgdmFyIGNvbnN0cmFpbnROYW1lID0gZm9ybWF0dGVyLndyYXAocmVmLkNPTlNUUkFJTlRfTkFNRSk7XG4gICAgICB2YXIgdGFibGVOYW1lID0gZm9ybWF0dGVyLndyYXAocmVmLlRBQkxFX05BTUUpO1xuICAgICAgcmV0dXJuIHJ1bm5lci5xdWVyeSh7XG4gICAgICAgIHNxbDogJ2FsdGVyIHRhYmxlICcgKyB0YWJsZU5hbWUgKyAnIGRyb3AgZm9yZWlnbiBrZXkgJyArIGNvbnN0cmFpbnROYW1lXG4gICAgICB9KTtcbiAgICB9KSk7XG4gIH0sXG4gIGNyZWF0ZUZLUmVmczogZnVuY3Rpb24gY3JlYXRlRktSZWZzKHJ1bm5lciwgcmVmcykge1xuICAgIHZhciBmb3JtYXR0ZXIgPSB0aGlzLmNsaWVudC5mb3JtYXR0ZXIoKTtcblxuICAgIHJldHVybiBQcm9taXNlLmFsbChyZWZzLm1hcChmdW5jdGlvbiAocmVmKSB7XG4gICAgICB2YXIgdGFibGVOYW1lID0gZm9ybWF0dGVyLndyYXAocmVmLlRBQkxFX05BTUUpO1xuICAgICAgdmFyIGtleU5hbWUgPSBmb3JtYXR0ZXIud3JhcChyZWYuQ09OU1RSQUlOVF9OQU1FKTtcbiAgICAgIHZhciBjb2x1bW4gPSBmb3JtYXR0ZXIuY29sdW1uaXplKHJlZi5DT0xVTU5fTkFNRSk7XG4gICAgICB2YXIgcmVmZXJlbmNlcyA9IGZvcm1hdHRlci5jb2x1bW5pemUocmVmLlJFRkVSRU5DRURfQ09MVU1OX05BTUUpO1xuICAgICAgdmFyIGluVGFibGUgPSBmb3JtYXR0ZXIud3JhcChyZWYuUkVGRVJFTkNFRF9UQUJMRV9OQU1FKTtcbiAgICAgIHZhciBvblVwZGF0ZSA9ICcgT04gVVBEQVRFICcgKyByZWYuVVBEQVRFX1JVTEU7XG4gICAgICB2YXIgb25EZWxldGUgPSAnIE9OIERFTEVURSAnICsgcmVmLkRFTEVURV9SVUxFO1xuXG4gICAgICByZXR1cm4gcnVubmVyLnF1ZXJ5KHtcbiAgICAgICAgc3FsOiAnYWx0ZXIgdGFibGUgJyArIHRhYmxlTmFtZSArICcgYWRkIGNvbnN0cmFpbnQgJyArIGtleU5hbWUgKyAnICcgKyAnZm9yZWlnbiBrZXkgKCcgKyBjb2x1bW4gKyAnKSByZWZlcmVuY2VzICcgKyBpblRhYmxlICsgJyAoJyArIHJlZmVyZW5jZXMgKyAnKScgKyBvblVwZGF0ZSArIG9uRGVsZXRlXG4gICAgICB9KTtcbiAgICB9KSk7XG4gIH0sXG4gIGluZGV4OiBmdW5jdGlvbiBpbmRleChjb2x1bW5zLCBpbmRleE5hbWUpIHtcbiAgICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCdpbmRleCcsIHRoaXMudGFibGVOYW1lUmF3LCBjb2x1bW5zKTtcbiAgICB0aGlzLnB1c2hRdWVyeSgnYWx0ZXIgdGFibGUgJyArIHRoaXMudGFibGVOYW1lKCkgKyBcIiBhZGQgaW5kZXggXCIgKyBpbmRleE5hbWUgKyBcIihcIiArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShjb2x1bW5zKSArIFwiKVwiKTtcbiAgfSxcblxuICBwcmltYXJ5OiBmdW5jdGlvbiBwcmltYXJ5KGNvbHVtbnMsIGluZGV4TmFtZSkge1xuICAgIGluZGV4TmFtZSA9IGluZGV4TmFtZSB8fCB0aGlzLl9pbmRleENvbW1hbmQoJ3ByaW1hcnknLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gICAgdGhpcy5wdXNoUXVlcnkoJ2FsdGVyIHRhYmxlICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgXCIgYWRkIHByaW1hcnkga2V5IFwiICsgaW5kZXhOYW1lICsgXCIoXCIgKyB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucykgKyBcIilcIik7XG4gIH0sXG5cbiAgdW5pcXVlOiBmdW5jdGlvbiB1bmlxdWUoY29sdW1ucywgaW5kZXhOYW1lKSB7XG4gICAgaW5kZXhOYW1lID0gaW5kZXhOYW1lIHx8IHRoaXMuX2luZGV4Q29tbWFuZCgndW5pcXVlJywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpO1xuICAgIHRoaXMucHVzaFF1ZXJ5KCdhbHRlciB0YWJsZSAnICsgdGhpcy50YWJsZU5hbWUoKSArIFwiIGFkZCB1bmlxdWUgXCIgKyBpbmRleE5hbWUgKyBcIihcIiArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShjb2x1bW5zKSArIFwiKVwiKTtcbiAgfSxcblxuICAvLyBDb21waWxlIGEgZHJvcCBpbmRleCBjb21tYW5kLlxuICBkcm9wSW5kZXg6IGZ1bmN0aW9uIGRyb3BJbmRleChjb2x1bW5zLCBpbmRleE5hbWUpIHtcbiAgICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCdpbmRleCcsIHRoaXMudGFibGVOYW1lUmF3LCBjb2x1bW5zKTtcbiAgICB0aGlzLnB1c2hRdWVyeSgnYWx0ZXIgdGFibGUgJyArIHRoaXMudGFibGVOYW1lKCkgKyAnIGRyb3AgaW5kZXggJyArIGluZGV4TmFtZSk7XG4gIH0sXG5cbiAgLy8gQ29tcGlsZSBhIGRyb3AgZm9yZWlnbiBrZXkgY29tbWFuZC5cbiAgZHJvcEZvcmVpZ246IGZ1bmN0aW9uIGRyb3BGb3JlaWduKGNvbHVtbnMsIGluZGV4TmFtZSkge1xuICAgIGluZGV4TmFtZSA9IGluZGV4TmFtZSB8fCB0aGlzLl9pbmRleENvbW1hbmQoJ2ZvcmVpZ24nLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gICAgdGhpcy5wdXNoUXVlcnkoJ2FsdGVyIHRhYmxlICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyBkcm9wIGZvcmVpZ24ga2V5ICcgKyBpbmRleE5hbWUpO1xuICB9LFxuXG4gIC8vIENvbXBpbGUgYSBkcm9wIHByaW1hcnkga2V5IGNvbW1hbmQuXG4gIGRyb3BQcmltYXJ5OiBmdW5jdGlvbiBkcm9wUHJpbWFyeSgpIHtcbiAgICB0aGlzLnB1c2hRdWVyeSgnYWx0ZXIgdGFibGUgJyArIHRoaXMudGFibGVOYW1lKCkgKyAnIGRyb3AgcHJpbWFyeSBrZXknKTtcbiAgfSxcblxuICAvLyBDb21waWxlIGEgZHJvcCB1bmlxdWUga2V5IGNvbW1hbmQuXG4gIGRyb3BVbmlxdWU6IGZ1bmN0aW9uIGRyb3BVbmlxdWUoY29sdW1uLCBpbmRleE5hbWUpIHtcbiAgICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCd1bmlxdWUnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1uKTtcbiAgICB0aGlzLnB1c2hRdWVyeSgnYWx0ZXIgdGFibGUgJyArIHRoaXMudGFibGVOYW1lKCkgKyAnIGRyb3AgaW5kZXggJyArIGluZGV4TmFtZSk7XG4gIH1cblxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gVGFibGVDb21waWxlcl9GaXJlYmlyZDsiXX0=