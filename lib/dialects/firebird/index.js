
// Firebird Client
// -------
'use strict';

var inherits = require('inherits');
var assign = require('lodash/object/assign');

var Client = require('../../client');
var Promise = require('../../promise');
var helpers = require('../../helpers');

var Transaction = require('./transaction');
var QueryCompiler = require('./query/compiler');
var SchemaCompiler = require('./schema/compiler');
var Formatter = require('./formatter');
var TableCompiler = require('./schema/tablecompiler');
var ColumnCompiler = require('./schema/columncompiler');
var pluck = require('lodash/collection/pluck');

// Always initialize with the "QueryBuilder" and "QueryCompiler"
// objects, which extend the base 'lib/query/builder' and
// 'lib/query/compiler', respectively.
function Client_Firebird(config) {
  Client.call(this, config);
}
inherits(Client_Firebird, Client);

assign(Client_Firebird.prototype, {

  dialect: 'firebird',

  driverName: 'node-firebird',

  _driver: function _driver() {
    return require('node-firebird');
  },

  QueryCompiler: QueryCompiler,

  SchemaCompiler: SchemaCompiler,

  TableCompiler: TableCompiler,

  ColumnCompiler: ColumnCompiler,

  Transaction: Transaction,

  Formatter: Formatter,

  wrapIdentifier: function wrapIdentifier(value) {
    if (value === '*') return value;
    var matched = value.match(/(.*?)(\[[0-9]\])/);
    if (matched) return this.wrapIdentifier(matched[1]) + matched[2];
    return '' + value.replace(/"/g, '""') + '';
  },

  // Get a raw connection, called by the `pool` whenever a new
  // connection needs to be added to the pool.
  acquireRawConnection: function acquireRawConnection() {
    var client = this;
    var driver = client.driver;
    var connectionSettings = client.connectionSettings;

    return new Promise(function (resolver, rejecter) {
      driver.attach(connectionSettings, function (err, db) {
        if (err) return rejecter(err);
        db.on('error', connectionErrorHandler.bind(null, client, db));
        db.on('end', connectionErrorHandler.bind(null, client, db));
        resolver(db);
      });
    });
  },

  // Used to explicitly close a connection, called internally by the pool
  // when a connection times out or the pool is shutdown.
  destroyRawConnection: function destroyRawConnection(connection, cb) {
    if (typeof cb.detach === "function") {
      cb.detach();
    }
  },

  // Runs the query on the specified connection, providing the bindings
  // and any other necessary prep work.
  _query: function _query(connection, obj) {
    if (!obj || typeof obj === 'string') obj = { sql: obj };
    return new Promise(function (resolver, rejecter) {
      var sql = obj.sql;
      if (!sql) return resolver();

      connection.query(sql, obj.bindings, function (err, rows, fields) {
        if (err) return rejecter(err);
        obj.response = [rows, fields, obj.bindings];
        resolver(obj);
      });
    });
  },

  // Process the response as returned from the query.
  processResponse: function processResponse(obj, runner) {
    if (obj == null) return;
    var response = obj.response;
    var method = obj.method;
    var rows = response[0];
    var fields = response[1];
    var bindings = response[2];
    if (obj.output) return obj.output.call(runner, rows, fields);
    switch (method) {
      case 'select':
      case 'pluck':
      case 'first':
        var resp = helpers.skim(rows);
        if (method === 'pluck') return pluck(resp, obj.pluck);
        return method === 'first' ? resp[0] : resp;
      case 'insert':
        return bindings;
      case 'del':
      case 'update':
      case 'counter':
        if (rows && rows.affectedRows) {
          rows.affectedRows;
        } else {
          rows = {};
          rows.affectedRows = [0];
        }
        return rows.affectedRows;
      default:
        return bindings;
    }
  }

});

// Firebird Specific error handler
function connectionErrorHandler(client, connection, err) {
  if (connection && err && err.fatal) {
    if (connection.__knex__disposed) return;
    connection.__knex__disposed = true;
    client.pool.destroy(connection);
  }
}

module.exports = Client_Firebird;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9maXJlYmlyZC9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSxZQUFZLENBQUM7O0FBRWIsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ25DLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDOztBQUU3QyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDckMsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3ZDLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQzs7QUFFdkMsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQzNDLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ2hELElBQUksY0FBYyxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQ2xELElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUN2QyxJQUFJLGFBQWEsR0FBRyxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUN0RCxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQztBQUN4RCxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQzs7Ozs7QUFLL0MsU0FBUyxlQUFlLENBQUMsTUFBTSxFQUFFO0FBQy9CLFFBQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0NBQzNCO0FBQ0QsUUFBUSxDQUFDLGVBQWUsRUFBRSxNQUFNLENBQUMsQ0FBQzs7QUFFbEMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUU7O0FBRWhDLFNBQU8sRUFBRSxVQUFVOztBQUVuQixZQUFVLEVBQUUsZUFBZTs7QUFFM0IsU0FBTyxF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RSxDQUFBO0FBQ1QsY0FBSSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQzFCO0FBQ0QsZUFBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0FBQUEsQUFDM0I7QUFDRSxlQUFPLFFBQVEsQ0FBQztBQUFBLEtBQ25CO0dBQ0Y7O0NBRUYsQ0FBQyxDQUFDOzs7QUFHSCxTQUFTLHNCQUFzQixDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFO0FBQ3ZELE1BQUksVUFBVSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFO0FBQ2xDLFFBQUksVUFBVSxDQUFDLGdCQUFnQixFQUFFLE9BQU87QUFDeEMsY0FBVSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztBQUNuQyxVQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztHQUNqQztDQUNGOztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsZUFBZSxDQUFDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBGaXJlYmlyZCBDbGllbnRcbi8vIC0tLS0tLS1cbid1c2Ugc3RyaWN0JztcblxudmFyIGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTtcbnZhciBhc3NpZ24gPSByZXF1aXJlKCdsb2Rhc2gvb2JqZWN0L2Fzc2lnbicpO1xuXG52YXIgQ2xpZW50ID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50Jyk7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKTtcbnZhciBoZWxwZXJzID0gcmVxdWlyZSgnLi4vLi4vaGVscGVycycpO1xuXG52YXIgVHJhbnNhY3Rpb24gPSByZXF1aXJlKCcuL3RyYW5zYWN0aW9uJyk7XG52YXIgUXVlcnlDb21waWxlciA9IHJlcXVpcmUoJy4vcXVlcnkvY29tcGlsZXInKTtcbnZhciBTY2hlbWFDb21waWxlciA9IHJlcXVpcmUoJy4vc2NoZW1hL2NvbXBpbGVyJyk7XG52YXIgRm9ybWF0dGVyID0gcmVxdWlyZSgnLi9mb3JtYXR0ZXInKTtcbnZhciBUYWJsZUNvbXBpbGVyID0gcmVxdWlyZSgnLi9zY2hlbWEvdGFibGVjb21waWxlcicpO1xudmFyIENvbHVtbkNvbXBpbGVyID0gcmVxdWlyZSgnLi9zY2hlbWEvY29sdW1uY29tcGlsZXInKTtcbnZhciBwbHVjayA9IHJlcXVpcmUoJ2xvZGFzaC9jb2xsZWN0aW9uL3BsdWNrJyk7XG5cbi8vIEFsd2F5cyBpbml0aWFsaXplIHdpdGggdGhlIFwiUXVlcnlCdWlsZGVyXCIgYW5kIFwiUXVlcnlDb21waWxlclwiXG4vLyBvYmplY3RzLCB3aGljaCBleHRlbmQgdGhlIGJhc2UgJ2xpYi9xdWVyeS9idWlsZGVyJyBhbmRcbi8vICdsaWIvcXVlcnkvY29tcGlsZXInLCByZXNwZWN0aXZlbHkuXG5mdW5jdGlvbiBDbGllbnRfRmlyZWJpcmQoY29uZmlnKSB7XG4gIENsaWVudC5jYWxsKHRoaXMsIGNvbmZpZyk7XG59XG5pbmhlcml0cyhDbGllbnRfRmlyZWJpcmQsIENsaWVudCk7XG5cbmFzc2lnbihDbGllbnRfRmlyZWJpcmQucHJvdG90eXBlLCB7XG5cbiAgZGlhbGVjdDogJ2ZpcmViaXJkJyxcblxuICBkcml2ZXJOYW1lOiAnbm9kZS1maXJlYmlyZCcsXG5cbiAgX2RyaXZlcjogZnVuY3Rpb24gX2RyaXZlcigpIHtcbiAgICByZXR1cm4gcmVxdWlyZSgnbm9kZS1maXJlYmlyZCcpO1xuICB9LFxuXG4gIFF1ZXJ5Q29tcGlsZXI6IFF1ZXJ5Q29tcGlsZXIsXG5cbiAgU2NoZW1hQ29tcGlsZXI6IFNjaGVtYUNvbXBpbGVyLFxuXG4gIFRhYmxlQ29tcGlsZXI6IFRhYmxlQ29tcGlsZXIsXG5cbiAgQ29sdW1uQ29tcGlsZXI6IENvbHVtbkNvbXBpbGVyLFxuXG4gIFRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbixcblxuICBGb3JtYXR0ZXI6IEZvcm1hdHRlcixcblxuICB3cmFwSWRlbnRpZmllcjogZnVuY3Rpb24gd3JhcElkZW50aWZpZXIodmFsdWUpIHtcbiAgICBpZiAodmFsdWUgPT09ICcqJykgcmV0dXJuIHZhbHVlO1xuICAgIHZhciBtYXRjaGVkID0gdmFsdWUubWF0Y2goLyguKj8pKFxcW1swLTldXFxdKS8pO1xuICAgIGlmIChtYXRjaGVkKSByZXR1cm4gdGhpcy53cmFwSWRlbnRpZmllcihtYXRjaGVkWzFdKSArIG1hdGNoZWRbMl07XG4gICAgcmV0dXJuICcnICsgdmFsdWUucmVwbGFjZSgvXCIvZywgJ1wiXCInKSArICcnO1xuICB9LFxuXG4gIC8vIEdldCBhIHJhdyBjb25uZWN0aW9uLCBjYWxsZWQgYnkgdGhlIGBwb29sYCB3aGVuZXZlciBhIG5ld1xuICAvLyBjb25uZWN0aW9uIG5lZWRzIHRvIGJlIGFkZGVkIHRvIHRoZSBwb29sLlxuICBhY3F1aXJlUmF3Q29ubmVjdGlvbjogZnVuY3Rpb24gYWNxdWlyZVJhd0Nvbm5lY3Rpb24oKSB7XG4gICAgdmFyIGNsaWVudCA9IHRoaXM7XG4gICAgdmFyIGRyaXZlciA9IGNsaWVudC5kcml2ZXI7XG4gICAgdmFyIGNvbm5lY3Rpb25TZXR0aW5ncyA9IGNsaWVudC5jb25uZWN0aW9uU2V0dGluZ3M7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgICAgZHJpdmVyLmF0dGFjaChjb25uZWN0aW9uU2V0dGluZ3MsIGZ1bmN0aW9uIChlcnIsIGRiKSB7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3RlcihlcnIpO1xuICAgICAgICBkYi5vbignZXJyb3InLCBjb25uZWN0aW9uRXJyb3JIYW5kbGVyLmJpbmQobnVsbCwgY2xpZW50LCBkYikpO1xuICAgICAgICBkYi5vbignZW5kJywgY29ubmVjdGlvbkVycm9ySGFuZGxlci5iaW5kKG51bGwsIGNsaWVudCwgZGIpKTtcbiAgICAgICAgcmVzb2x2ZXIoZGIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0sXG5cbiAgLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2xcbiAgLy8gd2hlbiBhIGNvbm5lY3Rpb24gdGltZXMgb3V0IG9yIHRoZSBwb29sIGlzIHNodXRkb3duLlxuICBkZXN0cm95UmF3Q29ubmVjdGlvbjogZnVuY3Rpb24gZGVzdHJveVJhd0Nvbm5lY3Rpb24oY29ubmVjdGlvbiwgY2IpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBjYi5kZXRhY2ggPT09IFwiZnVuY3Rpb25cIil7XG4gICAgICAgIGNiLmRldGFjaCgpO1xuICAgICAgICB9XG4gIH0sXG5cbiAgLy8gUnVucyB0aGUgcXVlcnkgb24gdGhlIHNwZWNpZmllZCBjb25uZWN0aW9uLCBwcm92aWRpbmcgdGhlIGJpbmRpbmdzXG4gIC8vIGFuZCBhbnkgb3RoZXIgbmVjZXNzYXJ5IHByZXAgd29yay5cbiAgX3F1ZXJ5OiBmdW5jdGlvbiBfcXVlcnkoY29ubmVjdGlvbiwgb2JqKSB7XG4gICAgaWYgKCFvYmogfHwgdHlwZW9mIG9iaiA9PT0gJ3N0cmluZycpIG9iaiA9IHsgc3FsOiBvYmogfTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgICAgdmFyIHNxbCA9IG9iai5zcWw7XG4gICAgICBpZiAoIXNxbCkgcmV0dXJuIHJlc29sdmVyKCk7XG5cbiAgICAgIGNvbm5lY3Rpb24ucXVlcnkoc3FsLCBvYmouYmluZGluZ3MsIGZ1bmN0aW9uIChlcnIsIHJvd3MsIGZpZWxkcykge1xuICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0ZXIoZXJyKTtcbiAgICAgICAgb2JqLnJlc3BvbnNlID0gW3Jvd3MsIGZpZWxkcywgb2JqLmJpbmRpbmdzXTtcbiAgICAgICAgcmVzb2x2ZXIob2JqKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9LFxuXG4gIC8vIFByb2Nlc3MgdGhlIHJlc3BvbnNlIGFzIHJldHVybmVkIGZyb20gdGhlIHF1ZXJ5LlxuICBwcm9jZXNzUmVzcG9uc2U6IGZ1bmN0aW9uIHByb2Nlc3NSZXNwb25zZShvYmosIHJ1bm5lcikge1xuICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuO1xuICAgIHZhciByZXNwb25zZSA9IG9iai5yZXNwb25zZTtcbiAgICB2YXIgbWV0aG9kID0gb2JqLm1ldGhvZDtcbiAgICB2YXIgcm93cyA9IHJlc3BvbnNlWzBdO1xuICAgIHZhciBmaWVsZHMgPSByZXNwb25zZVsxXTtcbiAgICB2YXIgYmluZGluZ3MgPSByZXNwb25zZVsyXTtcbiAgICBpZiAob2JqLm91dHB1dCkgcmV0dXJuIG9iai5vdXRwdXQuY2FsbChydW5uZXIsIHJvd3MsIGZpZWxkcyk7XG4gICAgc3dpdGNoIChtZXRob2QpIHtcbiAgICAgIGNhc2UgJ3NlbGVjdCc6XG4gICAgICBjYXNlICdwbHVjayc6XG4gICAgICBjYXNlICdmaXJzdCc6XG4gICAgICAgIHZhciByZXNwID0gaGVscGVycy5za2ltKHJvd3MpO1xuICAgICAgICBpZiAobWV0aG9kID09PSAncGx1Y2snKSByZXR1cm4gcGx1Y2socmVzcCwgb2JqLnBsdWNrKTtcbiAgICAgICAgcmV0dXJuIG1ldGhvZCA9PT0gJ2ZpcnN0JyA/IHJlc3BbMF0gOiByZXNwO1xuICAgICAgY2FzZSAnaW5zZXJ0JzpcbiAgICAgICAgcmV0dXJuIGJpbmRpbmdzO1xuICAgICAgY2FzZSAnZGVsJzpcbiAgICAgIGNhc2UgJ3VwZGF0ZSc6XG4gICAgICBjYXNlICdjb3VudGVyJzpcbiAgICAgICAgaWYgKHJvd3MgJiYgcm93cy5hZmZlY3RlZFJvd3MpIHtcbiAgICAgICAgICAgIHJvd3MuYWZmZWN0ZWRSb3dzXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByb3dzID0ge31cbiAgICAgICAgICAgIHJvd3MuYWZmZWN0ZWRSb3dzID0gWzBdXG4gICAgICAgIH0gICAgICBcbiAgICAgICAgcmV0dXJuIHJvd3MuYWZmZWN0ZWRSb3dzO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIGJpbmRpbmdzO1xuICAgIH1cbiAgfVxuXG59KTtcblxuLy8gRmlyZWJpcmQgU3BlY2lmaWMgZXJyb3IgaGFuZGxlclxuZnVuY3Rpb24gY29ubmVjdGlvbkVycm9ySGFuZGxlcihjbGllbnQsIGNvbm5lY3Rpb24sIGVycikge1xuICBpZiAoY29ubmVjdGlvbiAmJiBlcnIgJiYgZXJyLmZhdGFsKSB7XG4gICAgaWYgKGNvbm5lY3Rpb24uX19rbmV4X19kaXNwb3NlZCkgcmV0dXJuO1xuICAgIGNvbm5lY3Rpb24uX19rbmV4X19kaXNwb3NlZCA9IHRydWU7XG4gICAgY2xpZW50LnBvb2wuZGVzdHJveShjb25uZWN0aW9uKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IENsaWVudF9GaXJlYmlyZDsiXX0=