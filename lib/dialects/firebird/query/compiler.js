
// Firebird Query Compiler
// ------
'use strict';
var _ = require('lodash');
var inherits = require('inherits');
var QueryCompiler = require('../../../query/compiler');
var assign = require('lodash/object/assign');

function QueryCompiler_Firebird(client, builder) {
    QueryCompiler.call(this, client, builder);
}
inherits(QueryCompiler_Firebird, QueryCompiler);

assign(QueryCompiler_Firebird.prototype, {

    _emptyInsertValue: '() values ()',

    columnizeWithPrefix: function columnizeWithPrefix(prefix, target) {
        var columns = typeof target === 'string' ? [target] : target;
        var str = '',
            i = -1;
        while (++i < columns.length) {
            if (i > 0) str += ', ';
            str += prefix + this.wrap(columns[i]);
        }
        return str;
    },
    insert: function insert() {
        var insertValues = this.single.insert || [];
        if (Array.isArray(insertValues)) {
            var sql = 'insert into ' + this.tableName + ' ';
            var returning = this.single.returning;
            var returningSql = returning ? this._returning('insert', returning) + ' ' : '';

            if (insertValues.length === 0) {
                return '';
            }

            var insertData = this._prepInsert(insertValues);
            sql += '(' + this.formatter.columnize(insertData.columns) + ') values (';
            if (typeof insertData === 'string') {
                sql += insertData;
            } else {
                if (insertData.columns.length) {
                    var i = -1;
                    while (++i < insertData.values.length) {
                        if (i !== 0) sql += ' insert into ' + this.tableName + '(' + this.formatter.columnize(insertData.columns) + ') values (';
                        sql += this.formatter.parameterize(insertData.values[i]) + ');';
                    }
                    sql += ' end';
                } else if (insertValues.length === 1 && insertValues[0]) {
                    sql += returningSql + this._emptyInsertValue;
                } else {
                    sql = '';
                }
            }
            sql = 'execute block as begin ' + sql;
        } else {

            var sql = 'insert into ' + this.tableName + ' ';

            if (Array.isArray(insertValues)) {
                if (insertValues.length === 0) {
                    return '';
                }
            } else if (typeof insertValues === 'object' && _.isEmpty(insertValues)) {
                return sql + this._emptyInsertValue;
            }

            var insertData = this._prepInsert(insertValues);
            if (typeof insertData === 'string') {
                sql += insertData;
            } else {
                if (insertData.columns.length) {
                    sql += '(' + this.formatter.columnize(insertData.columns);
                    sql += ') values (';
                    var i = -1;
                    while (++i < insertData.values.length) {
                        if (i !== 0) sql += '), (';
                        sql += this.formatter.parameterize(insertData.values[i]);
                    }
                    sql += ')';
                } else if (insertValues.length === 1 && insertValues[0]) {
                    sql += this._emptyInsertValue;
                } else {
                    sql = '';
                }
            }
        }

        return {
            sql: sql,
            returning: returning
        };
    },

    // Update method, including joins, wheres, order & limits.
    update: function update() {
        var join = this.join();
        var updates = this._prepUpdate(this.single.update);
        var where = this.where();
        var order = this.order();
        var limit = this.limit();
        return 'update ' + this.tableName + (join ? ' ' + join : '') + ' set ' + updates.join(', ') + (where ? ' ' + where : '') + (order ? ' ' + order : '') + (limit ? ' ' + limit : '');
    },

    // Compiles a `columnInfo` query.
    columnInfo: function columnInfo() {
        var column = this.single.columnInfo;
        return {
            sql: 'select * from information_schema.columns where table_name = ? and table_schema = ?',
            bindings: [this.single.table, this.client.database()],
            output: function output(resp) {
                var out = resp.reduce(function (columns, val) {
                    columns[val.COLUMN_NAME] = {
                        defaultValue: val.COLUMN_DEFAULT,
                        type: val.DATA_TYPE,
                        maxLength: val.CHARACTER_MAXIMUM_LENGTH,
                        nullable: val.IS_NULLABLE === 'YES'
                    };
                    return columns;
                }, {});
                return column && out[column] || out;
            }
        };
    },

    limit: function limit() {
        var noLimit = !this.single.limit && this.single.limit !== 0;
        if (noLimit && !this.single.offset) return '';

        return 'first  ' + (this.single.offset && noLimit ? '18446744073709551615' : this.formatter.parameter(this.single.limit));
    }

});

// Set the QueryBuilder & QueryCompiler on the client object,
// incase anyone wants to modify things to suit their own purposes.
module.exports = QueryCompiler_Firebird;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9maXJlYmlyZC9xdWVyeS9jb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSxZQUFZLENBQUM7QUFDYixJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDMUIsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ25DLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0FBQ3ZELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDOztBQUU3QyxTQUFTLHNCQUFzQixDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUU7QUFDL0MsaUJBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztDQUMzQztBQUNELFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxhQUFhLENBQUMsQ0FBQzs7QUFFaEQsTUFBTSxDQUFDLHNCQUFzQixDQUFDLFNBQVMsRUFBRTs7QUFFdkMscUJBQWlCLEVBQUUsY0FBYzs7QUFFakMsdUJBQW1CLEVBQUUsU0FBUyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFO0FBQ2hFLFlBQUksT0FBTyxHQUFHLE9BQU8sTUFBTSxLQUFLLFFBQVEsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQztBQUM3RCxZQUFJLEdBQUcsR0FBRyxFQUFFO1lBQ1IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ1gsZUFBTyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFO0FBQzNCLGdCQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxJQUFJLElBQUksQ0FBQztBQUN2QixlQUFHLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDdkM7QUFDRCxlQUFP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LFNBQVMsS0FBSyxHQUFHO0FBQ3RCLFlBQUksT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDO0FBQzVELFlBQUksT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUM7O0FBRTlDLGVBQU8sU0FBUyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFJLE9BQU8sR0FBRyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBLEFBQUMsQ0FBQztLQUMzSDs7Q0FFRixDQUFDLENBQUM7Ozs7QUFJSCxNQUFNLENBQUMsT0FBTyxHQUFHLHNCQUFzQixDQUFDIiwiZmlsZSI6ImNvbXBpbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBGaXJlYmlyZCBRdWVyeSBDb21waWxlclxuLy8gLS0tLS0tXG4ndXNlIHN0cmljdCc7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTtcbnZhciBRdWVyeUNvbXBpbGVyID0gcmVxdWlyZSgnLi4vLi4vLi4vcXVlcnkvY29tcGlsZXInKTtcbnZhciBhc3NpZ24gPSByZXF1aXJlKCdsb2Rhc2gvb2JqZWN0L2Fzc2lnbicpO1xuXG5mdW5jdGlvbiBRdWVyeUNvbXBpbGVyX0ZpcmViaXJkKGNsaWVudCwgYnVpbGRlcikge1xuICBRdWVyeUNvbXBpbGVyLmNhbGwodGhpcywgY2xpZW50LCBidWlsZGVyKTtcbn1cbmluaGVyaXRzKFF1ZXJ5Q29tcGlsZXJfRmlyZWJpcmQsIFF1ZXJ5Q29tcGlsZXIpO1xuXG5hc3NpZ24oUXVlcnlDb21waWxlcl9GaXJlYmlyZC5wcm90b3R5cGUsIHtcblxuICBfZW1wdHlJbnNlcnRWYWx1ZTogJygpIHZhbHVlcyAoKScsXG5cbiAgY29sdW1uaXplV2l0aFByZWZpeDogZnVuY3Rpb24gY29sdW1uaXplV2l0aFByZWZpeChwcmVmaXgsIHRhcmdldCkge1xuICAgIHZhciBjb2x1bW5zID0gdHlwZW9mIHRhcmdldCA9PT0gJ3N0cmluZycgPyBbdGFyZ2V0XSA6IHRhcmdldDtcbiAgICB2YXIgc3RyID0gJycsXG4gICAgICAgIGkgPSAtMTtcbiAgICB3aGlsZSAoKytpIDwgY29sdW1ucy5sZW5ndGgpIHtcbiAgICAgIGlmIChpID4gMCkgc3RyICs9ICcsICc7XG4gICAgICBzdHIgKz0gcHJlZml4ICsgdGhpcy53cmFwKGNvbHVtbnNbaV0pO1xuICAgIH1cbiAgICByZXR1cm4gc3RyO1xuICB9LFxuICAgIGluc2VydDogZnVuY3Rpb24gaW5zZXJ0KCkge1xuICAgICAgICB2YXIgaW5zZXJ0VmFsdWVzID0gdGhpcy5zaW5nbGUuaW5zZXJ0IHx8IFtdO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShpbnNlcnRWYWx1ZXMpKSB7XG4gICAgICAgICAgICB2YXIgc3FsID0gJ2luc2VydCBpbnRvICcgKyB0aGlzLnRhYmxlTmFtZSArICcgJztcbiAgICAgICAgICAgIHZhciByZXR1cm5pbmcgPSB0aGlzLnNpbmdsZS5yZXR1cm5pbmc7XG4gICAgICAgICAgICB2YXIgcmV0dXJuaW5nU3FsID0gcmV0dXJuaW5nID8gdGhpcy5fcmV0dXJuaW5nKCdpbnNlcnQnLCByZXR1cm5pbmcpICsgJyAnIDogJyc7XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0VmFsdWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgaW5zZXJ0RGF0YSA9IHRoaXMuX3ByZXBJbnNlcnQoaW5zZXJ0VmFsdWVzKTtcbiAgICAgICAgICAgIHNxbCArPSAnKCcgKyB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoaW5zZXJ0RGF0YS5jb2x1bW5zKSArICcpIHZhbHVlcyAoJ1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnNlcnREYXRhID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHNxbCArPSBpbnNlcnREYXRhO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0RGF0YS5jb2x1bW5zLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IC0xO1xuICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKytpIDwgaW5zZXJ0RGF0YS52YWx1ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSAhPT0gMClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcWwgKz0gJyBpbnNlcnQgaW50byAnICsgdGhpcy50YWJsZU5hbWUgKyAnKCcgKyB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoaW5zZXJ0RGF0YS5jb2x1bW5zKSArICcpIHZhbHVlcyAoJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHNxbCArPSB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXJpemUoaW5zZXJ0RGF0YS52YWx1ZXNbaV0pICsgJyk7JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzcWwgKz0gJyBlbmQnO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zZXJ0VmFsdWVzLmxlbmd0aCA9PT0gMSAmJiBpbnNlcnRWYWx1ZXNbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3FsICs9IHJldHVybmluZ1NxbCArIHRoaXMuX2VtcHR5SW5zZXJ0VmFsdWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3FsID0gJyc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3FsID0gJ2V4ZWN1dGUgYmxvY2sgYXMgYmVnaW4gJyArIHNxbFxuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgIFxuXHQgICAgdmFyIHNxbCA9ICdpbnNlcnQgaW50byAnICsgdGhpcy50YWJsZU5hbWUgKyAnICc7XG5cblx0ICAgIGlmIChBcnJheS5pc0FycmF5KGluc2VydFZhbHVlcykpIHtcblx0ICAgICAgaWYgKGluc2VydFZhbHVlcy5sZW5ndGggPT09IDApIHtcblx0ICAgICAgICByZXR1cm4gJyc7XG5cdCAgICAgIH1cblx0ICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc2VydFZhbHVlcyA9PT0gJ29iamVjdCcgJiYgXy5pc0VtcHR5KGluc2VydFZhbHVlcykpIHtcblx0ICAgICAgcmV0dXJuIHNxbCArIHRoaXMuX2VtcHR5SW5zZXJ0VmFsdWU7XG5cdCAgICB9XG4gICAgICAgICAgICBcblx0ICAgIHZhciBpbnNlcnREYXRhID0gdGhpcy5fcHJlcEluc2VydChpbnNlcnRWYWx1ZXMpO1xuXHQgICAgaWYgKHR5cGVvZiBpbnNlcnREYXRhID09PSAnc3RyaW5nJykge1xuXHQgICAgICBzcWwgKz0gaW5zZXJ0RGF0YTtcblx0ICAgIH0gZWxzZSB7XG5cdCAgICAgIGlmIChpbnNlcnREYXRhLmNvbHVtbnMubGVuZ3RoKSB7XG5cdCAgICAgICAgc3FsICs9ICcoJyArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShpbnNlcnREYXRhLmNvbHVtbnMpO1xuXHQgICAgICAgIHNxbCArPSAnKSB2YWx1ZXMgKCc7XG5cdCAgICAgICAgdmFyIGkgPSAtMTtcblx0ICAgICAgICB3aGlsZSAoKytpIDwgaW5zZXJ0RGF0YS52YWx1ZXMubGVuZ3RoKSB7XG5cdCAgICAgICAgICBpZiAoaSAhPT0gMCkgc3FsICs9ICcpLCAoJztcblx0ICAgICAgICAgIHNxbCArPSB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXJpemUoaW5zZXJ0RGF0YS52YWx1ZXNbaV0pO1xuXHQgICAgICAgIH1cblx0ICAgICAgICBzcWwgKz0gJyknO1xuXHQgICAgICB9IGVsc2UgaWYgKGluc2VydFZhbHVlcy5sZW5ndGggPT09IDEgJiYgaW5zZXJ0VmFsdWVzWzBdKSB7XG5cdCAgICAgICAgc3FsICs9IHRoaXMuX2VtcHR5SW5zZXJ0VmFsdWU7XG5cdCAgICAgIH0gZWxzZSB7XG5cdCAgICAgICAgc3FsID0gJyc7XG5cdCAgICAgIH1cblx0ICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHNxbDogc3FsLFxuICAgICAgICAgICAgcmV0dXJuaW5nOiByZXR1cm5pbmdcbiAgICAgICAgfTtcbiAgICB9LFxuXG4gIC8vIFVwZGF0ZSBtZXRob2QsIGluY2x1ZGluZyBqb2lucywgd2hlcmVzLCBvcmRlciAmIGxpbWl0cy5cbiAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUoKSB7XG4gICAgdmFyIGpvaW4gPSB0aGlzLmpvaW4oKTtcbiAgICB2YXIgdXBkYXRlcyA9IHRoaXMuX3ByZXBVcGRhdGUodGhpcy5zaW5nbGUudXBkYXRlKTtcbiAgICB2YXIgd2hlcmUgPSB0aGlzLndoZXJlKCk7XG4gICAgdmFyIG9yZGVyID0gdGhpcy5vcmRlcigpO1xuICAgIHZhciBsaW1pdCA9IHRoaXMubGltaXQoKTtcbiAgICByZXR1cm4gJ3VwZGF0ZSAnICsgdGhpcy50YWJsZU5hbWUgKyAoam9pbiA/ICcgJyArIGpvaW4gOiAnJykgKyAnIHNldCAnICsgdXBkYXRlcy5qb2luKCcsICcpICsgKHdoZXJlID8gJyAnICsgd2hlcmUgOiAnJykgKyAob3JkZXIgPyAnICcgKyBvcmRlciA6ICcnKSArIChsaW1pdCA/ICcgJyArIGxpbWl0IDogJycpO1xuICB9LFxuXG4gIC8vIENvbXBpbGVzIGEgYGNvbHVtbkluZm9gIHF1ZXJ5LlxuICBjb2x1bW5JbmZvOiBmdW5jdGlvbiBjb2x1bW5JbmZvKCkge1xuICAgIHZhciBjb2x1bW4gPSB0aGlzLnNpbmdsZS5jb2x1bW5JbmZvO1xuICAgIHJldHVybiB7XG4gICAgICBzcWw6ICdzZWxlY3QgKiBmcm9tIGluZm9ybWF0aW9uX3NjaGVtYS5jb2x1bW5zIHdoZXJlIHRhYmxlX25hbWUgPSA/IGFuZCB0YWJsZV9zY2hlbWEgPSA/JyxcbiAgICAgIGJpbmRpbmdzOiBbdGhpcy5zaW5nbGUudGFibGUsIHRoaXMuY2xpZW50LmRhdGFiYXNlKCldLFxuICAgICAgb3V0cHV0OiBmdW5jdGlvbiBvdXRwdXQocmVzcCkge1xuICAgICAgICB2YXIgb3V0ID0gcmVzcC5yZWR1Y2UoZnVuY3Rpb24gKGNvbHVtbnMsIHZhbCkge1xuICAgICAgICAgIGNvbHVtbnNbdmFsLkNPTFVNTl9OQU1FXSA9IHtcbiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdmFsLkNPTFVNTl9ERUZBVUxULFxuICAgICAgICAgICAgdHlwZTogdmFsLkRBVEFfVFlQRSxcbiAgICAgICAgICAgIG1heExlbmd0aDogdmFsLkNIQVJBQ1RFUl9NQVhJTVVNX0xFTkdUSCxcbiAgICAgICAgICAgIG51bGxhYmxlOiB2YWwuSVNfTlVMTEFCTEUgPT09ICdZRVMnXG4gICAgICAgICAgfTtcbiAgICAgICAgICByZXR1cm4gY29sdW1ucztcbiAgICAgICAgfSwge30pO1xuICAgICAgICByZXR1cm4gY29sdW1uICYmIG91dFtjb2x1bW5dIHx8IG91dDtcbiAgICAgIH1cbiAgICB9O1xuICB9LFxuXG4gIGxpbWl0OiBmdW5jdGlvbiBsaW1pdCgpIHtcbiAgICB2YXIgbm9MaW1pdCA9ICF0aGlzLnNpbmdsZS5saW1pdCAmJiB0aGlzLnNpbmdsZS5saW1pdCAhPT0gMDtcbiAgICBpZiAobm9MaW1pdCAmJiAhdGhpcy5zaW5nbGUub2Zmc2V0KSByZXR1cm4gJyc7XG5cbiAgICByZXR1cm4gJ2ZpcnN0ICAnICsgKHRoaXMuc2luZ2xlLm9mZnNldCAmJiBub0xpbWl0ID8gJzE4NDQ2NzQ0MDczNzA5NTUxNjE1JyA6IHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnNpbmdsZS5saW1pdCkpO1xuICB9XG5cbn0pO1xuXG4vLyBTZXQgdGhlIFF1ZXJ5QnVpbGRlciAmIFF1ZXJ5Q29tcGlsZXIgb24gdGhlIGNsaWVudCBvYmplY3QsXG4vLyBpbmNhc2UgYW55b25lIHdhbnRzIHRvIG1vZGlmeSB0aGluZ3MgdG8gc3VpdCB0aGVpciBvd24gcHVycG9zZXMuXG5tb2R1bGUuZXhwb3J0cyA9IFF1ZXJ5Q29tcGlsZXJfRmlyZWJpcmQ7Il19