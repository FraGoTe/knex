
// Oracle Query Builder & Compiler
// ------
'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var QueryCompiler = require('../../../query/compiler');
var helpers = require('../../../helpers');
var assign = require('lodash/object/assign');
var ReturningHelper = require('../utils').ReturningHelper;

// Query Compiler
// -------

// Set the "Formatter" to use for the queries,
// ensuring that all parameterized values (even across sub-queries)
// are properly built into the same query.
function QueryCompiler_Oracle(client, builder) {
  QueryCompiler.call(this, client, builder);
}
inherits(QueryCompiler_Oracle, QueryCompiler);

assign(QueryCompiler_Oracle.prototype, {

  // Compiles an "insert" query, allowing for multiple
  // inserts using a single query statement.
  insert: function insert() {
    var insertValues = this.single.insert || [];
    var returning = this.single.returning;

    if (!Array.isArray(insertValues) && _.isPlainObject(this.single.insert)) {
      insertValues = [this.single.insert];
    }

    // always wrap returning argument in array
    if (returning && !Array.isArray(returning)) {
      returning = [returning];
    }

    if (Array.isArray(insertValues) && insertValues.length === 1 && _.isEmpty(insertValues[0])) {
      return this._addReturningToSqlAndConvert('insert into ' + this.tableName + ' (' + this.formatter.wrap(this.single.returning) + ') values (default)', returning, this.tableName);
    }

    if (_.isEmpty(this.single.insert) && typeof this.single.insert !== 'function') {
      return '';
    }

    var insertData = this._prepInsert(insertValues);

    var sql = {};

    if (_.isString(insertData)) {
      return this._addReturningToSqlAndConvert('insert into ' + this.tableName + ' ' + insertData, returning);
    }

    if (insertData.values.length === 1) {
      return this._addReturningToSqlAndConvert('insert into ' + this.tableName + ' (' + this.formatter.columnize(insertData.columns) + ') values (' + this.formatter.parameterize(insertData.values[0]) + ')', returning, this.tableName);
    }

    var insertDefaultsOnly = insertData.columns.length === 0;

    sql.sql = 'begin ' + _.map(insertData.values, function (value) {
      var returningHelper;
      var parameterizedValues = !insertDefaultsOnly ? this.formatter.parameterize(value) : '';
      var returningValues = Array.isArray(returning) ? returning : [returning];
      var subSql = 'insert into ' + this.tableName + ' ';

      if (returning) {
        returningHelper = new ReturningHelper(returningValues.join(':'));
        sql.outParams = (sql.outParams || []).concat(returningHelper);
      }

      if (insertDefaultsOnly) {
        // no columns given so only the default value
        subSql += '(' + this.formatter.wrap(this.single.returning) + ') values (default)';
      } else {
        subSql += '(' + this.formatter.columnize(insertData.columns) + ') values (' + parameterizedValues + ')';
      }
      subSql += returning ? ' returning ROWID into ' + this.formatter.parameter(returningHelper) : '';

      // pre bind position because subSql is an execute immediate parameter
      // later position binding will only convert the ? params
      subSql = this.formatter.client.positionBindings(subSql);
      return 'execute immediate \'' + subSql.replace(/'/g, "''") + (parameterizedValues || returning ? '\' using ' : '') + parameterizedValues + (parameterizedValues && returning ? ', ' : '') + (returning ? 'out ?' : '') + ';';
    }, this).join(' ') + 'end;';

    if (returning) {
      sql.returning = returning;
      // generate select statement with special order by to keep the order because 'in (..)' may change the order
      sql.returningSql = 'select ' + this.formatter.columnize(returning) + ' from ' + this.tableName + ' where ROWID in (' + sql.outParams.map(function (v, i) {
        return ':' + (i + 1);
      }).join(', ') + ')' + ' order by case ROWID ' + sql.outParams.map(function (v, i) {
        return 'when CHARTOROWID(:' + (i + 1) + ') then ' + i;
      }).join(' ') + ' end';
    }

    return sql;
  },

  // Update method, including joins, wheres, order & limits.
  update: function update() {
    var updates = this._prepUpdate(this.single.update);
    var where = this.where();
    return 'update ' + this.tableName + ' set ' + updates.join(', ') + (where ? ' ' + where : '');
  },

  // Compiles a `truncate` query.
  truncate: function truncate() {
    return 'truncate table ' + this.tableName;
  },

  forUpdate: function forUpdate() {
    return 'for update';
  },

  forShare: function forShare() {
    // lock for share is not directly supported by oracle
    // use LOCK TABLE .. IN SHARE MODE; instead
    helpers.warn('lock for share is not supported by oracle dialect');
    return '';
  },

  // Compiles a `columnInfo` query.
  columnInfo: function columnInfo() {
    var column = this.single.columnInfo;
    return {
      sql: 'select COLUMN_NAME, DATA_TYPE, CHAR_COL_DECL_LENGTH, NULLABLE from USER_TAB_COLS where TABLE_NAME = :1',
      bindings: [this.single.table],
      output: function output(resp) {
        var out = _.reduce(resp, function (columns, val) {
          columns[val.COLUMN_NAME] = {
            type: val.DATA_TYPE,
            maxLength: val.CHAR_COL_DECL_LENGTH,
            nullable: val.NULLABLE === 'Y'
          };
          return columns;
        }, {});
        return column && out[column] || out;
      }
    };
  },

  select: function select() {
    var statements = _.map(components, function (component) {
      return this[component]();
    }, this);
    var query = _.compact(statements).join(' ');
    return this._surroundQueryWithLimitAndOffset(query);
  },

  aggregate: function aggregate(stmt) {
    var val = stmt.value;
    var splitOn = val.toLowerCase().indexOf(' as ');
    var distinct = stmt.aggregateDistinct ? 'distinct ' : '';
    // Allows us to speciy an alias for the aggregate types.
    if (splitOn !== -1) {
      var col = val.slice(0, splitOn);
      var alias = val.slice(splitOn + 4);
      return stmt.method + '(' + distinct + this.formatter.wrap(col) + ') ' + this.formatter.wrap(alias);
    }
    return stmt.method + '(' + distinct + this.formatter.wrap(val) + ')';
  },

  // for single commands only
  _addReturningToSqlAndConvert: function _addReturningToSqlAndConvert(sql, returning, tableName) {
    var res = {
      sql: sql
    };

    if (!returning) {
      return res;
    }

    var returningValues = Array.isArray(returning) ? returning : [returning];
    var returningHelper = new ReturningHelper(returningValues.join(':'));
    res.sql = sql + ' returning ROWID into ' + this.formatter.parameter(returningHelper);
    res.returningSql = 'select ' + this.formatter.columnize(returning) + ' from ' + tableName + ' where ROWID = :1';
    res.outParams = [returningHelper];
    res.returning = returning;
    return res;
  },

  _surroundQueryWithLimitAndOffset: function _surroundQueryWithLimitAndOffset(query) {
    var limit = this.single.limit;
    var offset = this.single.offset;
    var hasLimit = limit || limit === 0 || limit === '0';
    limit = +limit;

    if (!hasLimit && !offset) return query;
    query = query || "";

    if (hasLimit && !offset) {
      return "select * from (" + query + ") where rownum <= " + this.formatter.parameter(limit);
    }

    var endRow = +offset + (hasLimit ? limit : 10000000000000);

    return "select * from " + "(select row_.*, ROWNUM rownum_ from (" + query + ") row_ " + "where rownum <= " + this.formatter.parameter(endRow) + ") " + "where rownum_ > " + this.formatter.parameter(offset);
  }

});

// Compiles the `select` statement, or nested sub-selects
// by calling each of the component compilers, trimming out
// the empties, and returning a generated query string.
QueryCompiler_Oracle.prototype.first = QueryCompiler_Oracle.prototype.select;

var components = ['columns', 'join', 'where', 'union', 'group', 'having', 'order', 'lock'];

module.exports = QueryCompiler_Oracle;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9vcmFjbGUvcXVlcnkvY29tcGlsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFHQSxJQUFJLENBQUMsR0FBaUIsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3hDLElBQUksUUFBUSxHQUFVLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMxQyxJQUFJLGFBQWEsR0FBSyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQztBQUN6RCxJQUFJLE9BQU8sR0FBVyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUNsRCxJQUFJLE1BQU0sR0FBWSxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUN0RCxJQUFJLGVBQWUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsZUFBZSxDQUFDOzs7Ozs7OztBQVExRCxTQUFTLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUU7QUFDN0MsZUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFBO0NBQzFDO0FBQ0QsUUFBUSxDQUFDLG9CQUFvQixFQUFFLGFBQWEsQ0FBQyxDQUFBOztBQUU3QyxNQUFNLENBQUMsb0JBQW9CLENBQUMsU0FBUyxFQUFFOzs7O0FBSXJDLFFBQU0sRUFBRSxrQkFBVztBQUNqQixRQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUE7QUFDM0MsUUFBSSxTQUFTLEdBQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7O0FBRXpDLFFBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRTtBQUN2RSxrQkFBWSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQTtLQUNw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QUMsR0FBRyxJQUFJLEdBQzVELGtCQUFrQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0dBQzlEOztDQUVGLENBQUMsQ0FBQTs7Ozs7QUFLRixvQkFBb0IsQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUE7O0FBRTVFLElBQUksVUFBVSxHQUFHLENBQ2YsU0FBUyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFDNUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQzFCLENBQUM7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxvQkFBb0IsQ0FBQyIsImZpbGUiOiJjb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLy8gT3JhY2xlIFF1ZXJ5IEJ1aWxkZXIgJiBDb21waWxlclxuLy8gLS0tLS0tXG52YXIgXyAgICAgICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgaW5oZXJpdHMgICAgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTtcbnZhciBRdWVyeUNvbXBpbGVyICAgPSByZXF1aXJlKCcuLi8uLi8uLi9xdWVyeS9jb21waWxlcicpO1xudmFyIGhlbHBlcnMgICAgICAgICA9IHJlcXVpcmUoJy4uLy4uLy4uL2hlbHBlcnMnKTtcbnZhciBhc3NpZ24gICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gvb2JqZWN0L2Fzc2lnbicpO1xudmFyIFJldHVybmluZ0hlbHBlciA9IHJlcXVpcmUoJy4uL3V0aWxzJykuUmV0dXJuaW5nSGVscGVyO1xuXG4vLyBRdWVyeSBDb21waWxlclxuLy8gLS0tLS0tLVxuXG4vLyBTZXQgdGhlIFwiRm9ybWF0dGVyXCIgdG8gdXNlIGZvciB0aGUgcXVlcmllcyxcbi8vIGVuc3VyaW5nIHRoYXQgYWxsIHBhcmFtZXRlcml6ZWQgdmFsdWVzIChldmVuIGFjcm9zcyBzdWItcXVlcmllcylcbi8vIGFyZSBwcm9wZXJseSBidWlsdCBpbnRvIHRoZSBzYW1lIHF1ZXJ5LlxuZnVuY3Rpb24gUXVlcnlDb21waWxlcl9PcmFjbGUoY2xpZW50LCBidWlsZGVyKSB7XG4gIFF1ZXJ5Q29tcGlsZXIuY2FsbCh0aGlzLCBjbGllbnQsIGJ1aWxkZXIpXG59XG5pbmhlcml0cyhRdWVyeUNvbXBpbGVyX09yYWNsZSwgUXVlcnlDb21waWxlcilcblxuYXNzaWduKFF1ZXJ5Q29tcGlsZXJfT3JhY2xlLnByb3RvdHlwZSwge1xuXG4gIC8vIENvbXBpbGVzIGFuIFwiaW5zZXJ0XCIgcXVlcnksIGFsbG93aW5nIGZvciBtdWx0aXBsZVxuICAvLyBpbnNlcnRzIHVzaW5nIGEgc2luZ2xlIHF1ZXJ5IHN0YXRlbWVudC5cbiAgaW5zZXJ0OiBmdW5jdGlvbigpIHtcbiAgICB2YXIgaW5zZXJ0VmFsdWVzID0gdGhpcy5zaW5nbGUuaW5zZXJ0IHx8IFtdXG4gICAgdmFyIHJldHVybmluZyAgICA9IHRoaXMuc2luZ2xlLnJldHVybmluZztcblxuICAgIGlmICghQXJyYXkuaXNBcnJheShpbnNlcnRWYWx1ZXMpICYmIF8uaXNQbGFpbk9iamVjdCh0aGlzLnNpbmdsZS5pbnNlcnQpKSB7XG4gICAgICBpbnNlcnRWYWx1ZXMgPSBbdGhpcy5zaW5nbGUuaW5zZXJ0XVxuICAgIH1cblxuICAgIC8vIGFsd2F5cyB3cmFwIHJldHVybmluZyBhcmd1bWVudCBpbiBhcnJheVxuICAgIGlmIChyZXR1cm5pbmcgJiYgIUFycmF5LmlzQXJyYXkocmV0dXJuaW5nKSkge1xuICAgICAgcmV0dXJuaW5nID0gW3JldHVybmluZ107XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoaW5zZXJ0VmFsdWVzKSAmJiBpbnNlcnRWYWx1ZXMubGVuZ3RoID09PSAxICYmIF8uaXNFbXB0eShpbnNlcnRWYWx1ZXNbMF0pKSB7XG4gICAgICByZXR1cm4gdGhpcy5fYWRkUmV0dXJuaW5nVG9TcWxBbmRDb252ZXJ0KCdpbnNlcnQgaW50byAnICsgdGhpcy50YWJsZU5hbWUgKyAnICgnICsgdGhpcy5mb3JtYXR0ZXIud3JhcCh0aGlzLnNpbmdsZS5yZXR1cm5pbmcpICsgJykgdmFsdWVzIChkZWZhdWx0KScsIHJldHVybmluZywgdGhpcy50YWJsZU5hbWUpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkodGhpcy5zaW5nbGUuaW5zZXJ0KSAmJiB0eXBlb2YgdGhpcy5zaW5nbGUuaW5zZXJ0ICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgdmFyIGluc2VydERhdGEgPSB0aGlzLl9wcmVwSW5zZXJ0KGluc2VydFZhbHVlcyk7XG5cbiAgICB2YXIgc3FsID0ge307XG5cbiAgICBpZiAoXy5pc1N0cmluZyhpbnNlcnREYXRhKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2FkZFJldHVybmluZ1RvU3FsQW5kQ29udmVydCgnaW5zZXJ0IGludG8gJyArIHRoaXMudGFibGVOYW1lICsgJyAnICsgaW5zZXJ0RGF0YSwgcmV0dXJuaW5nKTtcbiAgICB9XG5cbiAgICBpZiAoaW5zZXJ0RGF0YS52YWx1ZXMubGVuZ3RoID09PSAxKSB7XG4gICAgICByZXR1cm4gdGhpcy5fYWRkUmV0dXJuaW5nVG9TcWxBbmRDb252ZXJ0KCdpbnNlcnQgaW50byAnICsgdGhpcy50YWJsZU5hbWUgKyAnICgnICsgdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGluc2VydERhdGEuY29sdW1ucykgKyAnKSB2YWx1ZXMgKCcgKyB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXJpemUoaW5zZXJ0RGF0YS52YWx1ZXNbMF0pICsgJyknLCByZXR1cm5pbmcsIHRoaXMudGFibGVOYW1lKTtcbiAgICB9XG5cbiAgICB2YXIgaW5zZXJ0RGVmYXVsdHNPbmx5ID0gKGluc2VydERhdGEuY29sdW1ucy5sZW5ndGggPT09IDApO1xuXG4gICAgc3FsLnNxbCA9ICdiZWdpbiAnICtcbiAgICAgIF8ubWFwKGluc2VydERhdGEudmFsdWVzLCBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICB2YXIgcmV0dXJuaW5nSGVscGVyO1xuICAgICAgICAgIHZhciBwYXJhbWV0ZXJpemVkVmFsdWVzID0gIWluc2VydERlZmF1bHRzT25seSA/IHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcml6ZSh2YWx1ZSkgOiAnJztcbiAgICAgICAgICB2YXIgcmV0dXJuaW5nVmFsdWVzID0gQXJyYXkuaXNBcnJheShyZXR1cm5pbmcpID8gcmV0dXJuaW5nIDogW3JldHVybmluZ107XG4gICAgICAgICAgdmFyIHN1YlNxbCA9ICdpbnNlcnQgaW50byAnICsgdGhpcy50YWJsZU5hbWUgKyAnICc7XG5cbiAgICAgICAgICBpZiAocmV0dXJuaW5nKSB7XG4gICAgICAgICAgICByZXR1cm5pbmdIZWxwZXIgPSBuZXcgUmV0dXJuaW5nSGVscGVyKHJldHVybmluZ1ZhbHVlcy5qb2luKCc6JykpO1xuICAgICAgICAgICAgc3FsLm91dFBhcmFtcyA9IChzcWwub3V0UGFyYW1zIHx8IFtdKS5jb25jYXQocmV0dXJuaW5nSGVscGVyKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoaW5zZXJ0RGVmYXVsdHNPbmx5KSB7XG4gICAgICAgICAgICAvLyBubyBjb2x1bW5zIGdpdmVuIHNvIG9ubHkgdGhlIGRlZmF1bHQgdmFsdWVcbiAgICAgICAgICAgIHN1YlNxbCArPSAnKCcgKyB0aGlzLmZvcm1hdHRlci53cmFwKHRoaXMuc2luZ2xlLnJldHVybmluZykgKyAnKSB2YWx1ZXMgKGRlZmF1bHQpJztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3ViU3FsICs9ICcoJyArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShpbnNlcnREYXRhLmNvbHVtbnMpICsgJykgdmFsdWVzICgnICsgcGFyYW1ldGVyaXplZFZhbHVlcyArICcpJztcbiAgICAgICAgICB9XG4gICAgICAgICAgc3ViU3FsICs9IChyZXR1cm5pbmcgPyAnIHJldHVybmluZyBST1dJRCBpbnRvICcgKyB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIocmV0dXJuaW5nSGVscGVyKSA6ICcnKTtcblxuICAgICAgICAgIC8vIHByZSBiaW5kIHBvc2l0aW9uIGJlY2F1c2Ugc3ViU3FsIGlzIGFuIGV4ZWN1dGUgaW1tZWRpYXRlIHBhcmFtZXRlclxuICAgICAgICAgIC8vIGxhdGVyIHBvc2l0aW9uIGJpbmRpbmcgd2lsbCBvbmx5IGNvbnZlcnQgdGhlID8gcGFyYW1zXG4gICAgICAgICAgc3ViU3FsID0gdGhpcy5mb3JtYXR0ZXIuY2xpZW50LnBvc2l0aW9uQmluZGluZ3Moc3ViU3FsKTtcbiAgICAgICAgICByZXR1cm4gJ2V4ZWN1dGUgaW1tZWRpYXRlIFxcJycgKyBzdWJTcWwucmVwbGFjZSgvJy9nLCBcIicnXCIpICtcbiAgICAgICAgICAgICgocGFyYW1ldGVyaXplZFZhbHVlcyB8fCByZXR1cm5pbmcpID8gJ1xcJyB1c2luZyAnIDogJycpICtcbiAgICAgICAgICAgIHBhcmFtZXRlcml6ZWRWYWx1ZXMgK1xuICAgICAgICAgICAgKChwYXJhbWV0ZXJpemVkVmFsdWVzICYmIHJldHVybmluZykgPyAnLCAnIDogJycpICtcbiAgICAgICAgICAgIChyZXR1cm5pbmcgPyAnb3V0ID8nIDogJycpICsgJzsnO1xuICAgICAgfSwgdGhpcykuam9pbignICcpICtcbiAgICAgICdlbmQ7JztcblxuICAgIGlmIChyZXR1cm5pbmcpIHtcbiAgICAgIHNxbC5yZXR1cm5pbmcgPSByZXR1cm5pbmc7XG4gICAgICAvLyBnZW5lcmF0ZSBzZWxlY3Qgc3RhdGVtZW50IHdpdGggc3BlY2lhbCBvcmRlciBieSB0byBrZWVwIHRoZSBvcmRlciBiZWNhdXNlICdpbiAoLi4pJyBtYXkgY2hhbmdlIHRoZSBvcmRlclxuICAgICAgc3FsLnJldHVybmluZ1NxbCA9ICdzZWxlY3QgJyArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShyZXR1cm5pbmcpICtcbiAgICAgICAgJyBmcm9tICcgKyB0aGlzLnRhYmxlTmFtZSArXG4gICAgICAgICcgd2hlcmUgUk9XSUQgaW4gKCcgKyBzcWwub3V0UGFyYW1zLm1hcChmdW5jdGlvbiAodiwgaSkge3JldHVybiAnOicgKyAoaSArIDEpO30pLmpvaW4oJywgJykgKyAnKScgK1xuICAgICAgICAnIG9yZGVyIGJ5IGNhc2UgUk9XSUQgJyArIHNxbC5vdXRQYXJhbXMubWFwKGZ1bmN0aW9uICh2LCBpKSB7cmV0dXJuICd3aGVuIENIQVJUT1JPV0lEKDonICsgKGkgKyAxKSArICcpIHRoZW4gJyArIGk7fSkuam9pbignICcpICsgJyBlbmQnO1xuICAgIH1cblxuICAgIHJldHVybiBzcWw7XG4gIH0sXG5cbiAgLy8gVXBkYXRlIG1ldGhvZCwgaW5jbHVkaW5nIGpvaW5zLCB3aGVyZXMsIG9yZGVyICYgbGltaXRzLlxuICB1cGRhdGU6IGZ1bmN0aW9uKCkge1xuICAgIHZhciB1cGRhdGVzID0gdGhpcy5fcHJlcFVwZGF0ZSh0aGlzLnNpbmdsZS51cGRhdGUpO1xuICAgIHZhciB3aGVyZSAgID0gdGhpcy53aGVyZSgpO1xuICAgIHJldHVybiAndXBkYXRlICcgKyB0aGlzLnRhYmxlTmFtZSArXG4gICAgICAnIHNldCAnICsgdXBkYXRlcy5qb2luKCcsICcpICtcbiAgICAgICh3aGVyZSA/ICcgJyArIHdoZXJlIDogJycpO1xuICB9LFxuXG4gIC8vIENvbXBpbGVzIGEgYHRydW5jYXRlYCBxdWVyeS5cbiAgdHJ1bmNhdGU6IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAndHJ1bmNhdGUgdGFibGUgJyArIHRoaXMudGFibGVOYW1lO1xuICB9LFxuXG4gIGZvclVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuICdmb3IgdXBkYXRlJztcbiAgfSxcbiAgXG4gIGZvclNoYXJlOiBmdW5jdGlvbigpIHtcbiAgICAvLyBsb2NrIGZvciBzaGFyZSBpcyBub3QgZGlyZWN0bHkgc3VwcG9ydGVkIGJ5IG9yYWNsZVxuICAgIC8vIHVzZSBMT0NLIFRBQkxFIC4uIElOIFNIQVJFIE1PREU7IGluc3RlYWRcbiAgICBoZWxwZXJzLndhcm4oJ2xvY2sgZm9yIHNoYXJlIGlzIG5vdCBzdXBwb3J0ZWQgYnkgb3JhY2xlIGRpYWxlY3QnKTtcbiAgICByZXR1cm4gJyc7XG4gIH0sXG5cbiAgLy8gQ29tcGlsZXMgYSBgY29sdW1uSW5mb2AgcXVlcnkuXG4gIGNvbHVtbkluZm86IGZ1bmN0aW9uKCkge1xuICAgIHZhciBjb2x1bW4gPSB0aGlzLnNpbmdsZS5jb2x1bW5JbmZvO1xuICAgIHJldHVybiB7XG4gICAgICBzcWw6ICdzZWxlY3QgQ09MVU1OX05BTUUsIERBVEFfVFlQRSwgQ0hBUl9DT0xfREVDTF9MRU5HVEgsIE5VTExBQkxFIGZyb20gVVNFUl9UQUJfQ09MUyB3aGVyZSBUQUJMRV9OQU1FID0gOjEnLFxuICAgICAgYmluZGluZ3M6IFt0aGlzLnNpbmdsZS50YWJsZV0sXG4gICAgICBvdXRwdXQ6IGZ1bmN0aW9uKHJlc3ApIHtcbiAgICAgICAgdmFyIG91dCA9IF8ucmVkdWNlKHJlc3AsIGZ1bmN0aW9uKGNvbHVtbnMsIHZhbCkge1xuICAgICAgICAgIGNvbHVtbnNbdmFsLkNPTFVNTl9OQU1FXSA9IHtcbiAgICAgICAgICAgIHR5cGU6IHZhbC5EQVRBX1RZUEUsXG4gICAgICAgICAgICBtYXhMZW5ndGg6IHZhbC5DSEFSX0NPTF9ERUNMX0xFTkdUSCxcbiAgICAgICAgICAgIG51bGxhYmxlOiAodmFsLk5VTExBQkxFID09PSAnWScpXG4gICAgICAgICAgfTtcbiAgICAgICAgICByZXR1cm4gY29sdW1ucztcbiAgICAgICAgfSwge30pO1xuICAgICAgICByZXR1cm4gY29sdW1uICYmIG91dFtjb2x1bW5dIHx8IG91dDtcbiAgICAgIH1cbiAgICB9O1xuICB9LFxuXG4gIHNlbGVjdDogZnVuY3Rpb24oKSB7XG4gICAgdmFyIHN0YXRlbWVudHMgPSBfLm1hcChjb21wb25lbnRzLCBmdW5jdGlvbiAoY29tcG9uZW50KSB7XG4gICAgICByZXR1cm4gdGhpc1tjb21wb25lbnRdKCk7XG4gICAgfSwgdGhpcyk7XG4gICAgdmFyIHF1ZXJ5ID0gXy5jb21wYWN0KHN0YXRlbWVudHMpLmpvaW4oJyAnKTtcbiAgICByZXR1cm4gdGhpcy5fc3Vycm91bmRRdWVyeVdpdGhMaW1pdEFuZE9mZnNldChxdWVyeSk7XG4gIH0sXG5cbiAgYWdncmVnYXRlOiBmdW5jdGlvbihzdG10KSB7XG4gICAgdmFyIHZhbCA9IHN0bXQudmFsdWU7XG4gICAgdmFyIHNwbGl0T24gPSB2YWwudG9Mb3dlckNhc2UoKS5pbmRleE9mKCcgYXMgJyk7XG4gICAgdmFyIGRpc3RpbmN0ID0gc3RtdC5hZ2dyZWdhdGVEaXN0aW5jdCA/ICdkaXN0aW5jdCAnIDogJyc7XG4gICAgLy8gQWxsb3dzIHVzIHRvIHNwZWNpeSBhbiBhbGlhcyBmb3IgdGhlIGFnZ3JlZ2F0ZSB0eXBlcy5cbiAgICBpZiAoc3BsaXRPbiAhPT0gLTEpIHtcbiAgICAgIHZhciBjb2wgPSB2YWwuc2xpY2UoMCwgc3BsaXRPbik7XG4gICAgICB2YXIgYWxpYXMgPSB2YWwuc2xpY2Uoc3BsaXRPbiArIDQpO1xuICAgICAgcmV0dXJuIHN0bXQubWV0aG9kICsgJygnICsgZGlzdGluY3QgKyB0aGlzLmZvcm1hdHRlci53cmFwKGNvbCkgKyAnKSAnICsgdGhpcy5mb3JtYXR0ZXIud3JhcChhbGlhcyk7XG4gICAgfVxuICAgIHJldHVybiBzdG10Lm1ldGhvZCArICcoJyArIGRpc3RpbmN0ICsgdGhpcy5mb3JtYXR0ZXIud3JhcCh2YWwpICsgJyknO1xuICB9LFxuXG4gIC8vIGZvciBzaW5nbGUgY29tbWFuZHMgb25seVxuICBfYWRkUmV0dXJuaW5nVG9TcWxBbmRDb252ZXJ0OiBmdW5jdGlvbihzcWwsIHJldHVybmluZywgdGFibGVOYW1lKSB7XG4gICAgdmFyIHJlcyA9IHtcbiAgICAgIHNxbDogc3FsXG4gICAgfTtcblxuICAgIGlmICghcmV0dXJuaW5nKSB7XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH1cblxuICAgIHZhciByZXR1cm5pbmdWYWx1ZXMgPSBBcnJheS5pc0FycmF5KHJldHVybmluZykgPyByZXR1cm5pbmcgOiBbcmV0dXJuaW5nXTtcbiAgICB2YXIgcmV0dXJuaW5nSGVscGVyID0gbmV3IFJldHVybmluZ0hlbHBlcihyZXR1cm5pbmdWYWx1ZXMuam9pbignOicpKTtcbiAgICByZXMuc3FsID0gc3FsICsgJyByZXR1cm5pbmcgUk9XSUQgaW50byAnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKHJldHVybmluZ0hlbHBlcik7XG4gICAgcmVzLnJldHVybmluZ1NxbCA9ICdzZWxlY3QgJyArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShyZXR1cm5pbmcpICsgJyBmcm9tICcgKyB0YWJsZU5hbWUgKyAnIHdoZXJlIFJPV0lEID0gOjEnO1xuICAgIHJlcy5vdXRQYXJhbXMgPSBbcmV0dXJuaW5nSGVscGVyXTtcbiAgICByZXMucmV0dXJuaW5nID0gcmV0dXJuaW5nO1xuICAgIHJldHVybiByZXM7XG4gIH0sXG5cbiAgX3N1cnJvdW5kUXVlcnlXaXRoTGltaXRBbmRPZmZzZXQ6IGZ1bmN0aW9uKHF1ZXJ5KSB7XG4gICAgdmFyIGxpbWl0ID0gdGhpcy5zaW5nbGUubGltaXRcbiAgICB2YXIgb2Zmc2V0ID0gdGhpcy5zaW5nbGUub2Zmc2V0XG4gICAgdmFyIGhhc0xpbWl0ID0gKGxpbWl0IHx8IGxpbWl0ID09PSAwIHx8IGxpbWl0ID09PSAnMCcpO1xuICAgIGxpbWl0ID0gK2xpbWl0O1xuICAgIFxuICAgIGlmICghaGFzTGltaXQgJiYgIW9mZnNldCkgcmV0dXJuIHF1ZXJ5O1xuICAgIHF1ZXJ5ID0gcXVlcnkgfHwgXCJcIjtcblxuICAgIGlmIChoYXNMaW1pdCAmJiAhb2Zmc2V0KSB7XG4gICAgICByZXR1cm4gXCJzZWxlY3QgKiBmcm9tIChcIiArIHF1ZXJ5ICsgXCIpIHdoZXJlIHJvd251bSA8PSBcIiArIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcihsaW1pdCk7XG4gICAgfVxuXG4gICAgdmFyIGVuZFJvdyA9ICsob2Zmc2V0KSArIChoYXNMaW1pdCA/IGxpbWl0IDogMTAwMDAwMDAwMDAwMDApO1xuXG4gICAgcmV0dXJuIFwic2VsZWN0ICogZnJvbSBcIiArXG4gICAgICAgICAgIFwiKHNlbGVjdCByb3dfLiosIFJPV05VTSByb3dudW1fIGZyb20gKFwiICsgcXVlcnkgKyBcIikgcm93XyBcIiArXG4gICAgICAgICAgIFwid2hlcmUgcm93bnVtIDw9IFwiICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKGVuZFJvdykgKyBcIikgXCIgK1xuICAgICAgICAgICBcIndoZXJlIHJvd251bV8gPiBcIiArIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcihvZmZzZXQpO1xuICB9XG5cbn0pXG5cbi8vIENvbXBpbGVzIHRoZSBgc2VsZWN0YCBzdGF0ZW1lbnQsIG9yIG5lc3RlZCBzdWItc2VsZWN0c1xuLy8gYnkgY2FsbGluZyBlYWNoIG9mIHRoZSBjb21wb25lbnQgY29tcGlsZXJzLCB0cmltbWluZyBvdXRcbi8vIHRoZSBlbXB0aWVzLCBhbmQgcmV0dXJuaW5nIGEgZ2VuZXJhdGVkIHF1ZXJ5IHN0cmluZy5cblF1ZXJ5Q29tcGlsZXJfT3JhY2xlLnByb3RvdHlwZS5maXJzdCA9IFF1ZXJ5Q29tcGlsZXJfT3JhY2xlLnByb3RvdHlwZS5zZWxlY3RcblxudmFyIGNvbXBvbmVudHMgPSBbXG4gICdjb2x1bW5zJywgJ2pvaW4nLCAnd2hlcmUnLCAndW5pb24nLCAnZ3JvdXAnLFxuICAnaGF2aW5nJywgJ29yZGVyJywgJ2xvY2snXG5dO1xuXG5tb2R1bGUuZXhwb3J0cyA9IFF1ZXJ5Q29tcGlsZXJfT3JhY2xlO1xuIl19