
// Oracle Client
// -------
'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var assign = require('lodash/object/assign');

var Formatter = require('./formatter');
var Client = require('../../client');
var Promise = require('../../promise');
var helpers = require('../../helpers');
var SqlString = require('../../query/string');

var Transaction = require('./transaction');
var QueryCompiler = require('./query/compiler');
var SchemaCompiler = require('./schema/compiler');
var ColumnBuilder = require('./schema/columnbuilder');
var ColumnCompiler = require('./schema/columncompiler');
var TableCompiler = require('./schema/tablecompiler');
var OracleQueryStream = require('./stream');
var ReturningHelper = require('./utils').ReturningHelper;

// Always initialize with the "QueryBuilder" and "QueryCompiler"
// objects, which extend the base 'lib/query/builder' and
// 'lib/query/compiler', respectively.
function Client_Oracle(config) {
  Client.call(this, config);
}
inherits(Client_Oracle, Client);

assign(Client_Oracle.prototype, {

  dialect: 'oracle',

  driverName: 'oracle',

  _driver: function _driver() {
    return require('oracle');
  },

  Transaction: Transaction,

  Formatter: Formatter,

  QueryCompiler: QueryCompiler,

  SchemaCompiler: SchemaCompiler,

  ColumnBuilder: ColumnBuilder,

  ColumnCompiler: ColumnCompiler,

  TableCompiler: TableCompiler,

  prepBindings: function prepBindings(bindings) {
    return _.map(bindings, function (value) {
      // returning helper uses always ROWID as string
      if (value instanceof ReturningHelper && this.driver) {
        return new this.driver.OutParam(this.driver.OCCISTRING);
      } else if (typeof value === 'boolean') {
        return value ? 1 : 0;
      } else if (Buffer.isBuffer(value)) {
        return SqlString.bufferToString(value);
      } else if (value === undefined) {
        return this.valueForUndefined;
      }
      return value;
    }, this);
  },

  // Get a raw connection, called by the `pool` whenever a new
  // connection needs to be added to the pool.
  acquireRawConnection: function acquireRawConnection() {
    var client = this;
    return new Promise(function (resolver, rejecter) {
      client.driver.connect(client.connectionSettings, function (err, connection) {
        if (err) return rejecter(err);
        Promise.promisifyAll(connection);
        if (client.connectionSettings.prefetchRowCount) {
          connection.setPrefetchRowCount(client.connectionSettings.prefetchRowCount);
        }
        resolver(connection);
      });
    });
  },

  // Used to explicitly close a connection, called internally by the pool
  // when a connection times out or the pool is shutdown.
  destroyRawConnection: function destroyRawConnection(connection, cb) {
    connection.close();
    cb();
  },

  // Return the database for the Oracle client.
  database: function database() {
    return this.connectionSettings.database;
  },

  // Position the bindings for the query.
  positionBindings: function positionBindings(sql) {
    var questionCount = 0;
    return sql.replace(/\?/g, function () {
      questionCount += 1;
      return ':' + questionCount;
    });
  },

  _stream: function _stream(connection, obj, stream, options) {
    obj.sql = this.positionBindings(obj.sql);
    return new Promise(function (resolver, rejecter) {
      stream.on('error', rejecter);
      stream.on('end', resolver);
      var queryStream = new OracleQueryStream(connection, obj.sql, obj.bindings, options);
      queryStream.pipe(stream);
    });
  },

  // Runs the query on the specified connection, providing the bindings
  // and any other necessary prep work.
  _query: function _query(connection, obj) {

    // convert ? params into positional bindings (:1)
    obj.sql = this.positionBindings(obj.sql);

    obj.bindings = this.prepBindings(obj.bindings) || [];

    if (!obj.sql) throw new Error('The query is empty');

    return connection.executeAsync(obj.sql, obj.bindings).then(function (response) {
      if (!obj.returning) return response;
      var rowIds = obj.outParams.map(function (v, i) {
        return response['returnParam' + (i ? i : '')];
      });
      return connection.executeAsync(obj.returningSql, rowIds);
    }).then(function (response) {
      obj.response = response;
      return obj;
    });
  },

  // Process the response as returned from the query.
  processResponse: function processResponse(obj, runner) {
    var response = obj.response;
    var method = obj.method;
    if (obj.output) return obj.output.call(runner, response);
    switch (method) {
      case 'select':
      case 'pluck':
      case 'first':
        response = helpers.skim(response);
        if (obj.method === 'pluck') response = _.pluck(response, obj.pluck);
        return obj.method === 'first' ? response[0] : response;
      case 'insert':
      case 'del':
      case 'update':
      case 'counter':
        if (obj.returning) {
          if (obj.returning.length > 1 || obj.returning[0] === '*') {
            return response;
          }
          // return an array with values if only one returning value was specified
          return _.flatten(_.map(response, _.values));
        }
        return response.updateCount;
      default:
        return response;
    }
  }

});

module.exports = Client_Oracle;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9vcmFjbGUvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFHQSxJQUFJLENBQUMsR0FBbUIsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQ3pDLElBQUksUUFBUSxHQUFZLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtBQUMzQyxJQUFJLE1BQU0sR0FBYyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQTs7QUFFdkQsSUFBSSxTQUFTLEdBQVcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBQzlDLElBQUksTUFBTSxHQUFjLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQTtBQUMvQyxJQUFJLE9BQU8sR0FBYSxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7QUFDaEQsSUFBSSxPQUFPLEdBQWEsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0FBQ2hELElBQUksU0FBUyxHQUFXLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBOztBQUVyRCxJQUFJLFdBQVcsR0FBUyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7QUFDaEQsSUFBSSxhQUFhLEdBQU8sT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUE7QUFDbkQsSUFBSSxjQUFjLEdBQU0sT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUE7QUFDcEQsSUFBSSxhQUFhLEdBQU8sT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUE7QUFDekQsSUFBSSxjQUFjLEdBQU0sT0FBTyxDQUFDLHlCQUF5QixDQUFDLENBQUE7QUFDMUQsSUFBSSxhQUFhLEdBQU8sT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUE7QUFDekQsSUFBSSxpQkFBaUIsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDM0MsSUFBSSxlQUFlLEdBQUssT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLGVBQWUsQ0FBQTs7Ozs7QUFLMUQsU0FBUyxhQUFhLENBQUMsTUFBTSxFQUFFO0FBQzdCLFFB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RyxDQUFDLFNBQVMsRUFBRTtBQUNqQixjQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtBQUN4RCxtQkFBTyxRQUFRLENBQUM7V0FDakI7O0FBRUQsaUJBQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztTQUM3QztBQUNELGVBQU8sUUFBUSxDQUFDLFdBQVcsQ0FBQztBQUFBLEFBQzlCO0FBQ0UsZUFBTyxRQUFRLENBQUM7QUFBQSxLQUNuQjtHQUNGOztDQUVGLENBQUMsQ0FBQTs7QUFFRixNQUFNLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLy8gT3JhY2xlIENsaWVudFxuLy8gLS0tLS0tLVxudmFyIF8gICAgICAgICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJylcbnZhciBpbmhlcml0cyAgICAgICAgICA9IHJlcXVpcmUoJ2luaGVyaXRzJylcbnZhciBhc3NpZ24gICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaC9vYmplY3QvYXNzaWduJylcblxudmFyIEZvcm1hdHRlciAgICAgICAgID0gcmVxdWlyZSgnLi9mb3JtYXR0ZXInKVxudmFyIENsaWVudCAgICAgICAgICAgID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50JylcbnZhciBQcm9taXNlICAgICAgICAgICA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKVxudmFyIGhlbHBlcnMgICAgICAgICAgID0gcmVxdWlyZSgnLi4vLi4vaGVscGVycycpXG52YXIgU3FsU3RyaW5nICAgICAgICAgPSByZXF1aXJlKCcuLi8uLi9xdWVyeS9zdHJpbmcnKVxuXG52YXIgVHJhbnNhY3Rpb24gICAgICAgPSByZXF1aXJlKCcuL3RyYW5zYWN0aW9uJylcbnZhciBRdWVyeUNvbXBpbGVyICAgICA9IHJlcXVpcmUoJy4vcXVlcnkvY29tcGlsZXInKVxudmFyIFNjaGVtYUNvbXBpbGVyICAgID0gcmVxdWlyZSgnLi9zY2hlbWEvY29tcGlsZXInKVxudmFyIENvbHVtbkJ1aWxkZXIgICAgID0gcmVxdWlyZSgnLi9zY2hlbWEvY29sdW1uYnVpbGRlcicpXG52YXIgQ29sdW1uQ29tcGlsZXIgICAgPSByZXF1aXJlKCcuL3NjaGVtYS9jb2x1bW5jb21waWxlcicpXG52YXIgVGFibGVDb21waWxlciAgICAgPSByZXF1aXJlKCcuL3NjaGVtYS90YWJsZWNvbXBpbGVyJylcbnZhciBPcmFjbGVRdWVyeVN0cmVhbSA9IHJlcXVpcmUoJy4vc3RyZWFtJylcbnZhciBSZXR1cm5pbmdIZWxwZXIgICA9IHJlcXVpcmUoJy4vdXRpbHMnKS5SZXR1cm5pbmdIZWxwZXJcblxuLy8gQWx3YXlzIGluaXRpYWxpemUgd2l0aCB0aGUgXCJRdWVyeUJ1aWxkZXJcIiBhbmQgXCJRdWVyeUNvbXBpbGVyXCJcbi8vIG9iamVjdHMsIHdoaWNoIGV4dGVuZCB0aGUgYmFzZSAnbGliL3F1ZXJ5L2J1aWxkZXInIGFuZFxuLy8gJ2xpYi9xdWVyeS9jb21waWxlcicsIHJlc3BlY3RpdmVseS5cbmZ1bmN0aW9uIENsaWVudF9PcmFjbGUoY29uZmlnKSB7XG4gIENsaWVudC5jYWxsKHRoaXMsIGNvbmZpZylcbn1cbmluaGVyaXRzKENsaWVudF9PcmFjbGUsIENsaWVudClcblxuYXNzaWduKENsaWVudF9PcmFjbGUucHJvdG90eXBlLCB7XG5cbiAgZGlhbGVjdDogJ29yYWNsZScsXG5cbiAgZHJpdmVyTmFtZTogJ29yYWNsZScsXG5cbiAgX2RyaXZlcjogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHJlcXVpcmUoJ29yYWNsZScpXG4gIH0sXG5cbiAgVHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uLFxuXG4gIEZvcm1hdHRlcjogRm9ybWF0dGVyLFxuXG4gIFF1ZXJ5Q29tcGlsZXI6IFF1ZXJ5Q29tcGlsZXIsXG5cbiAgU2NoZW1hQ29tcGlsZXI6IFNjaGVtYUNvbXBpbGVyLFxuXG4gIENvbHVtbkJ1aWxkZXI6IENvbHVtbkJ1aWxkZXIsXG5cbiAgQ29sdW1uQ29tcGlsZXI6IENvbHVtbkNvbXBpbGVyLFxuXG4gIFRhYmxlQ29tcGlsZXI6IFRhYmxlQ29tcGlsZXIsXG5cbiAgcHJlcEJpbmRpbmdzOiBmdW5jdGlvbihiaW5kaW5ncykge1xuICAgIHJldHVybiBfLm1hcChiaW5kaW5ncywgZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIC8vIHJldHVybmluZyBoZWxwZXIgdXNlcyBhbHdheXMgUk9XSUQgYXMgc3RyaW5nXG4gICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBSZXR1cm5pbmdIZWxwZXIgJiYgdGhpcy5kcml2ZXIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyB0aGlzLmRyaXZlci5PdXRQYXJhbSh0aGlzLmRyaXZlci5PQ0NJU1RSSU5HKVxuICAgICAgfVxuICAgICAgZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlID8gMSA6IDBcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKEJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIFNxbFN0cmluZy5idWZmZXJUb1N0cmluZyh2YWx1ZSlcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVGb3JVbmRlZmluZWRcbiAgICAgIH1cbiAgICAgIHJldHVybiB2YWx1ZVxuICAgIH0sIHRoaXMpXG4gIH0sXG5cbiAgLy8gR2V0IGEgcmF3IGNvbm5lY3Rpb24sIGNhbGxlZCBieSB0aGUgYHBvb2xgIHdoZW5ldmVyIGEgbmV3XG4gIC8vIGNvbm5lY3Rpb24gbmVlZHMgdG8gYmUgYWRkZWQgdG8gdGhlIHBvb2wuXG4gIGFjcXVpcmVSYXdDb25uZWN0aW9uOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgY2xpZW50ID0gdGhpc1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHtcbiAgICAgIGNsaWVudC5kcml2ZXIuY29ubmVjdChjbGllbnQuY29ubmVjdGlvblNldHRpbmdzLFxuICAgICAgICBmdW5jdGlvbihlcnIsIGNvbm5lY3Rpb24pIHtcbiAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0ZXIoZXJyKVxuICAgICAgICAgIFByb21pc2UucHJvbWlzaWZ5QWxsKGNvbm5lY3Rpb24pXG4gICAgICAgICAgaWYgKGNsaWVudC5jb25uZWN0aW9uU2V0dGluZ3MucHJlZmV0Y2hSb3dDb3VudCkge1xuICAgICAgICAgICAgY29ubmVjdGlvbi5zZXRQcmVmZXRjaFJvd0NvdW50KGNsaWVudC5jb25uZWN0aW9uU2V0dGluZ3MucHJlZmV0Y2hSb3dDb3VudClcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzb2x2ZXIoY29ubmVjdGlvbilcbiAgICAgICAgfSlcbiAgICB9KVxuICB9LFxuXG4gIC8vIFVzZWQgdG8gZXhwbGljaXRseSBjbG9zZSBhIGNvbm5lY3Rpb24sIGNhbGxlZCBpbnRlcm5hbGx5IGJ5IHRoZSBwb29sXG4gIC8vIHdoZW4gYSBjb25uZWN0aW9uIHRpbWVzIG91dCBvciB0aGUgcG9vbCBpcyBzaHV0ZG93bi5cbiAgZGVzdHJveVJhd0Nvbm5lY3Rpb246IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIGNiKSB7XG4gICAgY29ubmVjdGlvbi5jbG9zZSgpXG4gICAgY2IoKVxuICB9LFxuXG4gIC8vIFJldHVybiB0aGUgZGF0YWJhc2UgZm9yIHRoZSBPcmFjbGUgY2xpZW50LlxuICBkYXRhYmFzZTogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvblNldHRpbmdzLmRhdGFiYXNlXG4gIH0sXG5cbiAgLy8gUG9zaXRpb24gdGhlIGJpbmRpbmdzIGZvciB0aGUgcXVlcnkuXG4gIHBvc2l0aW9uQmluZGluZ3M6IGZ1bmN0aW9uKHNxbCkge1xuICAgIHZhciBxdWVzdGlvbkNvdW50ID0gMFxuICAgIHJldHVybiBzcWwucmVwbGFjZSgvXFw/L2csIGZ1bmN0aW9uKCkge1xuICAgICAgcXVlc3Rpb25Db3VudCArPSAxXG4gICAgICByZXR1cm4gJzonICsgcXVlc3Rpb25Db3VudFxuICAgIH0pXG4gIH0sXG5cbiAgX3N0cmVhbTogZnVuY3Rpb24oY29ubmVjdGlvbiwgb2JqLCBzdHJlYW0sIG9wdGlvbnMpIHtcbiAgICBvYmouc3FsID0gdGhpcy5wb3NpdGlvbkJpbmRpbmdzKG9iai5zcWwpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZXIsIHJlamVjdGVyKSB7XG4gICAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0ZXIpO1xuICAgICAgc3RyZWFtLm9uKCdlbmQnLCByZXNvbHZlcik7XG4gICAgICB2YXIgcXVlcnlTdHJlYW0gPSBuZXcgT3JhY2xlUXVlcnlTdHJlYW0oY29ubmVjdGlvbiwgb2JqLnNxbCwgb2JqLmJpbmRpbmdzLCBvcHRpb25zKTtcbiAgICAgIHF1ZXJ5U3RyZWFtLnBpcGUoc3RyZWFtKVxuICAgIH0pO1xuICB9LFxuXG4gIC8vIFJ1bnMgdGhlIHF1ZXJ5IG9uIHRoZSBzcGVjaWZpZWQgY29ubmVjdGlvbiwgcHJvdmlkaW5nIHRoZSBiaW5kaW5nc1xuICAvLyBhbmQgYW55IG90aGVyIG5lY2Vzc2FyeSBwcmVwIHdvcmsuXG4gIF9xdWVyeTogZnVuY3Rpb24oY29ubmVjdGlvbiwgb2JqKSB7XG5cbiAgICAvLyBjb252ZXJ0ID8gcGFyYW1zIGludG8gcG9zaXRpb25hbCBiaW5kaW5ncyAoOjEpXG4gICAgb2JqLnNxbCA9IHRoaXMucG9zaXRpb25CaW5kaW5ncyhvYmouc3FsKTtcblxuICAgIG9iai5iaW5kaW5ncyA9IHRoaXMucHJlcEJpbmRpbmdzKG9iai5iaW5kaW5ncykgfHwgW107XG5cbiAgICBpZiAoIW9iai5zcWwpIHRocm93IG5ldyBFcnJvcignVGhlIHF1ZXJ5IGlzIGVtcHR5Jyk7XG5cbiAgICByZXR1cm4gY29ubmVjdGlvbi5leGVjdXRlQXN5bmMob2JqLnNxbCwgb2JqLmJpbmRpbmdzKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICBpZiAoIW9iai5yZXR1cm5pbmcpIHJldHVybiByZXNwb25zZVxuICAgICAgdmFyIHJvd0lkcyA9IG9iai5vdXRQYXJhbXMubWFwKGZ1bmN0aW9uICh2LCBpKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZVsncmV0dXJuUGFyYW0nICsgKGkgPyBpIDogJycpXTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGNvbm5lY3Rpb24uZXhlY3V0ZUFzeW5jKG9iai5yZXR1cm5pbmdTcWwsIHJvd0lkcylcbiAgICB9KS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICBvYmoucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICAgIHJldHVybiBvYmpcbiAgICB9KVxuXG4gIH0sXG5cbiAgLy8gUHJvY2VzcyB0aGUgcmVzcG9uc2UgYXMgcmV0dXJuZWQgZnJvbSB0aGUgcXVlcnkuXG4gIHByb2Nlc3NSZXNwb25zZTogZnVuY3Rpb24ob2JqLCBydW5uZXIpIHtcbiAgICB2YXIgcmVzcG9uc2UgPSBvYmoucmVzcG9uc2U7XG4gICAgdmFyIG1ldGhvZCAgID0gb2JqLm1ldGhvZDtcbiAgICBpZiAob2JqLm91dHB1dCkgcmV0dXJuIG9iai5vdXRwdXQuY2FsbChydW5uZXIsIHJlc3BvbnNlKTtcbiAgICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgIGNhc2UgJ3BsdWNrJzpcbiAgICAgIGNhc2UgJ2ZpcnN0JzpcbiAgICAgICAgcmVzcG9uc2UgPSBoZWxwZXJzLnNraW0ocmVzcG9uc2UpO1xuICAgICAgICBpZiAob2JqLm1ldGhvZCA9PT0gJ3BsdWNrJykgcmVzcG9uc2UgPSBfLnBsdWNrKHJlc3BvbnNlLCBvYmoucGx1Y2spO1xuICAgICAgICByZXR1cm4gb2JqLm1ldGhvZCA9PT0gJ2ZpcnN0JyA/IHJlc3BvbnNlWzBdIDogcmVzcG9uc2U7XG4gICAgICBjYXNlICdpbnNlcnQnOlxuICAgICAgY2FzZSAnZGVsJzpcbiAgICAgIGNhc2UgJ3VwZGF0ZSc6XG4gICAgICBjYXNlICdjb3VudGVyJzpcbiAgICAgICAgaWYgKG9iai5yZXR1cm5pbmcpIHtcbiAgICAgICAgICBpZiAob2JqLnJldHVybmluZy5sZW5ndGggPiAxIHx8IG9iai5yZXR1cm5pbmdbMF0gPT09ICcqJykge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyByZXR1cm4gYW4gYXJyYXkgd2l0aCB2YWx1ZXMgaWYgb25seSBvbmUgcmV0dXJuaW5nIHZhbHVlIHdhcyBzcGVjaWZpZWRcbiAgICAgICAgICByZXR1cm4gXy5mbGF0dGVuKF8ubWFwKHJlc3BvbnNlLCBfLnZhbHVlcykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNwb25zZS51cGRhdGVDb3VudDtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9XG4gIH1cblxufSlcblxubW9kdWxlLmV4cG9ydHMgPSBDbGllbnRfT3JhY2xlXG4iXX0=