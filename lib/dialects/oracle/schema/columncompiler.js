'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var assign = require('lodash/object/assign');
var utils = require('../utils');
var Raw = require('../../../raw');
var ColumnCompiler = require('../../../schema/columncompiler');

// Column Compiler
// -------

function ColumnCompiler_Oracle() {
  this.modifiers = ['defaultTo', 'checkIn', 'nullable', 'comment'];
  ColumnCompiler.apply(this, arguments);
}
inherits(ColumnCompiler_Oracle, ColumnCompiler);

assign(ColumnCompiler_Oracle.prototype, {

  // helper function for pushAdditional in increments() and bigincrements()
  _createAutoIncrementTriggerAndSequence: function _createAutoIncrementTriggerAndSequence() {
    // TODO Add warning that sequence etc is created
    this.pushAdditional(function () {
      var sequenceName = this.tableCompiler._indexCommand('seq', this.tableCompiler.tableNameRaw);
      var triggerName = this.tableCompiler._indexCommand('trg', this.tableCompiler.tableNameRaw, this.getColumnName());
      var tableName = this.tableCompiler.tableName();
      var columnName = this.formatter.wrap(this.getColumnName());
      var createTriggerSQL = 'create or replace trigger ' + triggerName + ' before insert on ' + tableName + ' for each row' + ' when (new.' + columnName + ' is null) ' + ' begin' + ' select ' + sequenceName + '.nextval into :new.' + columnName + ' from dual;' + ' end;';
      this.pushQuery(utils.wrapSqlWithCatch('create sequence ' + sequenceName, -955));
      this.pushQuery(createTriggerSQL);
    });
  },

  increments: function increments() {
    this._createAutoIncrementTriggerAndSequence();
    return 'integer not null primary key';
  },

  bigincrements: function bigincrements() {
    this._createAutoIncrementTriggerAndSequence();
    return 'number(20, 0) not null primary key';
  },

  floating: function floating(precision) {
    var parsedPrecision = this._num(precision, 0);
    return 'float' + (parsedPrecision ? '(' + parsedPrecision + ')' : '');
  },

  double: function double(precision, scale) {
    // if (!precision) return 'number'; // TODO: Check If default is ok
    return 'number(' + this._num(precision, 8) + ', ' + this._num(scale, 2) + ')';
  },

  integer: function integer(length) {
    return length ? 'number(' + this._num(length, 11) + ')' : 'integer';
  },

  tinyint: 'smallint',

  smallint: 'smallint',

  mediumint: 'integer',

  biginteger: 'number(20, 0)',

  text: 'clob',

  enu: function enu(allowed) {
    allowed = _.uniq(allowed);
    var maxLength = (allowed || []).reduce(function (maxLength, name) {
      return Math.max(maxLength, String(name).length);
    }, 1);

    // implicitly add the enum values as checked values
    this.columnBuilder._modifiers.checkIn = [allowed];

    return "varchar2(" + maxLength + ")";
  },

  time: 'timestamp with time zone',

  datetime: function datetime(without) {
    return without ? 'timestamp' : 'timestamp with time zone';
  },

  timestamp: function timestamp(without) {
    return without ? 'timestamp' : 'timestamp with time zone';
  },

  bit: 'clob',

  json: 'clob',

  bool: function bool() {
    // implicitly add the check for 0 and 1
    this.columnBuilder._modifiers.checkIn = [[0, 1]];
    return 'number(1, 0)';
  },

  varchar: function varchar(length) {
    return 'varchar2(' + this._num(length, 255) + ')';
  },

  // Modifiers
  // ------

  comment: function comment(_comment) {
    this.pushAdditional(function () {
      this.pushQuery('comment on column ' + this.tableCompiler.tableName() + '.' + this.formatter.wrap(this.args[0]) + " is '" + (_comment || '') + "'");
    }, _comment);
  },

  checkIn: function checkIn(value) {
    // TODO: Maybe accept arguments also as array
    // TODO: value(s) should be escaped properly
    if (value === undefined) {
      return '';
    } else if (value instanceof Raw) {
      value = value.toQuery();
    } else if (Array.isArray(value)) {
      value = _.map(value, function (v) {
        return "'" + v + "'";
      }).join(', ');
    } else {
      value = "'" + value + "'";
    }
    return 'check (' + this.formatter.wrap(this.args[0]) + ' in (' + value + '))';
  }

});

module.exports = ColumnCompiler_Oracle;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9vcmFjbGUvc2NoZW1hL2NvbHVtbmNvbXBpbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsSUFBSSxDQUFDLEdBQWdCLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQTtBQUN0QyxJQUFJLFFBQVEsR0FBUyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDeEMsSUFBSSxNQUFNLEdBQVcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUE7QUFDcEQsSUFBSSxLQUFLLEdBQVksT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFBO0FBQ3hDLElBQUksR0FBRyxHQUFjLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQTtBQUM1QyxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMsZ0NBQWdDLENBQUMsQ0FBQTs7Ozs7QUFLOUQsU0FBUyxxQkFBcUIsR0FBRztBQUMvQixNQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsV0FBVyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDakUsZ0JBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0NBQ3ZDO0FBQ0QsUUFBUSxDQUFDLHFCQUFxQixFQUFFLGNBQWMsQ0FBQyxDQUFDOztBQUVoRCxNQUFNLENBQUMscUJBQXFCLENBQUMsU0FBUyxFQUFFOzs7QUFHdEMsd0NBQXNDLEVBQUUsa0RBQVk7O0FBRWxELFFBQUksQ0FBQyxjQUFjLENBQUMsWUFBWTtBQUM5QixVQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUM1RixVQUFJLFdBQVcsR0FBSSxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFD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QyxFQUFFO0FBQ2hDLGVBQU8sR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7T0FDdEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNmLE1BQU07QUFDTCxXQUFLLEdBQUcsR0FBRyxHQUFHLEtBQUssR0FBRyxHQUFHLENBQUM7S0FDM0I7QUFDRCxXQUFPLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUM7R0FDL0U7O0NBRUYsQ0FBQyxDQUFDOztBQUVILE1BQU0sQ0FBQyxPQUFPLEdBQUcscUJBQXFCLENBQUMiLCJmaWxlIjoiY29sdW1uY29tcGlsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbnZhciBfICAgICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpXG52YXIgaW5oZXJpdHMgICAgICAgPSByZXF1aXJlKCdpbmhlcml0cycpXG52YXIgYXNzaWduICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gvb2JqZWN0L2Fzc2lnbicpXG52YXIgdXRpbHMgICAgICAgICAgPSByZXF1aXJlKCcuLi91dGlscycpXG52YXIgUmF3ICAgICAgICAgICAgPSByZXF1aXJlKCcuLi8uLi8uLi9yYXcnKVxudmFyIENvbHVtbkNvbXBpbGVyID0gcmVxdWlyZSgnLi4vLi4vLi4vc2NoZW1hL2NvbHVtbmNvbXBpbGVyJylcblxuLy8gQ29sdW1uIENvbXBpbGVyXG4vLyAtLS0tLS0tXG5cbmZ1bmN0aW9uIENvbHVtbkNvbXBpbGVyX09yYWNsZSgpIHtcbiAgdGhpcy5tb2RpZmllcnMgPSBbJ2RlZmF1bHRUbycsICdjaGVja0luJywgJ251bGxhYmxlJywgJ2NvbW1lbnQnXTtcbiAgQ29sdW1uQ29tcGlsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn1cbmluaGVyaXRzKENvbHVtbkNvbXBpbGVyX09yYWNsZSwgQ29sdW1uQ29tcGlsZXIpO1xuXG5hc3NpZ24oQ29sdW1uQ29tcGlsZXJfT3JhY2xlLnByb3RvdHlwZSwge1xuXG4gIC8vIGhlbHBlciBmdW5jdGlvbiBmb3IgcHVzaEFkZGl0aW9uYWwgaW4gaW5jcmVtZW50cygpIGFuZCBiaWdpbmNyZW1lbnRzKClcbiAgX2NyZWF0ZUF1dG9JbmNyZW1lbnRUcmlnZ2VyQW5kU2VxdWVuY2U6IGZ1bmN0aW9uICgpIHtcbiAgICAvLyBUT0RPIEFkZCB3YXJuaW5nIHRoYXQgc2VxdWVuY2UgZXRjIGlzIGNyZWF0ZWRcbiAgICB0aGlzLnB1c2hBZGRpdGlvbmFsKGZ1bmN0aW9uICgpIHtcbiAgICAgIHZhciBzZXF1ZW5jZU5hbWUgPSB0aGlzLnRhYmxlQ29tcGlsZXIuX2luZGV4Q29tbWFuZCgnc2VxJywgdGhpcy50YWJsZUNvbXBpbGVyLnRhYmxlTmFtZVJhdyk7XG4gICAgICB2YXIgdHJpZ2dlck5hbWUgID0gdGhpcy50YWJsZUNvbXBpbGVyLl9pbmRleENvbW1hbmQoJ3RyZycsIHRoaXMudGFibGVDb21waWxlci50YWJsZU5hbWVSYXcsIHRoaXMuZ2V0Q29sdW1uTmFtZSgpKTtcbiAgICAgIHZhciB0YWJsZU5hbWUgICAgPSB0aGlzLnRhYmxlQ29tcGlsZXIudGFibGVOYW1lKCk7XG4gICAgICB2YXIgY29sdW1uTmFtZSAgID0gdGhpcy5mb3JtYXR0ZXIud3JhcCh0aGlzLmdldENvbHVtbk5hbWUoKSk7XG4gICAgICB2YXIgY3JlYXRlVHJpZ2dlclNRTCA9ICdjcmVhdGUgb3IgcmVwbGFjZSB0cmlnZ2VyICcgKyB0cmlnZ2VyTmFtZSArICcgYmVmb3JlIGluc2VydCBvbiAnICsgdGFibGVOYW1lICtcbiAgICAgICAgJyBmb3IgZWFjaCByb3cnICtcbiAgICAgICAgJyB3aGVuIChuZXcuJyArIGNvbHVtbk5hbWUgKyAnIGlzIG51bGwpICcgK1xuICAgICAgICAnIGJlZ2luJyArXG4gICAgICAgICcgc2VsZWN0ICcgKyBzZXF1ZW5jZU5hbWUgKyAnLm5leHR2YWwgaW50byA6bmV3LicgKyBjb2x1bW5OYW1lICsgJyBmcm9tIGR1YWw7JyArXG4gICAgICAgICcgZW5kOyc7XG4gICAgICB0aGlzLnB1c2hRdWVyeSh1dGlscy53cmFwU3FsV2l0aENhdGNoKCdjcmVhdGUgc2VxdWVuY2UgJyArIHNlcXVlbmNlTmFtZSwgLTk1NSkpO1xuICAgICAgdGhpcy5wdXNoUXVlcnkoY3JlYXRlVHJpZ2dlclNRTCk7XG4gICAgfSk7XG4gIH0sXG5cbiAgaW5jcmVtZW50czogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuX2NyZWF0ZUF1dG9JbmNyZW1lbnRUcmlnZ2VyQW5kU2VxdWVuY2UoKTtcbiAgICByZXR1cm4gJ2ludGVnZXIgbm90IG51bGwgcHJpbWFyeSBrZXknO1xuICB9LFxuXG4gIGJpZ2luY3JlbWVudHM6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl9jcmVhdGVBdXRvSW5jcmVtZW50VHJpZ2dlckFuZFNlcXVlbmNlKCk7XG4gICAgcmV0dXJuICdudW1iZXIoMjAsIDApIG5vdCBudWxsIHByaW1hcnkga2V5JztcbiAgfSxcblxuICBmbG9hdGluZzogZnVuY3Rpb24ocHJlY2lzaW9uKSB7XG4gICAgdmFyIHBhcnNlZFByZWNpc2lvbiA9IHRoaXMuX251bShwcmVjaXNpb24sIDApO1xuICAgIHJldHVybiAnZmxvYXQnICsgKHBhcnNlZFByZWNpc2lvbiA/ICcoJyArIHBhcnNlZFByZWNpc2lvbiArICcpJyA6ICcnKTtcbiAgfSxcblxuICBkb3VibGU6IGZ1bmN0aW9uKHByZWNpc2lvbiwgc2NhbGUpIHtcbiAgICAvLyBpZiAoIXByZWNpc2lvbikgcmV0dXJuICdudW1iZXInOyAvLyBUT0RPOiBDaGVjayBJZiBkZWZhdWx0IGlzIG9rXG4gICAgcmV0dXJuICdudW1iZXIoJyArIHRoaXMuX251bShwcmVjaXNpb24sIDgpICsgJywgJyArIHRoaXMuX251bShzY2FsZSwgMikgKyAnKSc7XG4gIH0sXG5cbiAgaW50ZWdlcjogZnVuY3Rpb24obGVuZ3RoKSB7XG4gICAgICByZXR1cm4gbGVuZ3RoID8gJ251bWJlcignICsgdGhpcy5fbnVtKGxlbmd0aCwgMTEpICsgJyknIDogJ2ludGVnZXInO1xuICB9LFxuXG4gIHRpbnlpbnQ6ICdzbWFsbGludCcsXG4gIFxuICBzbWFsbGludDogJ3NtYWxsaW50JyxcbiAgXG4gIG1lZGl1bWludDogJ2ludGVnZXInLFxuICBcbiAgYmlnaW50ZWdlcjogJ251bWJlcigyMCwgMCknLFxuICBcbiAgdGV4dDogJ2Nsb2InLFxuXG4gIGVudTogZnVuY3Rpb24gKGFsbG93ZWQpIHtcbiAgICBhbGxvd2VkID0gXy51bmlxKGFsbG93ZWQpO1xuICAgIHZhciBtYXhMZW5ndGggPSAoYWxsb3dlZCB8fCBbXSkucmVkdWNlKGZ1bmN0aW9uIChtYXhMZW5ndGgsIG5hbWUpIHtcbiAgICAgIHJldHVybiBNYXRoLm1heChtYXhMZW5ndGgsIFN0cmluZyhuYW1lKS5sZW5ndGgpO1xuICAgIH0sIDEpO1xuXG4gICAgLy8gaW1wbGljaXRseSBhZGQgdGhlIGVudW0gdmFsdWVzIGFzIGNoZWNrZWQgdmFsdWVzXG4gICAgdGhpcy5jb2x1bW5CdWlsZGVyLl9tb2RpZmllcnMuY2hlY2tJbiA9IFthbGxvd2VkXTtcblxuICAgIHJldHVybiBcInZhcmNoYXIyKFwiICsgbWF4TGVuZ3RoICsgXCIpXCI7XG4gIH0sXG5cbiAgdGltZTogJ3RpbWVzdGFtcCB3aXRoIHRpbWUgem9uZScsXG5cbiAgZGF0ZXRpbWU6IGZ1bmN0aW9uKHdpdGhvdXQpIHtcbiAgICByZXR1cm4gd2l0aG91dCA/ICd0aW1lc3RhbXAnIDogJ3RpbWVzdGFtcCB3aXRoIHRpbWUgem9uZSc7XG4gIH0sXG5cbiAgdGltZXN0YW1wOiBmdW5jdGlvbih3aXRob3V0KSB7XG4gICAgcmV0dXJuIHdpdGhvdXQgPyAndGltZXN0YW1wJyA6ICd0aW1lc3RhbXAgd2l0aCB0aW1lIHpvbmUnO1xuICB9LFxuXG4gIGJpdDogJ2Nsb2InLFxuICBcbiAganNvbjogJ2Nsb2InLFxuXG4gIGJvb2w6IGZ1bmN0aW9uICgpIHtcbiAgICAvLyBpbXBsaWNpdGx5IGFkZCB0aGUgY2hlY2sgZm9yIDAgYW5kIDFcbiAgICB0aGlzLmNvbHVtbkJ1aWxkZXIuX21vZGlmaWVycy5jaGVja0luID0gW1swLCAxXV07XG4gICAgcmV0dXJuICdudW1iZXIoMSwgMCknO1xuICB9LFxuXG4gIHZhcmNoYXI6IGZ1bmN0aW9uKGxlbmd0aCkge1xuICAgIHJldHVybiAndmFyY2hhcjIoJyArIHRoaXMuX251bShsZW5ndGgsIDI1NSkgKyAnKSc7XG4gIH0sXG5cbiAgLy8gTW9kaWZpZXJzXG4gIC8vIC0tLS0tLVxuXG4gIGNvbW1lbnQ6IGZ1bmN0aW9uKGNvbW1lbnQpIHtcbiAgICB0aGlzLnB1c2hBZGRpdGlvbmFsKGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5wdXNoUXVlcnkoJ2NvbW1lbnQgb24gY29sdW1uICcgKyB0aGlzLnRhYmxlQ29tcGlsZXIudGFibGVOYW1lKCkgKyAnLicgK1xuICAgICAgICB0aGlzLmZvcm1hdHRlci53cmFwKHRoaXMuYXJnc1swXSkgKyBcIiBpcyAnXCIgKyAoY29tbWVudCB8fCAnJykrIFwiJ1wiKTtcbiAgICB9LCBjb21tZW50KTtcbiAgfSxcblxuICBjaGVja0luOiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAvLyBUT0RPOiBNYXliZSBhY2NlcHQgYXJndW1lbnRzIGFsc28gYXMgYXJyYXlcbiAgICAvLyBUT0RPOiB2YWx1ZShzKSBzaG91bGQgYmUgZXNjYXBlZCBwcm9wZXJseVxuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJhdykge1xuICAgICAgdmFsdWUgPSB2YWx1ZS50b1F1ZXJ5KCk7XG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgdmFsdWUgPSBfLm1hcCh2YWx1ZSwgZnVuY3Rpb24gKHYpIHtcbiAgICAgICAgcmV0dXJuIFwiJ1wiICsgdiArIFwiJ1wiO1xuICAgICAgfSkuam9pbignLCAnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFsdWUgPSBcIidcIiArIHZhbHVlICsgXCInXCI7XG4gICAgfVxuICAgIHJldHVybiAnY2hlY2sgKCcgKyB0aGlzLmZvcm1hdHRlci53cmFwKHRoaXMuYXJnc1swXSkgKyAnIGluICgnICsgdmFsdWUgKyAnKSknO1xuICB9XG5cbn0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IENvbHVtbkNvbXBpbGVyX09yYWNsZTtcbiJdfQ==