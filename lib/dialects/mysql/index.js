
// MySQL Client
// -------
'use strict';

var inherits = require('inherits');
var assign = require('lodash/object/assign');

var Client = require('../../client');
var Promise = require('../../promise');
var helpers = require('../../helpers');

var Transaction = require('./transaction');
var QueryCompiler = require('./query/compiler');
var SchemaCompiler = require('./schema/compiler');
var TableCompiler = require('./schema/tablecompiler');
var ColumnCompiler = require('./schema/columncompiler');
var pluck = require('lodash/collection/pluck');

// Always initialize with the "QueryBuilder" and "QueryCompiler"
// objects, which extend the base 'lib/query/builder' and
// 'lib/query/compiler', respectively.
function Client_MySQL(config) {
  Client.call(this, config);
}
inherits(Client_MySQL, Client);

assign(Client_MySQL.prototype, {

  dialect: 'mysql',

  driverName: 'mysql',

  _driver: function _driver() {
    return require('mysql');
  },

  QueryCompiler: QueryCompiler,

  SchemaCompiler: SchemaCompiler,

  TableCompiler: TableCompiler,

  ColumnCompiler: ColumnCompiler,

  Transaction: Transaction,

  wrapIdentifier: function wrapIdentifier(value) {
    return value !== '*' ? '`' + value.replace(/`/g, '``') + '`' : '*';
  },

  // Get a raw connection, called by the `pool` whenever a new
  // connection needs to be added to the pool.
  acquireRawConnection: function acquireRawConnection() {
    var client = this;
    var connection = this.driver.createConnection(this.connectionSettings);
    return new Promise(function (resolver, rejecter) {
      connection.connect(function (err) {
        if (err) return rejecter(err);
        connection.on('error', connectionErrorHandler.bind(null, client, connection));
        connection.on('end', connectionErrorHandler.bind(null, client, connection));
        resolver(connection);
      });
    });
  },

  // Used to explicitly close a connection, called internally by the pool
  // when a connection times out or the pool is shutdown.
  destroyRawConnection: function destroyRawConnection(connection, cb) {
    connection.end(cb);
  },

  // Grab a connection, run the query via the MySQL streaming interface,
  // and pass that through to the stream we've sent back to the client.
  _stream: function _stream(connection, obj, stream, options) {
    options = options || {};
    return new Promise(function (resolver, rejecter) {
      stream.on('error', rejecter);
      stream.on('end', resolver);
      connection.query(obj.sql, obj.bindings).stream(options).pipe(stream);
    });
  },

  // Runs the query on the specified connection, providing the bindings
  // and any other necessary prep work.
  _query: function _query(connection, obj) {
    if (!obj || typeof obj === 'string') obj = { sql: obj };
    return new Promise(function (resolver, rejecter) {
      var sql = obj.sql;
      if (!sql) return resolver();
      if (obj.options) sql = assign({ sql: sql }, obj.options);
      connection.query(sql, obj.bindings, function (err, rows, fields) {
        if (err) return rejecter(err);
        obj.response = [rows, fields];
        resolver(obj);
      });
    });
  },

  // Process the response as returned from the query.
  processResponse: function processResponse(obj, runner) {
    if (obj == null) return;
    var response = obj.response;
    var method = obj.method;
    var rows = response[0];
    var fields = response[1];
    if (obj.output) return obj.output.call(runner, rows, fields);
    switch (method) {
      case 'select':
      case 'pluck':
      case 'first':
        var resp = helpers.skim(rows);
        if (method === 'pluck') return pluck(resp, obj.pluck);
        return method === 'first' ? resp[0] : resp;
      case 'insert':
        return [rows.insertId];
      case 'del':
      case 'update':
      case 'counter':
        return rows.affectedRows;
      default:
        return response;
    }
  }

});

// MySQL Specific error handler
function connectionErrorHandler(client, connection, err) {
  if (connection && err && err.fatal) {
    if (connection.__knex__disposed) return;
    connection.__knex__disposed = true;
    client.pool.destroy(connection);
  }
}

module.exports = Client_MySQL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9teXNxbC9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUdBLElBQUksUUFBUSxHQUFTLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtBQUN4QyxJQUFJLE1BQU0sR0FBVyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQTs7QUFFcEQsSUFBSSxNQUFNLEdBQVcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBQzVDLElBQUksT0FBTyxHQUFVLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQTtBQUM3QyxJQUFJLE9BQU8sR0FBVSxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7O0FBRTdDLElBQUksV0FBVyxHQUFNLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQTtBQUM3QyxJQUFJLGFBQWEsR0FBSSxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtBQUNoRCxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtBQUNqRCxJQUFJLGFBQWEsR0FBSSxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtBQUN0RCxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQTtBQUN2RCxJQUFJLEtBQUssR0FBWSxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQTs7Ozs7QUFLdkQsU0FBUyxZQUFZLENBQUMsTUFBTSxFQUFFO0FBQzVCLFFBQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0NBQzNCO0FBQ0QsUUFBUSxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQzs7QUFFL0IsTUFBTSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUU7O0FBRTdCLFNBQU8sRUFBRSxPQUFPOztBQUVoQixZQUFVLEVBQUUsT0FBTzs7QUFFbkIsU0FBTyxFQUFFLG1CQUFXO0FBQ2xCLFdBQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFBO0dBQ3hCOztBQUVELGVBQWEs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WSxDQUFBO0FBQUEsQUFDMUI7QUFDRSxlQUFPLFFBQVEsQ0FBQTtBQUFBLEtBQ2xCO0dBQ0Y7O0NBRUYsQ0FBQyxDQUFBOzs7QUFHRixTQUFTLHNCQUFzQixDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFO0FBQ3ZELE1BQUksVUFBVSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFO0FBQ2xDLFFBQUksVUFBVSxDQUFDLGdCQUFnQixFQUFFLE9BQU07QUFDdkMsY0FBVSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQTtBQUNsQyxVQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtHQUNoQztDQUNGOztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBNeVNRTCBDbGllbnRcbi8vIC0tLS0tLS1cbnZhciBpbmhlcml0cyAgICAgICA9IHJlcXVpcmUoJ2luaGVyaXRzJylcbnZhciBhc3NpZ24gICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaC9vYmplY3QvYXNzaWduJylcblxudmFyIENsaWVudCAgICAgICAgID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50JylcbnZhciBQcm9taXNlICAgICAgICA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKVxudmFyIGhlbHBlcnMgICAgICAgID0gcmVxdWlyZSgnLi4vLi4vaGVscGVycycpXG5cbnZhciBUcmFuc2FjdGlvbiAgICA9IHJlcXVpcmUoJy4vdHJhbnNhY3Rpb24nKVxudmFyIFF1ZXJ5Q29tcGlsZXIgID0gcmVxdWlyZSgnLi9xdWVyeS9jb21waWxlcicpXG52YXIgU2NoZW1hQ29tcGlsZXIgPSByZXF1aXJlKCcuL3NjaGVtYS9jb21waWxlcicpXG52YXIgVGFibGVDb21waWxlciAgPSByZXF1aXJlKCcuL3NjaGVtYS90YWJsZWNvbXBpbGVyJylcbnZhciBDb2x1bW5Db21waWxlciA9IHJlcXVpcmUoJy4vc2NoZW1hL2NvbHVtbmNvbXBpbGVyJylcbnZhciBwbHVjayAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaC9jb2xsZWN0aW9uL3BsdWNrJylcblxuLy8gQWx3YXlzIGluaXRpYWxpemUgd2l0aCB0aGUgXCJRdWVyeUJ1aWxkZXJcIiBhbmQgXCJRdWVyeUNvbXBpbGVyXCJcbi8vIG9iamVjdHMsIHdoaWNoIGV4dGVuZCB0aGUgYmFzZSAnbGliL3F1ZXJ5L2J1aWxkZXInIGFuZFxuLy8gJ2xpYi9xdWVyeS9jb21waWxlcicsIHJlc3BlY3RpdmVseS5cbmZ1bmN0aW9uIENsaWVudF9NeVNRTChjb25maWcpIHtcbiAgQ2xpZW50LmNhbGwodGhpcywgY29uZmlnKTtcbn1cbmluaGVyaXRzKENsaWVudF9NeVNRTCwgQ2xpZW50KTtcblxuYXNzaWduKENsaWVudF9NeVNRTC5wcm90b3R5cGUsIHtcblxuICBkaWFsZWN0OiAnbXlzcWwnLFxuXG4gIGRyaXZlck5hbWU6ICdteXNxbCcsXG5cbiAgX2RyaXZlcjogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHJlcXVpcmUoJ215c3FsJylcbiAgfSxcblxuICBRdWVyeUNvbXBpbGVyOiBRdWVyeUNvbXBpbGVyLFxuXG4gIFNjaGVtYUNvbXBpbGVyOiBTY2hlbWFDb21waWxlcixcblxuICBUYWJsZUNvbXBpbGVyOiBUYWJsZUNvbXBpbGVyLFxuXG4gIENvbHVtbkNvbXBpbGVyOiBDb2x1bW5Db21waWxlcixcblxuICBUcmFuc2FjdGlvbjogVHJhbnNhY3Rpb24sXG5cbiAgd3JhcElkZW50aWZpZXI6IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgcmV0dXJuICh2YWx1ZSAhPT0gJyonID8gJ2AnICsgdmFsdWUucmVwbGFjZSgvYC9nLCAnYGAnKSArICdgJyA6ICcqJylcbiAgfSxcblxuICAvLyBHZXQgYSByYXcgY29ubmVjdGlvbiwgY2FsbGVkIGJ5IHRoZSBgcG9vbGAgd2hlbmV2ZXIgYSBuZXdcbiAgLy8gY29ubmVjdGlvbiBuZWVkcyB0byBiZSBhZGRlZCB0byB0aGUgcG9vbC5cbiAgYWNxdWlyZVJhd0Nvbm5lY3Rpb246IGZ1bmN0aW9uKCkge1xuICAgIHZhciBjbGllbnQgICAgID0gdGhpc1xuICAgIHZhciBjb25uZWN0aW9uID0gdGhpcy5kcml2ZXIuY3JlYXRlQ29ubmVjdGlvbih0aGlzLmNvbm5lY3Rpb25TZXR0aW5ncylcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZXIsIHJlamVjdGVyKSB7XG4gICAgICBjb25uZWN0aW9uLmNvbm5lY3QoZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3RlcihlcnIpXG4gICAgICAgIGNvbm5lY3Rpb24ub24oJ2Vycm9yJywgY29ubmVjdGlvbkVycm9ySGFuZGxlci5iaW5kKG51bGwsIGNsaWVudCwgY29ubmVjdGlvbikpXG4gICAgICAgIGNvbm5lY3Rpb24ub24oJ2VuZCcsIGNvbm5lY3Rpb25FcnJvckhhbmRsZXIuYmluZChudWxsLCBjbGllbnQsIGNvbm5lY3Rpb24pKVxuICAgICAgICByZXNvbHZlcihjb25uZWN0aW9uKVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0sXG5cbiAgLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2xcbiAgLy8gd2hlbiBhIGNvbm5lY3Rpb24gdGltZXMgb3V0IG9yIHRoZSBwb29sIGlzIHNodXRkb3duLlxuICBkZXN0cm95UmF3Q29ubmVjdGlvbjogZnVuY3Rpb24oY29ubmVjdGlvbiwgY2IpIHtcbiAgICBjb25uZWN0aW9uLmVuZChjYik7XG4gIH0sXG5cbiAgLy8gR3JhYiBhIGNvbm5lY3Rpb24sIHJ1biB0aGUgcXVlcnkgdmlhIHRoZSBNeVNRTCBzdHJlYW1pbmcgaW50ZXJmYWNlLFxuICAvLyBhbmQgcGFzcyB0aGF0IHRocm91Z2ggdG8gdGhlIHN0cmVhbSB3ZSd2ZSBzZW50IGJhY2sgdG8gdGhlIGNsaWVudC5cbiAgX3N0cmVhbTogZnVuY3Rpb24oY29ubmVjdGlvbiwgb2JqLCBzdHJlYW0sIG9wdGlvbnMpIHtcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fVxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHtcbiAgICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3RlcilcbiAgICAgIHN0cmVhbS5vbignZW5kJywgcmVzb2x2ZXIpXG4gICAgICBjb25uZWN0aW9uLnF1ZXJ5KG9iai5zcWwsIG9iai5iaW5kaW5ncykuc3RyZWFtKG9wdGlvbnMpLnBpcGUoc3RyZWFtKVxuICAgIH0pXG4gIH0sXG5cbiAgLy8gUnVucyB0aGUgcXVlcnkgb24gdGhlIHNwZWNpZmllZCBjb25uZWN0aW9uLCBwcm92aWRpbmcgdGhlIGJpbmRpbmdzXG4gIC8vIGFuZCBhbnkgb3RoZXIgbmVjZXNzYXJ5IHByZXAgd29yay5cbiAgX3F1ZXJ5OiBmdW5jdGlvbihjb25uZWN0aW9uLCBvYmopIHtcbiAgICBpZiAoIW9iaiB8fCB0eXBlb2Ygb2JqID09PSAnc3RyaW5nJykgb2JqID0ge3NxbDogb2JqfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHtcbiAgICAgIHZhciBzcWwgPSBvYmouc3FsXG4gICAgICBpZiAoIXNxbCkgcmV0dXJuIHJlc29sdmVyKClcbiAgICAgIGlmIChvYmoub3B0aW9ucykgc3FsID0gYXNzaWduKHtzcWw6IHNxbH0sIG9iai5vcHRpb25zKVxuICAgICAgY29ubmVjdGlvbi5xdWVyeShzcWwsIG9iai5iaW5kaW5ncywgZnVuY3Rpb24oZXJyLCByb3dzLCBmaWVsZHMpIHtcbiAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdGVyKGVycilcbiAgICAgICAgb2JqLnJlc3BvbnNlID0gW3Jvd3MsIGZpZWxkc11cbiAgICAgICAgcmVzb2x2ZXIob2JqKVxuICAgICAgfSlcbiAgICB9KVxuICB9LFxuXG4gIC8vIFByb2Nlc3MgdGhlIHJlc3BvbnNlIGFzIHJldHVybmVkIGZyb20gdGhlIHF1ZXJ5LlxuICBwcm9jZXNzUmVzcG9uc2U6IGZ1bmN0aW9uKG9iaiwgcnVubmVyKSB7XG4gICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm47XG4gICAgdmFyIHJlc3BvbnNlID0gb2JqLnJlc3BvbnNlXG4gICAgdmFyIG1ldGhvZCAgID0gb2JqLm1ldGhvZFxuICAgIHZhciByb3dzICAgICA9IHJlc3BvbnNlWzBdXG4gICAgdmFyIGZpZWxkcyAgID0gcmVzcG9uc2VbMV1cbiAgICBpZiAob2JqLm91dHB1dCkgcmV0dXJuIG9iai5vdXRwdXQuY2FsbChydW5uZXIsIHJvd3MsIGZpZWxkcylcbiAgICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgIGNhc2UgJ3BsdWNrJzpcbiAgICAgIGNhc2UgJ2ZpcnN0JzpcbiAgICAgICAgdmFyIHJlc3AgPSBoZWxwZXJzLnNraW0ocm93cylcbiAgICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BsdWNrJykgcmV0dXJuIHBsdWNrKHJlc3AsIG9iai5wbHVjaylcbiAgICAgICAgcmV0dXJuIG1ldGhvZCA9PT0gJ2ZpcnN0JyA/IHJlc3BbMF0gOiByZXNwXG4gICAgICBjYXNlICdpbnNlcnQnOlxuICAgICAgICByZXR1cm4gW3Jvd3MuaW5zZXJ0SWRdXG4gICAgICBjYXNlICdkZWwnOlxuICAgICAgY2FzZSAndXBkYXRlJzpcbiAgICAgIGNhc2UgJ2NvdW50ZXInOlxuICAgICAgICByZXR1cm4gcm93cy5hZmZlY3RlZFJvd3NcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiByZXNwb25zZVxuICAgIH1cbiAgfVxuXG59KVxuXG4vLyBNeVNRTCBTcGVjaWZpYyBlcnJvciBoYW5kbGVyXG5mdW5jdGlvbiBjb25uZWN0aW9uRXJyb3JIYW5kbGVyKGNsaWVudCwgY29ubmVjdGlvbiwgZXJyKSB7XG4gIGlmIChjb25uZWN0aW9uICYmIGVyciAmJiBlcnIuZmF0YWwpIHtcbiAgICBpZiAoY29ubmVjdGlvbi5fX2tuZXhfX2Rpc3Bvc2VkKSByZXR1cm5cbiAgICBjb25uZWN0aW9uLl9fa25leF9fZGlzcG9zZWQgPSB0cnVlXG4gICAgY2xpZW50LnBvb2wuZGVzdHJveShjb25uZWN0aW9uKVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ2xpZW50X015U1FMXG4iXX0=