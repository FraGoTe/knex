'use strict';

var Transaction = require('../../transaction');
var assign = require('lodash/object/assign');
var inherits = require('inherits');
var debug = require('debug')('knex:tx');
var helpers = require('../../helpers');

function Transaction_MySQL() {
  Transaction.apply(this, arguments);
}
inherits(Transaction_MySQL, Transaction);

assign(Transaction_MySQL.prototype, {

  query: function query(conn, sql, status, value) {
    var t = this;
    var q = this.trxClient.query(conn, sql)['catch'](function (err) {
      return err.errno === 1305;
    }, function () {
      helpers.warn('Transaction was implicitly committed, do not mix transactions and DDL with MySQL (#805)');
    })['catch'](function (err) {
      status = 2;
      value = err;
      t._completed = true;
      debug('%s error running transaction query', t.txid);
    }).tap(function () {
      if (status === 1) t._resolver(value);
      if (status === 2) t._rejecter(value);
    });
    if (status === 1 || status === 2) {
      t._completed = true;
    }
    return q;
  }

});

module.exports = Transaction_MySQL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9teXNxbC90cmFuc2FjdGlvbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO0FBQzlDLElBQUksTUFBTSxHQUFRLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2xELElBQUksUUFBUSxHQUFNLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtBQUNyQyxJQUFJLEtBQUssR0FBUyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUE7QUFDN0MsSUFBSSxPQUFPLEdBQU8sT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBOztBQUUxQyxTQUFTLGlCQUFpQixHQUFHO0FBQzNCLGFBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFBO0NBQ25DO0FBQ0QsUUFBUSxDQUFDLGlCQUFpQixFQUFFLFdBQVcsQ0FBQyxDQUFBOztBQUV4QyxNQUFNLENBQUMsaUJBQWlCLENBQUMsU0FBUyxFQUFFOztBQUVsQyxPQUFLLEVBQUUsZUFBUyxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7QUFDeEMsUUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFBO0FBQ1osUUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxTQUMvQixDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ25CLGFBQU8sR0FBRyxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUE7S0FDMUIsRUFBRSxZQUFXO0FBQ1osYUFBTyxDQUFDLElBQUksQ0FBQyx5RkFBeUYsQ0FBQyxDQUFBO0tBQ3hHLENBQUMsU0FDSSxDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ25CLFlBQU0sR0FBRyxDQUFDLENBQUE7QUFDVixXQUFLLEdBQUksR0FBRyxDQUFBO0FBQ1osT0FBQyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUE7QUFDbkIsV0FBSyxDQUFDLG9DQUFvQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtLQUNwRCxDQUFDLENBQ0QsR0FBRyxDQUFDLFlBQVc7QUFDZCxVQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUNwQyxVQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtLQUNyQyxDQUFDLENBQUE7QUFDSixRQUFJLE1BQU0sS0FBSyxDQUFDLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRTtBQUNoQyxPQUFDLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQTtLQUNwQjtBQUNELFdBQU8sQ0FBQyxDQUFDO0dBQ1Y7O0NBRUYsQ0FBQyxDQUFBOztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUEiLCJmaWxlIjoidHJhbnNhY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbnZhciBUcmFuc2FjdGlvbiA9IHJlcXVpcmUoJy4uLy4uL3RyYW5zYWN0aW9uJylcbnZhciBhc3NpZ24gICAgICA9IHJlcXVpcmUoJ2xvZGFzaC9vYmplY3QvYXNzaWduJyk7XG52YXIgaW5oZXJpdHMgICAgPSByZXF1aXJlKCdpbmhlcml0cycpXG52YXIgZGVidWcgICAgICAgPSByZXF1aXJlKCdkZWJ1ZycpKCdrbmV4OnR4JylcbnZhciBoZWxwZXJzICAgICA9IHJlcXVpcmUoJy4uLy4uL2hlbHBlcnMnKVxuXG5mdW5jdGlvbiBUcmFuc2FjdGlvbl9NeVNRTCgpIHtcbiAgVHJhbnNhY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKVxufVxuaW5oZXJpdHMoVHJhbnNhY3Rpb25fTXlTUUwsIFRyYW5zYWN0aW9uKVxuXG5hc3NpZ24oVHJhbnNhY3Rpb25fTXlTUUwucHJvdG90eXBlLCB7XG5cbiAgcXVlcnk6IGZ1bmN0aW9uKGNvbm4sIHNxbCwgc3RhdHVzLCB2YWx1ZSkge1xuICAgIHZhciB0ID0gdGhpc1xuICAgIHZhciBxID0gdGhpcy50cnhDbGllbnQucXVlcnkoY29ubiwgc3FsKVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICByZXR1cm4gZXJyLmVycm5vID09PSAxMzA1XG4gICAgICB9LCBmdW5jdGlvbigpIHtcbiAgICAgICAgaGVscGVycy53YXJuKCdUcmFuc2FjdGlvbiB3YXMgaW1wbGljaXRseSBjb21taXR0ZWQsIGRvIG5vdCBtaXggdHJhbnNhY3Rpb25zIGFuZCBEREwgd2l0aCBNeVNRTCAoIzgwNSknKVxuICAgICAgfSlcbiAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgc3RhdHVzID0gMlxuICAgICAgICB2YWx1ZSAgPSBlcnJcbiAgICAgICAgdC5fY29tcGxldGVkID0gdHJ1ZVxuICAgICAgICBkZWJ1ZygnJXMgZXJyb3IgcnVubmluZyB0cmFuc2FjdGlvbiBxdWVyeScsIHQudHhpZClcbiAgICAgIH0pXG4gICAgICAudGFwKGZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAoc3RhdHVzID09PSAxKSB0Ll9yZXNvbHZlcih2YWx1ZSlcbiAgICAgICAgaWYgKHN0YXR1cyA9PT0gMikgdC5fcmVqZWN0ZXIodmFsdWUpXG4gICAgICB9KVxuICAgIGlmIChzdGF0dXMgPT09IDEgfHwgc3RhdHVzID09PSAyKSB7XG4gICAgICB0Ll9jb21wbGV0ZWQgPSB0cnVlXG4gICAgfVxuICAgIHJldHVybiBxO1xuICB9XG5cbn0pXG5cbm1vZHVsZS5leHBvcnRzID0gVHJhbnNhY3Rpb25fTXlTUUxcbiJdfQ==