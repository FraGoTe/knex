
// WebSQL
// -------
'use strict';

var inherits = require('inherits');
var _ = require('lodash');

var Transaction = require('./transaction');
var Client_SQLite3 = require('../sqlite3');
var Promise = require('../../promise');
var assign = require('lodash/object/assign');

function Client_WebSQL(config) {
  Client_SQLite3.call(this, config);
  this.name = config.name || 'knex_database';
  this.version = config.version || '1.0';
  this.displayName = config.displayName || this.name;
  this.estimatedSize = config.estimatedSize || 5 * 1024 * 1024;
}
inherits(Client_WebSQL, Client_SQLite3);

assign(Client_WebSQL.prototype, {

  Transaction: Transaction,

  dialect: 'websql',

  // Get a raw connection from the database, returning a promise with the connection object.
  acquireConnection: function acquireConnection() {
    var client = this;
    return new Promise(function (resolve, reject) {
      try {
        /*jslint browser: true*/
        var db = openDatabase(client.name, client.version, client.displayName, client.estimatedSize);
        db.transaction(function (t) {
          t.__knexUid = _.uniqueId('__knexUid');
          resolve(t);
        });
      } catch (e) {
        reject(e);
      }
    });
  },

  // Used to explicitly close a connection, called internally by the pool
  // when a connection times out or the pool is shutdown.
  releaseConnection: function releaseConnection() {
    return Promise.resolve();
  },

  // Runs the query on the specified connection,
  // providing the bindings and any other necessary prep work.
  _query: function _query(connection, obj) {
    return new Promise(function (resolver, rejecter) {
      if (!connection) return rejecter(new Error('No connection provided.'));
      connection.executeSql(obj.sql, obj.bindings, function (trx, response) {
        obj.response = response;
        return resolver(obj);
      }, function (trx, err) {
        rejecter(err);
      });
    });
  },

  _stream: function _stream(connection, sql, stream) {
    var client = this;
    return new Promise(function (resolver, rejecter) {
      stream.on('error', rejecter);
      stream.on('end', resolver);
      return client._query(connection, sql).then(function (obj) {
        return client.processResponse(obj);
      }).map(function (row) {
        stream.write(row);
      })['catch'](function (err) {
        stream.emit('error', err);
      }).then(function () {
        stream.end();
      });
    });
  },

  processResponse: function processResponse(obj, runner) {
    var resp = obj.response;
    if (obj.output) return obj.output.call(runner, resp);
    switch (obj.method) {
      case 'pluck':
      case 'first':
      case 'select':
        var results = [];
        for (var i = 0, l = resp.rows.length; i < l; i++) {
          results[i] = _.clone(resp.rows.item(i));
        }
        if (obj.method === 'pluck') results = _.pluck(results, obj.pluck);
        return obj.method === 'first' ? results[0] : results;
      case 'insert':
        return [resp.insertId];
      case 'delete':
      case 'update':
      case 'counter':
        return resp.rowsAffected;
      default:
        return resp;
    }
  }

});

module.exports = Client_WebSQL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy93ZWJzcWwvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFHQSxJQUFJLFFBQVEsR0FBUyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDeEMsSUFBSSxDQUFDLEdBQWdCLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQTs7QUFFdEMsSUFBSSxXQUFXLEdBQU0sT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0FBQzdDLElBQUksY0FBYyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQTtBQUMxQyxJQUFJLE9BQU8sR0FBVSxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7QUFDN0MsSUFBSSxNQUFNLEdBQVcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUE7O0FBRXBELFNBQVMsYUFBYSxDQUFDLE1BQU0sRUFBRTtBQUM3QixnQkFBYyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDbEMsTUFBSSxDQUFDLElBQUksR0FBWSxNQUFNLENBQUMsSUFBSSxJQUFJLGVBQWUsQ0FBQztBQUNwRCxNQUFJLENBQUMsT0FBTyxHQUFTLE1BQU0sQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDO0FBQzdDLE1BQUksQ0FBQyxXQUFXLEdBQUssTUFBTSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDO0FBQ3JELE1BQUksQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLGFBQWEsSUFBSSxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztDQUM5RDtBQUNELFFBQVEsQ0FBQyxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUM7O0FBRXhDLE1BQU0sQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFOztBQUU5QixhQUFXLEVBQUUsV0FBVzs7QUFFeEIsU0FBTyxFQUFFLFFBQVE7OztBQUdqQixtQkFBaUIsRUFBRSw2QkFBVztBQUM1QixRQUFJLE1BQU0sR0FBRyxJQUFJLENBQUM7QUFDbEIs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WUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDO0FBQ2pCLGFBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ2hELGlCQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3pDO0FBQ0QsWUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLE9BQU8sRUFBRSxPQUFPLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ2xFLGVBQU8sR0FBRyxDQUFDLE1BQU0sS0FBSyxPQUFPLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztBQUFBLEFBQ3ZELFdBQUssUUFBUTtBQUNYLGVBQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFBQSxBQUN6QixXQUFLLFFBQVEsQ0FBQztBQUNkLFdBQUssUUFBUSxDQUFDO0FBQ2QsV0FBSyxTQUFTO0FBQ1osZUFBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0FBQUEsQUFDM0I7QUFDRSxlQUFPLElBQUksQ0FBQztBQUFBLEtBQ2Y7R0FDRjs7Q0FFRixDQUFDLENBQUE7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vIFdlYlNRTFxuLy8gLS0tLS0tLVxudmFyIGluaGVyaXRzICAgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKVxudmFyIF8gICAgICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJylcblxudmFyIFRyYW5zYWN0aW9uICAgID0gcmVxdWlyZSgnLi90cmFuc2FjdGlvbicpXG52YXIgQ2xpZW50X1NRTGl0ZTMgPSByZXF1aXJlKCcuLi9zcWxpdGUzJylcbnZhciBQcm9taXNlICAgICAgICA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKVxudmFyIGFzc2lnbiAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoL29iamVjdC9hc3NpZ24nKVxuXG5mdW5jdGlvbiBDbGllbnRfV2ViU1FMKGNvbmZpZykge1xuICBDbGllbnRfU1FMaXRlMy5jYWxsKHRoaXMsIGNvbmZpZyk7XG4gIHRoaXMubmFtZSAgICAgICAgICA9IGNvbmZpZy5uYW1lIHx8ICdrbmV4X2RhdGFiYXNlJztcbiAgdGhpcy52ZXJzaW9uICAgICAgID0gY29uZmlnLnZlcnNpb24gfHwgJzEuMCc7XG4gIHRoaXMuZGlzcGxheU5hbWUgICA9IGNvbmZpZy5kaXNwbGF5TmFtZSB8fCB0aGlzLm5hbWU7XG4gIHRoaXMuZXN0aW1hdGVkU2l6ZSA9IGNvbmZpZy5lc3RpbWF0ZWRTaXplIHx8IDUgKiAxMDI0ICogMTAyNDtcbn1cbmluaGVyaXRzKENsaWVudF9XZWJTUUwsIENsaWVudF9TUUxpdGUzKTtcblxuYXNzaWduKENsaWVudF9XZWJTUUwucHJvdG90eXBlLCB7XG5cbiAgVHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uLFxuXG4gIGRpYWxlY3Q6ICd3ZWJzcWwnLFxuXG4gIC8vIEdldCBhIHJhdyBjb25uZWN0aW9uIGZyb20gdGhlIGRhdGFiYXNlLCByZXR1cm5pbmcgYSBwcm9taXNlIHdpdGggdGhlIGNvbm5lY3Rpb24gb2JqZWN0LlxuICBhY3F1aXJlQ29ubmVjdGlvbjogZnVuY3Rpb24oKSB7XG4gICAgdmFyIGNsaWVudCA9IHRoaXM7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgLypqc2xpbnQgYnJvd3NlcjogdHJ1ZSovXG4gICAgICAgIHZhciBkYiA9IG9wZW5EYXRhYmFzZShjbGllbnQubmFtZSwgY2xpZW50LnZlcnNpb24sIGNsaWVudC5kaXNwbGF5TmFtZSwgY2xpZW50LmVzdGltYXRlZFNpemUpO1xuICAgICAgICBkYi50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7XG4gICAgICAgICAgdC5fX2tuZXhVaWQgPSBfLnVuaXF1ZUlkKCdfX2tuZXhVaWQnKTtcbiAgICAgICAgICByZXNvbHZlKHQpO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9LFxuXG4gIC8vIFVzZWQgdG8gZXhwbGljaXRseSBjbG9zZSBhIGNvbm5lY3Rpb24sIGNhbGxlZCBpbnRlcm5hbGx5IGJ5IHRoZSBwb29sXG4gIC8vIHdoZW4gYSBjb25uZWN0aW9uIHRpbWVzIG91dCBvciB0aGUgcG9vbCBpcyBzaHV0ZG93bi5cbiAgcmVsZWFzZUNvbm5lY3Rpb246IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICB9LFxuXG4gIC8vIFJ1bnMgdGhlIHF1ZXJ5IG9uIHRoZSBzcGVjaWZpZWQgY29ubmVjdGlvbixcbiAgLy8gcHJvdmlkaW5nIHRoZSBiaW5kaW5ncyBhbmQgYW55IG90aGVyIG5lY2Vzc2FyeSBwcmVwIHdvcmsuXG4gIF9xdWVyeTogZnVuY3Rpb24oY29ubmVjdGlvbiwgb2JqKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgICAgaWYgKCFjb25uZWN0aW9uKSByZXR1cm4gcmVqZWN0ZXIobmV3IEVycm9yKCdObyBjb25uZWN0aW9uIHByb3ZpZGVkLicpKTtcbiAgICAgIGNvbm5lY3Rpb24uZXhlY3V0ZVNxbChvYmouc3FsLCBvYmouYmluZGluZ3MsIGZ1bmN0aW9uKHRyeCwgcmVzcG9uc2UpIHtcbiAgICAgICAgb2JqLnJlc3BvbnNlID0gcmVzcG9uc2U7XG4gICAgICAgIHJldHVybiByZXNvbHZlcihvYmopO1xuICAgICAgfSwgZnVuY3Rpb24odHJ4LCBlcnIpIHtcbiAgICAgICAgcmVqZWN0ZXIoZXJyKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9LFxuXG4gIF9zdHJlYW06IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIHNxbCwgc3RyZWFtKSB7XG4gICAgdmFyIGNsaWVudCA9IHRoaXM7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdGVyKVxuICAgICAgc3RyZWFtLm9uKCdlbmQnLCByZXNvbHZlcilcbiAgICAgIHJldHVybiBjbGllbnQuX3F1ZXJ5KGNvbm5lY3Rpb24sIHNxbCkudGhlbihmdW5jdGlvbihvYmopIHtcbiAgICAgICAgcmV0dXJuIGNsaWVudC5wcm9jZXNzUmVzcG9uc2Uob2JqKVxuICAgICAgfSkubWFwKGZ1bmN0aW9uKHJvdykge1xuICAgICAgICBzdHJlYW0ud3JpdGUocm93KVxuICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycilcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgIHN0cmVhbS5lbmQoKVxuICAgICAgfSlcbiAgICB9KVxuICB9LFxuXG4gIHByb2Nlc3NSZXNwb25zZTogZnVuY3Rpb24ob2JqLCBydW5uZXIpIHtcbiAgICB2YXIgcmVzcCA9IG9iai5yZXNwb25zZTtcbiAgICBpZiAob2JqLm91dHB1dCkgcmV0dXJuIG9iai5vdXRwdXQuY2FsbChydW5uZXIsIHJlc3ApO1xuICAgIHN3aXRjaCAob2JqLm1ldGhvZCkge1xuICAgICAgY2FzZSAncGx1Y2snOlxuICAgICAgY2FzZSAnZmlyc3QnOlxuICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSByZXNwLnJvd3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgcmVzdWx0c1tpXSA9IF8uY2xvbmUocmVzcC5yb3dzLml0ZW0oaSkpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvYmoubWV0aG9kID09PSAncGx1Y2snKSByZXN1bHRzID0gXy5wbHVjayhyZXN1bHRzLCBvYmoucGx1Y2spO1xuICAgICAgICByZXR1cm4gb2JqLm1ldGhvZCA9PT0gJ2ZpcnN0JyA/IHJlc3VsdHNbMF0gOiByZXN1bHRzO1xuICAgICAgY2FzZSAnaW5zZXJ0JzpcbiAgICAgICAgcmV0dXJuIFtyZXNwLmluc2VydElkXTtcbiAgICAgIGNhc2UgJ2RlbGV0ZSc6XG4gICAgICBjYXNlICd1cGRhdGUnOlxuICAgICAgY2FzZSAnY291bnRlcic6XG4gICAgICAgIHJldHVybiByZXNwLnJvd3NBZmZlY3RlZDtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiByZXNwO1xuICAgIH1cbiAgfVxuXG59KVxuXG5tb2R1bGUuZXhwb3J0cyA9IENsaWVudF9XZWJTUUw7XG4iXX0=