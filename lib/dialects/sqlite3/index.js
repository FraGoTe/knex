
// SQLite3
// -------
'use strict';

var _ = require('lodash');
var Promise = require('../../promise');

var inherits = require('inherits');
var assign = require('lodash/object/assign');
var pluck = require('lodash/collection/pluck');

var Client = require('../../client');
var helpers = require('../../helpers');

var QueryCompiler = require('./query/compiler');
var SchemaCompiler = require('./schema/compiler');
var ColumnCompiler = require('./schema/columncompiler');
var TableCompiler = require('./schema/tablecompiler');
var SQLite3_DDL = require('./schema/ddl');

function Client_SQLite3(config) {
  Client.call(this, config);
  if (_.isUndefined(config.useNullAsDefault)) {
    helpers.warn('sqlite does not support inserting default values. Set the `useNullAsDefault` flag to hide this warning. (see docs http://knexjs.org/#Builder-insert).');
  }
}
inherits(Client_SQLite3, Client);

assign(Client_SQLite3.prototype, {

  dialect: 'sqlite3',

  driverName: 'sqlite3',

  _driver: function _driver() {
    return require('sqlite3');
  },

  SchemaCompiler: SchemaCompiler,

  QueryCompiler: QueryCompiler,

  ColumnCompiler: ColumnCompiler,

  TableCompiler: TableCompiler,

  ddl: function ddl(compiler, pragma, connection) {
    return new SQLite3_DDL(this, compiler, pragma, connection);
  },

  // Get a raw connection from the database, returning a promise with the connection object.
  acquireRawConnection: function acquireRawConnection() {
    var client = this;
    return new Promise(function (resolve, reject) {
      var db = new client.driver.Database(client.connectionSettings.filename, function (err) {
        if (err) return reject(err);
        resolve(db);
      });
    });
  },

  // Used to explicitly close a connection, called internally by the pool
  // when a connection times out or the pool is shutdown.
  destroyRawConnection: function destroyRawConnection(connection, cb) {
    connection.close();
    cb();
  },

  // Runs the query on the specified connection, providing the bindings and any other necessary prep work.
  _query: function _query(connection, obj) {
    var method = obj.method;
    var callMethod;
    switch (method) {
      case 'insert':
      case 'update':
      case 'counter':
      case 'del':
        callMethod = 'run';
        break;
      default:
        callMethod = 'all';
    }
    return new Promise(function (resolver, rejecter) {
      if (!connection || !connection[callMethod]) {
        return rejecter(new Error('Error calling ' + callMethod + ' on connection.'));
      }
      connection[callMethod](obj.sql, obj.bindings, function (err, response) {
        if (err) return rejecter(err);
        obj.response = response;

        // We need the context here, as it contains
        // the "this.lastID" or "this.changes"
        obj.context = this;
        return resolver(obj);
      });
    });
  },

  _stream: function _stream(connection, sql, stream) {
    var client = this;
    return new Promise(function (resolver, rejecter) {
      stream.on('error', rejecter);
      stream.on('end', resolver);
      return client._query(connection, sql).then(function (obj) {
        return obj.response;
      }).map(function (row) {
        stream.write(row);
      })['catch'](function (err) {
        stream.emit('error', err);
      }).then(function () {
        stream.end();
      });
    });
  },

  prepBindings: function prepBindings(bindings) {
    return _.map(bindings, function (binding) {
      if (binding === undefined && this.valueForUndefined !== null) {
        throw new TypeError("`sqlite` does not support inserting default values. Specify values explicitly or use the `useNullAsDefault` config flag. (see docs http://knexjs.org/#Builder-insert).");
      } else {
        return binding;
      }
    }, this);
  },

  // Ensures the response is returned in the same format as other clients.
  processResponse: function processResponse(obj, runner) {
    var ctx = obj.context;
    var response = obj.response;
    if (obj.output) return obj.output.call(runner, response);
    switch (obj.method) {
      case 'select':
      case 'pluck':
      case 'first':
        response = helpers.skim(response);
        if (obj.method === 'pluck') response = pluck(response, obj.pluck);
        return obj.method === 'first' ? response[0] : response;
      case 'insert':
        return [ctx.lastID];
      case 'del':
      case 'update':
      case 'counter':
        return ctx.changes;
      default:
        return response;
    }
  },

  poolDefaults: function poolDefaults(config) {
    return assign(Client.prototype.poolDefaults.call(this, config), {
      min: 1,
      max: 1
    });
  }

});

module.exports = Client_SQLite3;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9zcWxpdGUzL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBR0EsSUFBSSxDQUFDLEdBQWdCLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQTtBQUN0QyxJQUFJLE9BQU8sR0FBVSxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7O0FBRTdDLElBQUksUUFBUSxHQUFTLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtBQUN4QyxJQUFJLE1BQU0sR0FBVyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtBQUNwRCxJQUFJLEtBQUssR0FBWSxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQzs7QUFFeEQsSUFBSSxNQUFNLEdBQVcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBQzVDLElBQUksT0FBTyxHQUFVLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQTs7QUFFN0MsSUFBSSxhQUFhLEdBQUksT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUE7QUFDaEQsSUFBSSxjQUFjLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUE7QUFDakQsSUFBSSxjQUFjLEdBQUcsT0FBTyxDQUFDLHlCQUF5QixDQUFDLENBQUE7QUFDdkQsSUFBSSxhQUFhLEdBQUksT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUE7QUFDdEQsSUFBSSxXQUFXLEdBQU0sT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFBOztBQUU1QyxTQUFTLGNBQWMsQ0FBQyxNQUFNLEVBQUU7QUFDOUIsUUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUE7QUFDekIsTUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO0FBQzFDLFdBQU8sQ0FBQyxJQUFJLENBQUMsdUpBQXVKLENBQUMsQ0FBQztHQUN2SztDQUNGO0FBQ0QsUUFBUSxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQTs7QUFF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QUssT0FBTyxDQUFDO0FBQ2IsV0FBSyxPQUFPO0FBQ1YsZ0JBQVEsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQ2pDLFlBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxPQUFPLEVBQUUsUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBQ2pFLGVBQU8sR0FBRyxDQUFDLE1BQU0sS0FBSyxPQUFPLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQztBQUFBLEFBQ3pELFdBQUssUUFBUTtBQUNYLGVBQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7QUFBQSxBQUN0QixXQUFLLEtBQUssQ0FBQztBQUNYLFdBQUssUUFBUSxDQUFDO0FBQ2QsV0FBSyxTQUFTO0FBQ1osZUFBTyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQUEsQUFDckI7QUFDRSxlQUFPLFFBQVEsQ0FBQztBQUFBLEtBQ25CO0dBQ0Y7O0FBRUQsY0FBWSxFQUFFLHNCQUFTLE1BQU0sRUFBRTtBQUM3QixXQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxFQUFFO0FBQzlELFNBQUcsRUFBRSxDQUFDO0FBQ04sU0FBRyxFQUFFLENBQUM7S0FDUCxDQUFDLENBQUE7R0FDSDs7Q0FFRixDQUFDLENBQUE7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUEiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vIFNRTGl0ZTNcbi8vIC0tLS0tLS1cbnZhciBfICAgICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpXG52YXIgUHJvbWlzZSAgICAgICAgPSByZXF1aXJlKCcuLi8uLi9wcm9taXNlJylcblxudmFyIGluaGVyaXRzICAgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKVxudmFyIGFzc2lnbiAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoL29iamVjdC9hc3NpZ24nKVxudmFyIHBsdWNrICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoL2NvbGxlY3Rpb24vcGx1Y2snKTtcblxudmFyIENsaWVudCAgICAgICAgID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50JylcbnZhciBoZWxwZXJzICAgICAgICA9IHJlcXVpcmUoJy4uLy4uL2hlbHBlcnMnKVxuXG52YXIgUXVlcnlDb21waWxlciAgPSByZXF1aXJlKCcuL3F1ZXJ5L2NvbXBpbGVyJylcbnZhciBTY2hlbWFDb21waWxlciA9IHJlcXVpcmUoJy4vc2NoZW1hL2NvbXBpbGVyJylcbnZhciBDb2x1bW5Db21waWxlciA9IHJlcXVpcmUoJy4vc2NoZW1hL2NvbHVtbmNvbXBpbGVyJylcbnZhciBUYWJsZUNvbXBpbGVyICA9IHJlcXVpcmUoJy4vc2NoZW1hL3RhYmxlY29tcGlsZXInKVxudmFyIFNRTGl0ZTNfRERMICAgID0gcmVxdWlyZSgnLi9zY2hlbWEvZGRsJylcblxuZnVuY3Rpb24gQ2xpZW50X1NRTGl0ZTMoY29uZmlnKSB7XG4gIENsaWVudC5jYWxsKHRoaXMsIGNvbmZpZylcbiAgaWYgKF8uaXNVbmRlZmluZWQoY29uZmlnLnVzZU51bGxBc0RlZmF1bHQpKSB7XG4gICAgaGVscGVycy53YXJuKCdzcWxpdGUgZG9lcyBub3Qgc3VwcG9ydCBpbnNlcnRpbmcgZGVmYXVsdCB2YWx1ZXMuIFNldCB0aGUgYHVzZU51bGxBc0RlZmF1bHRgIGZsYWcgdG8gaGlkZSB0aGlzIHdhcm5pbmcuIChzZWUgZG9jcyBodHRwOi8va25leGpzLm9yZy8jQnVpbGRlci1pbnNlcnQpLicpO1xuICB9XG59XG5pbmhlcml0cyhDbGllbnRfU1FMaXRlMywgQ2xpZW50KVxuXG5hc3NpZ24oQ2xpZW50X1NRTGl0ZTMucHJvdG90eXBlLCB7XG5cbiAgZGlhbGVjdDogJ3NxbGl0ZTMnLFxuXG4gIGRyaXZlck5hbWU6ICdzcWxpdGUzJyxcblxuICBfZHJpdmVyOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gcmVxdWlyZSgnc3FsaXRlMycpXG4gIH0sXG5cbiAgU2NoZW1hQ29tcGlsZXI6IFNjaGVtYUNvbXBpbGVyLFxuXG4gIFF1ZXJ5Q29tcGlsZXI6IFF1ZXJ5Q29tcGlsZXIsXG5cbiAgQ29sdW1uQ29tcGlsZXI6IENvbHVtbkNvbXBpbGVyLFxuXG4gIFRhYmxlQ29tcGlsZXI6IFRhYmxlQ29tcGlsZXIsXG5cbiAgZGRsOiBmdW5jdGlvbihjb21waWxlciwgcHJhZ21hLCBjb25uZWN0aW9uKSB7XG4gICAgcmV0dXJuIG5ldyBTUUxpdGUzX0RETCh0aGlzLCBjb21waWxlciwgcHJhZ21hLCBjb25uZWN0aW9uKVxuICB9LFxuXG4gIC8vIEdldCBhIHJhdyBjb25uZWN0aW9uIGZyb20gdGhlIGRhdGFiYXNlLCByZXR1cm5pbmcgYSBwcm9taXNlIHdpdGggdGhlIGNvbm5lY3Rpb24gb2JqZWN0LlxuICBhY3F1aXJlUmF3Q29ubmVjdGlvbjogZnVuY3Rpb24oKSB7XG4gICAgdmFyIGNsaWVudCA9IHRoaXM7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgdmFyIGRiID0gbmV3IGNsaWVudC5kcml2ZXIuRGF0YWJhc2UoY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5ncy5maWxlbmFtZSwgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKVxuICAgICAgICByZXNvbHZlKGRiKVxuICAgICAgfSlcbiAgICB9KVxuICB9LFxuXG4gIC8vIFVzZWQgdG8gZXhwbGljaXRseSBjbG9zZSBhIGNvbm5lY3Rpb24sIGNhbGxlZCBpbnRlcm5hbGx5IGJ5IHRoZSBwb29sXG4gIC8vIHdoZW4gYSBjb25uZWN0aW9uIHRpbWVzIG91dCBvciB0aGUgcG9vbCBpcyBzaHV0ZG93bi5cbiAgZGVzdHJveVJhd0Nvbm5lY3Rpb246IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIGNiKSB7XG4gICAgY29ubmVjdGlvbi5jbG9zZSgpXG4gICAgY2IoKVxuICB9LFxuXG4gIC8vIFJ1bnMgdGhlIHF1ZXJ5IG9uIHRoZSBzcGVjaWZpZWQgY29ubmVjdGlvbiwgcHJvdmlkaW5nIHRoZSBiaW5kaW5ncyBhbmQgYW55IG90aGVyIG5lY2Vzc2FyeSBwcmVwIHdvcmsuXG4gIF9xdWVyeTogZnVuY3Rpb24oY29ubmVjdGlvbiwgb2JqKSB7XG4gICAgdmFyIG1ldGhvZCA9IG9iai5tZXRob2Q7XG4gICAgdmFyIGNhbGxNZXRob2Q7XG4gICAgc3dpdGNoIChtZXRob2QpIHtcbiAgICAgIGNhc2UgJ2luc2VydCc6XG4gICAgICBjYXNlICd1cGRhdGUnOlxuICAgICAgY2FzZSAnY291bnRlcic6XG4gICAgICBjYXNlICdkZWwnOlxuICAgICAgICBjYWxsTWV0aG9kID0gJ3J1bic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgY2FsbE1ldGhvZCA9ICdhbGwnO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZXIsIHJlamVjdGVyKSB7XG4gICAgICBpZiAoIWNvbm5lY3Rpb24gfHwgIWNvbm5lY3Rpb25bY2FsbE1ldGhvZF0pIHtcbiAgICAgICAgcmV0dXJuIHJlamVjdGVyKG5ldyBFcnJvcignRXJyb3IgY2FsbGluZyAnICsgY2FsbE1ldGhvZCArICcgb24gY29ubmVjdGlvbi4nKSlcbiAgICAgIH1cbiAgICAgIGNvbm5lY3Rpb25bY2FsbE1ldGhvZF0ob2JqLnNxbCwgb2JqLmJpbmRpbmdzLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3RlcihlcnIpXG4gICAgICAgIG9iai5yZXNwb25zZSA9IHJlc3BvbnNlO1xuXG4gICAgICAgIC8vIFdlIG5lZWQgdGhlIGNvbnRleHQgaGVyZSwgYXMgaXQgY29udGFpbnNcbiAgICAgICAgLy8gdGhlIFwidGhpcy5sYXN0SURcIiBvciBcInRoaXMuY2hhbmdlc1wiXG4gICAgICAgIG9iai5jb250ZXh0ICA9IHRoaXM7XG4gICAgICAgIHJldHVybiByZXNvbHZlcihvYmopXG4gICAgICB9KVxuICAgIH0pXG4gIH0sXG5cbiAgX3N0cmVhbTogZnVuY3Rpb24oY29ubmVjdGlvbiwgc3FsLCBzdHJlYW0pIHtcbiAgICB2YXIgY2xpZW50ID0gdGhpcztcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZXIsIHJlamVjdGVyKSB7XG4gICAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0ZXIpXG4gICAgICBzdHJlYW0ub24oJ2VuZCcsIHJlc29sdmVyKVxuICAgICAgcmV0dXJuIGNsaWVudC5fcXVlcnkoY29ubmVjdGlvbiwgc3FsKS50aGVuKGZ1bmN0aW9uKG9iaikge1xuICAgICAgICByZXR1cm4gb2JqLnJlc3BvbnNlXG4gICAgICB9KS5tYXAoZnVuY3Rpb24ocm93KSB7XG4gICAgICAgIHN0cmVhbS53cml0ZShyb3cpXG4gICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKVxuICAgICAgfSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgc3RyZWFtLmVuZCgpXG4gICAgICB9KVxuICAgIH0pXG4gIH0sXG5cbiAgcHJlcEJpbmRpbmdzOiBmdW5jdGlvbihiaW5kaW5ncykge1xuICAgIHJldHVybiBfLm1hcChiaW5kaW5ncywgZnVuY3Rpb24oYmluZGluZykge1xuICAgICAgaWYgKGJpbmRpbmcgPT09IHVuZGVmaW5lZCAmJiB0aGlzLnZhbHVlRm9yVW5kZWZpbmVkICE9PSBudWxsKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJgc3FsaXRlYCBkb2VzIG5vdCBzdXBwb3J0IGluc2VydGluZyBkZWZhdWx0IHZhbHVlcy4gU3BlY2lmeSB2YWx1ZXMgZXhwbGljaXRseSBvciB1c2UgdGhlIGB1c2VOdWxsQXNEZWZhdWx0YCBjb25maWcgZmxhZy4gKHNlZSBkb2NzIGh0dHA6Ly9rbmV4anMub3JnLyNCdWlsZGVyLWluc2VydCkuXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGJpbmRpbmdcbiAgICAgIH1cbiAgICB9LCB0aGlzKTtcbiAgfSxcblxuICAvLyBFbnN1cmVzIHRoZSByZXNwb25zZSBpcyByZXR1cm5lZCBpbiB0aGUgc2FtZSBmb3JtYXQgYXMgb3RoZXIgY2xpZW50cy5cbiAgcHJvY2Vzc1Jlc3BvbnNlOiBmdW5jdGlvbihvYmosIHJ1bm5lcikge1xuICAgIHZhciBjdHggICAgICA9IG9iai5jb250ZXh0O1xuICAgIHZhciByZXNwb25zZSA9IG9iai5yZXNwb25zZTtcbiAgICBpZiAob2JqLm91dHB1dCkgcmV0dXJuIG9iai5vdXRwdXQuY2FsbChydW5uZXIsIHJlc3BvbnNlKVxuICAgIHN3aXRjaCAob2JqLm1ldGhvZCkge1xuICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgIGNhc2UgJ3BsdWNrJzpcbiAgICAgIGNhc2UgJ2ZpcnN0JzpcbiAgICAgICAgcmVzcG9uc2UgPSBoZWxwZXJzLnNraW0ocmVzcG9uc2UpXG4gICAgICAgIGlmIChvYmoubWV0aG9kID09PSAncGx1Y2snKSByZXNwb25zZSA9IHBsdWNrKHJlc3BvbnNlLCBvYmoucGx1Y2spXG4gICAgICAgIHJldHVybiBvYmoubWV0aG9kID09PSAnZmlyc3QnID8gcmVzcG9uc2VbMF0gOiByZXNwb25zZTtcbiAgICAgIGNhc2UgJ2luc2VydCc6XG4gICAgICAgIHJldHVybiBbY3R4Lmxhc3RJRF07XG4gICAgICBjYXNlICdkZWwnOlxuICAgICAgY2FzZSAndXBkYXRlJzpcbiAgICAgIGNhc2UgJ2NvdW50ZXInOlxuICAgICAgICByZXR1cm4gY3R4LmNoYW5nZXM7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxuICB9LFxuXG4gIHBvb2xEZWZhdWx0czogZnVuY3Rpb24oY29uZmlnKSB7XG4gICAgcmV0dXJuIGFzc2lnbihDbGllbnQucHJvdG90eXBlLnBvb2xEZWZhdWx0cy5jYWxsKHRoaXMsIGNvbmZpZyksIHtcbiAgICAgIG1pbjogMSxcbiAgICAgIG1heDogMVxuICAgIH0pXG4gIH1cblxufSlcblxubW9kdWxlLmV4cG9ydHMgPSBDbGllbnRfU1FMaXRlM1xuIl19