'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var TableCompiler = require('../../../schema/tablecompiler');

// Table Compiler
// -------

function TableCompiler_SQLite3() {
  TableCompiler.apply(this, arguments);
  this.primaryKey = void 0;
}
inherits(TableCompiler_SQLite3, TableCompiler);

// Create a new table.
TableCompiler_SQLite3.prototype.createQuery = function (columns, ifNot) {
  var createStatement = ifNot ? 'create table if not exists ' : 'create table ';
  var sql = createStatement + this.tableName() + ' (' + columns.sql.join(', ');

  // SQLite forces primary keys to be added when the table is initially created
  // so we will need to check for a primary key commands and add the columns
  // to the table's declaration here so they can be created on the tables.
  sql += this.foreignKeys() || '';
  sql += this.primaryKeys() || '';
  sql += ')';

  this.pushQuery(sql);
};

TableCompiler_SQLite3.prototype.addColumns = function (columns) {
  for (var i = 0, l = columns.sql.length; i < l; i++) {
    this.pushQuery({
      sql: 'alter table ' + this.tableName() + ' add column ' + columns.sql[i],
      bindings: columns.bindings[i]
    });
  }
};

// Compile a drop unique key command.
TableCompiler_SQLite3.prototype.dropUnique = function (columns, indexName) {
  indexName = indexName || this._indexCommand('unique', this.tableNameRaw, columns);
  this.pushQuery('drop index ' + indexName);
};

TableCompiler_SQLite3.prototype.dropIndex = function (columns, indexName) {
  indexName = indexName || this._indexCommand('index', this.tableNameRaw, columns);
  this.pushQuery('drop index ' + indexName);
};

// Compile a unique key command.
TableCompiler_SQLite3.prototype.unique = function (columns, indexName) {
  indexName = indexName || this._indexCommand('unique', this.tableNameRaw, columns);
  columns = this.formatter.columnize(columns);
  this.pushQuery('create unique index ' + indexName + ' on ' + this.tableName() + ' (' + columns + ')');
};

// Compile a plain index key command.
TableCompiler_SQLite3.prototype.index = function (columns, indexName) {
  indexName = indexName || this._indexCommand('index', this.tableNameRaw, columns);
  columns = this.formatter.columnize(columns);
  this.pushQuery('create index ' + indexName + ' on ' + this.tableName() + ' (' + columns + ')');
};

TableCompiler_SQLite3.prototype.primary = TableCompiler_SQLite3.prototype.foreign = function () {
  if (this.method !== 'create' && this.method !== 'createIfNot') {
    console.warn('SQLite3 Foreign & Primary keys may only be added on create');
  }
};

TableCompiler_SQLite3.prototype.primaryKeys = function () {
  var pks = _.where(this.grouped.alterTable || [], { method: 'primary' });
  if (pks.length > 0 && pks[0].args.length > 0) {
    var args = Array.isArray(pks[0].args[0]) ? pks[0].args[0] : pks[0].args;
    return ', primary key (' + this.formatter.columnize(args) + ')';
  }
};

TableCompiler_SQLite3.prototype.foreignKeys = function () {
  var sql = '';
  var foreignKeys = _.where(this.grouped.alterTable || [], { method: 'foreign' });
  for (var i = 0, l = foreignKeys.length; i < l; i++) {
    var foreign = foreignKeys[i].args[0];
    var column = this.formatter.columnize(foreign.column);
    var references = this.formatter.columnize(foreign.references);
    var foreignTable = this.formatter.wrap(foreign.inTable);
    sql += ', foreign key(' + column + ') references ' + foreignTable + '(' + references + ')';
    if (foreign.onDelete) sql += ' on delete ' + foreign.onDelete;
    if (foreign.onUpdate) sql += ' on update ' + foreign.onUpdate;
  }
  return sql;
};

TableCompiler_SQLite3.prototype.createTableBlock = function () {
  return this.getColumns().concat().join(',');
};

// Compile a rename column command... very complex in sqlite
TableCompiler_SQLite3.prototype.renameColumn = function (from, to) {
  var compiler = this;
  this.pushQuery({
    sql: 'PRAGMA table_info(' + this.tableName() + ')',
    output: function output(pragma) {
      return compiler.client.ddl(compiler, pragma, this.connection).renameColumn(from, to);
    }
  });
};

TableCompiler_SQLite3.prototype.dropColumn = function (column) {
  var compiler = this;
  this.pushQuery({
    sql: 'PRAGMA table_info(' + this.tableName() + ')',
    output: function output(pragma) {
      return compiler.client.ddl(compiler, pragma, this.connection).dropColumn(column);
    }
  });
};

module.exports = TableCompiler_SQLite3;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9zcWxpdGUzL3NjaGVtYS90YWJsZWNvbXBpbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsSUFBSSxDQUFDLEdBQVUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2pDLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNuQyxJQUFJLGFBQWEsR0FBSyxPQUFPLENBQUMsK0JBQStCLENBQUMsQ0FBQzs7Ozs7QUFLL0QsU0FBUyxxQkFBcUIsR0FBRztBQUMvQixlQUFhLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNyQyxNQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQyxDQUFDO0NBQzFCO0FBQ0QsUUFBUSxDQUFDLHFCQUFxQixFQUFFLGFBQWEsQ0FBQyxDQUFDOzs7QUFHL0MscUJBQXFCLENBQUMsU0FBUyxDQUFDLFdBQVcsR0FBRyxVQUFTLE9BQU8sRUFBRSxLQUFLLEVBQUU7QUFDckUsTUFBSSxlQUFlLEdBQUcsS0FBSyxHQUFHLDZCQUE2QixHQUFHLGVBQWUsQ0FBQztBQUM5RSxNQUFJLEdBQUcsR0FBRyxlQUFlLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs7Ozs7QUFLN0UsS0FBRyxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLENBQUM7QUFDaEMsS0FBRyxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLENBQUM7QUFDaEMsS0FBRyxJQUFJLEdBQUcsQ0FBQzs7QUFFWCxNQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0NBQ3JCLENBQUM7O0FBRUYscUJBQXFCLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxVQUFTLE9BQU8sRUFBRTtBQUM3RCxPQUFLLElBQUksQ0FB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O0FBQ2IsT0FBRyxFQUFFLG9CQUFvQixHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxHQUFHO0FBQ2xELFVBQU0sRUFBRSxnQkFBUyxNQUFNLEVBQUU7QUFDdkIsYUFBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7S0FDbEY7R0FDRixDQUFDLENBQUM7Q0FDSixDQUFDOztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcscUJBQXFCLENBQUMiLCJmaWxlIjoidGFibGVjb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxudmFyIF8gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpO1xudmFyIFRhYmxlQ29tcGlsZXIgICA9IHJlcXVpcmUoJy4uLy4uLy4uL3NjaGVtYS90YWJsZWNvbXBpbGVyJyk7XG5cbi8vIFRhYmxlIENvbXBpbGVyXG4vLyAtLS0tLS0tXG5cbmZ1bmN0aW9uIFRhYmxlQ29tcGlsZXJfU1FMaXRlMygpIHtcbiAgVGFibGVDb21waWxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICB0aGlzLnByaW1hcnlLZXkgPSB2b2lkIDA7XG59XG5pbmhlcml0cyhUYWJsZUNvbXBpbGVyX1NRTGl0ZTMsIFRhYmxlQ29tcGlsZXIpO1xuXG4vLyBDcmVhdGUgYSBuZXcgdGFibGUuXG5UYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmNyZWF0ZVF1ZXJ5ID0gZnVuY3Rpb24oY29sdW1ucywgaWZOb3QpIHtcbiAgdmFyIGNyZWF0ZVN0YXRlbWVudCA9IGlmTm90ID8gJ2NyZWF0ZSB0YWJsZSBpZiBub3QgZXhpc3RzICcgOiAnY3JlYXRlIHRhYmxlICc7XG4gIHZhciBzcWwgPSBjcmVhdGVTdGF0ZW1lbnQgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyAoJyArIGNvbHVtbnMuc3FsLmpvaW4oJywgJyk7XG5cbiAgLy8gU1FMaXRlIGZvcmNlcyBwcmltYXJ5IGtleXMgdG8gYmUgYWRkZWQgd2hlbiB0aGUgdGFibGUgaXMgaW5pdGlhbGx5IGNyZWF0ZWRcbiAgLy8gc28gd2Ugd2lsbCBuZWVkIHRvIGNoZWNrIGZvciBhIHByaW1hcnkga2V5IGNvbW1hbmRzIGFuZCBhZGQgdGhlIGNvbHVtbnNcbiAgLy8gdG8gdGhlIHRhYmxlJ3MgZGVjbGFyYXRpb24gaGVyZSBzbyB0aGV5IGNhbiBiZSBjcmVhdGVkIG9uIHRoZSB0YWJsZXMuXG4gIHNxbCArPSB0aGlzLmZvcmVpZ25LZXlzKCkgfHwgJyc7XG4gIHNxbCArPSB0aGlzLnByaW1hcnlLZXlzKCkgfHwgJyc7XG4gIHNxbCArPSAnKSc7XG5cbiAgdGhpcy5wdXNoUXVlcnkoc3FsKTtcbn07XG5cblRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuYWRkQ29sdW1ucyA9IGZ1bmN0aW9uKGNvbHVtbnMpIHtcbiAgZm9yICh2YXIgaSA9IDAsIGwgPSBjb2x1bW5zLnNxbC5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICB0aGlzLnB1c2hRdWVyeSh7XG4gICAgICBzcWw6ICdhbHRlciB0YWJsZSAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgYWRkIGNvbHVtbiAnICsgY29sdW1ucy5zcWxbaV0sXG4gICAgICBiaW5kaW5nczogY29sdW1ucy5iaW5kaW5nc1tpXVxuICAgIH0pO1xuICB9XG59O1xuXG4vLyBDb21waWxlIGEgZHJvcCB1bmlxdWUga2V5IGNvbW1hbmQuXG5UYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmRyb3BVbmlxdWUgPSBmdW5jdGlvbihjb2x1bW5zLCBpbmRleE5hbWUpIHtcbiAgaW5kZXhOYW1lID0gaW5kZXhOYW1lIHx8IHRoaXMuX2luZGV4Q29tbWFuZCgndW5pcXVlJywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpO1xuICB0aGlzLnB1c2hRdWVyeSgnZHJvcCBpbmRleCAnICsgaW5kZXhOYW1lKTtcbn07XG5cblRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZHJvcEluZGV4ID0gZnVuY3Rpb24oY29sdW1ucywgaW5kZXhOYW1lKSB7XG4gIGluZGV4TmFtZSA9IGluZGV4TmFtZSB8fCB0aGlzLl9pbmRleENvbW1hbmQoJ2luZGV4JywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpO1xuICB0aGlzLnB1c2hRdWVyeSgnZHJvcCBpbmRleCAnICsgaW5kZXhOYW1lKTtcbn07XG5cbi8vIENvbXBpbGUgYSB1bmlxdWUga2V5IGNvbW1hbmQuXG5UYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLnVuaXF1ZSA9IGZ1bmN0aW9uKGNvbHVtbnMsIGluZGV4TmFtZSkge1xuICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCd1bmlxdWUnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gIGNvbHVtbnMgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucyk7XG4gIHRoaXMucHVzaFF1ZXJ5KCdjcmVhdGUgdW5pcXVlIGluZGV4ICcgKyBpbmRleE5hbWUgKyAnIG9uICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyAoJyArIGNvbHVtbnMgKyAnKScpO1xufTtcblxuLy8gQ29tcGlsZSBhIHBsYWluIGluZGV4IGtleSBjb21tYW5kLlxuVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5pbmRleCA9IGZ1bmN0aW9uKGNvbHVtbnMsIGluZGV4TmFtZSkge1xuICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCdpbmRleCcsIHRoaXMudGFibGVOYW1lUmF3LCBjb2x1bW5zKTtcbiAgY29sdW1ucyA9IHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShjb2x1bW5zKTtcbiAgdGhpcy5wdXNoUXVlcnkoJ2NyZWF0ZSBpbmRleCAnICsgaW5kZXhOYW1lICsgJyBvbiAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgKCcgKyBjb2x1bW5zICsgJyknKTtcbn07XG5cblRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUucHJpbWFyeSA9XG5UYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmZvcmVpZ24gPSBmdW5jdGlvbigpIHtcbiAgaWYgKHRoaXMubWV0aG9kICE9PSAnY3JlYXRlJyAmJiB0aGlzLm1ldGhvZCAhPT0gJ2NyZWF0ZUlmTm90Jykge1xuICAgIGNvbnNvbGUud2FybignU1FMaXRlMyBGb3JlaWduICYgUHJpbWFyeSBrZXlzIG1heSBvbmx5IGJlIGFkZGVkIG9uIGNyZWF0ZScpO1xuICB9XG59O1xuXG5UYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLnByaW1hcnlLZXlzID0gZnVuY3Rpb24oKSB7XG4gIHZhciBwa3MgPSBfLndoZXJlKHRoaXMuZ3JvdXBlZC5hbHRlclRhYmxlIHx8IFtdLCB7bWV0aG9kOiAncHJpbWFyeSd9KTtcbiAgaWYgKHBrcy5sZW5ndGggPiAwICYmIHBrc1swXS5hcmdzLmxlbmd0aCA+IDApIHtcbiAgICB2YXIgYXJncyA9IEFycmF5LmlzQXJyYXkocGtzWzBdLmFyZ3NbMF0pID8gcGtzWzBdLmFyZ3NbMF0gOiBwa3NbMF0uYXJncztcbiAgICByZXR1cm4gJywgcHJpbWFyeSBrZXkgKCcgKyB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoYXJncykgKyAnKSc7XG4gIH1cbn07XG5cblRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZm9yZWlnbktleXMgPSBmdW5jdGlvbigpIHtcbiAgdmFyIHNxbCA9ICcnO1xuICB2YXIgZm9yZWlnbktleXMgPSBfLndoZXJlKHRoaXMuZ3JvdXBlZC5hbHRlclRhYmxlIHx8IFtdLCB7bWV0aG9kOiAnZm9yZWlnbid9KTtcbiAgZm9yICh2YXIgaSA9IDAsIGwgPSBmb3JlaWduS2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICB2YXIgZm9yZWlnbiAgICAgICA9IGZvcmVpZ25LZXlzW2ldLmFyZ3NbMF07XG4gICAgdmFyIGNvbHVtbiAgICAgICAgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoZm9yZWlnbi5jb2x1bW4pO1xuICAgIHZhciByZWZlcmVuY2VzICAgID0gdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGZvcmVpZ24ucmVmZXJlbmNlcyk7XG4gICAgdmFyIGZvcmVpZ25UYWJsZSAgPSB0aGlzLmZvcm1hdHRlci53cmFwKGZvcmVpZ24uaW5UYWJsZSk7XG4gICAgc3FsICs9ICcsIGZvcmVpZ24ga2V5KCcgKyBjb2x1bW4gKyAnKSByZWZlcmVuY2VzICcgKyBmb3JlaWduVGFibGUgKyAnKCcgKyByZWZlcmVuY2VzICsgJyknO1xuICAgIGlmIChmb3JlaWduLm9uRGVsZXRlKSBzcWwgKz0gJyBvbiBkZWxldGUgJyArIGZvcmVpZ24ub25EZWxldGU7XG4gICAgaWYgKGZvcmVpZ24ub25VcGRhdGUpIHNxbCArPSAnIG9uIHVwZGF0ZSAnICsgZm9yZWlnbi5vblVwZGF0ZTtcbiAgfVxuICByZXR1cm4gc3FsO1xufTtcblxuVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5jcmVhdGVUYWJsZUJsb2NrID0gZnVuY3Rpb24oKSB7XG4gIHJldHVybiB0aGlzLmdldENvbHVtbnMoKS5jb25jYXQoKS5qb2luKCcsJyk7XG59O1xuXG4vLyBDb21waWxlIGEgcmVuYW1lIGNvbHVtbiBjb21tYW5kLi4uIHZlcnkgY29tcGxleCBpbiBzcWxpdGVcblRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUucmVuYW1lQ29sdW1uID0gZnVuY3Rpb24oZnJvbSwgdG8pIHtcbiAgdmFyIGNvbXBpbGVyID0gdGhpcztcbiAgdGhpcy5wdXNoUXVlcnkoe1xuICAgIHNxbDogJ1BSQUdNQSB0YWJsZV9pbmZvKCcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyknLFxuICAgIG91dHB1dDogZnVuY3Rpb24ocHJhZ21hKSB7XG4gICAgICByZXR1cm4gY29tcGlsZXIuY2xpZW50LmRkbChjb21waWxlciwgcHJhZ21hLCB0aGlzLmNvbm5lY3Rpb24pLnJlbmFtZUNvbHVtbihmcm9tLCB0byk7XG4gICAgfVxuICB9KTtcbn07XG5cblRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZHJvcENvbHVtbiA9IGZ1bmN0aW9uKGNvbHVtbikge1xuICB2YXIgY29tcGlsZXIgPSB0aGlzO1xuICB0aGlzLnB1c2hRdWVyeSh7XG4gICAgc3FsOiAnUFJBR01BIHRhYmxlX2luZm8oJyArIHRoaXMudGFibGVOYW1lKCkgKyAnKScsXG4gICAgb3V0cHV0OiBmdW5jdGlvbihwcmFnbWEpIHtcbiAgICAgIHJldHVybiBjb21waWxlci5jbGllbnQuZGRsKGNvbXBpbGVyLCBwcmFnbWEsIHRoaXMuY29ubmVjdGlvbikuZHJvcENvbHVtbihjb2x1bW4pO1xuICAgIH1cbiAgfSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFRhYmxlQ29tcGlsZXJfU1FMaXRlMztcbiJdfQ==