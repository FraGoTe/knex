
// SQLite3_DDL
//
// All of the SQLite3 specific DDL helpers for renaming/dropping
// columns and changing datatypes.
// -------

'use strict';

var _ = require('lodash');
var Promise = require('../../../promise');
var assign = require('lodash/object/assign');

// So altering the schema in SQLite3 is a major pain.
// We have our own object to deal with the renaming and altering the types
// for sqlite3 things.
function SQLite3_DDL(client, tableCompiler, pragma, connection) {
  this.client = client;
  this.tableCompiler = tableCompiler;
  this.pragma = pragma;
  this.tableName = this.tableCompiler.tableNameRaw;
  this.alteredName = _.uniqueId('_knex_temp_alter');
  this.connection = connection;
}

assign(SQLite3_DDL.prototype, {

  getColumn: Promise.method(function (column) {
    var currentCol = _.findWhere(this.pragma, { name: column });
    if (!currentCol) throw new Error('The column ' + column + ' is not in the ' + this.tableName + ' table');
    return currentCol;
  }),

  getTableSql: function getTableSql() {
    return this.trx.raw('SELECT name, sql FROM sqlite_master WHERE type="table" AND name="' + this.tableName + '"');
  },

  renameTable: Promise.method(function () {
    return this.trx.raw('ALTER TABLE "' + this.tableName + '" RENAME TO "' + this.alteredName + '"');
  }),

  dropOriginal: function dropOriginal() {
    return this.trx.raw('DROP TABLE "' + this.tableName + '"');
  },

  dropTempTable: function dropTempTable() {
    return this.trx.raw('DROP TABLE "' + this.alteredName + '"');
  },

  copyData: function copyData() {
    return this.trx.raw('SELECT * FROM "' + this.tableName + '"').bind(this).then(this.insertChunked(20, this.alteredName));
  },

  reinsertData: function reinsertData(iterator) {
    return function () {
      return this.trx.raw('SELECT * FROM "' + this.alteredName + '"').bind(this).then(this.insertChunked(20, this.tableName, iterator));
    };
  },

  insertChunked: function insertChunked(amount, target, iterator) {
    iterator = iterator || function (noop) {
      return noop;
    };
    return function (result) {
      var batch = [];
      var ddl = this;
      return Promise.reduce(result, function (memo, row) {
        memo++;
        batch.push(row);
        if (memo % 20 === 0 || memo === result.length) {
          return ddl.trx.queryBuilder().table(target).insert(_.map(batch, iterator)).then(function () {
            batch = [];
          }).thenReturn(memo);
        }
        return memo;
      }, 0);
    };
  },

  createTempTable: function createTempTable(createTable) {
    return function () {
      return this.trx.raw(createTable.sql.replace(this.tableName, this.alteredName));
    };
  },

  _doReplace: function _doReplace(sql, from, to) {
    var matched = sql.match(/^CREATE TABLE (\S+) \((.*)\)/);

    var tableName = matched[1],
        defs = matched[2];

    if (!defs) {
      throw new Error('No column definitions in this statement!');
    }

    var parens = 0,
        args = [],
        ptr = 0;
    for (var i = 0, x = defs.length; i < x; i++) {
      switch (defs[i]) {
        case '(':
          parens++;
          break;
        case ')':
          parens--;
          break;
        case ',':
          if (parens === 0) {
            args.push(defs.slice(ptr, i));
            ptr = i + 1;
          }
          break;
        case ' ':
          if (ptr === i) {
            ptr = i + 1;
          }
          break;
      }
    }
    args.push(defs.slice(ptr, i));

    args = args.map(function (item) {
      var split = item.split(' ');

      if (split[0] === from) {
        // column definition
        if (to) {
          split[0] = to;
          return split.join(' ');
        }
        return ''; // for deletions
      }

      // skip constraint name
      var idx = /constraint/i.test(split[0]) ? 2 : 0;

      // primary key and unique constraints have one or more
      // columns from this table listed between (); replace
      // one if it matches
      if (/primary|unique/i.test(split[idx])) {
        return item.replace(/\(.*\)/, function (columns) {
          return columns.replace(from, to);
        });
      }

      // foreign keys have one or more columns from this table
      // listed between (); replace one if it matches
      // foreign keys also have a 'references' clause
      // which may reference THIS table; if it does, replace
      // column references in that too!
      if (/foreign/.test(split[idx])) {
        split = item.split(/ references /i);
        // the quoted column names save us from having to do anything
        // other than a straight replace here
        split[0] = split[0].replace(from, to);

        if (split[1].slice(0, tableName.length) === tableName) {
          split[1] = split[1].replace(/\(.*\)/, function (columns) {
            return columns.replace(from, to);
          });
        }
        return split.join(' references ');
      }

      return item;
    });
    return sql.replace(/\(.*\)/, function () {
      return '(' + args.join(', ') + ')';
    }).replace(/,\s*([,)])/, '$1');
  },

  // Boy, this is quite a method.
  renameColumn: Promise.method(function (from, to) {
    var currentCol;

    return this.client.transaction((function (trx) {
      this.trx = trx;
      return this.getColumn(from).bind(this).tap(function (col) {
        currentCol = col;
      }).then(this.getTableSql).then(function (sql) {
        var a = this.client.wrapIdentifier(from);
        var b = this.client.wrapIdentifier(to);
        var createTable = sql[0];
        var newSql = this._doReplace(createTable.sql, a, b);
        if (sql === newSql) {
          throw new Error('Unable to find the column to change');
        }
        return Promise.bind(this).then(this.createTempTable(createTable)).then(this.copyData).then(this.dropOriginal).then(function () {
          return this.trx.raw(newSql);
        }).then(this.reinsertData(function (row) {
          row[to] = row[from];
          return _.omit(row, from);
        })).then(this.dropTempTable);
      });
    }).bind(this), { connection: this.connection });
  }),

  dropColumn: Promise.method(function (column) {
    var currentCol;

    return this.client.transaction((function (trx) {
      this.trx = trx;
      return this.getColumn(column).tap(function (col) {
        currentCol = col;
      }).bind(this).then(this.getTableSql).then(function (sql) {
        var createTable = sql[0];
        var a = this.client.wrapIdentifier(column);
        var newSql = this._doReplace(createTable.sql, a, '');
        if (sql === newSql) {
          throw new Error('Unable to find the column to change');
        }
        return Promise.bind(this).then(this.createTempTable(createTable)).then(this.copyData).then(this.dropOriginal).then(function () {
          return this.trx.raw(newSql);
        }).then(this.reinsertData(function (row) {
          return _.omit(row, column);
        })).then(this.dropTempTable);
      });
    }).bind(this), { connection: this.connection });
  })

});

module.exports = SQLite3_DDL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9zcWxpdGUzL3NjaGVtYS9kZGwuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBT0EsSUFBSSxDQUFDLEdBQVMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2hDLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQzFDLElBQUksTUFBTSxHQUFJLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDOzs7OztBQUs5QyxTQUFTLFdBQVcsQ0FBQyxNQUFNLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUU7QUFDOUQsTUFBSSxDQUFDLE1BQU0sR0FBVSxNQUFNLENBQUE7QUFDM0IsTUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7QUFDbkMsTUFBSSxDQUFDLE1BQU0sR0FBVSxNQUFNLENBQUM7QUFDNUIsTUFBSSxDQUFDLFNBQVMsR0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQztBQUNyRCxNQUFJLENBQUMsV0FBVyxHQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUNwRCxNQUFJLENBQUMsVUFBVSxHQUFNLFVBQVUsQ0FBQTtDQUNoQzs7QUFFRCxNQUFNLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRTs7QUFFNUIsV0FBUyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBUyxNQUFNLEVBQUU7QUFDekMsUUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUM7QUFDMUQsUUFBSSxDQUFDLFVBQVUsRUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLGFBQWEsR0FBRyxNQUFNLEdBQUcsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsQ0FBQztBQUN6RyxXQUFPLFVBQVUsQ0FBQztH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QUMsTUFBTSxDQUFDLENBQUM7U0FDN0IsQ0FBQyxDQUNELElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ3BDLGlCQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQzVCLENBQUMsQ0FBQyxDQUNGLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7T0FDN0IsQ0FBQyxDQUFBO0tBQ0gsQ0FBQSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFDLENBQUMsQ0FBQTtHQUM3QyxDQUFDOztDQUVILENBQUMsQ0FBQTs7QUFHRixNQUFNLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyIsImZpbGUiOiJkZGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vIFNRTGl0ZTNfRERMXG4vL1xuLy8gQWxsIG9mIHRoZSBTUUxpdGUzIHNwZWNpZmljIERETCBoZWxwZXJzIGZvciByZW5hbWluZy9kcm9wcGluZ1xuLy8gY29sdW1ucyBhbmQgY2hhbmdpbmcgZGF0YXR5cGVzLlxuLy8gLS0tLS0tLVxuXG52YXIgXyAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCcuLi8uLi8uLi9wcm9taXNlJyk7XG52YXIgYXNzaWduICA9IHJlcXVpcmUoJ2xvZGFzaC9vYmplY3QvYXNzaWduJyk7XG5cbi8vIFNvIGFsdGVyaW5nIHRoZSBzY2hlbWEgaW4gU1FMaXRlMyBpcyBhIG1ham9yIHBhaW4uXG4vLyBXZSBoYXZlIG91ciBvd24gb2JqZWN0IHRvIGRlYWwgd2l0aCB0aGUgcmVuYW1pbmcgYW5kIGFsdGVyaW5nIHRoZSB0eXBlc1xuLy8gZm9yIHNxbGl0ZTMgdGhpbmdzLlxuZnVuY3Rpb24gU1FMaXRlM19EREwoY2xpZW50LCB0YWJsZUNvbXBpbGVyLCBwcmFnbWEsIGNvbm5lY3Rpb24pIHtcbiAgdGhpcy5jbGllbnQgICAgICAgID0gY2xpZW50XG4gIHRoaXMudGFibGVDb21waWxlciA9IHRhYmxlQ29tcGlsZXI7XG4gIHRoaXMucHJhZ21hICAgICAgICA9IHByYWdtYTtcbiAgdGhpcy50YWJsZU5hbWUgICAgID0gdGhpcy50YWJsZUNvbXBpbGVyLnRhYmxlTmFtZVJhdztcbiAgdGhpcy5hbHRlcmVkTmFtZSAgID0gXy51bmlxdWVJZCgnX2tuZXhfdGVtcF9hbHRlcicpO1xuICB0aGlzLmNvbm5lY3Rpb24gICAgPSBjb25uZWN0aW9uXG59XG5cbmFzc2lnbihTUUxpdGUzX0RETC5wcm90b3R5cGUsIHtcblxuICBnZXRDb2x1bW46IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKGNvbHVtbikge1xuICAgIHZhciBjdXJyZW50Q29sID0gXy5maW5kV2hlcmUodGhpcy5wcmFnbWEsIHtuYW1lOiBjb2x1bW59KTtcbiAgICBpZiAoIWN1cnJlbnRDb2wpIHRocm93IG5ldyBFcnJvcignVGhlIGNvbHVtbiAnICsgY29sdW1uICsgJyBpcyBub3QgaW4gdGhlICcgKyB0aGlzLnRhYmxlTmFtZSArICcgdGFibGUnKTtcbiAgICByZXR1cm4gY3VycmVudENvbDtcbiAgfSksXG5cbiAgZ2V0VGFibGVTcWw6IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnRyeC5yYXcoJ1NFTEVDVCBuYW1lLCBzcWwgRlJPTSBzcWxpdGVfbWFzdGVyIFdIRVJFIHR5cGU9XCJ0YWJsZVwiIEFORCBuYW1lPVwiJyArIHRoaXMudGFibGVOYW1lICsgJ1wiJyk7XG4gIH0sXG5cbiAgcmVuYW1lVGFibGU6IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnRyeC5yYXcoJ0FMVEVSIFRBQkxFIFwiJyArIHRoaXMudGFibGVOYW1lICsgJ1wiIFJFTkFNRSBUTyBcIicgKyB0aGlzLmFsdGVyZWROYW1lICsgJ1wiJyk7XG4gIH0pLFxuXG4gIGRyb3BPcmlnaW5hbDogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMudHJ4LnJhdygnRFJPUCBUQUJMRSBcIicgKyB0aGlzLnRhYmxlTmFtZSArICdcIicpO1xuICB9LFxuXG4gIGRyb3BUZW1wVGFibGU6IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnRyeC5yYXcoJ0RST1AgVEFCTEUgXCInICsgdGhpcy5hbHRlcmVkTmFtZSArICdcIicpO1xuICB9LFxuXG4gIGNvcHlEYXRhOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy50cngucmF3KCdTRUxFQ1QgKiBGUk9NIFwiJyArIHRoaXMudGFibGVOYW1lICsgJ1wiJylcbiAgICAgIC5iaW5kKHRoaXMpXG4gICAgICAudGhlbih0aGlzLmluc2VydENodW5rZWQoMjAsIHRoaXMuYWx0ZXJlZE5hbWUpKTtcbiAgfSxcblxuICByZWluc2VydERhdGE6IGZ1bmN0aW9uKGl0ZXJhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXMudHJ4LnJhdygnU0VMRUNUICogRlJPTSBcIicgKyB0aGlzLmFsdGVyZWROYW1lICsgJ1wiJylcbiAgICAgICAgLmJpbmQodGhpcylcbiAgICAgICAgLnRoZW4odGhpcy5pbnNlcnRDaHVua2VkKDIwLCB0aGlzLnRhYmxlTmFtZSwgaXRlcmF0b3IpKTtcbiAgICB9O1xuICB9LFxuXG4gIGluc2VydENodW5rZWQ6IGZ1bmN0aW9uKGFtb3VudCwgdGFyZ2V0LCBpdGVyYXRvcikge1xuICAgIGl0ZXJhdG9yID0gaXRlcmF0b3IgfHwgZnVuY3Rpb24obm9vcCkgeyByZXR1cm4gbm9vcDsgfTtcbiAgICByZXR1cm4gZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICB2YXIgYmF0Y2ggPSBbXTtcbiAgICAgIHZhciBkZGwgPSB0aGlzO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVkdWNlKHJlc3VsdCwgZnVuY3Rpb24obWVtbywgcm93KSB7XG4gICAgICAgIG1lbW8rKztcbiAgICAgICAgYmF0Y2gucHVzaChyb3cpO1xuICAgICAgICBpZiAobWVtbyAlIDIwID09PSAwIHx8IG1lbW8gPT09IHJlc3VsdC5sZW5ndGgpIHtcbiAgICAgICAgICByZXR1cm4gZGRsLnRyeC5xdWVyeUJ1aWxkZXIoKVxuICAgICAgICAgICAgLnRhYmxlKHRhcmdldClcbiAgICAgICAgICAgIC5pbnNlcnQoXy5tYXAoYmF0Y2gsIGl0ZXJhdG9yKSlcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgeyBiYXRjaCA9IFtdOyB9KVxuICAgICAgICAgICAgLnRoZW5SZXR1cm4obWVtbyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1lbW87XG4gICAgICB9LCAwKTtcbiAgICB9O1xuICB9LFxuXG4gIGNyZWF0ZVRlbXBUYWJsZTogZnVuY3Rpb24oY3JlYXRlVGFibGUpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy50cngucmF3KGNyZWF0ZVRhYmxlLnNxbC5yZXBsYWNlKHRoaXMudGFibGVOYW1lLCB0aGlzLmFsdGVyZWROYW1lKSk7XG4gICAgfTtcbiAgfSxcblxuICBfZG9SZXBsYWNlOiBmdW5jdGlvbiAoc3FsLCBmcm9tLCB0bykge1xuICAgIHZhciBtYXRjaGVkID0gc3FsLm1hdGNoKC9eQ1JFQVRFIFRBQkxFIChcXFMrKSBcXCgoLiopXFwpLyk7XG4gICAgXG4gICAgdmFyIHRhYmxlTmFtZSA9IG1hdGNoZWRbMV0sXG4gICAgICAgIGRlZnMgPSBtYXRjaGVkWzJdO1xuICAgIFxuICAgIGlmICghZGVmcykgeyB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbHVtbiBkZWZpbml0aW9ucyBpbiB0aGlzIHN0YXRlbWVudCEnKTsgfVxuXG4gICAgdmFyIHBhcmVucyA9IDAsIGFyZ3MgPSBbIF0sIHB0ciA9IDA7XG4gICAgZm9yICh2YXIgaSA9IDAsIHggPSBkZWZzLmxlbmd0aDsgaSA8IHg7IGkrKykge1xuICAgICAgc3dpdGNoIChkZWZzW2ldKSB7XG4gICAgICAgIGNhc2UgJygnOlxuICAgICAgICAgIHBhcmVucysrO1xuICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnKSc6XG4gICAgICAgICAgcGFyZW5zLS07XG4gICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICcsJzpcbiAgICAgICAgICBpZiAocGFyZW5zID09PSAwKSB7XG4gICAgICAgICAgICBhcmdzLnB1c2goZGVmcy5zbGljZShwdHIsIGkpKTtcbiAgICAgICAgICAgIHB0ciA9IGkgKyAxO1xuICAgICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJyAnOlxuICAgICAgICAgIGlmIChwdHIgPT09IGkpIHtcbiAgICAgICAgICAgIHB0ciA9IGkgKyAxO1xuICAgICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIGFyZ3MucHVzaChkZWZzLnNsaWNlKHB0ciwgaSkpO1xuICAgIFxuICAgIGFyZ3MgPSBhcmdzLm1hcChmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgdmFyIHNwbGl0ID0gaXRlbS5zcGxpdCgnICcpO1xuXG4gICAgICBpZiAoc3BsaXRbMF0gPT09IGZyb20pIHtcbiAgICAgICAgLy8gY29sdW1uIGRlZmluaXRpb25cbiAgICAgICAgaWYgKHRvKSB7XG4gICAgICAgICAgc3BsaXRbMF0gPSB0bztcbiAgICAgICAgICByZXR1cm4gc3BsaXQuam9pbignICcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAnJzsgLy8gZm9yIGRlbGV0aW9uc1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBza2lwIGNvbnN0cmFpbnQgbmFtZVxuICAgICAgdmFyIGlkeCA9ICgvY29uc3RyYWludC9pLnRlc3Qoc3BsaXRbMF0pID8gMiA6IDApO1xuICAgICAgXG4gICAgICAvLyBwcmltYXJ5IGtleSBhbmQgdW5pcXVlIGNvbnN0cmFpbnRzIGhhdmUgb25lIG9yIG1vcmVcbiAgICAgIC8vIGNvbHVtbnMgZnJvbSB0aGlzIHRhYmxlIGxpc3RlZCBiZXR3ZWVuICgpOyByZXBsYWNlXG4gICAgICAvLyBvbmUgaWYgaXQgbWF0Y2hlc1xuICAgICAgaWYgKC9wcmltYXJ5fHVuaXF1ZS9pLnRlc3Qoc3BsaXRbaWR4XSkpIHtcbiAgICAgICAgcmV0dXJuIGl0ZW0ucmVwbGFjZSgvXFwoLipcXCkvLCBmdW5jdGlvbiAoY29sdW1ucykge1xuICAgICAgICAgIHJldHVybiBjb2x1bW5zLnJlcGxhY2UoZnJvbSwgdG8pO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gZm9yZWlnbiBrZXlzIGhhdmUgb25lIG9yIG1vcmUgY29sdW1ucyBmcm9tIHRoaXMgdGFibGVcbiAgICAgIC8vIGxpc3RlZCBiZXR3ZWVuICgpOyByZXBsYWNlIG9uZSBpZiBpdCBtYXRjaGVzXG4gICAgICAvLyBmb3JlaWduIGtleXMgYWxzbyBoYXZlIGEgJ3JlZmVyZW5jZXMnIGNsYXVzZVxuICAgICAgLy8gd2hpY2ggbWF5IHJlZmVyZW5jZSBUSElTIHRhYmxlOyBpZiBpdCBkb2VzLCByZXBsYWNlXG4gICAgICAvLyBjb2x1bW4gcmVmZXJlbmNlcyBpbiB0aGF0IHRvbyFcbiAgICAgIGlmICgvZm9yZWlnbi8udGVzdChzcGxpdFtpZHhdKSkge1xuICAgICAgICBzcGxpdCA9IGl0ZW0uc3BsaXQoLyByZWZlcmVuY2VzIC9pKTtcbiAgICAgICAgLy8gdGhlIHF1b3RlZCBjb2x1bW4gbmFtZXMgc2F2ZSB1cyBmcm9tIGhhdmluZyB0byBkbyBhbnl0aGluZ1xuICAgICAgICAvLyBvdGhlciB0aGFuIGEgc3RyYWlnaHQgcmVwbGFjZSBoZXJlXG4gICAgICAgIHNwbGl0WzBdID0gc3BsaXRbMF0ucmVwbGFjZShmcm9tLCB0byk7XG4gICAgICAgIFxuICAgICAgICBpZiAoc3BsaXRbMV0uc2xpY2UoMCwgdGFibGVOYW1lLmxlbmd0aCkgPT09IHRhYmxlTmFtZSkge1xuICAgICAgICAgIHNwbGl0WzFdID0gc3BsaXRbMV0ucmVwbGFjZSgvXFwoLipcXCkvLCBmdW5jdGlvbiAoY29sdW1ucykge1xuICAgICAgICAgICAgcmV0dXJuIGNvbHVtbnMucmVwbGFjZShmcm9tLCB0byk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNwbGl0LmpvaW4oJyByZWZlcmVuY2VzICcpO1xuICAgICAgfVxuICAgICAgXG4gICAgICByZXR1cm4gaXRlbTtcbiAgICB9KTtcbiAgICByZXR1cm4gc3FsLnJlcGxhY2UoL1xcKC4qXFwpLywgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuICcoJyArIGFyZ3Muam9pbignLCAnKSArICcpJztcbiAgICB9KS5yZXBsYWNlKC8sXFxzKihbLCldKS8sICckMScpO1xuICB9LFxuICBcbiAgLy8gQm95LCB0aGlzIGlzIHF1aXRlIGEgbWV0aG9kLlxuICByZW5hbWVDb2x1bW46IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKGZyb20sIHRvKSB7XG4gICAgdmFyIGN1cnJlbnRDb2w7XG5cbiAgICByZXR1cm4gdGhpcy5jbGllbnQudHJhbnNhY3Rpb24oZnVuY3Rpb24odHJ4KSB7XG4gICAgICB0aGlzLnRyeCA9IHRyeFxuICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29sdW1uKGZyb20pXG4gICAgICAgIC5iaW5kKHRoaXMpXG4gICAgICAgIC50YXAoZnVuY3Rpb24oY29sKSB7IGN1cnJlbnRDb2wgPSBjb2w7IH0pXG4gICAgICAgIC50aGVuKHRoaXMuZ2V0VGFibGVTcWwpXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uKHNxbCkge1xuICAgICAgICAgIHZhciBhID0gdGhpcy5jbGllbnQud3JhcElkZW50aWZpZXIoZnJvbSk7XG4gICAgICAgICAgdmFyIGIgPSB0aGlzLmNsaWVudC53cmFwSWRlbnRpZmllcih0byk7XG4gICAgICAgICAgdmFyIGNyZWF0ZVRhYmxlID0gc3FsWzBdO1xuICAgICAgICAgIHZhciBuZXdTcWwgPSB0aGlzLl9kb1JlcGxhY2UoY3JlYXRlVGFibGUuc3FsLCBhLCBiKTtcbiAgICAgICAgICBpZiAoc3FsID09PSBuZXdTcWwpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5hYmxlIHRvIGZpbmQgdGhlIGNvbHVtbiB0byBjaGFuZ2UnKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UuYmluZCh0aGlzKVxuICAgICAgICAgICAgLnRoZW4odGhpcy5jcmVhdGVUZW1wVGFibGUoY3JlYXRlVGFibGUpKVxuICAgICAgICAgICAgLnRoZW4odGhpcy5jb3B5RGF0YSlcbiAgICAgICAgICAgIC50aGVuKHRoaXMuZHJvcE9yaWdpbmFsKVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLnRyeC5yYXcobmV3U3FsKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbih0aGlzLnJlaW5zZXJ0RGF0YShmdW5jdGlvbihyb3cpIHtcbiAgICAgICAgICAgICAgcm93W3RvXSA9IHJvd1tmcm9tXTtcbiAgICAgICAgICAgICAgcmV0dXJuIF8ub21pdChyb3csIGZyb20pO1xuICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAudGhlbih0aGlzLmRyb3BUZW1wVGFibGUpXG4gICAgICAgIH0pXG4gICAgfS5iaW5kKHRoaXMpLCB7Y29ubmVjdGlvbjogdGhpcy5jb25uZWN0aW9ufSlcbiAgfSksXG5cbiAgZHJvcENvbHVtbjogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oY29sdW1uKSB7XG4gICAgdmFyIGN1cnJlbnRDb2w7XG5cbiAgICByZXR1cm4gdGhpcy5jbGllbnQudHJhbnNhY3Rpb24oZnVuY3Rpb24odHJ4KSB7XG4gICAgICB0aGlzLnRyeCA9IHRyeFxuICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29sdW1uKGNvbHVtbikudGFwKGZ1bmN0aW9uKGNvbCkgeyBcbiAgICAgICAgY3VycmVudENvbCA9IGNvbDsgXG4gICAgICB9KVxuICAgICAgLmJpbmQodGhpcylcbiAgICAgIC50aGVuKHRoaXMuZ2V0VGFibGVTcWwpXG4gICAgICAudGhlbihmdW5jdGlvbihzcWwpIHtcbiAgICAgICAgdmFyIGNyZWF0ZVRhYmxlID0gc3FsWzBdO1xuICAgICAgICB2YXIgYSA9IHRoaXMuY2xpZW50LndyYXBJZGVudGlmaWVyKGNvbHVtbik7XG4gICAgICAgIHZhciBuZXdTcWwgPSB0aGlzLl9kb1JlcGxhY2UoY3JlYXRlVGFibGUuc3FsLCBhLCAnJyk7XG4gICAgICAgIGlmIChzcWwgPT09IG5ld1NxbCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5hYmxlIHRvIGZpbmQgdGhlIGNvbHVtbiB0byBjaGFuZ2UnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpXG4gICAgICAgICAgLnRoZW4odGhpcy5jcmVhdGVUZW1wVGFibGUoY3JlYXRlVGFibGUpKVxuICAgICAgICAgIC50aGVuKHRoaXMuY29weURhdGEpXG4gICAgICAgICAgLnRoZW4odGhpcy5kcm9wT3JpZ2luYWwpXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50cngucmF3KG5ld1NxbCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbih0aGlzLnJlaW5zZXJ0RGF0YShmdW5jdGlvbihyb3cpIHtcbiAgICAgICAgICAgIHJldHVybiBfLm9taXQocm93LCBjb2x1bW4pO1xuICAgICAgICAgIH0pKVxuICAgICAgICAgIC50aGVuKHRoaXMuZHJvcFRlbXBUYWJsZSk7XG4gICAgICB9KVxuICAgIH0uYmluZCh0aGlzKSwge2Nvbm5lY3Rpb246IHRoaXMuY29ubmVjdGlvbn0pXG4gIH0pXG5cbn0pXG5cblxubW9kdWxlLmV4cG9ydHMgPSBTUUxpdGUzX0RETDtcbiJdfQ==