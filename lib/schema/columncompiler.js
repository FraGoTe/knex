
// Column Compiler
// Used for designating column definitions
// during the table "create" / "alter" statements.
// -------
'use strict';

var _ = require('lodash');
var Raw = require('../raw');
var helpers = require('./helpers');

function ColumnCompiler(client, tableCompiler, columnBuilder) {
  this.client = client;
  this.tableCompiler = tableCompiler;
  this.columnBuilder = columnBuilder;
  this.args = columnBuilder._args;
  this.type = columnBuilder._type.toLowerCase();
  this.grouped = _.groupBy(columnBuilder._statements, 'grouping');
  this.modified = columnBuilder._modifiers;
  this.isIncrements = this.type.indexOf('increments') !== -1;
  this.formatter = client.formatter();
  this.sequence = [];
}

ColumnCompiler.prototype.pushQuery = helpers.pushQuery;

ColumnCompiler.prototype.pushAdditional = helpers.pushAdditional;

// To convert to sql, we first go through and build the
// column as it would be in the insert statement
ColumnCompiler.prototype.toSQL = function () {
  this.pushQuery(this.compileColumn());
  if (this.sequence.additional) {
    this.sequence = this.sequence.concat(this.sequence.additional);
  }
  return this.sequence;
};

// Compiles a column.
ColumnCompiler.prototype.compileColumn = function () {
  return this.formatter.wrap(this.getColumnName()) + ' ' + this.getColumnType() + this.getModifiers();
};

// Assumes the autoincrementing key is named `id` if not otherwise specified.
ColumnCompiler.prototype.getColumnName = function () {
  var value = _.first(this.args);
  if (value) return value;
  if (this.isIncrements) {
    return 'id';
  } else {
    throw new Error('You did not specify a column name for the ' + this.type + 'column.');
  }
};

ColumnCompiler.prototype.getColumnType = function () {
  var type = this[this.type];
  return typeof type === 'function' ? type.apply(this, _.rest(this.args)) : type;
};

ColumnCompiler.prototype.getModifiers = function () {
  var modifiers = [];
  if (this.type.indexOf('increments') === -1) {
    for (var i = 0, l = this.modifiers.length; i < l; i++) {
      var modifier = this.modifiers[i];
      if (_.has(this.modified, modifier)) {
        var val = this[modifier].apply(this, this.modified[modifier]);
        if (val) modifiers.push(val);
      }
    }
  }
  return modifiers.length > 0 ? ' ' + modifiers.join(' ') : '';
};

// Types
// ------

ColumnCompiler.prototype.increments = 'integer not null primary key autoincrement';
ColumnCompiler.prototype.bigincrements = 'integer not null primary key autoincrement';
ColumnCompiler.prototype.integer = ColumnCompiler.prototype.smallint = ColumnCompiler.prototype.mediumint = 'integer';
ColumnCompiler.prototype.biginteger = 'bigint';
ColumnCompiler.prototype.varchar = function (length) {
  return 'varchar(' + this._num(length, 255) + ')';
};
ColumnCompiler.prototype.text = 'text';
ColumnCompiler.prototype.tinyint = 'tinyint';
ColumnCompiler.prototype.floating = function (precision, scale) {
  return 'float(' + this._num(precision, 8) + ', ' + this._num(scale, 2) + ')';
};
ColumnCompiler.prototype.decimal = function (precision, scale) {
  return 'decimal(' + this._num(precision, 8) + ', ' + this._num(scale, 2) + ')';
};
ColumnCompiler.prototype.binary = 'blob';
ColumnCompiler.prototype.bool = 'boolean';
ColumnCompiler.prototype.date = 'date';
ColumnCompiler.prototype.datetime = 'datetime';
ColumnCompiler.prototype.time = 'time';
ColumnCompiler.prototype.timestamp = 'timestamp';
ColumnCompiler.prototype.enu = 'varchar';

ColumnCompiler.prototype.bit = ColumnCompiler.prototype.json = 'text';

ColumnCompiler.prototype.uuid = 'char(36)';
ColumnCompiler.prototype.specifictype = function (type) {
  return type;
};

// Modifiers
// -------

ColumnCompiler.prototype.nullable = function (nullable) {
  return nullable === false ? 'not null' : 'null';
};
ColumnCompiler.prototype.notNullable = function () {
  return this.nullable(false);
};
ColumnCompiler.prototype.defaultTo = function (value) {
  if (value === void 0) {
    return '';
  } else if (value === null) {
    value = "null";
  } else if (value instanceof Raw) {
    value = value.toQuery();
  } else if (this.type === 'bool') {
    if (value === 'false') value = 0;
    value = "'" + (value ? 1 : 0) + "'";
  } else if (this.type === 'json' && _.isObject(value)) {
    return JSON.stringify(value);
  } else {
    value = "'" + value + "'";
  }
  return 'default ' + value;
};
ColumnCompiler.prototype._num = function (val, fallback) {
  if (val === undefined || val === null) return fallback;
  var number = parseInt(val, 10);
  return isNaN(number) ? fallback : number;
};

module.exports = ColumnCompiler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY2hlbWEvY29sdW1uY29tcGlsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUtBLElBQUksQ0FBQyxHQUFTLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNoQyxJQUFJLEdBQUcsR0FBTyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDaEMsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFBOztBQUVsQyxTQUFTLGNBQWMsQ0FBQyxNQUFNLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBRTtBQUM1RCxNQUFJLENBQUMsTUFBTSxHQUFVLE1BQU0sQ0FBQTtBQUMzQixNQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQTtBQUNsQyxNQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQTtBQUNsQyxNQUFJLENBQUMsSUFBSSxHQUFZLGFBQWEsQ0FBQyxLQUFLLENBQUM7QUFDekMsTUFBSSxDQUFDLElBQUksR0FBWSxhQUFhLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ3ZELE1BQUksQ0FBQyxPQUFPLEdBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ3RFLE1BQUksQ0FBQyxRQUFRLEdBQVEsYUFBYSxDQUFDLFVBQVUsQ0FBQztBQUM5QyxNQUFJLENBQUMsWUFBWSxHQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxBQUFDLENBQUM7QUFDOUQsTUFBSSxDQUFDLFNBQVMsR0FBTyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDeEMsTUFBSSxDQUFDLFFBQVEsR0FBUSxFQUFFLENBQUM7Q0FDekI7O0FBRUQsY0FBYyxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQTs7QUFFdEQsY0FBYyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUcs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SSxLQUFLLEtBQUssT0FBTyxFQUFFLEtBQUssR0FBRyxDQUFDLENBQUM7QUFDakMsU0FBSyxHQUFHLEdBQUcsSUFBSSxLQUFLLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQSxBQUFDLEdBQUcsR0FBRyxDQUFDO0dBQ3JDLE1BQU0sSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE1BQU0sSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFO0FBQ3BELFdBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztHQUM5QixNQUFNO0FBQ0wsU0FBSyxHQUFHLEdBQUcsR0FBRyxLQUFLLEdBQUcsR0FBRyxDQUFDO0dBQzNCO0FBQ0QsU0FBTyxVQUFVLEdBQUcsS0FBSyxDQUFDO0NBQzNCLENBQUM7QUFDRixjQUFjLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxVQUFTLEdBQUcsRUFBRSxRQUFRLEVBQUU7QUFDdEQsTUFBSSxHQUFHLEtBQUssU0FBUyxJQUFJLEdBQUcsS0FBSyxJQUFJLEVBQUUsT0FBTyxRQUFRLENBQUM7QUFDdkQsTUFBSSxNQUFNLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUMvQixTQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxRQUFRLEdBQUcsTUFBTSxDQUFDO0NBQzFDLENBQUM7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUMiLCJmaWxlIjoiY29sdW1uY29tcGlsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vIENvbHVtbiBDb21waWxlclxuLy8gVXNlZCBmb3IgZGVzaWduYXRpbmcgY29sdW1uIGRlZmluaXRpb25zXG4vLyBkdXJpbmcgdGhlIHRhYmxlIFwiY3JlYXRlXCIgLyBcImFsdGVyXCIgc3RhdGVtZW50cy5cbi8vIC0tLS0tLS1cbnZhciBfICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgUmF3ICAgICA9IHJlcXVpcmUoJy4uL3JhdycpO1xudmFyIGhlbHBlcnMgPSByZXF1aXJlKCcuL2hlbHBlcnMnKVxuXG5mdW5jdGlvbiBDb2x1bW5Db21waWxlcihjbGllbnQsIHRhYmxlQ29tcGlsZXIsIGNvbHVtbkJ1aWxkZXIpIHtcbiAgdGhpcy5jbGllbnQgICAgICAgID0gY2xpZW50XG4gIHRoaXMudGFibGVDb21waWxlciA9IHRhYmxlQ29tcGlsZXJcbiAgdGhpcy5jb2x1bW5CdWlsZGVyID0gY29sdW1uQnVpbGRlclxuICB0aGlzLmFyZ3MgICAgICAgICAgPSBjb2x1bW5CdWlsZGVyLl9hcmdzO1xuICB0aGlzLnR5cGUgICAgICAgICAgPSBjb2x1bW5CdWlsZGVyLl90eXBlLnRvTG93ZXJDYXNlKCk7XG4gIHRoaXMuZ3JvdXBlZCAgICAgICA9IF8uZ3JvdXBCeShjb2x1bW5CdWlsZGVyLl9zdGF0ZW1lbnRzLCAnZ3JvdXBpbmcnKTtcbiAgdGhpcy5tb2RpZmllZCAgICAgID0gY29sdW1uQnVpbGRlci5fbW9kaWZpZXJzO1xuICB0aGlzLmlzSW5jcmVtZW50cyAgPSAodGhpcy50eXBlLmluZGV4T2YoJ2luY3JlbWVudHMnKSAhPT0gLTEpO1xuICB0aGlzLmZvcm1hdHRlciAgICAgPSBjbGllbnQuZm9ybWF0dGVyKCk7XG4gIHRoaXMuc2VxdWVuY2UgICAgICA9IFtdO1xufVxuXG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUucHVzaFF1ZXJ5ID0gaGVscGVycy5wdXNoUXVlcnlcblxuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLnB1c2hBZGRpdGlvbmFsID0gaGVscGVycy5wdXNoQWRkaXRpb25hbFxuXG4vLyBUbyBjb252ZXJ0IHRvIHNxbCwgd2UgZmlyc3QgZ28gdGhyb3VnaCBhbmQgYnVpbGQgdGhlXG4vLyBjb2x1bW4gYXMgaXQgd291bGQgYmUgaW4gdGhlIGluc2VydCBzdGF0ZW1lbnRcbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKCkge1xuICB0aGlzLnB1c2hRdWVyeSh0aGlzLmNvbXBpbGVDb2x1bW4oKSk7XG4gIGlmICh0aGlzLnNlcXVlbmNlLmFkZGl0aW9uYWwpIHtcbiAgICB0aGlzLnNlcXVlbmNlID0gdGhpcy5zZXF1ZW5jZS5jb25jYXQodGhpcy5zZXF1ZW5jZS5hZGRpdGlvbmFsKTtcbiAgfVxuICByZXR1cm4gdGhpcy5zZXF1ZW5jZTtcbn07XG5cbi8vIENvbXBpbGVzIGEgY29sdW1uLlxuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmNvbXBpbGVDb2x1bW4gPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMuZm9ybWF0dGVyLndyYXAodGhpcy5nZXRDb2x1bW5OYW1lKCkpICsgJyAnICtcbiAgICB0aGlzLmdldENvbHVtblR5cGUoKSArIHRoaXMuZ2V0TW9kaWZpZXJzKCk7XG59O1xuXG4vLyBBc3N1bWVzIHRoZSBhdXRvaW5jcmVtZW50aW5nIGtleSBpcyBuYW1lZCBgaWRgIGlmIG5vdCBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtbk5hbWUgPSBmdW5jdGlvbigpIHtcbiAgdmFyIHZhbHVlID0gXy5maXJzdCh0aGlzLmFyZ3MpO1xuICBpZiAodmFsdWUpIHJldHVybiB2YWx1ZTtcbiAgaWYgKHRoaXMuaXNJbmNyZW1lbnRzKSB7XG4gICAgcmV0dXJuICdpZCc7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgZGlkIG5vdCBzcGVjaWZ5IGEgY29sdW1uIG5hbWUgZm9yIHRoZSAnICsgdGhpcy50eXBlICsgJ2NvbHVtbi4nKTtcbiAgfVxufTtcblxuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtblR5cGUgPSBmdW5jdGlvbigpIHtcbiAgdmFyIHR5cGUgPSB0aGlzW3RoaXMudHlwZV07XG4gIHJldHVybiB0eXBlb2YgdHlwZSA9PT0gJ2Z1bmN0aW9uJyA/IHR5cGUuYXBwbHkodGhpcywgXy5yZXN0KHRoaXMuYXJncykpIDogdHlwZTtcbn07XG5cbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5nZXRNb2RpZmllcnMgPSBmdW5jdGlvbigpIHtcbiAgdmFyIG1vZGlmaWVycyA9IFtdO1xuICBpZiAodGhpcy50eXBlLmluZGV4T2YoJ2luY3JlbWVudHMnKSA9PT0gLTEpIHtcbiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kaWZpZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgdmFyIG1vZGlmaWVyID0gdGhpcy5tb2RpZmllcnNbaV07XG4gICAgICBpZiAoXy5oYXModGhpcy5tb2RpZmllZCwgbW9kaWZpZXIpKSB7XG4gICAgICAgIHZhciB2YWwgPSB0aGlzW21vZGlmaWVyXS5hcHBseSh0aGlzLCB0aGlzLm1vZGlmaWVkW21vZGlmaWVyXSk7XG4gICAgICAgIGlmICh2YWwpIG1vZGlmaWVycy5wdXNoKHZhbCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBtb2RpZmllcnMubGVuZ3RoID4gMCA/ICcgJyArIG1vZGlmaWVycy5qb2luKCcgJykgOiAnJztcbn07XG5cbi8vIFR5cGVzXG4vLyAtLS0tLS1cblxuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmluY3JlbWVudHMgICAgPSAnaW50ZWdlciBub3QgbnVsbCBwcmltYXJ5IGtleSBhdXRvaW5jcmVtZW50JztcbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5iaWdpbmNyZW1lbnRzID0gJ2ludGVnZXIgbm90IG51bGwgcHJpbWFyeSBrZXkgYXV0b2luY3JlbWVudCc7XG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUuaW50ZWdlciAgICAgICA9IFxuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLnNtYWxsaW50ICAgICAgPSBcbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5tZWRpdW1pbnQgICAgID0gJ2ludGVnZXInO1xuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmJpZ2ludGVnZXIgICAgPSAnYmlnaW50JztcbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS52YXJjaGFyICAgICAgID0gZnVuY3Rpb24obGVuZ3RoKSB7XG4gIHJldHVybiAndmFyY2hhcignICsgdGhpcy5fbnVtKGxlbmd0aCwgMjU1KSArICcpJztcbn07XG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUudGV4dCA9ICd0ZXh0JztcbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS50aW55aW50ID0gJ3RpbnlpbnQnO1xuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmZsb2F0aW5nID0gZnVuY3Rpb24ocHJlY2lzaW9uLCBzY2FsZSkge1xuICByZXR1cm4gJ2Zsb2F0KCcgKyB0aGlzLl9udW0ocHJlY2lzaW9uLCA4KSArICcsICcgKyB0aGlzLl9udW0oc2NhbGUsIDIpICsgJyknO1xufTtcbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5kZWNpbWFsID0gZnVuY3Rpb24ocHJlY2lzaW9uLCBzY2FsZSkge1xuICByZXR1cm4gJ2RlY2ltYWwoJyArIHRoaXMuX251bShwcmVjaXNpb24sIDgpICsgJywgJyArIHRoaXMuX251bShzY2FsZSwgMikgKyAnKSc7XG59O1xuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmJpbmFyeSA9ICdibG9iJztcbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5ib29sID0gJ2Jvb2xlYW4nO1xuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmRhdGUgPSAnZGF0ZSc7XG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUuZGF0ZXRpbWUgPSAnZGF0ZXRpbWUnO1xuQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLnRpbWUgPSAndGltZSc7XG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUudGltZXN0YW1wID0gJ3RpbWVzdGFtcCc7XG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUuZW51ID0gJ3ZhcmNoYXInO1xuXG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUuYml0ID1cbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5qc29uID0gJ3RleHQnO1xuXG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUudXVpZCA9ICdjaGFyKDM2KSc7XG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUuc3BlY2lmaWN0eXBlID0gZnVuY3Rpb24odHlwZSkge1xuICByZXR1cm4gdHlwZTtcbn07XG5cbi8vIE1vZGlmaWVyc1xuLy8gLS0tLS0tLVxuXG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUubnVsbGFibGUgPSBmdW5jdGlvbihudWxsYWJsZSkge1xuICByZXR1cm4gbnVsbGFibGUgPT09IGZhbHNlID8gJ25vdCBudWxsJyA6ICdudWxsJztcbn07XG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUubm90TnVsbGFibGUgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMubnVsbGFibGUoZmFsc2UpO1xufTtcbkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5kZWZhdWx0VG8gPSBmdW5jdGlvbih2YWx1ZSkge1xuICBpZiAodmFsdWUgPT09IHZvaWQgMCkge1xuICAgIHJldHVybiAnJztcbiAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xuICAgIHZhbHVlID0gXCJudWxsXCI7XG4gIH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBSYXcpIHtcbiAgICB2YWx1ZSA9IHZhbHVlLnRvUXVlcnkoKTtcbiAgfSBlbHNlIGlmICh0aGlzLnR5cGUgPT09ICdib29sJykge1xuICAgIGlmICh2YWx1ZSA9PT0gJ2ZhbHNlJykgdmFsdWUgPSAwO1xuICAgIHZhbHVlID0gXCInXCIgKyAodmFsdWUgPyAxIDogMCkgKyBcIidcIjtcbiAgfSBlbHNlIGlmICh0aGlzLnR5cGUgPT09ICdqc29uJyAmJiBfLmlzT2JqZWN0KHZhbHVlKSkge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gIH0gZWxzZSB7XG4gICAgdmFsdWUgPSBcIidcIiArIHZhbHVlICsgXCInXCI7XG4gIH1cbiAgcmV0dXJuICdkZWZhdWx0ICcgKyB2YWx1ZTtcbn07XG5Db2x1bW5Db21waWxlci5wcm90b3R5cGUuX251bSA9IGZ1bmN0aW9uKHZhbCwgZmFsbGJhY2spIHtcbiAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkIHx8IHZhbCA9PT0gbnVsbCkgcmV0dXJuIGZhbGxiYWNrO1xuICB2YXIgbnVtYmVyID0gcGFyc2VJbnQodmFsLCAxMCk7XG4gIHJldHVybiBpc05hTihudW1iZXIpID8gZmFsbGJhY2sgOiBudW1iZXI7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IENvbHVtbkNvbXBpbGVyO1xuIl19