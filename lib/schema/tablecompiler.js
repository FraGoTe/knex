
// Table Compiler
// -------
'use strict';

var _ = require('lodash');
var helpers = require('./helpers');
var normalizeArr = require('../helpers').normalizeArr;

function TableCompiler(client, tableBuilder) {
  this.client = client;
  this.method = tableBuilder._method;
  this.schemaNameRaw = tableBuilder._schemaName;
  this.tableNameRaw = tableBuilder._tableName;
  this.single = tableBuilder._single;
  this.grouped = _.groupBy(tableBuilder._statements, 'grouping');
  this.formatter = client.formatter();
  this.sequence = [];
  this._formatting = client.config && client.config.formatting;
}

TableCompiler.prototype.pushQuery = helpers.pushQuery;

TableCompiler.prototype.pushAdditional = helpers.pushAdditional;

// Convert the tableCompiler toSQL
TableCompiler.prototype.toSQL = function () {
  this[this.method]();
  return this.sequence;
};

TableCompiler.prototype.lowerCase = true;

// Column Compilation
// -------

// If this is a table "creation", we need to first run through all
// of the columns to build them into a single string,
// and then run through anything else and push it to the query sequence.
TableCompiler.prototype.createAlterTableMethods = null;
TableCompiler.prototype.create = function (ifNot) {
  var columns = this.getColumns();
  var columnTypes = this.getColumnTypes(columns);
  if (this.createAlterTableMethods) {
    this.alterTableForCreate(columnTypes);
  }
  this.createQuery(columnTypes, ifNot);
  this.columnQueries(columns);
  delete this.single.comment;
  this.alterTable();
};

// Only create the table if it doesn't exist.
TableCompiler.prototype.createIfNot = function () {
  this.create(true);
};

// If we're altering the table, we need to one-by-one
// go through and handle each of the queries associated
// with altering the table's schema.
TableCompiler.prototype.alter = function () {
  var columns = this.getColumns();
  var columnTypes = this.getColumnTypes(columns);
  this.addColumns(columnTypes);
  this.columnQueries(columns);
  this.alterTable();
};

TableCompiler.prototype.foreign = function (foreignData) {
  if (foreignData.inTable && foreignData.references) {
    var keyName = this._indexCommand('foreign', this.tableNameRaw, foreignData.column);
    var column = this.formatter.columnize(foreignData.column);
    var references = this.formatter.columnize(foreignData.references);
    var inTable = this.formatter.wrap(foreignData.inTable);
    var onUpdate = foreignData.onUpdate ? (this.lowerCase ? ' on update ' : ' ON UPDATE ') + foreignData.onUpdate : '';
    var onDelete = foreignData.onDelete ? (this.lowerCase ? ' on delete ' : ' ON DELETE ') + foreignData.onDelete : '';
    if (this.lowerCase) {
      this.pushQuery((!this.forCreate ? 'alter table ' + this.tableName() + ' add ' : '') + 'constraint ' + keyName + ' ' + 'foreign key (' + column + ') references ' + inTable + ' (' + references + ')' + onUpdate + onDelete);
    } else {
      this.pushQuery((!this.forCreate ? 'ALTER TABLE ' + this.tableName() + ' ADD ' : '') + 'CONSTRAINT ' + keyName + ' ' + 'FOREIGN KEY (' + column + ') REFERENCES ' + inTable + ' (' + references + ')' + onUpdate + onDelete);
    }
  }
};

// Get all of the column sql & bindings individually for building the table queries.
TableCompiler.prototype.getColumnTypes = function (columns) {
  return _.reduce(_.map(columns, _.first), function (memo, column) {
    memo.sql.push(column.sql);
    memo.bindings.concat(column.bindings);
    return memo;
  }, { sql: [], bindings: [] });
};

// Adds all of the additional queries from the "column"
TableCompiler.prototype.columnQueries = function (columns) {
  var queries = _.reduce(_.map(columns, _.rest), function (memo, column) {
    if (!_.isEmpty(column)) return memo.concat(column);
    return memo;
  }, []);
  for (var i = 0, l = queries.length; i < l; i++) {
    this.pushQuery(queries[i]);
  }
};

// Add a new column.
TableCompiler.prototype.addColumnsPrefix = 'add column ';

// All of the columns to "add" for the query
TableCompiler.prototype.addColumns = function (columns) {
  if (columns.sql.length > 0) {
    var columnSql = _.map(columns.sql, function (column) {
      return this.addColumnsPrefix + column;
    }, this);
    this.pushQuery({
      sql: (this.lowerCase ? 'alter table ' : 'ALTER TABLE ') + this.tableName() + ' ' + columnSql.join(', '),
      bindings: columns.bindings
    });
  }
};

// Compile the columns as needed for the current create or alter table
TableCompiler.prototype.getColumns = function () {
  var i = -1,
      compiledColumns = [],
      columns = this.grouped.columns || [];
  while (++i < columns.length) {
    compiledColumns.push(this.client.columnCompiler(this, columns[i].builder).toSQL());
  }
  return compiledColumns;
};

TableCompiler.prototype.tableName = function () {
  var name = this.schemaNameRaw ? this.schemaNameRaw + '.' + this.tableNameRaw : this.tableNameRaw;

  return this.formatter.wrap(name);
};

// Generate all of the alter column statements necessary for the query.
TableCompiler.prototype.alterTable = function () {
  var alterTable = this.grouped.alterTable || [];
  for (var i = 0, l = alterTable.length; i < l; i++) {
    var statement = alterTable[i];
    if (this[statement.method]) {
      this[statement.method].apply(this, statement.args);
    } else {
      console.error('Debug: ' + statement.method + ' does not exist');
    }
  }
  for (var item in this.single) {
    if (typeof this[item] === 'function') this[item](this.single[item]);
  }
};

TableCompiler.prototype.alterTableForCreate = function (columnTypes) {
  this.forCreate = true;
  var savedSequence = this.sequence;
  var alterTable = this.grouped.alterTable || [];
  this.grouped.alterTable = [];
  for (var i = 0, l = alterTable.length; i < l; i++) {
    var statement = alterTable[i];
    if (_.indexOf(this.createAlterTableMethods, statement.method) < 0) {
      this.grouped.alterTable.push(statement);
      continue;
    }
    if (this[statement.method]) {
      this.sequence = [];
      this[statement.method].apply(this, statement.args);
      columnTypes.sql.push(this.sequence[0].sql);
    } else {
      console.error('Debug: ' + statement.method + ' does not exist');
    }
  }
  this.sequence = savedSequence;
  this.forCreate = false;
};

// Drop the index on the current table.
TableCompiler.prototype.dropIndex = function (value) {
  this.pushQuery('drop index' + value);
};

// Drop the unique
TableCompiler.prototype.dropUnique = TableCompiler.prototype.dropForeign = function () {
  throw new Error('Method implemented in the dialect driver');
};

TableCompiler.prototype.dropColumnPrefix = 'drop column ';
TableCompiler.prototype.dropColumn = function () {
  var columns = normalizeArr.apply(null, arguments);
  var drops = _.map(_.isArray(columns) ? columns : [columns], function (column) {
    return this.dropColumnPrefix + this.formatter.wrap(column);
  }, this);
  this.pushQuery((this.lowerCase ? 'alter table ' : 'ALTER TABLE ') + this.tableName() + ' ' + drops.join(', '));
};

// If no name was specified for this index, we will create one using a basic
// convention of the table name, followed by the columns, followed by an
// index type, such as primary or index, which makes the index unique.
TableCompiler.prototype._indexCommand = function (type, tableName, columns) {
  if (!_.isArray(columns)) columns = columns ? [columns] : [];
  var table = tableName.replace(/\.|-/g, '_');
  return (table + '_' + columns.join('_') + '_' + type).toLowerCase();
};

module.exports = TableCompiler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY2hlbWEvdGFibGVjb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUdBLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMxQixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDbkMsSUFBSSxZQUFZLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLFlBQVksQ0FBQTs7QUFFckQsU0FBUyxhQUFhLENBQUMsTUFBTSxFQUFFLFlBQVksRUFBRTtBQUMzQyxNQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtBQUNwQixNQUFJLENBQUMsTUFBTSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUM7QUFDbkMsTUFBSSxDQUFDLGFBQWEsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDO0FBQzlDLE1BQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDLFVBQVUsQ0FBQztBQUM1QyxNQUFJLENBQUMsTUFBTSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUM7QUFDbkMsTUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDL0QsTUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDcEMsTUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7QUFDbkIsTUFBSSxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFBO0NBQzdEOztBQUVELGFBQWEsQ0FBQyxTQUFTLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUE7O0FBRXJELGFBQWEsQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUE7OztBQUcvRCxhQUFhLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxZQUFZO0FBQzFDLE1BQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztBQUNwQixTQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7Q0FDdEIsQ0FBQzs7QUFFRixhQUFhLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7Ozs7Ozs7O0FBUXpDLGFBQWEsQ0FBQyxTQUFTLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO0FBQ3ZELGFBQWEsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLFVBQVUsS0FBSyxFQUFFO0FBQ2hELE1BQUksT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztBQUNoQyxNQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQy9DLE1BQUksSUFBSSxDQUFDLHVCQUF1QixFQUFFO0FBQ2hDLFFBQUksQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztHQUN2QztBQUNELE1BQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ3JDLE1BQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDNUIsU0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQztBQUMzQixNQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Q0FDbkIsQ0FBQzs7O0FBR0YsYUFBYSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEdBQUcsWUFBWTtBQUNoRCxNQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0NBQ25CLENBQUM7Ozs7O0FBS0YsYUFBYSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsWUFBWTtBQUMxQyxNQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7QUFDaEMsTUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUMvQyxNQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQzdCLE1BQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDNUIsTUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0NBQ25CLENBQUM7O0FBRUYsYUFBYSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsVUFBVSxXQUFXLEVBQUU7QUFDdkQsTUFBSSxXQUFXLENBQUMsT0FBTyxJQUFJLFdBQVcsQ0FBQyxVQUFVLEVBQUU7QUFDakQsUUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDbkYsUUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzFELFFBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNsRSxRQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDdkQsUUFBSSxRQUFRLEdBQUcsV0FBVyxDQUFDLFFBQVEsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsYUFBYSxHQUFHLGFBQWEsQ0FBQSxHQUFJLFdBQVcsQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO0FBQ25ILFFBQUksUUFBUSxHQUFHLFdBQVcsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLGFBQWEsR0FBRyxhQUFhLENBQUEsR0FBSSxXQUFXLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztBQUNuSCxRQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7QUFDbEIsVUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxjQUFjLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLE9BQU8sR0FBRyxFQUFFLENBQUEsR0FBSSxhQUFhLEdBQUcsT0FBTyxHQUFHLEdBQUcsR0FDakgsZUFBZSxHQUFHLE1BQU0sR0FBRyxlQUFlLEdBQUcsT0FBTyxHQUFHLElBQUksR0FBRyxVQUFVLEdBQUcsR0FBRyxHQUFHLFFBQVEsR0FBRyxRQUFRLENBQUMsQ0FBQztLQUN6RyxNQUFNO0FBQ0wsVUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxjQUFjLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLE9BQU8sR0FBRyxFQUFFLENBQUEsR0FBSSxhQUFhLEdBQUcsT0FBTyxHQUFHLEdBQUcsR0FDakgsZUFBZSxHQUFHLE1BQU0sR0FBRyxlQUFlLEdBQUcsT0FBTyxHQUFHLElBQUksR0FBRyxVQUFVLEdBQUcsR0FBRyxHQUFHLFFBQVEsR0FBRyxRQUFRLENBQUMsQ0FBQztLQUN6RztHQUNGO0NBQ0YsQ0FBQzs7O0FBR0YsYUFBYSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUcsVUFBVSxPQUFPLEVBQUU7QUFDMUQsU0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxVQUFVLElBQUksRUFBRSxNQUFNLEVBQUU7QUFDL0QsUUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzFCLFFBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN0QyxXQUFPLElBQUksQ0FBQztHQUNiLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0NBQy9CLENBQUM7OztBQUdGLGFBQWEsQ0FBQyxTQUFTLENBQUMsYUFBYSxHQUFHLFVBQVUsT0FBTyxFQUFFO0FBQ3pELE1BQUksT0FBTyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLFVBQVUsSUFBSSxFQUFFLE1BQU0sRUFBRTtBQUNyRSxRQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDbkQsV0FBTyxJQUFJLENBQUM7R0FDYixFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ1AsT0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUM5QyxRQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0dBQzVCO0NBQ0YsQ0FBQzs7O0FBR0YsYUFBYSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsR0FBRyxhQUFhLENBQUM7OztBQUd6RCxhQUFhLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxVQUFVLE9BQU8sRUFBRTtBQUN0RCxNQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtBQUMxQixRQUFJLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsVUFBVSxNQUFNLEVBQUU7QUFDbkQsYUFBTyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsTUFBTSxDQUFDO0tBQ3ZDLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDVCxRQUFJLENBQUMsU0FBUyxDQUFDO0FBQ2IsU0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxjQUFjLEdBQUcsY0FBYyxDQUFBLEdBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLEdBQUcsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztBQUN2RyxjQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7S0FDM0IsQ0FBQyxDQUFDO0dBQ0o7Q0FDRixDQUFDOzs7QUFHRixhQUFhLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxZQUFZO0FBQy9DLE1BQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztNQUFFLGVBQWUsR0FBRyxFQUFFO01BQUUsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztBQUN2RSxTQUFPLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUU7QUFDM0IsbUJBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBO0dBQ25GO0FBQ0QsU0FBTyxlQUFlLENBQUM7Q0FDeEIsQ0FBQzs7QUFFRixhQUFhLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxZQUFZO0FBQzlDLE1BQUksSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLEdBQ3hCLElBQUksQ0FBQyxhQUFhLFNBQUksSUFBSSxDQUFDLFlBQVksR0FDeEMsSUFBSSxDQUFDLFlBQVksQ0FBQzs7QUFFdEIsU0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztDQUNsQyxDQUFDOzs7QUFHRixhQUFhLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxZQUFZO0FBQy9DLE1BQUksVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztBQUMvQyxPQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ2pELFFBQUksU0FBUyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM5QixRQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUU7QUFDMUIsVUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNwRCxNQUFNO0FBQ0wsYUFBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQyxDQUFDO0tBQ2pFO0dBQ0Y7QUFDRCxPQUFLLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7QUFDNUIsUUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxVQUFVLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztHQUNyRTtDQUNGLENBQUM7O0FBRUYsYUFBYSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsR0FBRyxVQUFVLFdBQVcsRUFBRTtBQUNuRSxNQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztBQUN0QixNQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO0FBQ2xDLE1BQUksVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztBQUMvQyxNQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7QUFDN0IsT0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUNqRCxRQUFJLFNBQVMsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUIsUUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ2pFLFVBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN4QyxlQUFTO0tBQ1Y7QUFDRCxRQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUU7QUFDMUIsVUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7QUFDbkIsVUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNuRCxpQkFBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUM1QyxNQUFNO0FBQ0wsYUFBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQyxDQUFDO0tBQ2pFO0dBQ0Y7QUFDRCxNQUFJLENBQUMsUUFBUSxHQUFHLGFBQWEsQ0FBQztBQUM5QixNQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztDQUN4QixDQUFDOzs7QUFJRixhQUFhLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxVQUFVLEtBQUssRUFBRTtBQUNuRCxNQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsQ0FBQztDQUN0QyxDQUFDOzs7QUFHRixhQUFhLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FDbEMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEdBQUcsWUFBWTtBQUNoRCxRQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7Q0FDN0QsQ0FBQzs7QUFFRixhQUFhLENBQUMsU0FBUyxDQUFDLGdCQUFnQixHQUFHLGNBQWMsQ0FBQztBQUMxRCxhQUFhLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxZQUFZO0FBQy9DLE1BQUksT0FBTyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQ2xELE1BQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxVQUFVLE1BQU0sRUFBRTtBQUM1RSxXQUFPLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztHQUM1RCxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ1QsTUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsY0FBYyxHQUFHLGNBQWMsQ0FBQSxHQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0NBQ2hILENBQUM7Ozs7O0FBS0YsYUFBYSxDQUFDLFNBQVMsQ0FBQyxhQUFhLEdBQUcsVUFBVSxJQUFJLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRTtBQUMxRSxNQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxPQUFPLEdBQUcsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQzVELE1BQUksS0FBSyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzVDLFNBQU8sQ0FBQyxLQUFLLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQSxDQUFFLFdBQVcsRUFBRSxDQUFDO0NBQ3JFLENBQUM7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMiLCJmaWxlIjoidGFibGVjb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLy8gVGFibGUgQ29tcGlsZXJcbi8vIC0tLS0tLS1cbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgaGVscGVycyA9IHJlcXVpcmUoJy4vaGVscGVycycpO1xudmFyIG5vcm1hbGl6ZUFyciA9IHJlcXVpcmUoJy4uL2hlbHBlcnMnKS5ub3JtYWxpemVBcnJcblxuZnVuY3Rpb24gVGFibGVDb21waWxlcihjbGllbnQsIHRhYmxlQnVpbGRlcikge1xuICB0aGlzLmNsaWVudCA9IGNsaWVudFxuICB0aGlzLm1ldGhvZCA9IHRhYmxlQnVpbGRlci5fbWV0aG9kO1xuICB0aGlzLnNjaGVtYU5hbWVSYXcgPSB0YWJsZUJ1aWxkZXIuX3NjaGVtYU5hbWU7XG4gIHRoaXMudGFibGVOYW1lUmF3ID0gdGFibGVCdWlsZGVyLl90YWJsZU5hbWU7XG4gIHRoaXMuc2luZ2xlID0gdGFibGVCdWlsZGVyLl9zaW5nbGU7XG4gIHRoaXMuZ3JvdXBlZCA9IF8uZ3JvdXBCeSh0YWJsZUJ1aWxkZXIuX3N0YXRlbWVudHMsICdncm91cGluZycpO1xuICB0aGlzLmZvcm1hdHRlciA9IGNsaWVudC5mb3JtYXR0ZXIoKTtcbiAgdGhpcy5zZXF1ZW5jZSA9IFtdO1xuICB0aGlzLl9mb3JtYXR0aW5nID0gY2xpZW50LmNvbmZpZyAmJiBjbGllbnQuY29uZmlnLmZvcm1hdHRpbmdcbn1cblxuVGFibGVDb21waWxlci5wcm90b3R5cGUucHVzaFF1ZXJ5ID0gaGVscGVycy5wdXNoUXVlcnlcblxuVGFibGVDb21waWxlci5wcm90b3R5cGUucHVzaEFkZGl0aW9uYWwgPSBoZWxwZXJzLnB1c2hBZGRpdGlvbmFsXG5cbi8vIENvbnZlcnQgdGhlIHRhYmxlQ29tcGlsZXIgdG9TUUxcblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLnRvU1FMID0gZnVuY3Rpb24gKCkge1xuICB0aGlzW3RoaXMubWV0aG9kXSgpO1xuICByZXR1cm4gdGhpcy5zZXF1ZW5jZTtcbn07XG5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmxvd2VyQ2FzZSA9IHRydWU7XG5cbi8vIENvbHVtbiBDb21waWxhdGlvblxuLy8gLS0tLS0tLVxuXG4vLyBJZiB0aGlzIGlzIGEgdGFibGUgXCJjcmVhdGlvblwiLCB3ZSBuZWVkIHRvIGZpcnN0IHJ1biB0aHJvdWdoIGFsbFxuLy8gb2YgdGhlIGNvbHVtbnMgdG8gYnVpbGQgdGhlbSBpbnRvIGEgc2luZ2xlIHN0cmluZyxcbi8vIGFuZCB0aGVuIHJ1biB0aHJvdWdoIGFueXRoaW5nIGVsc2UgYW5kIHB1c2ggaXQgdG8gdGhlIHF1ZXJ5IHNlcXVlbmNlLlxuVGFibGVDb21waWxlci5wcm90b3R5cGUuY3JlYXRlQWx0ZXJUYWJsZU1ldGhvZHMgPSBudWxsO1xuVGFibGVDb21waWxlci5wcm90b3R5cGUuY3JlYXRlID0gZnVuY3Rpb24gKGlmTm90KSB7XG4gIHZhciBjb2x1bW5zID0gdGhpcy5nZXRDb2x1bW5zKCk7XG4gIHZhciBjb2x1bW5UeXBlcyA9IHRoaXMuZ2V0Q29sdW1uVHlwZXMoY29sdW1ucyk7XG4gIGlmICh0aGlzLmNyZWF0ZUFsdGVyVGFibGVNZXRob2RzKSB7XG4gICAgdGhpcy5hbHRlclRhYmxlRm9yQ3JlYXRlKGNvbHVtblR5cGVzKTtcbiAgfVxuICB0aGlzLmNyZWF0ZVF1ZXJ5KGNvbHVtblR5cGVzLCBpZk5vdCk7XG4gIHRoaXMuY29sdW1uUXVlcmllcyhjb2x1bW5zKTtcbiAgZGVsZXRlIHRoaXMuc2luZ2xlLmNvbW1lbnQ7XG4gIHRoaXMuYWx0ZXJUYWJsZSgpO1xufTtcblxuLy8gT25seSBjcmVhdGUgdGhlIHRhYmxlIGlmIGl0IGRvZXNuJ3QgZXhpc3QuXG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5jcmVhdGVJZk5vdCA9IGZ1bmN0aW9uICgpIHtcbiAgdGhpcy5jcmVhdGUodHJ1ZSk7XG59O1xuXG4vLyBJZiB3ZSdyZSBhbHRlcmluZyB0aGUgdGFibGUsIHdlIG5lZWQgdG8gb25lLWJ5LW9uZVxuLy8gZ28gdGhyb3VnaCBhbmQgaGFuZGxlIGVhY2ggb2YgdGhlIHF1ZXJpZXMgYXNzb2NpYXRlZFxuLy8gd2l0aCBhbHRlcmluZyB0aGUgdGFibGUncyBzY2hlbWEuXG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5hbHRlciA9IGZ1bmN0aW9uICgpIHtcbiAgdmFyIGNvbHVtbnMgPSB0aGlzLmdldENvbHVtbnMoKTtcbiAgdmFyIGNvbHVtblR5cGVzID0gdGhpcy5nZXRDb2x1bW5UeXBlcyhjb2x1bW5zKTtcbiAgdGhpcy5hZGRDb2x1bW5zKGNvbHVtblR5cGVzKTtcbiAgdGhpcy5jb2x1bW5RdWVyaWVzKGNvbHVtbnMpO1xuICB0aGlzLmFsdGVyVGFibGUoKTtcbn07XG5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmZvcmVpZ24gPSBmdW5jdGlvbiAoZm9yZWlnbkRhdGEpIHtcbiAgaWYgKGZvcmVpZ25EYXRhLmluVGFibGUgJiYgZm9yZWlnbkRhdGEucmVmZXJlbmNlcykge1xuICAgIHZhciBrZXlOYW1lID0gdGhpcy5faW5kZXhDb21tYW5kKCdmb3JlaWduJywgdGhpcy50YWJsZU5hbWVSYXcsIGZvcmVpZ25EYXRhLmNvbHVtbik7XG4gICAgdmFyIGNvbHVtbiA9IHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShmb3JlaWduRGF0YS5jb2x1bW4pO1xuICAgIHZhciByZWZlcmVuY2VzID0gdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGZvcmVpZ25EYXRhLnJlZmVyZW5jZXMpO1xuICAgIHZhciBpblRhYmxlID0gdGhpcy5mb3JtYXR0ZXIud3JhcChmb3JlaWduRGF0YS5pblRhYmxlKTtcbiAgICB2YXIgb25VcGRhdGUgPSBmb3JlaWduRGF0YS5vblVwZGF0ZSA/ICh0aGlzLmxvd2VyQ2FzZSA/ICcgb24gdXBkYXRlICcgOiAnIE9OIFVQREFURSAnKSArIGZvcmVpZ25EYXRhLm9uVXBkYXRlIDogJyc7XG4gICAgdmFyIG9uRGVsZXRlID0gZm9yZWlnbkRhdGEub25EZWxldGUgPyAodGhpcy5sb3dlckNhc2UgPyAnIG9uIGRlbGV0ZSAnIDogJyBPTiBERUxFVEUgJykgKyBmb3JlaWduRGF0YS5vbkRlbGV0ZSA6ICcnO1xuICAgIGlmICh0aGlzLmxvd2VyQ2FzZSkge1xuICAgICAgdGhpcy5wdXNoUXVlcnkoKCF0aGlzLmZvckNyZWF0ZSA/ICdhbHRlciB0YWJsZSAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgYWRkICcgOiAnJykgKyAnY29uc3RyYWludCAnICsga2V5TmFtZSArICcgJyArXG4gICAgICAgICdmb3JlaWduIGtleSAoJyArIGNvbHVtbiArICcpIHJlZmVyZW5jZXMgJyArIGluVGFibGUgKyAnICgnICsgcmVmZXJlbmNlcyArICcpJyArIG9uVXBkYXRlICsgb25EZWxldGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnB1c2hRdWVyeSgoIXRoaXMuZm9yQ3JlYXRlID8gJ0FMVEVSIFRBQkxFICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyBBREQgJyA6ICcnKSArICdDT05TVFJBSU5UICcgKyBrZXlOYW1lICsgJyAnICtcbiAgICAgICAgJ0ZPUkVJR04gS0VZICgnICsgY29sdW1uICsgJykgUkVGRVJFTkNFUyAnICsgaW5UYWJsZSArICcgKCcgKyByZWZlcmVuY2VzICsgJyknICsgb25VcGRhdGUgKyBvbkRlbGV0ZSk7XG4gICAgfVxuICB9XG59O1xuXG4vLyBHZXQgYWxsIG9mIHRoZSBjb2x1bW4gc3FsICYgYmluZGluZ3MgaW5kaXZpZHVhbGx5IGZvciBidWlsZGluZyB0aGUgdGFibGUgcXVlcmllcy5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtblR5cGVzID0gZnVuY3Rpb24gKGNvbHVtbnMpIHtcbiAgcmV0dXJuIF8ucmVkdWNlKF8ubWFwKGNvbHVtbnMsIF8uZmlyc3QpLCBmdW5jdGlvbiAobWVtbywgY29sdW1uKSB7XG4gICAgbWVtby5zcWwucHVzaChjb2x1bW4uc3FsKTtcbiAgICBtZW1vLmJpbmRpbmdzLmNvbmNhdChjb2x1bW4uYmluZGluZ3MpO1xuICAgIHJldHVybiBtZW1vO1xuICB9LCB7IHNxbDogW10sIGJpbmRpbmdzOiBbXSB9KTtcbn07XG5cbi8vIEFkZHMgYWxsIG9mIHRoZSBhZGRpdGlvbmFsIHF1ZXJpZXMgZnJvbSB0aGUgXCJjb2x1bW5cIlxuVGFibGVDb21waWxlci5wcm90b3R5cGUuY29sdW1uUXVlcmllcyA9IGZ1bmN0aW9uIChjb2x1bW5zKSB7XG4gIHZhciBxdWVyaWVzID0gXy5yZWR1Y2UoXy5tYXAoY29sdW1ucywgXy5yZXN0KSwgZnVuY3Rpb24gKG1lbW8sIGNvbHVtbikge1xuICAgIGlmICghXy5pc0VtcHR5KGNvbHVtbikpIHJldHVybiBtZW1vLmNvbmNhdChjb2x1bW4pO1xuICAgIHJldHVybiBtZW1vO1xuICB9LCBbXSk7XG4gIGZvciAodmFyIGkgPSAwLCBsID0gcXVlcmllcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICB0aGlzLnB1c2hRdWVyeShxdWVyaWVzW2ldKTtcbiAgfVxufTtcblxuLy8gQWRkIGEgbmV3IGNvbHVtbi5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmFkZENvbHVtbnNQcmVmaXggPSAnYWRkIGNvbHVtbiAnO1xuXG4vLyBBbGwgb2YgdGhlIGNvbHVtbnMgdG8gXCJhZGRcIiBmb3IgdGhlIHF1ZXJ5XG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5hZGRDb2x1bW5zID0gZnVuY3Rpb24gKGNvbHVtbnMpIHtcbiAgaWYgKGNvbHVtbnMuc3FsLmxlbmd0aCA+IDApIHtcbiAgICB2YXIgY29sdW1uU3FsID0gXy5tYXAoY29sdW1ucy5zcWwsIGZ1bmN0aW9uIChjb2x1bW4pIHtcbiAgICAgIHJldHVybiB0aGlzLmFkZENvbHVtbnNQcmVmaXggKyBjb2x1bW47XG4gICAgfSwgdGhpcyk7XG4gICAgdGhpcy5wdXNoUXVlcnkoe1xuICAgICAgc3FsOiAodGhpcy5sb3dlckNhc2UgPyAnYWx0ZXIgdGFibGUgJyA6ICdBTFRFUiBUQUJMRSAnKSArIHRoaXMudGFibGVOYW1lKCkgKyAnICcgKyBjb2x1bW5TcWwuam9pbignLCAnKSxcbiAgICAgIGJpbmRpbmdzOiBjb2x1bW5zLmJpbmRpbmdzXG4gICAgfSk7XG4gIH1cbn07XG5cbi8vIENvbXBpbGUgdGhlIGNvbHVtbnMgYXMgbmVlZGVkIGZvciB0aGUgY3VycmVudCBjcmVhdGUgb3IgYWx0ZXIgdGFibGVcblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtbnMgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBpID0gLTEsIGNvbXBpbGVkQ29sdW1ucyA9IFtdLCBjb2x1bW5zID0gdGhpcy5ncm91cGVkLmNvbHVtbnMgfHwgW107XG4gIHdoaWxlICgrK2kgPCBjb2x1bW5zLmxlbmd0aCkge1xuICAgIGNvbXBpbGVkQ29sdW1ucy5wdXNoKHRoaXMuY2xpZW50LmNvbHVtbkNvbXBpbGVyKHRoaXMsIGNvbHVtbnNbaV0uYnVpbGRlcikudG9TUUwoKSlcbiAgfVxuICByZXR1cm4gY29tcGlsZWRDb2x1bW5zO1xufTtcblxuVGFibGVDb21waWxlci5wcm90b3R5cGUudGFibGVOYW1lID0gZnVuY3Rpb24gKCkge1xuICB2YXIgbmFtZSA9IHRoaXMuc2NoZW1hTmFtZVJhdyA/XG4gICAgYCR7dGhpcy5zY2hlbWFOYW1lUmF3fS4ke3RoaXMudGFibGVOYW1lUmF3fWBcbiAgICA6IHRoaXMudGFibGVOYW1lUmF3O1xuXG4gIHJldHVybiB0aGlzLmZvcm1hdHRlci53cmFwKG5hbWUpO1xufTtcblxuLy8gR2VuZXJhdGUgYWxsIG9mIHRoZSBhbHRlciBjb2x1bW4gc3RhdGVtZW50cyBuZWNlc3NhcnkgZm9yIHRoZSBxdWVyeS5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmFsdGVyVGFibGUgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBhbHRlclRhYmxlID0gdGhpcy5ncm91cGVkLmFsdGVyVGFibGUgfHwgW107XG4gIGZvciAodmFyIGkgPSAwLCBsID0gYWx0ZXJUYWJsZS5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICB2YXIgc3RhdGVtZW50ID0gYWx0ZXJUYWJsZVtpXTtcbiAgICBpZiAodGhpc1tzdGF0ZW1lbnQubWV0aG9kXSkge1xuICAgICAgdGhpc1tzdGF0ZW1lbnQubWV0aG9kXS5hcHBseSh0aGlzLCBzdGF0ZW1lbnQuYXJncyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0RlYnVnOiAnICsgc3RhdGVtZW50Lm1ldGhvZCArICcgZG9lcyBub3QgZXhpc3QnKTtcbiAgICB9XG4gIH1cbiAgZm9yICh2YXIgaXRlbSBpbiB0aGlzLnNpbmdsZSkge1xuICAgIGlmICh0eXBlb2YgdGhpc1tpdGVtXSA9PT0gJ2Z1bmN0aW9uJykgdGhpc1tpdGVtXSh0aGlzLnNpbmdsZVtpdGVtXSk7XG4gIH1cbn07XG5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmFsdGVyVGFibGVGb3JDcmVhdGUgPSBmdW5jdGlvbiAoY29sdW1uVHlwZXMpIHtcbiAgdGhpcy5mb3JDcmVhdGUgPSB0cnVlO1xuICB2YXIgc2F2ZWRTZXF1ZW5jZSA9IHRoaXMuc2VxdWVuY2U7XG4gIHZhciBhbHRlclRhYmxlID0gdGhpcy5ncm91cGVkLmFsdGVyVGFibGUgfHwgW107XG4gIHRoaXMuZ3JvdXBlZC5hbHRlclRhYmxlID0gW107XG4gIGZvciAodmFyIGkgPSAwLCBsID0gYWx0ZXJUYWJsZS5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICB2YXIgc3RhdGVtZW50ID0gYWx0ZXJUYWJsZVtpXTtcbiAgICBpZiAoXy5pbmRleE9mKHRoaXMuY3JlYXRlQWx0ZXJUYWJsZU1ldGhvZHMsIHN0YXRlbWVudC5tZXRob2QpIDwgMCkge1xuICAgICAgdGhpcy5ncm91cGVkLmFsdGVyVGFibGUucHVzaChzdGF0ZW1lbnQpO1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGlmICh0aGlzW3N0YXRlbWVudC5tZXRob2RdKSB7XG4gICAgICB0aGlzLnNlcXVlbmNlID0gW107XG4gICAgICB0aGlzW3N0YXRlbWVudC5tZXRob2RdLmFwcGx5KHRoaXMsIHN0YXRlbWVudC5hcmdzKTtcbiAgICAgIGNvbHVtblR5cGVzLnNxbC5wdXNoKHRoaXMuc2VxdWVuY2VbMF0uc3FsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcignRGVidWc6ICcgKyBzdGF0ZW1lbnQubWV0aG9kICsgJyBkb2VzIG5vdCBleGlzdCcpO1xuICAgIH1cbiAgfVxuICB0aGlzLnNlcXVlbmNlID0gc2F2ZWRTZXF1ZW5jZTtcbiAgdGhpcy5mb3JDcmVhdGUgPSBmYWxzZTtcbn07XG5cblxuLy8gRHJvcCB0aGUgaW5kZXggb24gdGhlIGN1cnJlbnQgdGFibGUuXG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5kcm9wSW5kZXggPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgdGhpcy5wdXNoUXVlcnkoJ2Ryb3AgaW5kZXgnICsgdmFsdWUpO1xufTtcblxuLy8gRHJvcCB0aGUgdW5pcXVlXG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5kcm9wVW5pcXVlID1cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmRyb3BGb3JlaWduID0gZnVuY3Rpb24gKCkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCBpbXBsZW1lbnRlZCBpbiB0aGUgZGlhbGVjdCBkcml2ZXInKTtcbn07XG5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmRyb3BDb2x1bW5QcmVmaXggPSAnZHJvcCBjb2x1bW4gJztcblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmRyb3BDb2x1bW4gPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBjb2x1bW5zID0gbm9ybWFsaXplQXJyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7XG4gIHZhciBkcm9wcyA9IF8ubWFwKF8uaXNBcnJheShjb2x1bW5zKSA/IGNvbHVtbnMgOiBbY29sdW1uc10sIGZ1bmN0aW9uIChjb2x1bW4pIHtcbiAgICByZXR1cm4gdGhpcy5kcm9wQ29sdW1uUHJlZml4ICsgdGhpcy5mb3JtYXR0ZXIud3JhcChjb2x1bW4pO1xuICB9LCB0aGlzKTtcbiAgdGhpcy5wdXNoUXVlcnkoKHRoaXMubG93ZXJDYXNlID8gJ2FsdGVyIHRhYmxlICcgOiAnQUxURVIgVEFCTEUgJykgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyAnICsgZHJvcHMuam9pbignLCAnKSk7XG59O1xuXG4vLyBJZiBubyBuYW1lIHdhcyBzcGVjaWZpZWQgZm9yIHRoaXMgaW5kZXgsIHdlIHdpbGwgY3JlYXRlIG9uZSB1c2luZyBhIGJhc2ljXG4vLyBjb252ZW50aW9uIG9mIHRoZSB0YWJsZSBuYW1lLCBmb2xsb3dlZCBieSB0aGUgY29sdW1ucywgZm9sbG93ZWQgYnkgYW5cbi8vIGluZGV4IHR5cGUsIHN1Y2ggYXMgcHJpbWFyeSBvciBpbmRleCwgd2hpY2ggbWFrZXMgdGhlIGluZGV4IHVuaXF1ZS5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLl9pbmRleENvbW1hbmQgPSBmdW5jdGlvbiAodHlwZSwgdGFibGVOYW1lLCBjb2x1bW5zKSB7XG4gIGlmICghXy5pc0FycmF5KGNvbHVtbnMpKSBjb2x1bW5zID0gY29sdW1ucyA/IFtjb2x1bW5zXSA6IFtdO1xuICB2YXIgdGFibGUgPSB0YWJsZU5hbWUucmVwbGFjZSgvXFwufC0vZywgJ18nKTtcbiAgcmV0dXJuICh0YWJsZSArICdfJyArIGNvbHVtbnMuam9pbignXycpICsgJ18nICsgdHlwZSkudG9Mb3dlckNhc2UoKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gVGFibGVDb21waWxlcjsiXX0=