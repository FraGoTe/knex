// Seeder
// -------

'use strict';

var fs = require('fs');
var path = require('path');
var _ = require('lodash');
var mkdirp = require('mkdirp');
var Promise = require('../promise');

// The new seeds we're performing, typically called from the `knex.seed`
// interface on the main `knex` object. Passes the `knex` instance performing
// the seeds.
function Seeder(knex) {
  this.knex = knex;
  this.config = this.setConfig(knex.client.config.seeds);
}

// Runs all seed files for the given environment.
Seeder.prototype.run = Promise.method(function (config) {
  this.config = this.setConfig(config);
  return this._seedData().bind(this).spread(function (all) {
    return this._runSeeds(all);
  });
});

// Creates a new seed file, with a given name.
Seeder.prototype.make = function (name, config) {
  this.config = this.setConfig(config);
  if (!name) Promise.rejected(new Error('A name must be specified for the generated seed'));
  return this._ensureFolder(config).bind(this).then(this._generateStubTemplate).then(this._writeNewSeed(name));
};

// Lists all available seed files as a sorted array.
Seeder.prototype._listAll = Promise.method(function (config) {
  this.config = this.setConfig(config);
  return Promise.promisify(fs.readdir, fs)(this._absoluteConfigDir()).bind(this).then(function (seeds) {
    return _.filter(seeds, function (value) {
      var extension = path.extname(value);
      return _.contains(['.co', '.coffee', '.eg', '.iced', '.js', '.litcoffee', '.ls'], extension);
    }).sort();
  });
});

// Gets the seed file list from the specified seed directory.
Seeder.prototype._seedData = function () {
  return Promise.join(this._listAll());
};

// Ensures a folder for the seeds exist, dependent on the
// seed config settings.
Seeder.prototype._ensureFolder = function () {
  var dir = this._absoluteConfigDir();
  return Promise.promisify(fs.stat, fs)(dir)['catch'](function () {
    return Promise.promisify(mkdirp)(dir);
  });
};

// Run seed files, in sequence.
Seeder.prototype._runSeeds = function (seeds) {
  return Promise.all(_.map(seeds, this._validateSeedStructure, this)).bind(this).then(function (seeds) {
    return Promise.bind(this).then(function () {
      return this._waterfallBatch(seeds);
    });
  });
};

// Validates seed files by requiring and checking for a `seed` function.
Seeder.prototype._validateSeedStructure = function (name) {
  var seed = require(path.join(this._absoluteConfigDir(), name));
  if (typeof seed.seed !== 'function') {
    throw new Error('Invalid seed file: ' + name + ' must have a seed function');
  }
  return name;
};

// Generates the stub template for the current seed file, returning a compiled template.
Seeder.prototype._generateStubTemplate = function () {
  var stubPath = this.config.stub || path.join(__dirname, 'stub', this.config.extension + '.stub');
  return Promise.promisify(fs.readFile, fs)(stubPath).then(function (stub) {
    return _.template(stub.toString(), null, { variable: 'd' });
  });
};

// Write a new seed to disk, using the config and generated filename,
// passing any `variables` given in the config to the template.
Seeder.prototype._writeNewSeed = function (name) {
  var config = this.config;
  var dir = this._absoluteConfigDir();
  return function (tmpl) {
    if (name[0] === '-') name = name.slice(1);
    var filename = name + '.' + config.extension;
    return Promise.promisify(fs.writeFile, fs)(path.join(dir, filename), tmpl(config.variables || {}))['return'](path.join(dir, filename));
  };
};

// Runs a batch of seed files.
Seeder.prototype._waterfallBatch = function (seeds) {
  var knex = this.knex;
  var seedDirectory = this._absoluteConfigDir();
  var current = Promise.bind({ failed: false, failedOn: 0 });
  var log = [];
  _.each(seeds, function (seed) {
    var name = path.join(seedDirectory, seed);
    seed = require(name);

    // Run each seed file.
    current = current.then(function () {
      return seed.seed(knex, Promise);
    }).then(function () {
      log.push(name);
    });
  });

  return current.thenReturn([log]);
};

Seeder.prototype._absoluteConfigDir = function () {
  return path.resolve(process.cwd(), this.config.directory);
};

Seeder.prototype.setConfig = function (config) {
  return _.extend({
    extension: 'js',
    directory: './seeds'
  }, this.config || {}, config);
};

module.exports = Seeder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZWVkL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBR0EsSUFBSSxFQUFFLEdBQVMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzdCLElBQUksSUFBSSxHQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMvQixJQUFJLENBQUMsR0FBVSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDakMsSUFBSSxNQUFNLEdBQUssT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2pDLElBQUksT0FBTyxHQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQzs7Ozs7QUFLckMsU0FBUyxNQUFNLENBQUMsSUFBSSxFQUFFO0FBQ3BCLE1BQUksQ0FBQyxJQUFJLEdBQUssSUFBSSxDQUFDO0FBQ25CLE1BQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztDQUN4RDs7O0FBR0QsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxVQUFTLE1BQU0sRUFBRTtBQUNyRCxNQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDckMsU0FBTyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FDVixNQUFNLENBQUMsVUFBUyxHQUFHLEVBQUU7QUFDcEIsV0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0dBQzVCLENBQUMsQ0FBQztDQUNOLENBQUMsQ0FBQzs7O0FBR0gsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsVUFBUyxJQUFJLEVBQUUsTUFBTSxFQUFFO0FBQzdDLE1BQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNy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T0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0NBQzNELENBQUM7O0FBRUYsTUFBTSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsVUFBUyxNQUFNLEVBQUU7QUFDNUMsU0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ2QsYUFBUyxFQUFFLElBQUk7QUFDZixhQUFTLEVBQUUsU0FBUztHQUNyQixFQUFFLElBQUksQ0FBQyxNQUFNLElBQUksRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0NBQy9CLENBQUM7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTZWVkZXJcbi8vIC0tLS0tLS1cblxudmFyIGZzICAgICAgID0gcmVxdWlyZSgnZnMnKTtcbnZhciBwYXRoICAgICA9IHJlcXVpcmUoJ3BhdGgnKTtcbnZhciBfICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIG1rZGlycCAgID0gcmVxdWlyZSgnbWtkaXJwJyk7XG52YXIgUHJvbWlzZSAgPSByZXF1aXJlKCcuLi9wcm9taXNlJyk7XG5cbi8vIFRoZSBuZXcgc2VlZHMgd2UncmUgcGVyZm9ybWluZywgdHlwaWNhbGx5IGNhbGxlZCBmcm9tIHRoZSBga25leC5zZWVkYFxuLy8gaW50ZXJmYWNlIG9uIHRoZSBtYWluIGBrbmV4YCBvYmplY3QuIFBhc3NlcyB0aGUgYGtuZXhgIGluc3RhbmNlIHBlcmZvcm1pbmdcbi8vIHRoZSBzZWVkcy5cbmZ1bmN0aW9uIFNlZWRlcihrbmV4KSB7XG4gIHRoaXMua25leCAgID0ga25leDtcbiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhrbmV4LmNsaWVudC5jb25maWcuc2VlZHMpO1xufVxuXG4vLyBSdW5zIGFsbCBzZWVkIGZpbGVzIGZvciB0aGUgZ2l2ZW4gZW52aXJvbm1lbnQuXG5TZWVkZXIucHJvdG90eXBlLnJ1biA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKGNvbmZpZykge1xuICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0Q29uZmlnKGNvbmZpZyk7XG4gIHJldHVybiB0aGlzLl9zZWVkRGF0YSgpXG4gICAgLmJpbmQodGhpcylcbiAgICAuc3ByZWFkKGZ1bmN0aW9uKGFsbCkge1xuICAgICAgcmV0dXJuIHRoaXMuX3J1blNlZWRzKGFsbCk7XG4gICAgfSk7XG59KTtcblxuLy8gQ3JlYXRlcyBhIG5ldyBzZWVkIGZpbGUsIHdpdGggYSBnaXZlbiBuYW1lLlxuU2VlZGVyLnByb3RvdHlwZS5tYWtlID0gZnVuY3Rpb24obmFtZSwgY29uZmlnKSB7XG4gIHRoaXMuY29uZmlnID0gdGhpcy5zZXRDb25maWcoY29uZmlnKTtcbiAgaWYgKCFuYW1lKSBQcm9taXNlLnJlamVjdGVkKG5ldyBFcnJvcignQSBuYW1lIG11c3QgYmUgc3BlY2lmaWVkIGZvciB0aGUgZ2VuZXJhdGVkIHNlZWQnKSk7XG4gIHJldHVybiB0aGlzLl9lbnN1cmVGb2xkZXIoY29uZmlnKVxuICAgIC5iaW5kKHRoaXMpXG4gICAgLnRoZW4odGhpcy5fZ2VuZXJhdGVTdHViVGVtcGxhdGUpXG4gICAgLnRoZW4odGhpcy5fd3JpdGVOZXdTZWVkKG5hbWUpKTtcbn07XG5cbi8vIExpc3RzIGFsbCBhdmFpbGFibGUgc2VlZCBmaWxlcyBhcyBhIHNvcnRlZCBhcnJheS5cblNlZWRlci5wcm90b3R5cGUuX2xpc3RBbGwgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihjb25maWcpIHtcbiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhjb25maWcpO1xuICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMucmVhZGRpciwgZnMpKHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCkpXG4gICAgLmJpbmQodGhpcylcbiAgICAudGhlbihmdW5jdGlvbihzZWVkcykge1xuICAgICAgcmV0dXJuIF8uZmlsdGVyKHNlZWRzLCBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICB2YXIgZXh0ZW5zaW9uID0gcGF0aC5leHRuYW1lKHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIF8uY29udGFpbnMoWycuY28nLCAnLmNvZmZlZScsICcuZWcnLCAnLmljZWQnLCAnLmpzJywgJy5saXRjb2ZmZWUnLCAnLmxzJ10sIGV4dGVuc2lvbik7XG4gICAgICB9KS5zb3J0KCk7XG4gICAgfSk7XG59KTtcblxuLy8gR2V0cyB0aGUgc2VlZCBmaWxlIGxpc3QgZnJvbSB0aGUgc3BlY2lmaWVkIHNlZWQgZGlyZWN0b3J5LlxuU2VlZGVyLnByb3RvdHlwZS5fc2VlZERhdGEgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIFByb21pc2Uuam9pbih0aGlzLl9saXN0QWxsKCkpO1xufTtcblxuXG4vLyBFbnN1cmVzIGEgZm9sZGVyIGZvciB0aGUgc2VlZHMgZXhpc3QsIGRlcGVuZGVudCBvbiB0aGVcbi8vIHNlZWQgY29uZmlnIHNldHRpbmdzLlxuU2VlZGVyLnByb3RvdHlwZS5fZW5zdXJlRm9sZGVyID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGRpciA9IHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCk7XG4gICAgcmV0dXJuIFByb21pc2UucHJvbWlzaWZ5KGZzLnN0YXQsIGZzKShkaXIpXG4gICAgICAuY2F0Y2goZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnByb21pc2lmeShta2RpcnApKGRpcik7XG4gICAgICB9KTtcbn07XG5cbi8vIFJ1biBzZWVkIGZpbGVzLCBpbiBzZXF1ZW5jZS5cblNlZWRlci5wcm90b3R5cGUuX3J1blNlZWRzID0gZnVuY3Rpb24oc2VlZHMpIHtcbiAgcmV0dXJuIFByb21pc2UuYWxsKF8ubWFwKHNlZWRzLCB0aGlzLl92YWxpZGF0ZVNlZWRTdHJ1Y3R1cmUsIHRoaXMpKVxuICAgIC5iaW5kKHRoaXMpXG4gICAgLnRoZW4oZnVuY3Rpb24oc2VlZHMpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcylcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX3dhdGVyZmFsbEJhdGNoKHNlZWRzKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59O1xuXG4vLyBWYWxpZGF0ZXMgc2VlZCBmaWxlcyBieSByZXF1aXJpbmcgYW5kIGNoZWNraW5nIGZvciBhIGBzZWVkYCBmdW5jdGlvbi5cblNlZWRlci5wcm90b3R5cGUuX3ZhbGlkYXRlU2VlZFN0cnVjdHVyZSA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgdmFyIHNlZWQgPSByZXF1aXJlKHBhdGguam9pbih0aGlzLl9hYnNvbHV0ZUNvbmZpZ0RpcigpLCBuYW1lKSk7XG4gIGlmICh0eXBlb2Ygc2VlZC5zZWVkICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNlZWQgZmlsZTogJyArIG5hbWUgKyAnIG11c3QgaGF2ZSBhIHNlZWQgZnVuY3Rpb24nKTtcbiAgfVxuICByZXR1cm4gbmFtZTtcbn07XG5cbi8vIEdlbmVyYXRlcyB0aGUgc3R1YiB0ZW1wbGF0ZSBmb3IgdGhlIGN1cnJlbnQgc2VlZCBmaWxlLCByZXR1cm5pbmcgYSBjb21waWxlZCB0ZW1wbGF0ZS5cblNlZWRlci5wcm90b3R5cGUuX2dlbmVyYXRlU3R1YlRlbXBsYXRlID0gZnVuY3Rpb24oKSB7XG4gIHZhciBzdHViUGF0aCA9IHRoaXMuY29uZmlnLnN0dWIgfHwgcGF0aC5qb2luKF9fZGlybmFtZSwgJ3N0dWInLCB0aGlzLmNvbmZpZy5leHRlbnNpb24gKyAnLnN0dWInKTtcbiAgcmV0dXJuIFByb21pc2UucHJvbWlzaWZ5KGZzLnJlYWRGaWxlLCBmcykoc3R1YlBhdGgpLnRoZW4oZnVuY3Rpb24oc3R1Yikge1xuICAgIHJldHVybiBfLnRlbXBsYXRlKHN0dWIudG9TdHJpbmcoKSwgbnVsbCwge3ZhcmlhYmxlOiAnZCd9KTtcbiAgfSk7XG59O1xuXG4vLyBXcml0ZSBhIG5ldyBzZWVkIHRvIGRpc2ssIHVzaW5nIHRoZSBjb25maWcgYW5kIGdlbmVyYXRlZCBmaWxlbmFtZSxcbi8vIHBhc3NpbmcgYW55IGB2YXJpYWJsZXNgIGdpdmVuIGluIHRoZSBjb25maWcgdG8gdGhlIHRlbXBsYXRlLlxuU2VlZGVyLnByb3RvdHlwZS5fd3JpdGVOZXdTZWVkID0gZnVuY3Rpb24obmFtZSkge1xuICB2YXIgY29uZmlnID0gdGhpcy5jb25maWc7XG4gIHZhciBkaXIgPSB0aGlzLl9hYnNvbHV0ZUNvbmZpZ0RpcigpO1xuICByZXR1cm4gZnVuY3Rpb24odG1wbCkge1xuICAgIGlmIChuYW1lWzBdID09PSAnLScpIG5hbWUgPSBuYW1lLnNsaWNlKDEpO1xuICAgIHZhciBmaWxlbmFtZSAgPSBuYW1lICsgJy4nICsgY29uZmlnLmV4dGVuc2lvbjtcbiAgICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMud3JpdGVGaWxlLCBmcykoXG4gICAgICBwYXRoLmpvaW4oZGlyLCBmaWxlbmFtZSksXG4gICAgICB0bXBsKGNvbmZpZy52YXJpYWJsZXMgfHwge30pXG4gICAgKS5yZXR1cm4ocGF0aC5qb2luKGRpciwgZmlsZW5hbWUpKTtcbiAgfTtcbn07XG5cbi8vIFJ1bnMgYSBiYXRjaCBvZiBzZWVkIGZpbGVzLlxuU2VlZGVyLnByb3RvdHlwZS5fd2F0ZXJmYWxsQmF0Y2ggPSBmdW5jdGlvbihzZWVkcykge1xuICB2YXIga25leCAgICAgID0gdGhpcy5rbmV4O1xuICB2YXIgc2VlZERpcmVjdG9yeSA9IHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCk7XG4gIHZhciBjdXJyZW50ICAgPSBQcm9taXNlLmJpbmQoe2ZhaWxlZDogZmFsc2UsIGZhaWxlZE9uOiAwfSk7XG4gIHZhciBsb2cgICAgICAgPSBbXTtcbiAgXy5lYWNoKHNlZWRzLCBmdW5jdGlvbihzZWVkKSB7XG4gICAgdmFyIG5hbWUgID0gcGF0aC5qb2luKHNlZWREaXJlY3RvcnksIHNlZWQpO1xuICAgIHNlZWQgPSByZXF1aXJlKG5hbWUpO1xuXG4gICAgLy8gUnVuIGVhY2ggc2VlZCBmaWxlLlxuICAgIGN1cnJlbnQgPSBjdXJyZW50LnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gc2VlZC5zZWVkKGtuZXgsIFByb21pc2UpO1xuICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICBsb2cucHVzaChuYW1lKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGN1cnJlbnQudGhlblJldHVybihbbG9nXSk7XG59O1xuXG5TZWVkZXIucHJvdG90eXBlLl9hYnNvbHV0ZUNvbmZpZ0RpciA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIHRoaXMuY29uZmlnLmRpcmVjdG9yeSk7XG59O1xuXG5TZWVkZXIucHJvdG90eXBlLnNldENvbmZpZyA9IGZ1bmN0aW9uKGNvbmZpZykge1xuICByZXR1cm4gXy5leHRlbmQoe1xuICAgIGV4dGVuc2lvbjogJ2pzJyxcbiAgICBkaXJlY3Rvcnk6ICcuL3NlZWRzJ1xuICB9LCB0aGlzLmNvbmZpZyB8fCB7fSwgY29uZmlnKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gU2VlZGVyO1xuIl19