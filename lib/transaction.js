
// Transaction
// -------
'use strict';

var Promise = require('./promise');
var EventEmitter = require('events').EventEmitter;
var inherits = require('inherits');

var makeKnex = require('./util/make-knex');
var assign = require('lodash/object/assign');
var uniqueId = require('lodash/utility/uniqueId');
var debug = require('debug')('knex:tx');

// Acts as a facade for a Promise, keeping the internal state
// and managing any child transactions.
function Transaction(client, container, config, outerTx) {
  var _this = this;

  var txid = this.txid = uniqueId('trx');

  this.client = client;
  this.outerTx = outerTx;
  this.trxClient = undefined;
  this._debug = client.config && client.config.debug;

  debug('%s: Starting %s transaction', txid, outerTx ? 'nested' : 'top level');

  this._promise = Promise.using(this.acquireConnection(client, config, txid), function (connection) {

    var trxClient = _this.trxClient = makeTxClient(_this, client, connection);
    var init = client.transacting ? _this.savepoint(connection) : _this.begin(connection);

    init.then(function () {
      return makeTransactor(_this, connection, trxClient);
    }).then(function (transactor) {

      var result = container(transactor);

      // If we've returned a "thenable" from the transaction container,
      // and it's got the transaction object we're running for this, assume
      // the rollback and commit are chained to this object's success / failure.
      if (result && result.then && typeof result.then === 'function') {
        result.then(function (val) {
          transactor.commit(val);
        })['catch'](function (err) {
          transactor.rollback(err);
        });
      }
    })['catch'](function (e) {
      return _this._rejecter(e);
    });

    return new Promise(function (resolver, rejecter) {
      _this._resolver = resolver;
      _this._rejecter = rejecter;
    });
  });

  this._completed = false;

  // If there is more than one child transaction,
  // we queue them, executing each when the previous completes.
  this._childQueue = [];

  // The queue is a noop unless we have child promises.
  this._queue = this._queue || Promise.resolve(true);

  // If there's a wrapping transaction, we need to see if there are
  // any current children in the pending queue.
  if (outerTx) {

    // If there are other promises pending, we just wait until that one
    // settles (commit or rollback) and then we can continue.
    if (outerTx._childQueue.length > 0) {

      this._queue = this._queue.then(function () {
        return Promise.settle(outerTx._childQueue[outerTx._childQueue.length - 1]);
      });
    }

    // Push the current promise onto the queue of promises.
    outerTx._childQueue.push(this._promise);
  }
}
inherits(Transaction, EventEmitter);

assign(Transaction.prototype, {

  isCompleted: function isCompleted() {
    return this._completed || this.outerTx && this.outerTx.isCompleted() || false;
  },

  begin: function begin(conn) {
    return this.query(conn, 'BEGIN;');
  },

  savepoint: function savepoint(conn) {
    return this.query(conn, 'SAVEPOINT ' + this.txid + ';');
  },

  commit: function commit(conn, value) {
    return this.query(conn, 'COMMIT;', 1, value);
  },

  release: function release(conn, value) {
    return this.query(conn, 'RELEASE SAVEPOINT ' + this.txid + ';', 1, value);
  },

  rollback: function rollback(conn, error) {
    return this.query(conn, 'ROLLBACK;', 2, error);
  },

  rollbackTo: function rollbackTo(conn, error) {
    return this.query(conn, 'ROLLBACK TO SAVEPOINT ' + this.txid, 2, error);
  },

  query: function query(conn, sql, status, value) {
    var _this2 = this;

    var q = this.trxClient.query(conn, sql)['catch'](function (err) {
      status = 2;
      value = err;
      _this2._completed = true;
      debug('%s error running transaction query', _this2.txid);
    }).tap(function () {
      if (status === 1) _this2._resolver(value);
      if (status === 2) _this2._rejecter(value);
    });
    if (status === 1 || status === 2) {
      this._completed = true;
    }
    return q;
  },

  debug: function debug(enabled) {
    this._debug = arguments.length ? enabled : true;
    return this;
  },

  _skipping: function _skipping(sql) {
    return Promise.reject(new Error('Transaction ' + this.txid + ' has already been released skipping: ' + sql));
  },

  // Acquire a connection and create a disposer - either using the one passed
  // via config or getting one off the client. The disposer will be called once
  // the original promise is marked completed.
  acquireConnection: function acquireConnection(client, config, txid) {
    var configConnection = config && config.connection;
    return Promise['try'](function () {
      return configConnection || client.acquireConnection();
    }).disposer(function (connection) {
      if (!configConnection) {
        debug('%s: releasing connection', txid);
        client.releaseConnection(connection);
      } else {
        debug('%s: not releasing external connection', txid);
      }
    });
  }

});

// The transactor is a full featured knex object, with a "commit",
// a "rollback" and a "savepoint" function. The "savepoint" is just
// sugar for creating a new transaction. If the rollback is run
// inside a savepoint, it rolls back to the last savepoint - otherwise
// it rolls back the transaction.
function makeTransactor(trx, connection, trxClient) {

  var transactor = makeKnex(trxClient);

  transactor.transaction = function (container, options) {
    return new trxClient.Transaction(trxClient, container, options, trx);
  };
  transactor.savepoint = function (container, options) {
    return transactor.transaction(container, options);
  };

  if (trx.client.transacting) {
    transactor.commit = function (value) {
      return trx.release(connection, value);
    };
    transactor.rollback = function (error) {
      return trx.rollbackTo(connection, error);
    };
  } else {
    transactor.commit = function (value) {
      return trx.commit(connection, value);
    };
    transactor.rollback = function (error) {
      return trx.rollback(connection, error);
    };
  }

  return transactor;
}

// We need to make a client object which always acquires the same
// connection and does not release back into the pool.
function makeTxClient(trx, client, connection) {

  var trxClient = Object.create(client.constructor.prototype);
  trxClient.config = client.config;
  trxClient.driver = client.driver;
  trxClient.connectionSettings = client.connectionSettings;
  trxClient.transacting = true;

  trxClient.on('query', function (arg) {
    trx.emit('query', arg);
    client.emit('query', arg);
  });

  var _query = trxClient.query;
  trxClient.query = function (conn, obj) {
    var completed = trx.isCompleted();
    return Promise['try'](function () {
      if (conn !== connection) throw new Error('Invalid connection for transaction query.');
      if (completed) completedError(trx, obj);
      return _query.call(trxClient, conn, obj);
    });
  };
  var _stream = trxClient.stream;
  trxClient.stream = function (conn, obj, stream, options) {
    var completed = trx.isCompleted();
    return Promise['try'](function () {
      if (conn !== connection) throw new Error('Invalid connection for transaction query.');
      if (completed) completedError(trx, obj);
      return _stream.call(trxClient, conn, obj, stream, options);
    });
  };
  trxClient.acquireConnection = function () {
    return trx._queue.then(function () {
      return connection;
    });
  };
  trxClient.releaseConnection = function () {
    return Promise.resolve();
  };

  return trxClient;
}

function completedError(trx, obj) {
  var sql = typeof obj === 'string' ? obj : obj && obj.sql;
  debug('%s: Transaction completed: %s', trx.id, sql);
  throw new Error('Transaction query already complete, run with DEBUG=knex:tx for more info');
}

var promiseInterface = ['then', 'bind', 'catch', 'finally', 'asCallback', 'spread', 'map', 'reduce', 'tap', 'thenReturn', 'return', 'yield', 'ensure', 'nodeify', 'exec'];

// Creates a method which "coerces" to a promise, by calling a
// "then" method on the current `Target`
promiseInterface.forEach(function (method) {
  Transaction.prototype[method] = function () {
    return this._promise = this._promise[method].apply(this._promise, arguments);
  };
});

module.exports = Transaction;
//# sourceMappingURL=data:application/json;base64,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LEVBQUUsWUFBWSxFQUNoRCxRQUFRLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUM5QyxRQUFRLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUMvQyxDQUFBOzs7O0FBSUQsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFVBQVMsTUFBTSxFQUFFO0FBQ3hDLGFBQVcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUcsWUFBVztBQUN6QyxXQUFRLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQztHQUMvRSxDQUFBO0NBQ0YsQ0FBQyxDQUFBOztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFDIiwiZmlsZSI6InRyYW5zYWN0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBUcmFuc2FjdGlvblxuLy8gLS0tLS0tLVxudmFyIFByb21pc2UgICAgICA9IHJlcXVpcmUoJy4vcHJvbWlzZScpXG52YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyXG52YXIgaW5oZXJpdHMgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKVxuXG52YXIgbWFrZUtuZXggICAgID0gcmVxdWlyZSgnLi91dGlsL21ha2Uta25leCcpXG52YXIgYXNzaWduICAgICAgID0gcmVxdWlyZSgnbG9kYXNoL29iamVjdC9hc3NpZ24nKVxudmFyIHVuaXF1ZUlkICAgICA9IHJlcXVpcmUoJ2xvZGFzaC91dGlsaXR5L3VuaXF1ZUlkJylcbnZhciBkZWJ1ZyAgICAgICAgPSByZXF1aXJlKCdkZWJ1ZycpKCdrbmV4OnR4JylcblxuLy8gQWN0cyBhcyBhIGZhY2FkZSBmb3IgYSBQcm9taXNlLCBrZWVwaW5nIHRoZSBpbnRlcm5hbCBzdGF0ZVxuLy8gYW5kIG1hbmFnaW5nIGFueSBjaGlsZCB0cmFuc2FjdGlvbnMuXG5mdW5jdGlvbiBUcmFuc2FjdGlvbihjbGllbnQsIGNvbnRhaW5lciwgY29uZmlnLCBvdXRlclR4KSB7XG4gIFxuICB2YXIgdHhpZCA9IHRoaXMudHhpZCA9IHVuaXF1ZUlkKCd0cngnKVxuXG4gIHRoaXMuY2xpZW50ICAgID0gY2xpZW50XG4gIHRoaXMub3V0ZXJUeCAgID0gb3V0ZXJUeFxuICB0aGlzLnRyeENsaWVudCA9IHVuZGVmaW5lZDtcbiAgdGhpcy5fZGVidWcgICAgPSBjbGllbnQuY29uZmlnICYmIGNsaWVudC5jb25maWcuZGVidWdcblxuICBkZWJ1ZygnJXM6IFN0YXJ0aW5nICVzIHRyYW5zYWN0aW9uJywgdHhpZCwgb3V0ZXJUeCA/ICduZXN0ZWQnIDogJ3RvcCBsZXZlbCcpXG5cbiAgdGhpcy5fcHJvbWlzZSA9IFByb21pc2UudXNpbmcodGhpcy5hY3F1aXJlQ29ubmVjdGlvbihjbGllbnQsIGNvbmZpZywgdHhpZCksIChjb25uZWN0aW9uKSA9PiB7XG4gICAgXG4gICAgdmFyIHRyeENsaWVudCA9IHRoaXMudHJ4Q2xpZW50ID0gbWFrZVR4Q2xpZW50KHRoaXMsIGNsaWVudCwgY29ubmVjdGlvbilcbiAgICB2YXIgaW5pdCAgICAgID0gY2xpZW50LnRyYW5zYWN0aW5nID8gdGhpcy5zYXZlcG9pbnQoY29ubmVjdGlvbikgOiB0aGlzLmJlZ2luKGNvbm5lY3Rpb24pXG4gICAgXG4gICAgaW5pdC50aGVuKCgpID0+IHtcbiAgICAgIHJldHVybiBtYWtlVHJhbnNhY3Rvcih0aGlzLCBjb25uZWN0aW9uLCB0cnhDbGllbnQpXG4gICAgfSlcbiAgICAudGhlbigodHJhbnNhY3RvcikgPT4ge1xuXG4gICAgICB2YXIgcmVzdWx0ID0gY29udGFpbmVyKHRyYW5zYWN0b3IpXG5cbiAgICAgIC8vIElmIHdlJ3ZlIHJldHVybmVkIGEgXCJ0aGVuYWJsZVwiIGZyb20gdGhlIHRyYW5zYWN0aW9uIGNvbnRhaW5lcixcbiAgICAgIC8vIGFuZCBpdCdzIGdvdCB0aGUgdHJhbnNhY3Rpb24gb2JqZWN0IHdlJ3JlIHJ1bm5pbmcgZm9yIHRoaXMsIGFzc3VtZVxuICAgICAgLy8gdGhlIHJvbGxiYWNrIGFuZCBjb21taXQgYXJlIGNoYWluZWQgdG8gdGhpcyBvYmplY3QncyBzdWNjZXNzIC8gZmFpbHVyZS5cbiAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LnRoZW4gJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHJlc3VsdC50aGVuKCh2YWwpID0+IHtcbiAgICAgICAgICB0cmFuc2FjdG9yLmNvbW1pdCh2YWwpXG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgdHJhbnNhY3Rvci5yb2xsYmFjayhlcnIpXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgXG4gICAgfSlcbiAgICAuY2F0Y2goKGUpID0+IHRoaXMuX3JlamVjdGVyKGUpKVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlciwgcmVqZWN0ZXIpID0+IHtcbiAgICAgIHRoaXMuX3Jlc29sdmVyID0gcmVzb2x2ZXJcbiAgICAgIHRoaXMuX3JlamVjdGVyID0gcmVqZWN0ZXJcbiAgICB9KVxuICB9KVxuXG4gIHRoaXMuX2NvbXBsZXRlZCAgPSBmYWxzZVxuXG4gIC8vIElmIHRoZXJlIGlzIG1vcmUgdGhhbiBvbmUgY2hpbGQgdHJhbnNhY3Rpb24sXG4gIC8vIHdlIHF1ZXVlIHRoZW0sIGV4ZWN1dGluZyBlYWNoIHdoZW4gdGhlIHByZXZpb3VzIGNvbXBsZXRlcy5cbiAgdGhpcy5fY2hpbGRRdWV1ZSA9IFtdXG5cbiAgLy8gVGhlIHF1ZXVlIGlzIGEgbm9vcCB1bmxlc3Mgd2UgaGF2ZSBjaGlsZCBwcm9taXNlcy5cbiAgdGhpcy5fcXVldWUgPSB0aGlzLl9xdWV1ZSB8fCBQcm9taXNlLnJlc29sdmUodHJ1ZSlcblxuICAvLyBJZiB0aGVyZSdzIGEgd3JhcHBpbmcgdHJhbnNhY3Rpb24sIHdlIG5lZWQgdG8gc2VlIGlmIHRoZXJlIGFyZSBcbiAgLy8gYW55IGN1cnJlbnQgY2hpbGRyZW4gaW4gdGhlIHBlbmRpbmcgcXVldWUuXG4gIGlmIChvdXRlclR4KSB7XG5cbiAgICAvLyBJZiB0aGVyZSBhcmUgb3RoZXIgcHJvbWlzZXMgcGVuZGluZywgd2UganVzdCB3YWl0IHVudGlsIHRoYXQgb25lXG4gICAgLy8gc2V0dGxlcyAoY29tbWl0IG9yIHJvbGxiYWNrKSBhbmQgdGhlbiB3ZSBjYW4gY29udGludWUuXG4gICAgaWYgKG91dGVyVHguX2NoaWxkUXVldWUubGVuZ3RoID4gMCkge1xuXG4gICAgICB0aGlzLl9xdWV1ZSA9IHRoaXMuX3F1ZXVlLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnNldHRsZShvdXRlclR4Ll9jaGlsZFF1ZXVlW291dGVyVHguX2NoaWxkUXVldWUubGVuZ3RoIC0gMV0pXG4gICAgICB9KVxuXG4gICAgfVxuXG4gICAgLy8gUHVzaCB0aGUgY3VycmVudCBwcm9taXNlIG9udG8gdGhlIHF1ZXVlIG9mIHByb21pc2VzLlxuICAgIG91dGVyVHguX2NoaWxkUXVldWUucHVzaCh0aGlzLl9wcm9taXNlKVxuICB9XG5cbn1cbmluaGVyaXRzKFRyYW5zYWN0aW9uLCBFdmVudEVtaXR0ZXIpXG5cbmFzc2lnbihUcmFuc2FjdGlvbi5wcm90b3R5cGUsIHtcblxuICBpc0NvbXBsZXRlZDogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbXBsZXRlZCB8fCB0aGlzLm91dGVyVHggJiYgdGhpcy5vdXRlclR4LmlzQ29tcGxldGVkKCkgfHwgZmFsc2VcbiAgfSxcblxuICBiZWdpbjogZnVuY3Rpb24oY29ubikge1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5KGNvbm4sICdCRUdJTjsnKVxuICB9LFxuXG4gIHNhdmVwb2ludDogZnVuY3Rpb24oY29ubikge1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5KGNvbm4sICdTQVZFUE9JTlQgJyArIHRoaXMudHhpZCArICc7JylcbiAgfSxcblxuICBjb21taXQ6IGZ1bmN0aW9uKGNvbm4sIHZhbHVlKSB7XG4gICAgcmV0dXJuIHRoaXMucXVlcnkoY29ubiwgJ0NPTU1JVDsnLCAxLCB2YWx1ZSlcbiAgfSxcblxuICByZWxlYXNlOiBmdW5jdGlvbihjb25uLCB2YWx1ZSkge1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5KGNvbm4sICdSRUxFQVNFIFNBVkVQT0lOVCAnICsgdGhpcy50eGlkICsgJzsnLCAxLCB2YWx1ZSlcbiAgfSxcblxuICByb2xsYmFjazogZnVuY3Rpb24oY29ubiwgZXJyb3IpIHtcbiAgICByZXR1cm4gdGhpcy5xdWVyeShjb25uLCAnUk9MTEJBQ0s7JywgMiwgZXJyb3IpXG4gIH0sXG5cbiAgcm9sbGJhY2tUbzogZnVuY3Rpb24oY29ubiwgZXJyb3IpIHtcbiAgICByZXR1cm4gdGhpcy5xdWVyeShjb25uLCAnUk9MTEJBQ0sgVE8gU0FWRVBPSU5UICcgKyB0aGlzLnR4aWQsIDIsIGVycm9yKVxuICB9LFxuXG4gIHF1ZXJ5OiBmdW5jdGlvbihjb25uLCBzcWwsIHN0YXR1cywgdmFsdWUpIHtcbiAgICB2YXIgcSA9IHRoaXMudHJ4Q2xpZW50LnF1ZXJ5KGNvbm4sIHNxbClcbiAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIHN0YXR1cyA9IDJcbiAgICAgICAgdmFsdWUgID0gZXJyXG4gICAgICAgIHRoaXMuX2NvbXBsZXRlZCA9IHRydWVcbiAgICAgICAgZGVidWcoJyVzIGVycm9yIHJ1bm5pbmcgdHJhbnNhY3Rpb24gcXVlcnknLCB0aGlzLnR4aWQpXG4gICAgICB9KVxuICAgICAgLnRhcCgoKSA9PiB7XG4gICAgICAgIGlmIChzdGF0dXMgPT09IDEpIHRoaXMuX3Jlc29sdmVyKHZhbHVlKVxuICAgICAgICBpZiAoc3RhdHVzID09PSAyKSB0aGlzLl9yZWplY3Rlcih2YWx1ZSlcbiAgICAgIH0pXG4gICAgaWYgKHN0YXR1cyA9PT0gMSB8fCBzdGF0dXMgPT09IDIpIHtcbiAgICAgIHRoaXMuX2NvbXBsZXRlZCA9IHRydWVcbiAgICB9XG4gICAgcmV0dXJuIHE7XG4gIH0sXG5cbiAgZGVidWc6IGZ1bmN0aW9uKGVuYWJsZWQpIHtcbiAgICB0aGlzLl9kZWJ1ZyA9IGFyZ3VtZW50cy5sZW5ndGggPyBlbmFibGVkIDogdHJ1ZTtcbiAgICByZXR1cm4gdGhpc1xuICB9LFxuXG4gIF9za2lwcGluZzogZnVuY3Rpb24oc3FsKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignVHJhbnNhY3Rpb24gJyArIHRoaXMudHhpZCArICcgaGFzIGFscmVhZHkgYmVlbiByZWxlYXNlZCBza2lwcGluZzogJyArIHNxbCkpXG4gIH0sXG5cbiAgLy8gQWNxdWlyZSBhIGNvbm5lY3Rpb24gYW5kIGNyZWF0ZSBhIGRpc3Bvc2VyIC0gZWl0aGVyIHVzaW5nIHRoZSBvbmUgcGFzc2VkIFxuICAvLyB2aWEgY29uZmlnIG9yIGdldHRpbmcgb25lIG9mZiB0aGUgY2xpZW50LiBUaGUgZGlzcG9zZXIgd2lsbCBiZSBjYWxsZWQgb25jZSBcbiAgLy8gdGhlIG9yaWdpbmFsIHByb21pc2UgaXMgbWFya2VkIGNvbXBsZXRlZC5cbiAgYWNxdWlyZUNvbm5lY3Rpb246IGZ1bmN0aW9uKGNsaWVudCwgY29uZmlnLCB0eGlkKSB7XG4gICAgdmFyIGNvbmZpZ0Nvbm5lY3Rpb24gPSBjb25maWcgJiYgY29uZmlnLmNvbm5lY3Rpb25cbiAgICByZXR1cm4gUHJvbWlzZS50cnkoZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gY29uZmlnQ29ubmVjdGlvbiB8fCBjbGllbnQuYWNxdWlyZUNvbm5lY3Rpb24oKSAgXG4gICAgfSlcbiAgICAuZGlzcG9zZXIoZnVuY3Rpb24oY29ubmVjdGlvbikge1xuICAgICAgaWYgKCFjb25maWdDb25uZWN0aW9uKSB7XG4gICAgICAgIGRlYnVnKCclczogcmVsZWFzaW5nIGNvbm5lY3Rpb24nLCB0eGlkKVxuICAgICAgICBjbGllbnQucmVsZWFzZUNvbm5lY3Rpb24oY29ubmVjdGlvbilcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlYnVnKCclczogbm90IHJlbGVhc2luZyBleHRlcm5hbCBjb25uZWN0aW9uJywgdHhpZClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbn0pXG5cbi8vIFRoZSB0cmFuc2FjdG9yIGlzIGEgZnVsbCBmZWF0dXJlZCBrbmV4IG9iamVjdCwgd2l0aCBhIFwiY29tbWl0XCIsIFxuLy8gYSBcInJvbGxiYWNrXCIgYW5kIGEgXCJzYXZlcG9pbnRcIiBmdW5jdGlvbi4gVGhlIFwic2F2ZXBvaW50XCIgaXMganVzdFxuLy8gc3VnYXIgZm9yIGNyZWF0aW5nIGEgbmV3IHRyYW5zYWN0aW9uLiBJZiB0aGUgcm9sbGJhY2sgaXMgcnVuXG4vLyBpbnNpZGUgYSBzYXZlcG9pbnQsIGl0IHJvbGxzIGJhY2sgdG8gdGhlIGxhc3Qgc2F2ZXBvaW50IC0gb3RoZXJ3aXNlXG4vLyBpdCByb2xscyBiYWNrIHRoZSB0cmFuc2FjdGlvbi5cbmZ1bmN0aW9uIG1ha2VUcmFuc2FjdG9yKHRyeCwgY29ubmVjdGlvbiwgdHJ4Q2xpZW50KSB7XG4gIFxuICB2YXIgdHJhbnNhY3RvciA9IG1ha2VLbmV4KHRyeENsaWVudClcblxuICB0cmFuc2FjdG9yLnRyYW5zYWN0aW9uID0gZnVuY3Rpb24oY29udGFpbmVyLCBvcHRpb25zKSB7XG4gICAgcmV0dXJuIG5ldyB0cnhDbGllbnQuVHJhbnNhY3Rpb24odHJ4Q2xpZW50LCBjb250YWluZXIsIG9wdGlvbnMsIHRyeClcbiAgfSAgXG4gIHRyYW5zYWN0b3Iuc2F2ZXBvaW50ID0gZnVuY3Rpb24oY29udGFpbmVyLCBvcHRpb25zKSB7XG4gICAgcmV0dXJuIHRyYW5zYWN0b3IudHJhbnNhY3Rpb24oY29udGFpbmVyLCBvcHRpb25zKVxuICB9XG5cbiAgaWYgKHRyeC5jbGllbnQudHJhbnNhY3RpbmcpIHtcbiAgICB0cmFuc2FjdG9yLmNvbW1pdCA9IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICByZXR1cm4gdHJ4LnJlbGVhc2UoY29ubmVjdGlvbiwgdmFsdWUpXG4gICAgfVxuICAgIHRyYW5zYWN0b3Iucm9sbGJhY2sgPSBmdW5jdGlvbihlcnJvcikge1xuICAgICAgcmV0dXJuIHRyeC5yb2xsYmFja1RvKGNvbm5lY3Rpb24sIGVycm9yKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdHJhbnNhY3Rvci5jb21taXQgPSBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgcmV0dXJuIHRyeC5jb21taXQoY29ubmVjdGlvbiwgdmFsdWUpXG4gICAgfVxuICAgIHRyYW5zYWN0b3Iucm9sbGJhY2sgPSBmdW5jdGlvbihlcnJvcikge1xuICAgICAgcmV0dXJuIHRyeC5yb2xsYmFjayhjb25uZWN0aW9uLCBlcnJvcilcbiAgICB9XG4gIH1cblxuICByZXR1cm4gdHJhbnNhY3RvclxufVxuXG5cbi8vIFdlIG5lZWQgdG8gbWFrZSBhIGNsaWVudCBvYmplY3Qgd2hpY2ggYWx3YXlzIGFjcXVpcmVzIHRoZSBzYW1lIFxuLy8gY29ubmVjdGlvbiBhbmQgZG9lcyBub3QgcmVsZWFzZSBiYWNrIGludG8gdGhlIHBvb2wuXG5mdW5jdGlvbiBtYWtlVHhDbGllbnQodHJ4LCBjbGllbnQsIGNvbm5lY3Rpb24pIHtcblxuICB2YXIgdHJ4Q2xpZW50ICAgICAgICAgICAgICAgID0gT2JqZWN0LmNyZWF0ZShjbGllbnQuY29uc3RydWN0b3IucHJvdG90eXBlKVxuICB0cnhDbGllbnQuY29uZmlnICAgICAgICAgICAgID0gY2xpZW50LmNvbmZpZ1xuICB0cnhDbGllbnQuZHJpdmVyICAgICAgICAgICAgID0gY2xpZW50LmRyaXZlclxuICB0cnhDbGllbnQuY29ubmVjdGlvblNldHRpbmdzID0gY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5nc1xuICB0cnhDbGllbnQudHJhbnNhY3RpbmcgICAgICAgID0gdHJ1ZVxuICBcbiAgdHJ4Q2xpZW50Lm9uKCdxdWVyeScsIGZ1bmN0aW9uKGFyZykge1xuICAgIHRyeC5lbWl0KCdxdWVyeScsIGFyZylcbiAgICBjbGllbnQuZW1pdCgncXVlcnknLCBhcmcpXG4gIH0pXG5cbiAgdmFyIF9xdWVyeSA9IHRyeENsaWVudC5xdWVyeTtcbiAgdHJ4Q2xpZW50LnF1ZXJ5ICA9IGZ1bmN0aW9uKGNvbm4sIG9iaikge1xuICAgIHZhciBjb21wbGV0ZWQgPSB0cnguaXNDb21wbGV0ZWQoKVxuICAgIHJldHVybiBQcm9taXNlLnRyeShmdW5jdGlvbigpIHtcbiAgICAgIGlmIChjb25uICE9PSBjb25uZWN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY29ubmVjdGlvbiBmb3IgdHJhbnNhY3Rpb24gcXVlcnkuJylcbiAgICAgIGlmIChjb21wbGV0ZWQpIGNvbXBsZXRlZEVycm9yKHRyeCwgb2JqKVxuICAgICAgcmV0dXJuIF9xdWVyeS5jYWxsKHRyeENsaWVudCwgY29ubiwgb2JqKVxuICAgIH0pXG4gIH1cbiAgdmFyIF9zdHJlYW0gPSB0cnhDbGllbnQuc3RyZWFtXG4gIHRyeENsaWVudC5zdHJlYW0gPSBmdW5jdGlvbihjb25uLCBvYmosIHN0cmVhbSwgb3B0aW9ucykge1xuICAgIHZhciBjb21wbGV0ZWQgPSB0cnguaXNDb21wbGV0ZWQoKVxuICAgIHJldHVybiBQcm9taXNlLnRyeShmdW5jdGlvbigpIHtcbiAgICAgIGlmIChjb25uICE9PSBjb25uZWN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY29ubmVjdGlvbiBmb3IgdHJhbnNhY3Rpb24gcXVlcnkuJylcbiAgICAgIGlmIChjb21wbGV0ZWQpIGNvbXBsZXRlZEVycm9yKHRyeCwgb2JqKVxuICAgICAgcmV0dXJuIF9zdHJlYW0uY2FsbCh0cnhDbGllbnQsIGNvbm4sIG9iaiwgc3RyZWFtLCBvcHRpb25zKVxuICAgIH0pXG4gIH1cbiAgdHJ4Q2xpZW50LmFjcXVpcmVDb25uZWN0aW9uID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRyeC5fcXVldWUudGhlbihmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBjb25uZWN0aW9uXG4gICAgfSlcbiAgfVxuICB0cnhDbGllbnQucmVsZWFzZUNvbm5lY3Rpb24gPSBmdW5jdGlvbigpIHsgXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gIH1cblxuICByZXR1cm4gdHJ4Q2xpZW50XG59XG5cbmZ1bmN0aW9uIGNvbXBsZXRlZEVycm9yKHRyeCwgb2JqKSB7XG4gIHZhciBzcWwgPSB0eXBlb2Ygb2JqID09PSAnc3RyaW5nJyA/IG9iaiA6IG9iaiAmJiBvYmouc3FsXG4gIGRlYnVnKCclczogVHJhbnNhY3Rpb24gY29tcGxldGVkOiAlcycsIHRyeC5pZCwgc3FsKVxuICB0aHJvdyBuZXcgRXJyb3IoJ1RyYW5zYWN0aW9uIHF1ZXJ5IGFscmVhZHkgY29tcGxldGUsIHJ1biB3aXRoIERFQlVHPWtuZXg6dHggZm9yIG1vcmUgaW5mbycpICBcbn1cblxudmFyIHByb21pc2VJbnRlcmZhY2UgPSBbXG4gICd0aGVuJywgJ2JpbmQnLCAnY2F0Y2gnLCAnZmluYWxseScsICdhc0NhbGxiYWNrJyxcbiAgJ3NwcmVhZCcsICdtYXAnLCAncmVkdWNlJywgJ3RhcCcsICd0aGVuUmV0dXJuJyxcbiAgJ3JldHVybicsICd5aWVsZCcsICdlbnN1cmUnLCAnbm9kZWlmeScsICdleGVjJ1xuXVxuXG4vLyBDcmVhdGVzIGEgbWV0aG9kIHdoaWNoIFwiY29lcmNlc1wiIHRvIGEgcHJvbWlzZSwgYnkgY2FsbGluZyBhXG4vLyBcInRoZW5cIiBtZXRob2Qgb24gdGhlIGN1cnJlbnQgYFRhcmdldGBcbnByb21pc2VJbnRlcmZhY2UuZm9yRWFjaChmdW5jdGlvbihtZXRob2QpIHtcbiAgVHJhbnNhY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gKHRoaXMuX3Byb21pc2UgPSB0aGlzLl9wcm9taXNlW21ldGhvZF0uYXBwbHkodGhpcy5fcHJvbWlzZSwgYXJndW1lbnRzKSlcbiAgfVxufSlcblxubW9kdWxlLmV4cG9ydHMgPSBUcmFuc2FjdGlvbjtcbiJdfQ==