
// Raw
// -------
'use strict';

var inherits = require('inherits');
var EventEmitter = require('events').EventEmitter;
var assign = require('lodash/object/assign');
var reduce = require('lodash/collection/reduce');
var isPlainObject = require('lodash/lang/isPlainObject');

function Raw(client) {
  this.client = client;

  this.sql = '';
  this.bindings = [];
  this._cached = undefined;

  // Todo: Deprecate
  this._wrappedBefore = undefined;
  this._wrappedAfter = undefined;
  this._debug = client && client.options && client.options.debug;
}
inherits(Raw, EventEmitter);

assign(Raw.prototype, {

  set: function set(sql, bindings) {
    this._cached = undefined;
    this.sql = sql;
    this.bindings = bindings;
    return this;
  },

  // Wraps the current sql with `before` and `after`.
  wrap: function wrap(before, after) {
    this._cached = undefined;
    this._wrappedBefore = before;
    this._wrappedAfter = after;
    return this;
  },

  // Calls `toString` on the Knex object.
  toString: function toString() {
    return this.toQuery();
  },

  // Returns the raw sql for the query.
  toSQL: function toSQL() {
    if (this._cached) return this._cached;
    if (Array.isArray(this.bindings)) {
      this._cached = replaceRawArrBindings(this);
    } else if (this.bindings && isPlainObject(this.bindings)) {
      this._cached = replaceKeyBindings(this);
    } else {
      this._cached = {
        method: 'raw',
        sql: this.sql,
        bindings: this.bindings
      };
    }
    if (this._wrappedBefore) {
      this._cached.sql = this._wrappedBefore + this._cached.sql;
    }
    if (this._wrappedAfter) {
      this._cached.sql = this._cached.sql + this._wrappedAfter;
    }
    this._cached.options = reduce(this._options, assign, {});
    return this._cached;
  }

});

function replaceRawArrBindings(raw) {
  var expectedBindings = raw.bindings.length;
  var values = raw.bindings;
  var client = raw.client;
  var index = 0;
  var bindings = [];

  var sql = raw.sql.replace(/\\?\?\??/g, function (match) {
    if (match === '\\?') {
      return match;
    }

    var value = values[index++];

    if (value && typeof value.toSQL === 'function') {
      var bindingSQL = value.toSQL();
      if (bindingSQL.bindings !== undefined) {
        bindings = bindings.concat(bindingSQL.bindings);
      }
      return bindingSQL.sql;
    }

    if (match === '??') {
      return client.formatter().columnize(value);
    }
    bindings.push(value);
    return '?';
  });

  if (expectedBindings !== index) {
    throw new Error('Expected ' + expectedBindings + ' bindings, saw ' + index);
  }

  return {
    method: 'raw',
    sql: sql,
    bindings: bindings
  };
}

function replaceKeyBindings(raw) {
  var values = raw.bindings;
  var client = raw.client;
  var sql = raw.sql,
      bindings = [];

  var regex = new RegExp('(^|\\s)(\\:\\w+\\:?)', 'g');
  sql = raw.sql.replace(regex, function (full) {
    var key = full.trim();
    var isIdentifier = key[key.length - 1] === ':';
    var value = isIdentifier ? values[key.slice(1, -1)] : values[key.slice(1)];
    if (value === undefined) return '';
    if (value && typeof value.toSQL === 'function') {
      var bindingSQL = value.toSQL();
      if (bindingSQL.bindings !== undefined) {
        bindings = bindings.concat(bindingSQL.bindings);
      }
      return full.replace(key, bindingSQL.sql);
    }
    if (isIdentifier) {
      return full.replace(key, client.formatter().columnize(value));
    }
    bindings.push(value);
    return full.replace(key, '?');
  });

  return {
    method: 'raw',
    sql: sql,
    bindings: bindings
  };
}

// Allow the `Raw` object to be utilized with full access to the relevant
// promise API.
require('./interface')(Raw);

module.exports = Raw;
//# sourceMappingURL=data:application/json;base64,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QUFDMUUsUUFBSSxLQUFLLEtBQUssU0FBUyxFQUFFLE9BQU8sRUFBRSxDQUFBO0FBQ2xDLFFBQUksS0FBSyxJQUFJLE9BQU8sS0FBSyxDQUFDLEtBQUssS0FBSyxVQUFVLEVBQUU7QUFDOUMsVUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFBO0FBQzlCLFVBQUksVUFBVSxDQUFDLFFBQVEsS0FBSyxTQUFTLEVBQUU7QUFDckMsZ0JBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQTtPQUNoRDtBQUNELGFBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0tBQ3pDO0FBQ0QsUUFBSSxZQUFZLEVBQUU7QUFDaEIsYUFBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7S0FDOUQ7QUFDRCxZQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBQ3BCLFdBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7R0FDOUIsQ0FBQyxDQUFBOztBQUVGLFNBQU87QUFDTCxVQUFNLEVBQUUsS0FBSztBQUNiLE9BQUcsRUFBRSxHQUFHO0FBQ1IsWUFBUSxFQUFFLFFBQVE7R0FDbkIsQ0FBQTtDQUNGOzs7O0FBSUQsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBOztBQUUzQixNQUFNLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQSIsImZpbGUiOiJyYXcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vIFJhd1xuLy8gLS0tLS0tLVxudmFyIGluaGVyaXRzICAgICAgPSByZXF1aXJlKCdpbmhlcml0cycpXG52YXIgRXZlbnRFbWl0dGVyICA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlclxudmFyIGFzc2lnbiAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gvb2JqZWN0L2Fzc2lnbicpXG52YXIgcmVkdWNlICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaC9jb2xsZWN0aW9uL3JlZHVjZScpXG52YXIgaXNQbGFpbk9iamVjdCA9IHJlcXVpcmUoJ2xvZGFzaC9sYW5nL2lzUGxhaW5PYmplY3QnKVxuXG5mdW5jdGlvbiBSYXcoY2xpZW50KSB7XG4gIHRoaXMuY2xpZW50ICAgPSBjbGllbnRcblxuICB0aGlzLnNxbCAgICAgID0gJydcbiAgdGhpcy5iaW5kaW5ncyA9IFtdXG4gIHRoaXMuX2NhY2hlZCAgPSB1bmRlZmluZWRcblxuICAvLyBUb2RvOiBEZXByZWNhdGVcbiAgdGhpcy5fd3JhcHBlZEJlZm9yZSA9IHVuZGVmaW5lZFxuICB0aGlzLl93cmFwcGVkQWZ0ZXIgID0gdW5kZWZpbmVkXG4gIHRoaXMuX2RlYnVnICAgICAgICAgPSBjbGllbnQgJiYgY2xpZW50Lm9wdGlvbnMgJiYgY2xpZW50Lm9wdGlvbnMuZGVidWdcbn1cbmluaGVyaXRzKFJhdywgRXZlbnRFbWl0dGVyKVxuXG5hc3NpZ24oUmF3LnByb3RvdHlwZSwge1xuXG4gIHNldDogZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgeyAgICBcbiAgICB0aGlzLl9jYWNoZWQgID0gdW5kZWZpbmVkXG4gICAgdGhpcy5zcWwgICAgICA9IHNxbFxuICAgIHRoaXMuYmluZGluZ3MgPSBiaW5kaW5nc1xuICAgIHJldHVybiB0aGlzXG4gIH0sXG5cbiAgLy8gV3JhcHMgdGhlIGN1cnJlbnQgc3FsIHdpdGggYGJlZm9yZWAgYW5kIGBhZnRlcmAuXG4gIHdyYXA6IGZ1bmN0aW9uKGJlZm9yZSwgYWZ0ZXIpIHtcbiAgICB0aGlzLl9jYWNoZWQgICAgICAgID0gdW5kZWZpbmVkXG4gICAgdGhpcy5fd3JhcHBlZEJlZm9yZSA9IGJlZm9yZVxuICAgIHRoaXMuX3dyYXBwZWRBZnRlciAgPSBhZnRlclxuICAgIHJldHVybiB0aGlzXG4gIH0sXG5cbiAgLy8gQ2FsbHMgYHRvU3RyaW5nYCBvbiB0aGUgS25leCBvYmplY3QuXG4gIHRvU3RyaW5nOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy50b1F1ZXJ5KClcbiAgfSxcblxuICAvLyBSZXR1cm5zIHRoZSByYXcgc3FsIGZvciB0aGUgcXVlcnkuXG4gIHRvU1FMOiBmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5fY2FjaGVkKSByZXR1cm4gdGhpcy5fY2FjaGVkXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5iaW5kaW5ncykpIHtcbiAgICAgIHRoaXMuX2NhY2hlZCA9IHJlcGxhY2VSYXdBcnJCaW5kaW5ncyh0aGlzKSBcbiAgICB9IGVsc2UgaWYgKHRoaXMuYmluZGluZ3MgJiYgaXNQbGFpbk9iamVjdCh0aGlzLmJpbmRpbmdzKSkge1xuICAgICAgdGhpcy5fY2FjaGVkID0gcmVwbGFjZUtleUJpbmRpbmdzKHRoaXMpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2NhY2hlZCA9IHtcbiAgICAgICAgbWV0aG9kOiAncmF3JyxcbiAgICAgICAgc3FsOiB0aGlzLnNxbCxcbiAgICAgICAgYmluZGluZ3M6IHRoaXMuYmluZGluZ3NcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuX3dyYXBwZWRCZWZvcmUpIHtcbiAgICAgIHRoaXMuX2NhY2hlZC5zcWwgPSB0aGlzLl93cmFwcGVkQmVmb3JlICsgdGhpcy5fY2FjaGVkLnNxbFxuICAgIH1cbiAgICBpZiAodGhpcy5fd3JhcHBlZEFmdGVyKSB7XG4gICAgICB0aGlzLl9jYWNoZWQuc3FsID0gdGhpcy5fY2FjaGVkLnNxbCArIHRoaXMuX3dyYXBwZWRBZnRlclxuICAgIH1cbiAgICB0aGlzLl9jYWNoZWQub3B0aW9ucyA9IHJlZHVjZSh0aGlzLl9vcHRpb25zLCBhc3NpZ24sIHt9KVxuICAgIHJldHVybiB0aGlzLl9jYWNoZWRcbiAgfVxuXG59KVxuXG5mdW5jdGlvbiByZXBsYWNlUmF3QXJyQmluZGluZ3MocmF3KSB7XG4gIHZhciBleHBlY3RlZEJpbmRpbmdzID0gcmF3LmJpbmRpbmdzLmxlbmd0aFxuICB2YXIgdmFsdWVzICAgICAgICAgICA9IHJhdy5iaW5kaW5nc1xuICB2YXIgY2xpZW50ICAgICAgICAgICA9IHJhdy5jbGllbnRcbiAgdmFyIGluZGV4ICAgICAgICAgICAgPSAwO1xuICB2YXIgYmluZGluZ3MgICAgICAgICA9IFtdXG5cbiAgdmFyIHNxbCA9IHJhdy5zcWwucmVwbGFjZSgvXFxcXD9cXD9cXD8/L2csIGZ1bmN0aW9uKG1hdGNoKSB7XG4gICAgaWYgKG1hdGNoID09PSAnXFxcXD8nKSB7XG4gICAgICByZXR1cm4gbWF0Y2hcbiAgICB9XG5cbiAgICB2YXIgdmFsdWUgPSB2YWx1ZXNbaW5kZXgrK11cbiAgICBcbiAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlLnRvU1FMID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB2YXIgYmluZGluZ1NRTCA9IHZhbHVlLnRvU1FMKClcbiAgICAgIGlmIChiaW5kaW5nU1FMLmJpbmRpbmdzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYmluZGluZ3MgPSBiaW5kaW5ncy5jb25jYXQoYmluZGluZ1NRTC5iaW5kaW5ncykgIFxuICAgICAgfVxuICAgICAgcmV0dXJuIGJpbmRpbmdTUUwuc3FsXG4gICAgfVxuXG4gICAgaWYgKG1hdGNoID09PSAnPz8nKSB7XG4gICAgICByZXR1cm4gY2xpZW50LmZvcm1hdHRlcigpLmNvbHVtbml6ZSh2YWx1ZSlcbiAgICB9XG4gICAgYmluZGluZ3MucHVzaCh2YWx1ZSlcbiAgICByZXR1cm4gJz8nXG4gIH0pXG5cbiAgaWYgKGV4cGVjdGVkQmluZGluZ3MgIT09IGluZGV4KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCAnICsgZXhwZWN0ZWRCaW5kaW5ncyArICcgYmluZGluZ3MsIHNhdyAnICsgaW5kZXgpXG4gIH1cblxuICByZXR1cm4ge1xuICAgIG1ldGhvZDogJ3JhdycsXG4gICAgc3FsOiBzcWwsXG4gICAgYmluZGluZ3M6IGJpbmRpbmdzXG4gIH1cbn1cblxuZnVuY3Rpb24gcmVwbGFjZUtleUJpbmRpbmdzKHJhdykge1xuICB2YXIgdmFsdWVzICAgPSByYXcuYmluZGluZ3NcbiAgdmFyIGNsaWVudCAgID0gcmF3LmNsaWVudFxuICB2YXIgc3FsICAgICAgPSByYXcuc3FsLCBiaW5kaW5ncyA9IFtdXG5cbiAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnKF58XFxcXHMpKFxcXFw6XFxcXHcrXFxcXDo/KScsICdnJylcbiAgc3FsID0gcmF3LnNxbC5yZXBsYWNlKHJlZ2V4LCBmdW5jdGlvbihmdWxsKSB7XG4gICAgdmFyIGtleSA9IGZ1bGwudHJpbSgpO1xuICAgIHZhciBpc0lkZW50aWZpZXIgPSBrZXlba2V5Lmxlbmd0aCAtIDFdID09PSAnOidcbiAgICB2YXIgdmFsdWUgPSBpc0lkZW50aWZpZXIgPyB2YWx1ZXNba2V5LnNsaWNlKDEsIC0xKV0gOiB2YWx1ZXNba2V5LnNsaWNlKDEpXVxuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gJydcbiAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlLnRvU1FMID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB2YXIgYmluZGluZ1NRTCA9IHZhbHVlLnRvU1FMKClcbiAgICAgIGlmIChiaW5kaW5nU1FMLmJpbmRpbmdzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYmluZGluZ3MgPSBiaW5kaW5ncy5jb25jYXQoYmluZGluZ1NRTC5iaW5kaW5ncykgIFxuICAgICAgfVxuICAgICAgcmV0dXJuIGZ1bGwucmVwbGFjZShrZXksIGJpbmRpbmdTUUwuc3FsKVxuICAgIH1cbiAgICBpZiAoaXNJZGVudGlmaWVyKSB7XG4gICAgICByZXR1cm4gZnVsbC5yZXBsYWNlKGtleSwgY2xpZW50LmZvcm1hdHRlcigpLmNvbHVtbml6ZSh2YWx1ZSkpXG4gICAgfVxuICAgIGJpbmRpbmdzLnB1c2godmFsdWUpXG4gICAgcmV0dXJuIGZ1bGwucmVwbGFjZShrZXksICc/JylcbiAgfSlcblxuICByZXR1cm4ge1xuICAgIG1ldGhvZDogJ3JhdycsXG4gICAgc3FsOiBzcWwsXG4gICAgYmluZGluZ3M6IGJpbmRpbmdzXG4gIH1cbn1cblxuLy8gQWxsb3cgdGhlIGBSYXdgIG9iamVjdCB0byBiZSB1dGlsaXplZCB3aXRoIGZ1bGwgYWNjZXNzIHRvIHRoZSByZWxldmFudFxuLy8gcHJvbWlzZSBBUEkuXG5yZXF1aXJlKCcuL2ludGVyZmFjZScpKFJhdylcblxubW9kdWxlLmV4cG9ydHMgPSBSYXdcbiJdfQ==